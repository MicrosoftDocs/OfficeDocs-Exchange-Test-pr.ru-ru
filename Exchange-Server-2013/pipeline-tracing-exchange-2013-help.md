---
title: 'Трассировка конвейера: Exchange 2013 Help'
TOCTitle: Трассировка конвейера
ms:assetid: e7780499-9a6f-48b1-aea8-df88ecd8b18a
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Bb125018(v=EXCHG.150)
ms:contentKeyID: 52061285
ms.date: 04/30/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# Трассировка конвейера

 

_**Применимо к:**Exchange Server 2013_

_**Последнее изменение раздела:**2015-03-09_

Функция конвейерной трассировки отвечает за захват копий сообщений электронной почты от определенного отправителя по мере их перемещения через транспортную службу и службу доставки с помощью транспорта почтовых ящиков на серверах почтовых ящиков, а также через пограничные транспортные серверы. Функция конвейерной трассировки также отвечает за захват подробных сведений об изменениях, которые применяет каждый агент транспорта к сообщениям в транспортном конвейере, с помощью файлов моментальных снимков сообщений. Путем проверки содержимого файлов снимков сообщений можно определить, внесли ли агенты транспорта изменения в сообщения конвейерной трассировки передачи должным образом. При обнаружении неисправности необходимо определить, в каком агенте транспорта произошла ошибка. После этого, чтобы устранить неисправность, можно сосредоточиться на поиске ошибок этого агента. Затем можно просмотреть файлы снимков сообщений снова, чтобы убедиться, что устранение неисправности прошло успешно.

<table>
<colgroup>
<col style="width: 100%" />
</colgroup>
<thead>
<tr class="header">
<th><img src="images/Dd876857.Caution(EXCHG.150).gif" title="Внимание!" alt="Внимание!" />Внимание!</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><ul>
<li><p>Функция конвейерной трассировки копирует все содержимое сообщений электронной почты, которые отправляются с адреса электронной почты отправителя. Чтобы избежать нежелательного раскрытия конфиденциальной информации, необходимо настроить соответствующие разрешения системы безопасности в папке конвейерной трассировки.</p></li>
<li><p>Не следует включать конвейерную трассировку на длительный период времени. Конвейерная трассировка создает файлы, которые могут быстро накапливаться. Если включена конвейерная трассировка, всегда следите за объемом свободного дискового пространства.</p></li>
</ul></td>
</tr>
</tbody>
</table>


## Настройка конвейерной трассировки

Прежде чем включить конвейерную трассировку, необходимо указать адрес электронной почты отправителя, за которым следует вести наблюдение. Конвейерная трассировка предназначена для внесения в журнал сообщений, которые отправляются с определенного адреса электронной почты. Адрес электронной почты отправителя может являться внутренним или внешним по отношению к организации Exchange. Также можно включить конвейерную трассировку для системных сообщений, которые создаются транспортной службой на указанном сервере почтовых ящиков или пограничном транспортном сервере, например автоматических ответов, уведомлений о доставке, отчетов журналов и т. д. Можно также изменить расположение папки конвейерной трассировки.

Параметры, которые используются для настройки конвейерной трассировки, приведены в следующей таблице.


<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>Командлет</th>
<th>Параметр</th>
<th>Значение по умолчанию</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>Set-TransportService</strong></p>
<p><strong>Set-MailboxTransportService</strong></p></td>
<td><p><em>PipelineTracingSenderAddress</em></p></td>
<td><p>Пусто (<code>$null</code>)</p></td>
<td><p>Указывает адрес электронной почты отправителя, за которым необходимо вести наблюдение.</p>
<p>Указывает значение &quot;&lt;&gt;&quot; для наблюдения за системными сообщениями, которые отправляются указанной транспортной службой на сервере.</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-TransportService</strong></p>
<p><strong>Set-MailboxTransportService</strong></p></td>
<td><p><em>PipelineTracingPath</em></p></td>
<td><p><strong>Транспортная служба</strong>. <code>%ExchangeInstallPath%TransportRoles\Logs\Hub\PipelineTracing</code></p>
<p><strong>Транспортная служба почтовых ящиков</strong>. <code>%ExchangeInstallPath%TransportRoles\Logs\Mailbox\PipelineTracing</code></p></td>
<td><p>Путь должен находиться на локальном сервере. UNC-пути не поддерживаются.</p>
<p>Указанный путь включает папку <code>MessageSnapshots</code>, в которой хранятся файлы конвейерной трассировки.</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-TransportService</strong></p>
<p><strong>Set-MailboxTransportService</strong></p></td>
<td><p><em>PipelineTracingEnabled</em></p></td>
<td><p><code>$false</code></p></td>
<td><p>Конвейерную трассировку можно включить только для указанной транспортной службы на сервере после настройки адреса отправителя, за которым необходимо вести наблюдение.</p></td>
</tr>
</tbody>
</table>


Дополнительные сведения о том, как разрешить конвейерную трассировку и настроить для нее адрес отправителя, см. в статье [Настройка конвейерной трассировки](configure-pipeline-tracing-exchange-2013-help.md).

## Файлы моментальных снимков сообщений

Моментальные снимки сообщений — это файлы, в которые записываются все изменения, внесенные в сообщение агентами транспорта в транспортной службе или службе доставки с помощью транспорта почтовых ящиков. Эти файлы хранятся в папке `MessageSnapshots` по соответствующему пути конвейерной трассировки для транспортной службы.

В папке `MessageSnapshots` служба Exchange создает по одной папке для каждого сообщения, которое отправляется наблюдаемым отправителем и перемещается через указанную транспортную службу. Каждой папке присваивается имя в соответствии с GUID, назначенным сообщению. Если включить конвейерную трассировку для транспортной службы и транспортной службы почтовых ящиков на одном сервере почтовых ящиков, каждая из этих служб назначает различные GUID одному сообщению, поэтому имя папки для сообщения в папке `MessageSnapshots` транспортной службы отличается от имени папки для того же сообщения в папке `MessageSnapshots` транспортной службы почтовых ящиков. Если включить конвейерную трассировку на нескольких серверах Exchange, по мере продвижения сообщения по указанной транспортной службе на каждом из серверов Exchange этому сообщению назначаются различные GUID.

В каждой папке сообщений служба Exchange создает несколько файлов моментальных снимков сообщений с расширением EML. Эти файлы моментальных снимков сообщений включают в себя содержимое сообщения, которое записывается по мере обнаружения каждого события SMTP и агента транспорта.

Если агент транспорта зарегистрирован в событии SMTP, служба Exchange создает моментальный снимок сообщения еще до того, как сообщение столкнется с агентами транспорта. В результате копия сообщения создается перед тем, как это сообщение обнаружит агентов транспорта, зарегистрированных в этом событии. Затем создается новый снимок сообщения для каждого агента транспорта, которого обнаруживает сообщение независимо от того, изменил ли агент транспорта содержимое сообщения. Однако если для данного события отсутствуют зарегистрированные агенты, служба Exchange не создает ни одного моментального снимка сообщения для этого события.

Например, если в событии **OnEndofData** зарегистрировано три агента транспорта, однако, только два из них изменяют сообщение, создается четвертый снимок сообщения. Первый снимок сообщения делается тогда, когда оно обнаруживает событие **OnEndofData** до внесения в сообщение изменений агентом транспорта, зарегистрированным в этом событии. Затем для каждого агента транспорта создается один снимок сообщения независимо от того, изменил ли его агент транспорта.

Создаваемые файлы моментальных снимков сообщений описаны в следующем списке.

  - **Original.eml**. Этот файл содержит исходное неизмененное содержимое сообщения электронной почты, записанное еще до того, как оно обнаружило событие SMTP или агент транспорта.

  - **Routingnnnn.eml**. Эти файлы включают в себя содержимое сообщения электронной почты, если оно обнаруживает события SMTP и агенты транспорта, зарегистрированные в этих событиях, в классификационной части транспортной службы. Заполнитель *nnnn* представляет собой целое значение, начиная с `0001`. Это значение увеличивается на единицу для каждого события SMTP и агента транспорта, зарегистрированного в этом событии, в порядке, в котором они выполняют действия в отношении сообщения. Эти файлы моментальных снимков **Routing** не создаются в службе доставки с помощью транспорта почтовых ящиков.

  - **SmtpReceivennnn.eml**. Эти файлы включают в себя содержимое сообщения электронной почты, если оно обнаруживает события SMTP **OnEndofData** и **OnEndOfHeaders** и агенты транспорта, зарегистрированные в этих событиях, на приемной части SMTP транспортной службы или службы доставки с помощью транспорта почтовых ящиков. Заполнитель *nnnn* представляет собой целое значение, начиная с `0001`. Это значение увеличивается на единицу для каждого события SMTP и агента транспорта, зарегистрированного в этом событии, в порядке, в котором они выполняют действия в отношении сообщения.

Файлы моментальных снимков сообщений можно открыть с помощью Блокнота или любого текстового редактора.

Каждый файл снимка сообщения начинается с заголовков, которые добавляются к содержимому сообщения и перечисляют SMTP-события и агентов транспорта, к которым относится файл снимка сообщений. Эти заголовки начинаются кодом `X-CreatedBy: MessageSnapshot-Begin injected headers` и заканчиваются кодом `X-EndOfInjectedXHeaders: MessageSnapshot-End injected headers`. В каждом файле моментального снимка сообщения эти заголовки заменяются каждым последующим агентом транспорта и событием SMTP. Ниже приведен пример заголовков, добавляемых в файл сообщения электронной почты.

    X-CreatedBy: MessageSnapshot-Begin injected headers
    X-MessageSnapshot-UTC-Time: 2013-01-23T23:20:18.138Z
    X-MessageSnapshot-Record-Id: 21474836486
    X-MessageSnapshot-Source: OnSubmittedMessageX-Sender: michelle@nwtraders.com
    X-Receiver: chris@contoso.com
    X-EndOfInjectedXHeaders: MessageSnapshot-End injected headers

После заголовков моментальных снимков сообщений файлы включают содержимое сообщений, в том числе все заголовки исходных сообщений. Если агент транспорта изменяет содержимое сообщения, то изменения отображаются вместе с сообщением. Поскольку сообщение обрабатывается всеми агентами транспорта, вносимые каждым агентом изменения применяются к содержимому сообщения. Если агент транспорта не внес никаких изменений в содержимое сообщения, снимок сообщения, созданного этим агентом, совпадает со снимком сообщения, созданным предыдущим агентом транспорта.

