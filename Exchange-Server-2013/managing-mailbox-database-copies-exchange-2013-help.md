---
title: 'Управление копиями баз данных почтовых ящиков: Exchange 2013 Help'
TOCTitle: Управление копиями баз данных почтовых ящиков
ms:assetid: 28cedf1d-365a-4e36-b2ba-6bf81af8684f
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Dd335158(v=EXCHG.150)
ms:contentKeyID: 50487689
ms.date: 04/30/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# Управление копиями баз данных почтовых ящиков

 

_**Применимо к:**Exchange Server 2013_

_**Последнее изменение раздела:**2016-08-26_

После создания, настройки и заполнения группы обеспечения доступности баз данных (DAG) участниками сервера почтовых ящиков можно использовать Центр администрирования Exchange (EAC) или командную консоль Exchange для гибкого и детализированного добавления копий базы данных почтовых ящиков.

## Управление копиями базы данных

После создания нескольких копий базы данных можно использовать EAC или командную консоль для отслеживания работоспособности и состояния каждой копии и для выполнения других задач управления, связанных с копиями баз данных. Некоторые задачи управления, выполнение которых может потребоваться, включают в себя приостановку или возобновление работы копии базы данных, заполнение или удаление такой копии, отслеживание копий базы данных, а также настройку их параметров.

## Приостановка и возобновление работы копий базы данных

По ряду причин, например для выполнения планового обслуживания, может потребоваться приостановка и возобновление непрерывной репликации копии базы данных. Кроме того, для выполнения некоторых административных задач, таких как заполнение, требуется предварительная приостановка копии базы данных. Рекомендуется приостанавливать репликацию при изменении пути к базе данных или к ее файлам журнала. Чтобы приостановить и возобновить работу копии базы данных, можно использовать консоль управления Exchange или запустить командлеты **Suspend-MailboxDatabaseCopy** и **Resume-MailboxDatabaseCopy** в командной консоли. Дополнительные сведения о приостановке и возобновлении непрерывной репликации копии базы данных см. в разделе [Приостановка или возобновление работы копии базы данных почтовых ящиков](suspend-or-resume-a-mailbox-database-copy-exchange-2013-help.md).

## Заполнение копии базы данных

*Заполнение*, также называемое *обновлением*, — это процесс, при котором происходит добавление базы данных — пустой базы данных или копии рабочей базы данных, — к расположению целевой копии на другом сервере почтовых ящиков в одной с активной базой данных группе доступности баз данных. Эта база данных становится основной для копии, обслуживаемой сервером.

В зависимости от ситуации заполнение может выполняться автоматически или вручную. После добавления копия базы данных будет автоматически заполнена, если целевой сервер и его хранилище настроены правильно. Чтобы вручную заполнить копию базы данных без автоматического заполнения при создании копии, можно использовать параметр *SeedingPostponed* при запуске командлета [Add-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd298105\(v=exchg.150\)).

Иногда необходимо повторно заполнить копии базы данных после выполнения первоначального заполнения. Чтобы повторно заполнить копию базы данных или заполнить ее вручную, можно использовать мастер обновления копии базы данных в центре администрирования Exchange или командлет [Update-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd335201\(v=exchg.150\)) в командной консоли. Перед заполнением копии базы данных необходимо приостановить работу копии базы данных почтовых ящиков. Подробное описание действий по заполнению копии базы данных см. в разделе [Обновление копии базы данных почтовых ящиков](update-a-mailbox-database-copy-exchange-2013-help.md).

После заполнения копии базы данных вручную репликация заполненной копии базы данных почтовых ящиков будет автоматически возобновлена. Если автоматическое возобновление репликации не требуется, необходимо использовать параметр *ManualResume* при запуске командлета [Update-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd335201\(v=exchg.150\)).

## Выбор объекта заполнения

Вы можете заполнить копию базы данных почтовых ящиков, копию каталога индексов контента или и ту, и другую.

По умолчанию мастер обновления копии базы данных почтовых ящиков и командлет [Update-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd335201\(v=exchg.150\)) заполняют копию базы данных почтовых ящиков и копию каталога индексов контента. Чтобы заполнить только копию базы данных почтовых ящиков, используйте параметр *DatabaseOnly* при запуске командлета [Update-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd335201\(v=exchg.150\)). Чтобы заполнить только копию каталога индексов контента, используйте параметр *CatalogOnly* при запуске командлета [Update-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd335201\(v=exchg.150\)).

## Выбор источника заполнения

Исправную копию базы данных можно использовать в качестве источника заполнения для дополнительной копии этой базы данных. Это может быть полезно, если группа доступности базы данных развернута в нескольких физических местоположениях. В качестве примера рассмотрим развертывание группы доступности базы данных из четырех участников, в которой два участника (MBX1 и MBX2) находятся в Москве, а другие два участника (MBX3 и MBX4) — в Санкт-Петербурге. База данных почтовых ящиков с именем DB1 активна в MBX1, а пассивные копии DB1 расположены в MBX2 и MBX3. При добавлении копии DB1 в MBX4 вы можете использовать копию в MBX3 как источник для заполнения. При этом вы избегаете заполнения по каналу глобальной сети между Москвой и Санкт-Петербургом.

Чтобы использовать определенную копию в качестве источника для заполнения при добавлении новой копии базы данных, выполните следующие действия.

  - Добавьте копию базы данных с помощью командлета [Add-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd298105\(v=exchg.150\)) с параметром *SeedingPostponed*. Если параметр *SeedingPostponed* не используется, копия базы данных будет заполнена явным образом с помощью активной копии базы данных в качестве источника.

  - Можно указать исходный сервер, который будет использоваться как часть мастера обновления копии базы данных почтовых ящиков в центре администрирования Exchange, либо использовать параметр *SourceServer* при выполнении командлета [Update-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd335201\(v=exchg.150\)), чтобы указать нужный исходный сервер для заполнения. (В предыдущем примере сервер MBX3 указан в качестве исходного сервера.) Если параметр *SourceServer* не используется, копия базы данных будет заполнена явным образом с помощью активной копии базы данных.

## Заполнение и сети

Можно выбрать не только определенный исходный сервер для заполнения копии базы данных почтовых ящиков, но и использовать командную консоль, чтобы указать сеть группы доступности баз данных, которую необходимо использовать, а также дополнительно переопределить параметры сжатия и шифрования данных сети группы доступности баз данных во время заполнения.

<table>
<thead>
<tr class="header">
<th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Заполнение каталога индексов контента возможно только по сети MAPI, даже при использовании параметра <code>-Network</code> в командлете Update-MailboxDatabaseCopy.</td>
</tr>
</tbody>
</table>


Чтобы указать сети, которые необходимо использовать для заполнения, выберите параметр *Network* при запуске командлета [Update-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd335201\(v=exchg.150\)) и укажите необходимые сети группы доступности базы данных. Если параметр *Network* не указан, система будет использовать для выбора сети, необходимой для заполнения, следующее поведение по умолчанию.

  - Если исходный и целевой серверы находятся в одной подсети и настроена сеть репликации, включающая в себя эту подсеть, будет использоваться сеть репликации.

  - Если исходный и целевой серверы находятся в различных подсетях, даже если настроена сеть репликации, включающая в себя эти подсети, клиентская сеть (MAPI) будет использоваться для заполнения.

  - Если исходный и целевой серверы находятся в различных центрах данных, будет использоваться клиентская сеть (MAPI) для заполнения.

На уровне групп доступности базы данных сети групп доступности базы данных необходимо настроить для шифрования и сжатия данных. Параметры по умолчанию разрешают использование шифрования и сжатия только для связи в разных подсетях. Если источник и цель находятся в различных подсетях и для группы доступности базы данных установлены значения по умолчанию для параметров *NetworkCompression* и *NetworkEncryption*, можно переопределить эти значения с помощью параметров *NetworkCompressionOverride* и *NetworkEncryptionOverride* соответственно при запуске командлета [Update-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd335201\(v=exchg.150\)).

## Процесс заполнения

При запуске процесса заполнения с помощью командлетов [Add-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd298105\(v=exchg.150\)) или [Update-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd335201\(v=exchg.150\)) выполняются следующие задачи.

1.  Из Active Directory считываются свойства базы данных, чтобы проверить указанные базы данных и серверы и убедиться, что исходный и целевой серверы используют Exchange 2013, являются участниками одной группы доступности базы данных, а также что указанная база данных не является базой данных восстановления. Также считываются пути к файлам базы данных.

2.  Приготовления выполняются для проверки повторного заполнения из службы репликации Microsoft Exchange целевого сервера.

3.  Служба репликации Microsoft Exchange на целевом сервере проверяет наличие базы данных и файлов журнала транзакций в каталогах файлов, считанных при проверке Active Directory на шаге 1.

4.  Служба репликации Microsoft Exchange возвращает сведения о состоянии из целевого сервера в интерфейс администратора, в котором запущен командлет.

5.  Если все предварительные проверки выполнены успешно, будет предложено подтвердить операцию перед продолжением. При подтверждении операции процесс продолжится. Если при предварительных проверках произошла ошибка, будет создан отчет об этой ошибке и произойдет сбой операции.

6.  Операция заполнения начнется из службы репликации Microsoft Exchange целевого сервера.

7.  Служба репликации Microsoft Exchange приостановит репликацию базы данных для активной копии базы данных.

8.  Сведения о состоянии базы данных обновляются службой репликации Microsoft Exchange для отображения состояния заполнения.

9.  Если на целевом сервере отсутствуют каталоги для файлов целевой базы данных и файлов журнала, они будут созданы.

10. Запрос на заполнение базы данных оправляется из службы репликации Microsoft Exchange на целевом сервере в службу репликации Microsoft Exchange на исходном сервере с помощью протокола TCP. Этот запрос и последующее подключения для заполнения базы данных выполняются в сети группы доступности базы данных, настроенной в качестве сети репликации.

11. Служба репликации Microsoft Exchange на исходном сервере запускает потоковую архивацию расширенного обработчика хранилищ (ESE) с помощью интерфейса службы банка данных Microsoft Exchange.

12. Служба банка данных Microsoft Exchange передает сведения базы данных в службу репликации Microsoft Exchange.

13. Сведения базы данных перемещаются из службы репликации Microsoft Exchange исходного сервера в службу репликации Microsoft Exchange целевого сервера.

14. Служба репликации Microsoft Exchange на целевом сервере записывает копию базы данных во временный каталог, расположенный в каталоге основной базы данных с именем *temp-seeding*.

15. Операция потоковой архивации на исходном сервере заканчивается, когда достигается конец базы данных.

16. Операция записи завершается на целевом сервере, и база данных перемещается из каталога "temp-seeding" в конечное расположение. Каталог "temp-seeding" удаляется.

17. Служба репликации Microsoft Exchange на целевом сервере предоставляет запрос службе поиска Microsoft Exchange на подключение каталога индексов содержимого к копии базы данных, если она существует. Если существуют файлы каталога предыдущей копии базы данных с истекшим сроком действия, происходит сбой операции подключения, что приводит к необходимости репликации каталога с исходного сервера. Подобным образом, если каталог отсутствует в новом экземпляре копии базы данных на целевом сервере, требуется создать копию каталога. Служба репликации Microsoft Exchange указывает службе поиска Microsoft Exchange приостановить индексирование копии базы данных, пока новый каталог копируется из источника.

18. Служба репликации Microsoft Exchange на целевом сервере отправляет запрос на заполнение каталога службе репликации Microsoft Exchange на исходном сервере.

19. На исходном сервере служба репликации Microsoft Exchange запрашивает сведения о каталоге из службы поиска Microsoft Exchange и отправляет запрос на приостановку индексации.

20. Служба поиска Microsoft Exchange на исходном сервере возвращает сведения о каталоге из каталога поиска службе репликации Microsoft Exchange.

21. Служба репликации Microsoft Exchange на исходном сервере считывает файлы каталога из каталога.

22. Служба репликации Microsoft Exchange на исходном сервере перемещает данные каталога в службу репликации Microsoft Exchange на целевом сервере с помощью подключения в сети репликации. После считывания служба репликации Microsoft Exchange отправляет запрос на возобновление индексации исходной базы данных службе поиска Microsoft Exchange.

23. Если в папке на целевом сервере существуют файлы каталога, служба репликации Microsoft Exchange на целевом сервере удалит их.

24. Служба репликации Microsoft Exchange на целевом сервере записывает данные каталога во временную папку *CiSeed.Temp*, пока данные не будут полностью перемещены.

25. Служба репликации Microsoft Exchange перемещает все данные каталога в конечное местоположение.

26. Служба репликации Microsoft Exchange на целевом сервере возобновляет индексацию поиска в целевой базе данных.

27. Служба репликации Microsoft Exchange на целевом сервере возвращает уведомление о состоянии завершения.

28. Конечный результат операции проходит в интерфейс администратора, в котором был запущен командлет.

## Настройка копий базы данных

После создания копии базы данных можно, при необходимости, просматривать и изменять ее параметры конфигурации. Некоторые сведения о конфигурации можно просмотреть в EAC на странице **Свойства** копии базы данных. Также можно использовать командлеты [Get-MailboxDatabase](https://technet.microsoft.com/ru-ru/library/bb124924\(v=exchg.150\)) и [Set-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd298104\(v=exchg.150\)) в командной консоли Exchange для просмотра и настройки таких параметров копии базы данных, как время задержки преобразования, время задержки усечения и приоритет активации. Дополнительные сведения о просмотре и настройке параметров копии базы данных см. в разделе [Настройка свойств копии базы данных почтовых ящиков](configure-mailbox-database-copy-properties-exchange-2013-help.md).

## Использование параметров задержки преобразования и задержки усечения

Копии базы данных почтовых ящиков поддерживают использование параметров *время задержки преобразования* и *время задержки усечения*, которые указываются в минутах. Установка времени задержки преобразования позволяет выполнить откат копии базы данных к определенной точке во времени. Установка времени задержки усечения позволяет использовать журналы в пассивной копии базы данных для восстановления утерянных файлов журнала активной копии базы данных. Поскольку использование обеих этих функций приводит к временному созданию файлов журнала, использование каждой из них влияет на архитектуру хранилища.

## Время задержки преобразования

Время задержки преобразования — свойство копии базы данных почтовых ящиков, которое определяет в минутах время задержки преобразования журнала для копии базы данных. Отсчет времени задержки преобразования запускается после репликации файла журнала в пассивную копию и успешного прохождения проверки. Задержка преобразования журналов в копию базы данных позволяет восстановить состояние базы данных в определенной точке времени в прошлом. Копия базы данных почтовых ящиков, для которой настроено запаздывание преобразования больше 0, называется *изолированной копией базы данных почтовых ящиков*, или просто *изолированной копией*.

Стратегия, использующая копии базы данных и функции судебного удержания в системе Exchange 2013, может обеспечить защиту от ряда сбоев, которые приводят к потере данных. Тем не менее, эти функции не могут обеспечить защиту от потери данных в случае логического повреждения, которое может привести к потере данных (хотя и в редких случаях). Изолированные копии разработаны для предотвращения потери данных в случае логического повреждения. Как правило, существует два типа логического повреждения

  - **Логическое повреждение базы данных**   Контрольная сумма страниц базы данных является правильной, но сведения — логически неправильными. Это происходит, когда расширенный обработчик хранилищ пытается записать страницу базы данных, и несмотря на то, что отображается сообщение об успешном завершении операции, данные либо вообще не записываются на диск, либо записываются в неправильном месте. Такая ситуация называется *утерянной очисткой*. Чтобы предотвратить потерю данных в результате утерянной очистки, расширенный обработчик хранилищ (ESE) добавляет в базу данных механизм определения утерянной очистки и функцию исправления страницы (восстановления одной страницы).

  - **Логическое повреждение хранилища**   Данные добавляются, удаляются или изменяются неожиданным для пользователя образом. Такие случаи обычно вызваны сторонними приложениями. Это повреждение является повреждением только в том смысле, что оно является таковым для пользователя. Хранилище Exchange считает транзакцию, которая привела к логическому повреждению серией правильных операций MAPI. Функция судебного удержания в Exchange 2013 обеспечивает защиту от логического повреждения хранилища (так как это не позволяет пользователям и приложениям удалить контент без возможности восстановления). Однако возможны сценарии, когда почтовый ящик пользователя становится настолько поврежденным, что легче будет восстановить базу данных на момент до повреждения, а затем экспортировать почтовый ящик пользователя, чтобы извлечь неповрежденные данные.

Комбинация копий базы данных, политики удержания и восстановления одиночной страницы с помощью расширенного обработчика хранилищ предотвращает редкие катастрофические случаи логического повреждения хранилища. Решение о том, использовать копию базы данных с задержкой преобразования (изолированную копию), зависит от используемых сторонних приложений и от опыта исправления логических повреждений хранилища в организации.

В определенных сценариях при вызове автоматического воспроизведения журналов в Exchange 2013 изолированные копии могут исправить себя:

  - При достижении порога нехватки места на диске.

  - Если изолированная копия физически повреждена и требуется исправить страницу.

  - При наличии менее трех доступных работоспособных копий (активных или пассивных; изолированные копии не учитываются) в течение более 24 часов.

Благодаря этой функции для изолированных копий доступно исправление страниц. Если для изолированной копии потребуется исправление страниц, в ней будут автоматически воспроизведены журналы, что позволит исправить страницы. Изолированные копии также вызовут эту функцию, если будет достигнут порог нехватки места на диске или обнаружено, что изолированная копия является единственной доступной копией в течение определенного времени.

Воспроизведение изолированных копий по умолчанию отключено. Его можно включить с помощью следующей команды.

    Set-DatabaseAvailabilityGroup <DAGName> -ReplayLagManagerEnabled $true

После включения воспроизведение происходит при наличии менее трех копий. Можно изменить значение по умолчанию, равное 3, изменив следующее значение DWORD в реестре.

**HKLM\\Software\\Microsoft\\ExchangeServer\\v15\\Replay\\Parameters\\ReplayLagManagerNumAvailableCopies**

Чтобы включить воспроизведение для нижних порогов доступного дискового пространства, необходимо настроить следующую запись реестра.

**HKLM\\Software\\Microsoft\\ExchangeServer\\v15\\Replay\\Parameters\\ReplayLagLowSpacePlaydownThresholdInMB**

После настройки какого-либо из этих параметров реестра перезапустите службу управления DAG Microsoft Exchange, чтобы изменения вступили в силу.

В качестве примера рассмотрим среду, где у базы данных есть 4 копии (3 копии с высоким уровнем доступности и 1 изолированная копия), а для параметра ReplayLagManagerNumAvailableCopies используется значение по умолчанию. Если неизолированная копия по какой-либо причине недоступна (например, приостановлена и т. д.), то изолированная копия автоматически воспроизводит файлы журналов через 24 часа.

Если вы решите использовать изолированные копии, не включая параметр `ReplayLagManagerEnabled`, учтите следующее:

  - Существует настраиваемое администратором значение времени задержки преобразования, и по умолчанию оно отключено.

  - Для параметра времени задержки преобразования по умолчанию установлено значение 0 дней. Максимальное значение для этого параметра — 14 дней.

  - Изолированные копии не считаются высокодоступными. Они разработаны для аварийного восстановления и защиты от логического повреждения хранилища.

  - Чем больше время задержки преобразования, тем дольше длится процесс восстановления базы данных. В зависимости от количества файлов журнала, которые необходимо преобразовать во время восстановления, и скорости, с которой оборудование их преобразовывает, восстановление базы данных может занять несколько часов.

  - Рекомендуется определить, критично ли использование изолированных копий для общей стратегии аварийного восстановления. Если их использование является критичным, рекомендуется использовать несколько изолированных копий или использовать резервный массив независимых дисков (RAID) для защиты отдельной изолированной копии при отсутствии нескольких изолированных копий. При потере или повреждении диска отложенная во времени точка не будет потеряна.

  - Изолированные копии невозможно исправить с помощью функции восстановления одиночной страницы в расширенном обработчике хранилищ (ESE). Если изолированная копия вызывает повреждение страницы базы данных (например, ошибку 1018), ее необходимо повторно заполнить (что приведет к потере изолированности копии).

Активация и восстановление изолированной копии базы данных почтовых ящиков — легкий процесс, если необходимо преобразование всех файлов журнала и приведение копии базы данных к текущему состоянию. Преобразование файлов журнала к определенному моменту времени является более сложной операцией, поскольку необходимо вручную управлять файлами журнала и запускать служебные программы Exchange Server Eseutil.exe.

Подробное описание действий по активации изолированной копии базы данных почтовых ящиков см. в разделе [Активация отстающей копии базы данных почтовых ящиков](activate-a-lagged-mailbox-database-copy-exchange-2013-help.md).

## Время задержки усечения

Время задержки усечения — свойство копии базы данных почтовых ящиков, которое определяет в минутах время задержки удаления журнала для копии базы данных после преобразования файла журнала в копию базы данных. Отсчет времени задержки усечения запускается после репликации файла журнала в пассивную копию, успешного прохождения проверки и преобразования в копию базы данных. Отложенное усечение файлов журнала в копии базы данных позволяет выполнить восстановление после сбоев, влияющих на файлы журнала активной копии базы данных.

## Копии базы данных и усечение журнала

Усечение журнала в Exchange 2013 работает так же, как и в Exchange 2010. Поведение усечения зависит от параметров времени задержки преобразования и времени задержки усечения копии.

Файл журнала копии базы данных должен соответствовать следующим критериям, если для параметров задержки установлено значение по умолчанию 0 (отключено).

  - Файл журнала должен иметь архив или циклическое ведение журнала должно быть включено.

  - Файл журнала должен находиться под контрольной точкой (минимальный файл журнала, необходимый для восстановления) для базы данных.

  - Для всех других изолированных копий необходимо выполнить проверку файла журнала.

  - Для всех других копий (неизолированных) необходимо воспроизвести файл журнала.

Для выполнения усечения необходимо соответствие копии базы данных следующим критериям.

  - Файл журнала должен быть ниже контрольной точки для базы данных.

  - Время, прошедшее с момента создания файла журнала, должно превышать значение ReplayLagTime + TruncationLagTime.

  - Файл журнала должен быть усечен на активной копии.

Усечение журнала в Exchange 2013 не выполняется для активной копии базы данных почтового ящика при наличии приостановленных пассивных копий. Если действия по обслуживанию выполняются в течение продолжительного периода времени (например, нескольких дней), может быть создано большое количество файлов журнала. Чтобы предотвратить заполнение диска журналов журналами транзакций, можно удалить соответствующую пассивную копию базы данных, а не приостанавливать ее. После выполнения планового обслуживания можно повторно добавить эту пассивную копию базы данных.

В Exchange 2013 с пакетом обновления 1 (SP1) появилась новая функция под названием *свободные усечения*. По умолчанию эта функция отключена. Во время обычных операций в каждой копии базы данных хранятся журналы, которые нужно доставлять в другие копии баз данных до тех пор, пока от каждой из них не будет получено подтверждение преобразования (пассивные копии) или получения (изолированные копии) файлов журналов. Так работает усечение журнала по умолчанию. Если по какой-либо причине копия базы данных становится недоступной, файлы журналов начинают накапливаться на дисках, используемых другими копиями базы данных. Если поврежденная копия базы данных остается недоступной в течение длительного времени, другие копии базы данных могут переполнить диск.

Если включить свободное усечение, оно выполняется по-другому. Каждая копия базы данных отслеживает собственное свободное место на диске и применяет свободное усечение, если свободного места становится мало. Для активной копии игнорируется самая старая "отставшая" копия (пассивная копия базы данных, занимающая последнее место при преобразовании журнала), и усекаются самый старые оставшиеся пассивные копии. Глобальное усечение рассчитывается в активной копии базы данных. Пассивные копии попытаются повлиять на решение относительно усечения активной копии. Несмотря на свое имя (MinCopiesToProtect), Exchange будет игнорировать самую старую известную "отставшую" при запуске усечения. Если останется мало свободного места, то пассивная копия независимо усечет свои файлы журнала, используя настроенные параметры, которые описаны ниже.

Если ранее недоступная база данных снова станет доступной, в ней будут отсутствовать файлы журналов, удаленные из других исправных копий. Ее состояние будет отображаться как FailedAndSuspended (сбой и приостановка). В этом случае, если настроена функция автоматического повторного заполнения, поврежденная копия будет автоматически заполнена данными. Если эта функция не настроена, администратору придется заполнить копию базы данных вручную.

Необходимое количество исправных копий, минимальный порог свободного дискового пространства и число журналов являются настраиваемыми параметрами. По умолчанию порог свободного дискового пространства составляет 204 800 МБ (200 ГБ). Число журналов составляет 100 000 (100 ГБ) для пассивных и 10 000 (10 ГБ) для активных копий.

Включение свободных усечений и настройка их параметров производится путем редактирования реестра Windows для каждого участника группы DAG. Существует три настраиваемых значения реестра. Все они хранятся в разделе HKLM\\Software\\Microsoft\\ExchangeServer\\v15\\BackupInformation. По умолчанию раздела BackupInformation после значений DWORD не существует. Его нужно создать вручную. В следующей таблице описываются значения реестра типа DWORD в разделе BackupInformation.


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Значение реестра</th>
<th>Описание</th>
<th>Значение по умолчанию</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>LooseTruncation_MinCopiesToProtect</p></td>
<td><p>Этот раздел используется для включения свободного усечения. Он представляет собой количество пассивный копий, которые необходимо защитить от свободного усечения в активной копии базы данных. Если присвоить этому ключу значение 0, свободные усечения будут отключены.</p></td>
<td><p>0</p></td>
</tr>
<tr class="even">
<td><p>LooseTruncation_MinDiskFreeSpaceThresholdInMB</p></td>
<td><p>Пороговое значение доступного места на диске (в МБ) для запуска свободных усечений. Если количество свободного места на диске падает ниже этого значения, происходит запуск свободных усечений.</p></td>
<td><p>Если этот параметр реестра не настроен, при свободном усечении используется параметр по умолчанию (200 ГБ).</p></td>
</tr>
<tr class="odd">
<td><p>LooseTruncation_MinLogsToProtect</p></td>
<td><p>Минимальное количество файлов журналов, сохраняемых в работоспособных копиях, к которым применяется усечение. Если данный параметр реестра настроен, его значение применяется к активным и пассивным копиям.</p></td>
<td><p>Если данный параметр реестра не настроен, используются значения по умолчанию (100 000 для пассивных копий базы данных и 10 000 для активных копий базы данных).</p></td>
</tr>
</tbody>
</table>


Обратите внимание, что при использовании параметра реестра LooseTruncation\_MinLogsToProtect с активными и пассивными копиями базы данных выполняются разные действия. Для активной копии базы данных значение данного параметра равно числу дополнительных журналов, которые сохраняются до журналов, необходимых для защищенных пассивных копий и требуемого диапазона активной копии. Для пассивной копии базы данных значение данного параметра равно числу журналов, сохраненных из последнего доступного журнала. Десятая часть данного значения также используется для сохранения журналов перед необходимым диапазоном этой пассивной копии. Два предельных значения заданы, чтобы изолированные копии базы данных не заняли слишком много места, поскольку их диапазон обычно очень большой.

## Политика активации базы данных

В некоторых случаях может потребоваться создать копию базы данных почтовых ящиков и предотвратить автоматическую активацию этой копии в случае сбоя. Ниже приведены примеры.

  - При развертывании одной или нескольких копий базы данных почтовых ящиков в другом центре данных или центре данных, работающем в режиме ожидания.

  - Если настроить отсроченную копию базы данных для целей восстановления.

  - При выполнении обслуживания или обновления сервера.

В каждом из указанных выше сценариев копии базы данных не должны автоматически активироваться системой. Чтобы предотвратить автоматическую активацию копии базы данных почтовых ящиков, можно настроить блокирование (приостановку) активации копии. Это позволяет системе обслуживать текущую базу данных с помощью доставки журнала и преобразования, но предотвращает автоматическую активацию и использование копии. Администратор должен вручную активировать заблокированные для активации копии. Вы можете настроить политику активации базы данных для всего сервера с помощью командлета [Set-MailboxServer](https://technet.microsoft.com/ru-ru/library/aa998651\(v=exchg.150\)) или отдельной копии базы данных с помощью командлета [Set-MailboxDatabaseCopy](https://technet.microsoft.com/ru-ru/library/dd298104\(v=exchg.150\)), чтобы задать для параметра *DatabaseCopyAutoActivationPolicy* значение Blocked.

Дополнительные сведения о настройке политики активации базы данных см. в разделе [Настройка политики активации для копии базы данных почтовых ящиков](configure-activation-policy-for-a-mailbox-database-copy-exchange-2013-help.md).

## Влияние перемещения почтовых ящиков на непрерывную репликацию

В интенсивно используемой базе данных почтовых ящиков с высокой скорость создания журналов шансы на потерю данных выше, если репликация в пассивные копии базы данных не поспевает за созданием журналов. Один из сценариев, при котором возрастает скорость создания журналов, — перемещение почтовых ящиков. Exchange 2013 содержит интерфейс Data Guarantee API, который используется такими службами, как служба репликации почтовых ящиков (MRS) Microsoft Exchange, для проверки работоспособности архитектуры копий базы данных на основе значения параметра *DataMoveReplicationConstraint*, заданного системой или администратором. В частности, Data Guarantee API может использоваться для:

  - **Проверки работоспособности репликации**   Подтверждает, что доступно необходимое число копий базы данных.

  - **Проверка очистки репликации**   Подтверждает, что необходимые файлы журналов были преобразованы для требуемого числа копий базы данных.

При выполнении API-интерфейса он возвращает следующие сведения о состоянии вызывающему приложению:

  - **Retry**   Означает, что есть временные ошибки, не позволяющие проверить базу данных.

  - **Satisfied**   Означает, что база данных соответствует требуемым условиям или не реплицирована.

  - **NotSatisfied**   Означает, что база данных не соответствует требуемым условиям. Кроме того, вызывающему приложению предоставляется информация о причине возврата состояния **NotSatisfied**.

Значение параметра *DataMoveReplicationConstraint* для базы данных почтовых ящиков определяет, сколько копий базы данных следует оценить во время запроса. Параметр *DataMoveReplicationConstraint* имеет следующие значения.

  - `None`   При создании базы данных почтовых ящиков это значение задается по умолчанию. Если задано это значение, условия интерфейса Data Guarantee API игнорируются. Этот параметр следует использовать только для баз данных почтовых ящиков, которые не реплицируются.

  - `SecondCopy`   Это значение по умолчанию при добавлении второй копии базы данных почтовых ящиков. Если задано это значение, по крайней мере одна пассивная копия базы данных должна соответствовать условиям Data Guarantee API.

  - `SecondDatacenter` Если задано это значение, по крайней мере одна пассивная копия базы данных на другом сайте Active Directory должна соответствовать условиям Data Guarantee API.

  - `AllDatacenters` Если задано это значение, по крайней мере одна пассивная копия базы данных на каждом сайте Active Directory должна соответствовать условиям Data Guarantee API.

  - `AllCopies`   Если задано это значение, все копии базы данных должны соответствовать условиям Data Guarantee API.

**Проверка работоспособности репликации**

При выполнении Data Guarantee API для оценки работоспособности инфраструктуры копий баз данных, оцениваются несколько элементов.


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Если для параметра <em>DataMoveReplicationConstraint</em> задано значение...</th>
<th>То для этой базы данных...</th>
<th>Условия</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><code>SecondCopy</code></p></td>
<td><p>По крайней мере одна пассивная копия реплицированной базы данных должна соответствовать условиям в следующем столбце.</p></td>
<td><p>Пассивная копия базы данных должна:</p>
<ul>
<li><p>быть работоспособной;</p></li>
<li><p>содержать очередь преобразования в течение 10 минут времени задержки преобразования;</p></li>
<li><p>использовать очередь копирования длиной не менее 10 журналов;</p></li>
<li><p>использовать среднюю очередь копирования длиной не менее 10 журналов. Средняя длина очереди копирования вычисляется на основе количества запросов состояния базы данных приложением.</p></li>
</ul></td>
</tr>
<tr class="even">
<td><p><code>SecondDatacenter</code></p></td>
<td><p>По крайней мере одна пассивная копия на другом сайте Active Directory должна соответствовать условиям в следующем столбце.</p></td>
<td></td>
</tr>
<tr class="odd">
<td><p><code>AllDatacenters</code></p></td>
<td><p>Активную копию необходимо подключить, а пассивная копия на каждом сайте Active Directory должна соответствовать условиям в следующем столбце.</p></td>
<td></td>
</tr>
<tr class="even">
<td><p><code>AllCopies</code></p></td>
<td><p>Активную копию необходимо подключить, а все пассивные копии базы данных должны соответствовать условиям в следующем столбце.</p></td>
<td></td>
</tr>
</tbody>
</table>


**Проверка очистки репликации**

Data Guarantee API также можно использовать для проверки того, что требуемое число копий базы данных преобразовали необходимые журналы транзакций. Это делается за счет сравнения метки времени последнего преобразованного журнала с меткой времени вызывающей службы (в большинстве случаев это метка времени последнего файла журнала, который содержит необходимые данные), плюс дополнительные пять секунд (для учета рассогласования системного времени). Если метка времени преобразования больше метки времени применения, условие параметра *DataMoveReplicationConstraint* удовлетворяется. Если метка времени преобразования меньше метки времени применения, условие *DataMoveReplicationConstraint* не удовлетворяется.

Перед перемещением большого числа почтовых ящиков в базы данных репликации или из них в DAG рекомендуется настроить параметр *DataMoveReplicationConstraint* в каждой базе данных почтовых ящиков в соответствии со следующими условиями:


<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Если вы развертываете...</th>
<th>Задайте для DataMoveReplicationConstraint значение…</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Базы данных почтовых ящиков, которые не имеют каких-либо копий базы данных</p></td>
<td><p><code>None</code></p></td>
</tr>
<tr class="even">
<td><p>Группа обеспечения доступности баз данных в пределах одного сайта Active Directory</p></td>
<td><p><code>SecondCopy</code></p></td>
</tr>
<tr class="odd">
<td><p>Группа обеспечения доступности баз данных в нескольких центрах обработки данных с использование распределенного сайта Active Directory</p></td>
<td><p><code>SecondCopy</code></p></td>
</tr>
<tr class="even">
<td><p>Группа обеспечения доступности баз данных, которая распределена среди двух сайтов Active Directory, на каждом сайте будут копии базы данных с высокой доступностью</p></td>
<td><p><code>SecondDatacenter</code></p></td>
</tr>
<tr class="odd">
<td><p>Группа обеспечения доступности баз данных, которая распределена среди двух сайтов Active Directory. На втором сайте у вас будут только изолированные копии базы данных</p></td>
<td><p><code>SecondCopy</code></p>
<p>Это связано с тем, что Data Guarantee API не гарантирует фиксирование данных до воспроизведения файла журнала в копии базы данных и вследствие природы изолированной копии базы данных это ограничение не позволит выполнить запрос на перемещение, если значение ReplayLagTime этой изолированной копии базы данных меньше 30 минут.</p></td>
</tr>
<tr class="even">
<td><p>Группа обеспечения доступности баз данных, которая распределена среди трех или большего числа сайтов Active Directory, при этом каждый сайт будет содержать копии базы данных с высокой доступностью</p></td>
<td><p><code>AllDatacenters</code></p></td>
</tr>
</tbody>
</table>


## Балансировка копий баз данных

Следствием самой структуры групп обеспечения доступности баз данных (DAG) и результатом переключений базы данных и отработок отказа в них является то, что для активных копий базы данных почтовых ящиков узлы размещения будут меняться несколько раз в течение времени жизни группы DAG. В итоге, группы DAG становятся несбалансированными с точки зрения распределения активных копий базы данных почтовых ящиков. В следующей таблице приводится пример группы DAG, в которой имеются четыре базы данных с четырьмя копиями каждой из них (всего 16 баз данных на каждом сервере) с неравномерным распределением активных копий баз данных.

### Группа DAG с несбалансированным распределением активных копий

<table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th>Сервер</th>
<th>Количество активных баз данных</th>
<th>Количество пассивных баз данных</th>
<th>Количество подключенных баз данных</th>
<th>Количество отключенных баз данных</th>
<th>Список для подсчета приоритетов</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>EX1</p></td>
<td><p>5</p></td>
<td><p>11</p></td>
<td><p>5</p></td>
<td><p>0</p></td>
<td><p>4, 4, 3, 5</p></td>
</tr>
<tr class="even">
<td><p>EX2</p></td>
<td><p>1</p></td>
<td><p>15</p></td>
<td><p>1</p></td>
<td><p>0</p></td>
<td><p>1, 8, 6, 1</p></td>
</tr>
<tr class="odd">
<td><p>EX3</p></td>
<td><p>12</p></td>
<td><p>4</p></td>
<td><p>12</p></td>
<td><p>0</p></td>
<td><p>13, 2, 1, 0</p></td>
</tr>
<tr class="even">
<td><p>EX4</p></td>
<td><p>1</p></td>
<td><p>15</p></td>
<td><p>1</p></td>
<td><p>0</p></td>
<td><p>1, 1, 5, 9</p></td>
</tr>
</tbody>
</table>


В предыдущем примере для каждой базы данных существует четыре копии, и поэтому возможно только четыре значения для приоритета активации (1, 2, 3 или 4). В столбце **Список для подсчета приоритетов** приводится подсчет числа баз данных с каждым из этих значений. Например, на сервере EX3 имеется 13 копий баз данных с приоритетом активации 1, две копии с приоритетом 2, одна копия с приоритетом 3 и ни одной копии с приоритетом 4.

Как можно видеть, эта группа обеспечения доступности баз данных не сбалансирована с точки зрения количества активных баз данных или количества пассивных баз данных, размещаемых каждым членом такой группы, либо подсчета приоритетов активации для размещенных баз данных.

Вы можете использовать скрипт RedistributeActiveDatabases.ps1 для балансировки копий баз данных почтовых ящиков в группе обеспечения доступности баз данных. В этом сценарии базы данных перемещаются между своими копиями с целью попытки получения равных количеств подключенных баз данных на каждом сервере в группе DAG. При необходимости также выполняется попытка балансировки активных баз данных по сайтам.

В этом сценарии имеется два параметра для балансировки активных копий баз данных в группе DAG.

  - **BalanceDbsByActivationPreference**   При указании данного параметра в сценарии производится попытка переместить базы данных в их наиболее предпочтительную копию (на основе приоритета активации) безотносительно сайта Active Directory.

  - **BalanceDbsBySiteAndActivationPreference**   При указании этого параметра в сценарии производится попытка переместить активные базы данных в их наиболее предпочтительную копию, а также сбалансировать активные базы данных в пределах каждого сайта Active Directory.

После запуска сценария с первым параметром предыдущая несбалансированная группа DAG становится сбалансированной, как показано в следующей таблице.

### Группа DAG со сбалансированным распределением активных копий

<table style="width:100%;">
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th>Сервер</th>
<th>Количество активных баз данных</th>
<th>Количество пассивных баз данных</th>
<th>Количество подключенных баз данных</th>
<th>Количество отключенных баз данных</th>
<th>Список для подсчета приоритетов</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>EX1</p></td>
<td><p>4</p></td>
<td><p>12</p></td>
<td><p>4</p></td>
<td><p>0</p></td>
<td><p>4, 4, 4, 4</p></td>
</tr>
<tr class="even">
<td><p>EX2</p></td>
<td><p>4</p></td>
<td><p>12</p></td>
<td><p>4</p></td>
<td><p>0</p></td>
<td><p>4, 4, 4, 4</p></td>
</tr>
<tr class="odd">
<td><p>EX3</p></td>
<td><p>4</p></td>
<td><p>12</p></td>
<td><p>4</p></td>
<td><p>0</p></td>
<td><p>4, 4, 4, 4</p></td>
</tr>
<tr class="even">
<td><p>EX4</p></td>
<td><p>4</p></td>
<td><p>12</p></td>
<td><p>4</p></td>
<td><p>0</p></td>
<td><p>4, 4, 4, 4</p></td>
</tr>
</tbody>
</table>


Как показано выше, эта группа DAG теперь сбалансирована с точки зрения количества активных и пассивных баз данных на каждом сервере и приоритетов активации по серверам.

В следующей таблице перечислены параметры скрипта RedistributeActiveDatabases.ps1.

### Параметры сценария RedistributeActiveDatabases.ps1

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><em>DagName</em></p></td>
<td><p>Указывает имя группы DAG, которую необходимо сбалансировать. Если этот параметр не указан, будет использоваться та группа обеспечения доступности баз данных, членом которой является данный локальный сервер.</p></td>
</tr>
<tr class="even">
<td><p><em>BalanceDbsByActivationPreference</em></p></td>
<td><p>Указывает, что согласно сценарию базы данных должны перемещаться в их наиболее предпочтительную копию безотносительно сайта Active Directory.</p></td>
</tr>
<tr class="odd">
<td><p><em>BalanceDbsBySiteAndActivationPreference</em></p></td>
<td><p>При указании этого параметра в сценарии производится попытка переместить активные базы данных в их наиболее предпочтительную копию, а также сбалансировать активные базы данных в пределах каждого сайта Active Directory.</p></td>
</tr>
<tr class="even">
<td><p><em>ShowFinalDatabaseDistribution</em></p></td>
<td><p>Указывает, что отчет по распределению текущей базы данных должен отображаться после перераспределения.</p></td>
</tr>
<tr class="odd">
<td><p><em>AllowedDeviationFromMeanPercentage</em></p></td>
<td><p>Указывает допустимую вариацию активных баз данных по сайтам, выраженную в процентах. Значение по умолчанию — 20 %. Например, если между тремя сайтами было распределено 99 баз данных, то идеальным распределением будет по 33 базы данных на каждом сайте. Если допустимое отклонение составляет 20 %, то при выполнении сценария будет производиться попытка сбалансировать базы данных таким образом, чтобы количество баз данных на каждом сайте отклонялось не более чем на 10 % в ту или другую сторону от этого значения. 10 % от 33 составляют 3,3, это значение можно округлить до 4. Следовательно, в результате выполнения сценария на каждом сайте будет от 29 до 37 баз данных.</p></td>
</tr>
<tr class="even">
<td><p><em>ShowDatabaseCurrentActives</em></p></td>
<td><p>Указывает, что в сценарии необходимо создать отчет для каждой базы данных с подробными сведениями о том, как перемещалась база данных и является ли она теперь активной в своей наиболее предпочтительной копии.</p></td>
</tr>
<tr class="odd">
<td><p><em>ShowDatabaseDistributionByServer</em></p></td>
<td><p>Указывает, что в сценарии необходимо создать отчет для каждого сервера со сведениями о распределении базы данных на нем.</p></td>
</tr>
<tr class="even">
<td><p><em>RunOnlyOnPAM</em></p></td>
<td><p>Указывает, что сценарий должен выполняться только для того члена группы DAG, который имеет роль диспетчера PAM. В сценарии в таком случае проверяется, происходит ли его запуск из диспетчера PAM. Если это условие не выполнено, то происходит выход из сценария.</p></td>
</tr>
<tr class="odd">
<td><p><em>LogEvents</em></p></td>
<td><p>Указывает, что в процессе выполнения сценария необходимо внести в журнал событие 4115 (MsExchangeRepl) со сводкой по действиям.</p></td>
</tr>
<tr class="even">
<td><p><em>IncludeNonReplicatedDatabases</em></p></td>
<td><p>Указывает, что в сценарий во время определения способа перераспределения активных баз данных необходимо включить нереплицированные базы данных (базы данных без копий). Несмотря на то что нереплицированные базы данных перемещать невозможно, они могут влиять на распределение реплицированных баз данных.</p></td>
</tr>
<tr class="odd">
<td><p><em>Confirm</em></p></td>
<td><p>Переключатель Confirm можно использовать для отключения запросов на подтверждение, которые отображаются по умолчанию при запуске этого скрипта. Чтобы отключить запросы на подтверждение, используйте синтаксис -Confirm:$False. В синтаксисе необходимо использовать двоеточие ( : ).</p></td>
</tr>
</tbody>
</table>


## Примеры RedistributeActiveDatabases.ps1

В этом примере показано распределение текущей базы данных для группы DAG, в том числе список для подсчета приоритетов.

    RedistributeActiveDatabases.ps1 -DagName DAG1 -ShowDatabaseDistributionByServer | Format-Table

Этот пример выполняет повторное распределение и балансировку активных копий базы данных почтовых ящиков в группе доступности с использованием предпочтений активации без запроса на ввода данных.

    RedistributeActiveDatabases.ps1 -DagName DAG1 -BalanceDbsByActivationPreference -Confirm:$False

В этом примере выполняется перераспределение и балансировка активных копий базы данных почтовых ящиков в группе DAG с учетом приоритетов активации, а также формируется сводка по процессу распределения.

    RedistributeActiveDatabases.ps1 -DagName DAG1 -BalanceDbsByActivationPreference -ShowFinalDatabaseDistribution

## Копии базы данных мониторинга

Копия базы данных является первой защитой при сбое, влияющем на активную копию базы данных. Поэтому необходимо отслеживать работоспособность и состояние копий базы данных, чтобы убедиться, что они будут доступны при необходимости. Можно просмотреть различные сведения, в том числе длину очереди копирования, длину очереди преобразования, состояние и информацию о состоянии индекса контента, изучив сведения о копии базы данных в центре администрирования Exchange. Также можно использовать командлет **Get-MailboxDatabaseCopyStatus** для просмотра различных сведений о состоянии копии базы данных.

Дополнительные сведения об отслеживании копий базы данных см. в разделе [Наблюдение за группами обеспечения доступности баз данных](monitoring-database-availability-groups-exchange-2013-help.md).

## Удаление копии базы данных

Копию базы данных можно удалить в любой момент с помощью EAC или командлета **Remove-MailboxDatabaseCopy** в командной консоли Exchange. После удаления копии базы данных необходимо вручную удалить все файлы журнала базы данных и транзакций на сервере, с которого удалена база данных. Подробное описание действий по удалению копии базы данных см. в разделе [Удаление копии базы данных почтовых ящиков](remove-a-mailbox-database-copy-exchange-2013-help.md).

## Переключения базы данных.

Сервер почтовых ящиков, на котором размещена активная копия базы данных, является хозяином базы данных почтовых ящиков. В процессе активации пассивной копии базы данных изменяется хозяин базы данных почтовых ящиков и пассивная копия преобразуется в новую активную копию. Этот процесс называется переключением базы данных. При переключении базы данных активная копия базы данных отключается на одном сервере почтовых ящиков, а пассивная копия этой базы данных подключается в качестве новой активной базы данных почтовых ящиков на другом сервере почтовых ящиков. При выполнении переключения можно также переопределить параметр подключения базы данных на новом хозяине базы данных почтовых ящиков.

Можно быстро определить, какой сервер почтовых ящиков является текущим хозяином базы данных почтовых ящиков. Для этого необходимо просмотреть правый столбец на вкладке **Копии базы данных** в центре администрирования Exchange. Переключение можно выполнить с помощью ссылки **Активировать** в EAC или с помощью командлета **Move-ActiveMailboxDatabase** в командной консоли Exchange.

Перед активацией пассивной копии будет выполнено несколько внутренних проверок.

  - Выполняется проверка состояния копии базы данных. Если копия базы данных находится в состоянии сбоя, переключение будет заблокировано. Такое поведение можно переопределить и обойти проверку работоспособности с помощью параметра *SkipHealthChecks* командлета **Move-ActiveMailboxDatabase**. Этот параметр позволяет переместить активную копию в копию базы данных в состоянии сбоя.

  - Проверяется, является ли активная копия базы данных источником заполнения каких-либо пассивных копий базы данных. Если активная копия в данный момент используется как источник для заполнения, переключение блокируется. Такое поведение можно переопределить и обойти проверку источника заполнения с помощью параметра *SkipActiveCopyChecks* командлета **Move-ActiveMailboxDatabase**. Этот параметр позволяет переместить активную копию, используемую как источник заполнения. При применении этого параметра заполнение будет отменено и будет считаться неудачным.

  - Выполняется проверка значений длины очереди копирования и очереди преобразования копии базы данных на нахождение в пределах заданных критериев. Также выполняется проверка того, используется ли копия базы данных в качестве источника для заполнения. Если значения длины очередей не соответствуют заданным критериям или база данных является источником заполнения, переключение будет заблокировано. Такое поведение можно переопределить и обойти эти проверки с помощью параметра *SkipLagChecks* командлета **Move-ActiveMailboxDatabase**. Этот параметр позволяет активировать копии, которые имеют значения очередей преобразования и копирования за пределами настроенных критериев.

  - Выполняется проверка состояния каталога поиска (индексов содержимого) для копии базы данных. Если каталог поиска устарел, неисправен или поврежден, переключение будет заблокировано. Такое поведение можно переопределить и обойти проверку каталога поиска с помощью параметра *SkipClientExperienceChecks* командлета **Move-ActiveMailboxDatabase**. Этот параметр позволяет пропустить проверку работоспособности каталога поиска. Если каталог поиска для активируемой копии базы данных неисправен или нестабилен, и этот параметр используется для пропуска проверки работоспособности каталога и активации копии базы данных, необходимо повторно сканировать или заполнить каталог поиска.

При выполнении переключения базы данных можно также переопределить параметры подключения, настроенные для сервера, содержащего пассивную копию базы данных, которую необходимо активировать. При использовании параметра *MountDialOverride* командлета **Move-ActiveMailboxDatabase** целевой сервер переопределит собственные параметры подключения и будет использовать настройки, указанные в параметре *MountDialOverride*.

Дополнительные сведения о переключении копии базы данных см. в разделе [Активация копии базы данных почтовых ящиков](activate-a-mailbox-database-copy-exchange-2013-help.md).

