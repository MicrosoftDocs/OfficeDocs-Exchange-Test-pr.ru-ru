---
title: 'Теневая избыточность: Exchange 2013 Help'
TOCTitle: Теневая избыточность
ms:assetid: a40dbe61-2a18-48a8-b2e0-4e81a6678d11
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Dd351027(v=EXCHG.150)
ms:contentKeyID: 50488799
ms.date: 04/30/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# Теневая избыточность

 

_**Применимо к:**Exchange Server 2013_

_**Последнее изменение раздела:**2015-03-09_

Теневая избыточность была введена в Microsoft Exchange Server 2010 для того, чтобы обеспечить избыточное копирование сообщений прежде, чем они будут доставлены в почтовые ящики. В Exchange 2010 теневая избыточность задерживала удаление сообщения из транспортной базы данных на транспортном сервере, пока сервер не убедится, что очередной скачок в пути доставки сообщений завершил доставку. Если следующий скачок терпел неудачу прежде, чем сообщить об успешной доставке на транспортный сервер, транспортный сервер повторно отправлял сообщение на следующий скачок. Серверы Exchange 2010 серверы использовали глагол XSHADOW, чтобы сообщать о поддержке теневой избыточности. Если сервер SMTP не поддерживал теневую избыточность, Exchange 2010 использовал отсроченное подтверждение, основанное на настроенном временном интервале на соединителе получения, чтобы создать избыточную копию сообщения.

Крупное усовершенствование теневой избыточности в Microsoft Exchange Server 2013 заключается в том, что транспортный сервер теперь создает избыточную копию любых сообщений, которые он получает, прежде чем подтверждать успешное получение сообщения для отправившего сервера. Наличие или отсутствие поддержки теневой избыточности на отправляющем сервере не имеют значения. Это помогает гарантировать, что все сообщения в транспортном конвейере Exchange 2013 станут избыточными при передаче. Если Exchange 2013 решает, что исходное сообщение потеряно в пути, будет повторно доставлена избыточная копия сообщения.

**Содержание**

Компоненты теневой избыточности

Требования для теневой избыточности

Теневая избыточность по умолчанию включена

Как создаются теневые сообщения

Тайм-ауты SMTP

Как хранятся теневые сообщения

Обработка сообщений после простоя

## Компоненты теневой избыточности

В следующей таблице описаны компоненты теневой избыточности. Эти термины используются всюду в данном разделе.


<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Термин</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Транспортный сервер</p></td>
<td><p>Сервер Exchange Server, который имеет очереди сообщений и отвечает за маршрутизацию сообщений. В Exchange 2013 транспортный сервер — сервер почтовых ящиков (транспортная служба на сервере почтовых ящиков).</p></td>
</tr>
<tr class="even">
<td><p>База данных транспорта</p></td>
<td><p>База данных очереди сообщений на транспортном сервере Exchange 2013. Теневые очереди и система безопасности также хранятся в базе данных транспорта.</p></td>
</tr>
<tr class="odd">
<td><p>Граница высокой доступности транспорта</p></td>
<td><p>Группа обеспечения доступности баз данных (DAG) в средах с DAG, или сайт в Active Directory в среде без DAG. Когда сообщение прибывает на транспортный сервер в границе высокой доступности, Exchange пытается поддерживать 2 избыточных копии сообщения на транспортных серверах в пределах границы. Когда сообщение выходит за границу высокой доступности, Exchange прекращает поддерживать избыточные копии сообщения.</p></td>
</tr>
<tr class="even">
<td><p>Основное сообщение</p></td>
<td><p>Сообщение, отправленное в транспортный конвейер для доставки.</p></td>
</tr>
<tr class="odd">
<td><p>Теневое сообщение</p></td>
<td><p>Избыточная копия сообщения, которую теневой сервер сохраняет, пока не убедится, что основное сообщение было успешно обработано основным сервером.</p></td>
</tr>
<tr class="even">
<td><p>Основной сервер</p></td>
<td><p>Транспортный сервер, который в настоящее время обрабатывает основное сообщение.</p></td>
</tr>
<tr class="odd">
<td><p>Теневой сервер</p></td>
<td><p>Транспортный сервер, хранящий теневое сообщение для основного сервера. Транспортный сервер может одновременно быть основным сервером для некоторых сообщений и теневым сервером для других сообщений.</p></td>
</tr>
<tr class="even">
<td><p>Теневая очередь</p></td>
<td><p>Очередь доставки, где теневой сервер хранит теневые сообщения. Для сообщений с несколькими получателями каждый следующий прыжок для основного сообщения требует отдельной теневой очереди.</p></td>
</tr>
<tr class="odd">
<td><p>Состояние удаления</p></td>
<td><p>Информация, которую транспортный сервер поддерживает для теневых сообщений, указывающая на то, что основное сообщение было успешно обработано.</p></td>
</tr>
<tr class="even">
<td><p>Уведомление об удалении</p></td>
<td><p>Ответ, который теневой сервер получает от основного сервера, и который указывает, что теневое сообщение готово к отклонению.</p></td>
</tr>
<tr class="odd">
<td><p>Система безопасности</p></td>
<td><p>Улучшенная версия транспортной корзины в Exchange 2013. Сообщения, которые были успешно обработаны или доставлены в почтовый ящик получателя транспортной службой на сервере почтовых ящиков, перемещаются в систему безопасности. Подробнее см. в разделе <a href="safety-net-exchange-2013-help.md">Система безопасности</a>.</p></td>
</tr>
<tr class="even">
<td><p>Диспетчер теневой избыточности</p></td>
<td><p>Компонент транспорта, управляющий теневой избыточностью.</p></td>
</tr>
<tr class="odd">
<td><p>Пульс</p></td>
<td><p>Процесс, который позволяет основным серверам и теневым серверам проверять доступность друг друга.</p></td>
</tr>
</tbody>
</table>


В начало

## Требования для теневой избыточности

Хотя это может казаться очевидным, теневая избыточность требует наличия нескольких серверов почтовых ящиков Exchange 2013. Сервер почтовых ящиков может быть автономным, или же серверы почтовых ящиков и серверы клиентского доступа могут быть установлены на одном компьютере.

  - Если сервер почтовых ящиков — не член DAG, другие серверы почтовых ящиков должны находиться в локальном сайте Active Directory.

  - Если сервер почтовых ящиков — член DAG, другие серверы почтовых ящиков должны принадлежать к той же самой DAG. Другие серверы почтовых ящиков, которые принадлежат DAG, могут находиться в локальном или удаленном сайте Active Directory. Если DAG охватывает несколько сайтов Active Directory, теневая избыточность предпочитает создавать избыточные копии сообщений в удаленном сайте Active Directory для обеспечения устойчивости.

Ситуации, в которых системе теневой избыточности не удается защитить передаваемые сообщения:

  - В односерверной среде Exchange.

  - В DAG, где не закончена подготовка.

  - При одновременном отказе двух или больше транспортных серверов, вовлеченных в обеспечение теневой избыточности сообщений.

В начало

## Теневая избыточность по умолчанию включена

По умолчанию теневая избыточность включается глобально в транспортной службе на всех серверах почтовых ящиков при использовании параметра *ShadowRedundancyEnabled* командлета **Set-TransportConfig**. По умолчанию, если транспортная служба на сервере не может создать избыточную копию сообщения, сообщение не отклоняется. При этом в Exchange 2013 можно настроить отклонение сообщений, если избыточная копия сообщения не была создана, при использовании параметра *RejectMessageOnShadowFailure* командлета **Set-TransportConfig**. Сообщение отклоняется с указанием временного сбоя, но отправляющий сервер может передать сообщение снова. Код ответа SMTP — `451 4.4.0 Message failed to be made redundant.`. Настраивать в Exchange 2013 отклонение сообщений, которые не могут быть сделаны избыточными, следует только тогда, когда в вашей организации есть несколько серверов почтовых ящиков Exchange 2013.

В следующей таблице описаны параметры, которые позволяют использовать теневую избыточность.

### Параметры, которые позволяют использовать теневую избыточность

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Параметр</th>
<th>Значение по умолчанию</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><em>ShadowRedundancyEnabled</em> по <strong>Set-TransportConfig</strong></p></td>
<td><p><code>$true</code></p></td>
<td><ul>
<li><p><code>$true</code> включает теневую избыточность на всех транспортных серверах в организации.</p></li>
<li><p><code>$false</code> выключает теневую избыточность на всех транспортных серверах в организации.</p></li>
</ul></td>
</tr>
<tr class="even">
<td><p><em>RejectMessageOnShadowFailure</em> по <strong>Set-TransportConfig</strong></p></td>
<td><p><code>$false</code></p></td>
<td><ul>
<li><p><code>$false</code>   Когда теневая копия сообщения не может быть создана, основное сообщение будет принято транспортными серверами в организации. Эти сообщения не сохраняются избыточно, пока находятся в пути.</p></li>
<li><p><code>$true</code>   Никакое сообщение не будет принято или подтверждено каким-либо транспортным сервером в организации, пока не будет успешно создана теневая копия сообщения. Если теневая копия сообщения не может быть создана, основное сообщение будет отклонено с временной ошибкой. Все сообщения в организации избыточно сохраняются, пока находятся в пути.</p>
<p>Задавать значение <code>$true</code> следует только если у вас есть несколько серверов почтовых ящиков Exchange 2013 в DAG или сайте Active Directory, где может быть создана теневая копия сообщения.</p></li>
</ul>
<p>Этот параметр имеет смысл, только если <em>ShadowRedundancyEnabled</em> равняется <code>$true</code>.</p></td>
</tr>
</tbody>
</table>


В начало

## Как создаются теневые сообщения

Главная цель теневой избыточности состоит в том, чтобы всегда поддерживать две копии сообщения в пределах границы высокой доступности транспорта, пока сообщение в пути. То, где и когда избыточная копия сообщения будет создана, зависит от того, откуда сообщение прибыло и куда оно идет. Существует три основных определяющих фактора:

  - Сообщения, полученные из-за границы высокой доступности транспорта.

  - Сообщения, отправленные за пределы границы высокой доступности транспорта.

  - Сообщения, полученные от службы отправки транспорта почтовых ящиков с сервера почтовых ящиков в пределах границы высокой доступности.

*Граница высокой доступности транспорта* — одна из следующих сущностей:

  - DAG — для серверов почтовых ящиков, которые являются членами DAG. Сюда относятся группы DAG, которые охватывают несколько сайтов Active Directory.

  - Сайт Active Directory — для серверов почтовых ящиков, которые не принадлежат к DAG.

Теневая избыточность никогда не отслеживает теневые сообщения через границу высокой доступности транспорта. Когда сообщение пересекает границу высокой доступности, теневая избыточность запускается или перезапускается. Это уменьшает трафик и предотвращает повторную отправку теневых сообщений через границу высокой доступности транспорта. Транспортные серверы-концентраторы Exchange 2010 являются особым случаем, который обсуждается позже в этом разделе.

## Сообщения, полученные из-за границы высокой доступности транспорта

Когда служба транспорта на Exchange 2013 получает от сервера почтовых ящиков сообщение извне границы высокой доступности транспорта, то на этом сервере почтовых ящиков не важно наличие поддержки теневой избыточности на отправляющем сервере. Пока теневая избыточность включена, почтовый сервер, принимающий сообщения, создает резервные копии на другом сервере почтовых ящиков в пределах границы высокой доступности транспорта перед подтверждением получения сообщения обратно на отправляющий сервер. Вот пример того, как этот процесс работает:

![Создание теневых сообщений](images/Dd351027.a97d383b-6ae4-458d-af3a-1ac0a41cd52b(EXCHG.150).gif "Создание теневых сообщений")

1.  Сервер SMTP передает сообщение в службу транспорта на сервере почтовых ящиков. Сервер почтовых ящиков является основным сервером, и сообщение — основное.

2.  Во время сеанса SMTP, если исходный сервер SMTP еще активен, служба транспорта на основном сервере открывает новый, параллельный сеанс SMTP с транспортной службой на другом сервере почтовых ящиков в организации, чтобы создать резервные копии.
    
      - Если основной сервер входит в группу обеспечения доступности баз данных, основной сервер подключается к другому серверу почтовых ящиков в той же группе обеспечения доступности баз данных. Если группа обеспечения доступности баз данных распространяется на несколько сайтов Active Directory, сервер почтовых ящиков в другом сайте Active Directory является предпочтительным по умолчанию. Этот параметр контролируется параметром *ShadowMessagePreference* командлета **Set-TransportService**. Значением по умолчанию является `PreferRemote`, но вы можете изменить его на `RemoteOnly` или `LocalOnly`.
    
      - Если основной сервер не является участником группы DAG, основной сервер подключается к другому серверу почтовых ящиков в том же сайте Active Directory независимо от значения параметра *ShadowMessagePreference*.

3.  Основной сервер передает копии сообщения на службе транспорта другого сервера почтовых ящиков, а служба транспорта на другом сервере почтовых ящиков подтверждает, что копия сообщения была успешно создана. Копия сообщения является теневым сообщением, и сервер почтовых ящиков, на котором она находится, — это теневой сервер по отношению к основному. Сообщение существует в теневой очереди на теневом сервере.

4.  После того как первичный сервер получает подтверждение от теневого сервера, основной сервер подтверждает получение сообщения для исходного сервера SMTP в исходном сеансе SMTP, и сеанс SMTP будет закрыт.

## Сообщения, отправленные за пределы границы высокой доступности транспорта

Когда транспортный сервер Exchange 2013 передает сообщение за границу высокой доступности транспорта, сервер SMTP на другой стороне подтверждает успешное получение сообщения, транспортный сервер перемещает это сообщение в систему безопасности. Повторная отправка сообщения из системы не может выполняться, если основное сообщение было успешно передано за границу высокой доступности транспорта. Дополнительные сведения о системе безопасности см. в разделе [Система безопасности](safety-net-exchange-2013-help.md).

## Сообщения, передаваемые в рамках границ высокой доступности транспорта

Маршрутизация сообщений оптимизирована в Exchange 2013. Если конечный пункт назначения находится в DAG или сайте Active Directory, несколько прыжков между службами транспорта на серверах почтовых ящиков в DAG или сайте Active Directory обычно не требуются. Когда сообщение принимается службой транспорта на сервере почтовых ящиков в группе обеспечения доступности баз данных или сайте Active Directory, где находится конечное место назначения сообщения, следующим прыжком для сообщения обычно будет непосредственно конечное назначение. Задача теневой избыточности — сохранение двух копий сообщения при передаче — считается выполненной, если одна теневая копия существует в группе DAG или сайте Active Directory. Как правило, несколько переходов в пределах границы высокой доступности транспорта требуется только в режиме переключения при отказе в группе DAG, требующей командлет **Redirect-Message** для очистки активных очередей на сервере почтовых ящиков.

## Теневая избыточность с транспортными серверами-концентраторами Exchange 2010 в одном сайте Active Directory

Когда транспортный сервер-концентратор Exchange 2010 передает сообщение на сервер почтовых ящиков Exchange 2013 в том же сайте Active Directory, транспортный сервер-концентратор Exchange 2010 объявляет о поддержке теневой избыточности с помощью команды XSHADOW, но сам сервер почтовых ящиков не объявляет о ней. Это мешает транспортному серверу-концентратору Exchange 2010 создать теневую копию этого сообщения на сервере почтовых ящиков Exchange 2013.

Когда служба транспорта на сервере почтовых ящиков Exchange 2013 передает сообщение на транспортный сервер-концентратор Exchange 2010 в том же сайте Active Directory, сервер почтовых ящиков Exchange 2013 хранит теневую копию сообщения для транспортного сервера-концентратора Exchange 2010. Когда сервер почтовых ящиков Exchange 2013 получает подтверждение от транспортного сервера-концентратора Exchange 2010, гласящее, что сообщение было успешно получено, сервер почтовых ящиков Exchange 2013 перемещается успешно обработанное сообщение в систему безопасности. Тем не менее успешно обработанные сообщения, которые хранятся в системе безопасности сервера почтовых ящиков Exchange 2013, никогда не будет вновь отправлены на транспортный сервер-концентратор Exchange 2010.

В начало

## Тайм-ауты SMTP

В течение попытки создания резервной копии сообщения SMTP-соединение между передающим и основным SMTP-сервером либо сеанс SMTP между основным и теневым серверами могут прерываться. Соединители получения и соединители отправки имеют параметр *ConnectionInactivityTimeOut*, указывающий на фактическую передачу данных через соединитель. Соединители получения также имеют абсолютный параметр *ConnectionTimeOut*.

Если сеанс SMTP завершается по тайм-ауту до того, как теневая копия сообщения будет успешно создана и подтверждена, результат контролируется параметром *RejectMessageOnShadowFailure* командлета **Set-TransportConfig**. По умолчанию значение этого параметра равно `$false`, что означает, что основное сообщение принято без создания теневой копии. Если этот параметр имеет значение `$true`, основное сообщение отклоняется с временной ошибкой `451 4.4.0`.

Если теневая копия сообщения успешно создана, но сеанс SMTP между отправляющим SMTP-сервером и основным сервером прерывается по тайм-ауту, основной сервер принимает и обрабатывает основное сообщение. Отправляющий SMTP-сервер повторно доставит неподтвержденное сообщение, но обнаружение повторяющихся сообщений не позволит пользователям почтовых ящиков Exchange увидеть повторяющиеся сообщения. Когда отправляющий SMTP-сервер передает сообщение повторно, основной сервер создаст другую теневую копию сообщения. Связь между теневыми сообщениями, созданными во время отправки сообщений с отправляющего SMTP-сервера, отсутствует.

В следующей таблице описываются параметры создания теневых сообщений

### Параметры создания теневых сообщений

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Источник</th>
<th>Значение по умолчанию</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><em>ShadowMessagePreferenceSetting</em> по <strong>Set-TransportConfig</strong></p></td>
<td><p><code>PreferRemote</code></p></td>
<td><ul>
<li><p><code>PreferRemote</code>   Попытка создать теневую копию этого сообщения на сервере почтовых ящиков в другом сайте Active Directory. Если это не удается сделать, производится попытка создать теневую копию этого сообщения на сервере в локальном сайте Active Directory.</p></li>
<li><p><code>LocalOnly</code>   Создать теневую копию сообщения можно на транспортном сервере в локальном сайте Active Directory.</p></li>
<li><p><code>RemoteOnly</code>: Создать теневую копию сообщения можно на транспортном сервере в другом сайте Active Directory.</p></li>
</ul>
<p>Этот параметр имеет смысл только в случае, когда основной сервер,который пытается создать теневую копию этого сообщения, является сервером почтовых ящиков, входящим в группу DAG, охватывающую несколько сайтов Active Directory.</p></td>
</tr>
<tr class="even">
<td><p><em>MaxRetriesForRemoteSiteShadow</em> по <strong>Set-TransportConfig</strong></p></td>
<td><p>4</p></td>
<td><p>Этот параметр используется, если сервер почтовых ящиков является членом группы обеспечения доступности баз данных, охватывающую несколько сайтов Active Directory.</p>
<ul>
<li><p>Если значение <em>ShadowMessagePreferenceSetting</em> равно <code>PreferRemote</code>, сначала сервер почтовых ящиков пытается создать теневую копию сообщения на другом сервере почтовых ящиков на удаленном сайте Active Directory столько раз, сколько указано в <em>MaxRetriesForRemoteSiteShadow</em>. Если это сделать не удается, сервер почтовых ящиков пытается создать теневую копию сообщения на другом сервере почтовых ящиков в локальном сайте Active Directory столько раз, сколько указано в <em>MaxRetriesForLocalSiteShadow</em>.</p></li>
<li><p>Если значение <em>ShadowMessagePreferenceSetting</em> равно <code>RemoteOnly</code>, сначала сервер почтовых ящиков пытается создать теневую копию сообщения на другом сервере почтовых ящиков на удаленном сайте Active Directory столько раз, сколько указано в <em>MaxRetriesForRemoteSiteShadow</em>.</p></li>
<li><p>Параметр</p></li>
</ul>
<p>Если теневая копия сообщения не создается:</p>
<ul>
<li><p>Если значение <em>RejectMessageOnShadowFailure</em> равно <code>$true</code>, основное сообщение отклоняется с указанием на временную ошибку.</p></li>
<li><p>Если значение <em>RejectMessageOnShadowFailure</em> равно <code>$false</code>, основное сообщение все же принимается, но сохраняется без обеспечения избыточности.</p></li>
</ul></td>
</tr>
<tr class="odd">
<td><p><em>MaxRetriesForLocalSiteShadow</em> по <strong>Set-TransportConfig</strong></p></td>
<td><p>2</p></td>
<td><p>Этот параметр используется в следующих случаях:</p>
<ul>
<li><p>Если сервер почтовых ящиков является членом группы обеспечения доступности баз данных, охватывающей несколько сайтов Active Directory.</p>
<ol>
<li><p>Если значение <em>ShadowMessagePreferenceSetting</em> равно <code>PreferRemote</code>, сначала сервер почтовых ящиков пытается создать теневую копию сообщения на другом сервере почтовых ящиков на удаленном сайте Active Directory столько раз, сколько указано в <em>MaxRetriesForRemoteSiteShadow</em>. Если это сделать не удается, сервер почтовых ящиков пытается создать теневую копию сообщения на другом сервере почтовых ящиков в локальном сайте Active Directory столько раз, сколько указано в <em>MaxRetriesForLocalSiteShadow</em>.</p></li>
<li><p>Если значение <em>ShadowMessagePreferenceSetting</em> равно <code>LocalOnly</code>, сначала сервер почтовых ящиков пытается создать теневую копию сообщения на другом сервере почтовых ящиков на локальном сайте Active Directory столько раз, сколько указано в <em>MaxRetriesForLocalSiteShadow</em>.</p></li>
</ol></li>
<li><p>Если сервер почтовых ящиков не является участником группы или является членом группы, сосредоточенной на одном сайте Active Directory, сервер почтовых ящиков пытается создать теневую копию этого сообщения на другом сервере почтовых ящиков в локальном сайте Active Directory столько раз, сколько задано в <em>MaxRetriesForLocalSiteShadow</em>.</p></li>
</ul>
<p>Если теневая копия сообщения не создается:</p>
<ul>
<li><p>Если значение <em>RejectMessageOnShadowFailure</em> равно <code>$true</code>, основное сообщение отклоняется с указанием на временную ошибку.</p></li>
<li><p>Если значение <em>RejectMessageOnShadowFailure</em> равно <code>$false</code>, основное сообщение все же принимается, но сохраняется без обеспечения избыточности.</p></li>
</ul></td>
</tr>
<tr class="even">
<td><p><em>ConnectionInactivityTimeout</em> по <strong>Set-ReceiveConnector</strong></p></td>
<td><p>5 минут в службе транспорта на серверах почтовых ящиков</p>
<p>5 минут в службе транспорта переднего плана на серверах клиентского доступа.</p>
<p>1 минута на пограничных транспортных серверах.</p></td>
<td><p>Этот параметр задает максимальное количество времени, в течение которого подключение по протоколу SMTP к исходному серверу обмена сообщениями может оставаться открытым при его бездействии. Значение данного параметра должно быть меньше значения, заданного для параметра <em>ConnectionTimeout</em>.</p></td>
</tr>
<tr class="odd">
<td><p><em>ConnectionTimeout</em> по <strong>Set-ReceiveConnector</strong></p></td>
<td><p>10 минут в службе транспорта на серверах почтовых ящиков</p>
<p>10 минут в службе транспорта переднего плана на серверах клиентского доступа.</p>
<p>5 минут на пограничных транспортных серверах.</p></td>
<td><p>Этот параметр задает максимальное количество времени, в течение которого подключение по протоколу SMTP к исходному серверу обмена сообщениями может оставаться открытым, даже если сервер обмена сообщениями передает данные. Значение данного параметра должно быть больше значения, заданного для параметра <em>ConnectionInactivityTimeout</em>.</p></td>
</tr>
<tr class="even">
<td><p><em>ConnectionInactivityTimeOut</em> о <strong>Set-SendConnector</strong></p></td>
<td><p>10 минут.</p></td>
<td><p>Этот параметр задает максимальное количество времени, в течение которого подключение по протоколу SMTP к конечному серверу обмена сообщениями может оставаться открытым при его бездействии.</p></td>
</tr>
</tbody>
</table>


В начало

## Как хранятся теневые сообщения

После успешного создания теневого сообщения работа теневой избыточности только начинается. Основной и теневой серверы должны постоянно находиться в контакте друг с другом, чтобы отслеживать ход сообщения.

Когда основной сервер успешно передает сообщение для следующего прыжка и следующий прыжок подтверждает прием сообщения, основной сервер обновляет *состояние удаления* сообщения, указывая, что оно доставлено. Состояние удаления по сути представляет собой сообщение, содержащее список отслеживаемых сообщений. Успешно доставленное сообщение не обязано находиться в теневой очереди, поэтому когда теневой сервер узнает, что основной сервер успешно передал сообщение для следующего прыжка, теневой сервер перемещает теневое сообщение из теневой очереди в систему безопасности.

Теневой сервер определяет состояние отмены теневых сообщений в теневой очереди путем опроса основного сервера. Если теневой сервер открывает сеанс SMTP с основным сервером по какой-либо причине, в том числе при передаче других не связанных сообщений, теневой сервер выдает команду **XQDISCARD**, чтобы определить состояние удаления основного сообщения. Если теневой сервер еще не открыл сеанс SMTP с основным сервером после истечения заданного интервала времени, теневой сервер открывает сеанс SMTP с ним и отправляет команду **XQDISCARD**. Интервал времени определяется параметром *ShadowHeartbeatFrequentcy* командлета **Set-TransportConfig**. Значение по умолчанию равно 2 минутам. Когда теневой сервер открывает сеанс SMTP с основным сервером, основной сервер отвечает *уведомлениями об удалении* для сообщений, относящихся к пославшему запрос теневому серверу. В Exchange 2013 уведомления об удалении хранятся на диске, а не в памяти. Поэтому, если служба транспорта Microsoft Exchange перезапускается, уведомления об удалении сохраняются. После запуска службы основной сервер по-прежнему знает о сообщениях, которые он успешно обработал, и эти сведения доступны теневому серверу.

SMTP-связь между теневым сервером и основным сервером используется в качестве *пульса*, определяющего доступность серверов. Если теневой сервер не может открыть сеанс SMTP с основным сервером после истечения заданного интервала времени или база данных транспорта основного сервера имеет другой идентификатор, теневой сервер выдвигает себя в качестве основного, продвигает теневые сообщения в качестве основных и передает эти сообщения на следующий прыжок. Интервал времени определяется параметром *ShadowResubmitTimeSpan* командлета **Set-TransportConfig**. Значение по умолчанию: 3 часа.

*Диспетчер теневой избыточности* является основным компонентом транспортного сервера Exchange 2013, отвечающего за управление теневой избыточностью. Диспетчер теневой избыточности осуществляет сохранение следующих сведений для всех основных сообщений, обрабатываемых сервером в данный момент времени:

  - теневой сервер для каждого обрабатываемого основного сообщения;

  - состояние удаления для отправки на теневые серверы.

Диспетчер теневой избыточности осуществляет следующие операции для всех теневых сообщений, находящихся в теневых очередях сервера:

  - сохранение списка основных серверов для каждого теневого сообщения;

  - сравнение исходного идентификатора базы данных и текущего идентификатора базы данных очереди, где хранится основная копия сообщения;

  - проверка доступности каждого основного сервера, в очередь для которого помещено теневое сообщение;

  - обработка уведомлений об удалении для основных серверов.

  - удаление теневых сообщений из теневых очередей после получения всех ожидаемых уведомлений об удалении;

  - принятие решений о том, когда теневой сервер должен вступить во владение теневыми сообщениями и стать основным сервером.

  - отслеживание раздвоения сообщений и других побочных эффектов, например уведомлений о состоянии доставки (DSN), а также отчетов журнала для гарантии того, что избыточные копии сообщений не будут освобождаться до полной обработки всех ветвлений.

В следующей таблице описаны параметры, которые управляют тем, как хранятся теневые сообщения.


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Параметр</th>
<th>Значение по умолчанию</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><em>ShadowHeartbeatFrequency</em> по <strong>Set-TransportConfig</strong></p></td>
<td><p>2 минуты</p></td>
<td><p>Максимальный период времени, в течение которого теневой сервер ждет перед открытием SMTP-подключения к основному серверу, чтобы проверить состояние удаления из сообщения.</p></td>
</tr>
<tr class="even">
<td><p><em>ShadowResubmitTimeSpan</em> по <strong>Set-TransportConfig</strong></p></td>
<td><p>3 часа</p></td>
<td><p>Время ожидания сервера до принятия решения о том, что на основном сервере произошел сбой, и присвоения владения теневыми сообщениями в теневой очереди для недоступного основного сервера.</p></td>
</tr>
<tr class="odd">
<td><p><em>ShadowMessageAutoDiscardInterval</em> по <strong>Set-TransportConfig</strong></p></td>
<td><p>2 дней</p></td>
<td><p>Как долго сервер сохраняет события отклонения для успешно доставленных сообщений. Основной сервер ставит в очередь события отмены, пока не последует запрос теневого сервера. Однако, если теневой сервер не запрашивает основной сервер в течение периода, указанного в этом параметре, основной сервер удаляет события отмены, поставленные в очередь.</p></td>
</tr>
<tr class="even">
<td><p><em>SafetyNetHoldTime</em> по <strong>Set-TransportConfig</strong></p></td>
<td><p>2 дней</p></td>
<td><p>Как долго успешно обработанные сообщения сохраняются в системе безопасности. Неподтвержденные теневые сообщения удаляются из системы безопасности после истечении определенного срока — суммы <em>SafetyNetHoldTime</em> и <em>MessageExpirationTimeout</em> в <strong>Set-TransportService</strong>.</p></td>
</tr>
<tr class="odd">
<td><p><em>MessageExpirationTimeout</em> по <strong>Set-TransportService</strong></p></td>
<td><p>2 дней</p></td>
<td><p>Как долго сообщение может оставаться в очереди до истечения срока его действия.</p></td>
</tr>
</tbody>
</table>


В начало

## Обработка сообщений после простоя

Теневая избыточность минимизирует потери сообщений, вызванные простоями серверов. Когда транспортный сервер возобновляет работу после простоя, могут иметь место два сценария.

  - **Сервер возобновляет работу с новой базой данных транспорта**   В данном сценарии база данных транспорта не может быть восстановлена из-за повреждения данных или неисправности оборудования. Поскольку в этом случае транспортный сервер имеет новый идентификатор базы данных, другие транспортные серверы в организации распознают его как новый маршрут. Это также касается ситуации, когда сервер не может быть восстановлен, и вместо него в эксплуатацию вводится новый сервер.

  - **Сервер возобновляет работу с той же самой базой данных транспорта.**   В этом сценарии транспортный сервер не терпит сбой, но отключается от сети в течение времени, достаточного для того, чтобы теневой сервер стал владельцем сообщений и повторно передал их. Например, данный сценарий может быть вызван сбоем сетевой карты или длительным обслуживанием сервера.

В следующей таблице описано, как теневая избыточность реагирует на этих два сценария. Допустим, что простаивавший сервер имеет имя Mailbox01.

### Обработка сообщений при сценариях восстановления

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Сценарий восстановления</th>
<th>Выполняемые действия</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Mailbox01 возобновляет работу с новой базой данных.</p></td>
<td><p>Когда Mailbox01 становится недоступен, каждый сервер, на котором в очереди есть теневые сообщения для Mailbox01, вступает во владение ими и повторно передает их. Затем сообщения доставляются к месту их назначения.</p>
<p>Максимальная задержка сообщений контролируется параметром <em>ShadowHeartbeatFrequency</em> командлета <strong>Set-TransportConfig</strong>. Значение по умолчанию равно 2 минутам.</p></td>
</tr>
<tr class="even">
<td><p>Mailbox01 возобновляет работу с той же самой базой данных.</p></td>
<td><p>Когда Mailbox01 возобновляет работу, он доставляет находящиеся в его очередях сообщения, которые уже доставлены серверами, на которых хранятся теневые копии сообщений Mailbox01. Это приводит к дублирующейся доставке данных сообщений. Пользователи почтовых ящиков Exchange не увидят повторяющиеся сообщения в связи с работой функции обнаружения повторяющихся сообщений. Однако получатели в сторонних системах обмена сообщениями могут получать дубликаты сообщений.</p>
<p>Максимальная задержка сообщений контролируется параметром <em>ShadowResubmitTimeSpan</em> командлета <strong>Set-TransportConfig</strong>. Значение по умолчанию: 3 часа.</p></td>
</tr>
</tbody>
</table>


В начало

