---
title: 'Управление группами доступности базы данных: Exchange 2013 Help'
TOCTitle: Управление группами доступности базы данных
ms:assetid: 74be3f97-ec0f-4d2a-b5d8-7770cc489919
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Dd298065(v=EXCHG.150)
ms:contentKeyID: 50488418
ms.date: 05/22/2018
mtps_version: v=EXCHG.150
ms.translationtype: MT
---

# Управление группами доступности базы данных

 

_**Применимо к:**Exchange Server 2013_

_**Последнее изменение раздела:**2017-10-04_

Группа обеспечения доступности баз данных (DAG) — это набор из не более 16 серверов почтовых ящиков Microsoft Exchange Server 2013, которые обеспечивают автоматическое восстановление на уровне базы данных в случае сбоя базы данных, сервера или сети. В группах DAG используется непрерывная репликация и подмножество технологий отказоустойчивых кластеров Windows, чтобы обеспечить высокий уровень доступности и устойчивость сайта. Почтовые серверы в группе доступности базы данных отслеживают сбои в работе друг друга. Добавленный в эту группу сервер почтовых ящиков работает вместе с другими серверами DAG, что обеспечивает автоматическое восстановление на уровне базы данных после возникновения ошибок в ней.

Первоначально создается пустая группа DAG. Когда первый сервер добавляется к группе DAG, для нее автоматически создается отказоустойчивый кластер. Кроме того, инициализируется инфраструктура, которая отслеживает сбои на серверах и в сети. Механизм периодических сигналов о подтверждении соединения с отказоустойчивым кластером и база данных кластера затем используются для отслеживания и обработки информации о группе доступности, которая может быстро изменяться, например о состоянии подключения базы данных, состоянии репликации и о последнем подключении.

**Содержание**

Creating DAGs

DAG membership

Configuring DAG properties

DAG networks

Configuring DAG members

Performing maintenance on DAG members

Shutting down DAG members

Installing updates on DAG members

## Создание групп обеспечения доступности баз данных

Группу обеспечения доступности базы данных (DAG) можно создать с помощью мастера создания группы обеспечения доступности баз данных в центре администрирования Exchange или командлета **New-DatabaseAvailabilityGroup** в командной консоли Exchange. При создании группы обеспечения доступности базы данных необходимо указать ее имя, а также необязательные параметры следящего сервера и следящего каталога. Кроме того, группе можно назначить один или несколько IP-адресов, используя статические IP-адреса или разрешив группе автоматически получить необходимые IP-адреса с помощью протокола DHCP. Можно также вручную назначить IP-адреса группе обеспечения доступности баз данных с помощью параметра *DatabaseAvailabilityGroupIpAddresses*. Если этот параметр не указан, группа попытается получить IP-адрес с помощью DHCP-сервера в сети.

Если вы создаете группу обеспечения доступности баз данных, которая содержит серверы почтовых ящиков, работающих под управлением Windows Server 2012 R2, у вас также есть возможность создания группы обеспечения доступности баз данных без точки административного доступа кластера. В этом случае у кластера не будет объекта имени кластера (CNO) в Active Directory, а группа основных ресурсов кластера будет без ресурса сетевого имени или ресурса IP-адреса.

Дополнительные сведения о создании группы обеспечения доступности баз данных см. в разделе [Создание группы обеспечения доступности баз данных](create-a-database-availability-group-exchange-2013-help.md).

При создании группы обеспечения доступности баз данных в службах Active Directory создается пустой объект, представляющий группу доступности с указанным именем, и класс объекта **msExchMDBAvailabilityGroup**.

В DAG используется подмножество технологий отказоустойчивых кластеров Windows, таких как пульс кластера, сети кластеров и база данных кластер (для хранения данных, которые могут быстро изменяться, например, при изменении состояния базы данных из активного на пассивное или наоборот, либо с подключенного на отключенное или наоборот). Поскольку группы DAG опираются на отказоустойчивую кластеризацию Windows, их можно создавать только на серверах почтовых ящиков Exchange 2013 в системе Windows Server 2008 R2 Enterprise или DataCenter, Windows Server 2012 DataCenter или Standard либо Windows Server 2012 R2 Standard или Datacenter.

<table>
<thead>
<tr class="header">
<th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Отказоустойчивый кластер, создаваемый и используемый группой DAG, должен быть выделен для этой группы. Кластер не может использоваться для другого решения для обеспечения высокого уровня доступности или в каких-либо других целях. Например, невозможно использовать отказоустойчивый кластер для кластеризации других приложений и служб. Использование базового отказоустойчивого кластера группы обеспечения доступности баз данных в других целях, кроме группы DAG, не поддерживается.</td>
</tr>
</tbody>
</table>


## Следящий сервер и следящий каталог группы обеспечения доступности баз данных

При создании группы обеспечения доступности базы данных необходимо указать ее имя (не более 15 символов), которое является уникальным в пределах леса Active Directory. Кроме того, настраивается каждая группа доступности с помощью следящего сервера и следящего каталога. Следящий сервер и каталог на нем используются только в том случае, если в группе DAG четное число членов, и только в целях формирования кворума. Нет необходимости заранее создавать следящий каталог. Он будет автоматически создан и защищен системой Exchange на следящем сервере. Каталог не должен использоваться ни для каких других целей, кроме следящего сервера группы обеспечения доступности базы данных.

Для следящего сервера существуют следующие требования:

  - Следящий сервер не должен быть членом группы DAG.

  - Следящий сервер должен располагаться в том же лесу Active Directory, что и группа DAG.

  - Следящий сервер должен работать под управлением поддерживаемой версии Windows Server. Для получения дополнительных сведений см [Требования к системе для установки Exchange 2013](exchange-2013-system-requirements-exchange-2013-help.md).

  - Один сервер может быть следящим сервером для нескольких групп DAG. Однако для каждой группы DAG требуется собственный следящий каталог.

Независимо от того, какой сервер используется в качестве следящего, если на нем включен брандмауэр Windows, необходимо включить исключение брандмауэра Windows для общего доступа к файлам и принтерам.

<table>
<thead>
<tr class="header">
<th><img src="images/Dd876857.important(EXCHG.150).gif" title="Важно" alt="Важно" />Важно!</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Если указанный следящий сервер не является сервером Exchange 2013 или Exchange 2010, перед созданием группы обеспечения доступности баз данных следует добавить универсальную группу безопасности доверенной подсистемы Exchange к локальной группе администраторов на следящем сервере. Эти разрешения безопасности необходимы для создания каталога и файлового ресурса на следящем сервере в приложении Exchange.<br />
Следящий сервер использует протокол SMB порт 445.</td>
</tr>
</tbody>
</table>


Ни следящий сервер, ни каталог не должны быть отказоустойчивыми или использовать какую-либо форму избыточности или высокой доступности. Не требуется использовать кластеризованный файловый сервер или какую-либо другую форму устойчивости для следящего сервера. На это есть несколько причин. Чтобы возникла необходимость в следящем сервере при работе с большими группами обеспечения доступности баз данных (например, с шестью и более членами), должно произойти несколько сбоев. Так как группа DAG из шести членов может выдержать сбои двух серверов без потери кворума, то, чтобы для сохранения кворума потребовался следящий сервер, сбои должны произойти у трех членов группы. Кроме того, при наличии сбоя, который влияет на текущий следящий сервер (например, следящий сервер потерян из-за сбоя оборудования), для настройки нового следящего сервера и следящего каталога (при наличии кворума) используйте командлет [Set-DatabaseAvailabilityGroup](https://technet.microsoft.com/ru-ru/library/dd297934\(v=exchg.150\)).

<table>
<thead>
<tr class="header">
<th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Если следящий сервер утратил свое хранилище или кто-либо изменил следящий каталог или разрешения для общего ресурса, для настройки следящего сервера и следящего каталога в исходном расположении можно использовать командлет <strong>Set-DatabaseAvailabilityGroup</strong>.</td>
</tr>
</tbody>
</table>


## Варианты размещения следящего сервера

Размещение следящего сервера группы обеспечения доступности баз данных зависит от требований компании и вариантов, доступных в организации. Exchange 2013 включает поддержку новых параметров конфигурации группы обеспечения доступности баз данных, нерекомендованных или недоступных в предыдущих версиях Exchange. Такие параметры включают использование третьего расположения, например третьего центра обработки данных, филиала или виртуальной сети Microsoft Azure.

В следующей таблице приведены общие рекомендации по размещению следящего сервера в различных сценариях развертывания.


<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Сценарий развертывания</th>
<th>рекомендации</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Один сервер DAG, развернутый в одном центре обработки данных.</p></td>
<td><p>Удаленный следящий сервер в том же центре обработки данных, в котором находятся члены DAG</p></td>
</tr>
<tr class="even">
<td><p>Одна DAG, развернутая для двух центров обработки данных; другие расположения недоступны</p></td>
<td><p>Расположите следящий сервер в виртуальной сети Microsoft Azure для автоматической отработки отказа центра данных. Или</p>
<p>Расположите следящий сервер в главном центре обработки данных</p></td>
</tr>
<tr class="odd">
<td><p>Несколько групп DAG, развернутых в одном центре обработки данных</p></td>
<td><p>Удаленный следящий сервер в том же центре обработки данных, в котором находятся члены DAG. Доступны следующие дополнительные параметры.</p>
<ul>
<li><p>Использование одного следящего сервера для нескольких DAG</p></li>
<li><p>Использование члена DAG в качестве следящего сервера для другой DAG</p></li>
</ul>
<p></p></td>
</tr>
<tr class="even">
<td><p>Несколько групп DAG, развернутых для двух центров обработки данных</p></td>
<td><p>Расположите следящий сервер в виртуальной сети Microsoft Azure для автоматической отработки отказа центра данных. Или</p>
<p>Расположите следящий сервер в центре обработки данных, являющемся главным для каждой DAG. Доступны следующие дополнительные параметры.</p>
<ul>
<li><p>Использование одного следящего сервера для нескольких DAG</p></li>
<li><p>Использование члена DAG в качестве следящего сервера для другой DAG</p>
<p></p></li>
</ul></td>
</tr>
<tr class="odd">
<td><p>Одна или несколько DAG, развернутых для более чем двух центров обработки данных</p></td>
<td><p>В данной конфигурации следящий сервер может быть расположен в центре обработки данных, в котором требуется разместить большую часть голосов кворума.</p></td>
</tr>
</tbody>
</table>


Если группа DAG развернута для двух центров обработки данных, новый параметр конфигурации Exchange 2013 позволяет разместить следящий сервер в третьем расположении. Если в организации есть третье расположение сетевой инфраструктуры, изолированное от сетевых сбоев, влияющих на два центра обработки данных, в которых развернута группа DAG, вы можете выполнить развертывание следящего сервера DAG в данном третьем расположении, чтобы предусмотреть возможность автоматического обхода отказов для баз данных с переключением на другой центр обработки данных при возникновении сбоя в масштабе всего центра обработки данных Если в вашей организации два физических местоположения, вы можете использовать виртуальную сеть Microsoft Azure как третье расположение для размещения следящего сервера.

## Определение следящего сервера и следящего каталога во время создания группы обеспечения доступности баз данных

При создании группы обеспечения доступности базы данных необходимо указать ее имя. Дополнительно можно указать следящий сервер и следящий каталог.

При создании группы DAG доступны следующие сочетания параметров и реакций на события:

  - Можно указать только имя группы обеспечения доступности базы данных и не устанавливать флажки **Следящий сервер** и **Следящий каталог**. В этом сценарии будет выполнен поиск локального сайта Active Directory для сервера клиентского доступа, на котором не установлена роль сервера почтовых ящиков. Затем на этом сервере будет автоматически создан каталог по умолчанию (%SystemDrive%:\\DAGFileShareWitnesses\\\<*Имя\_FQDN\_для\_DAG*\>) и общий ресурс по умолчанию (\<*Имя\_FQDN\_для\_DAG*\>), а этот сервер клиентского доступа будет использован в качестве следящего сервера. Например, рассмотрим следящий сервер с именем CAS3, на котором операционная система установлена на диске C. В группе DAG с именем DAG1 в домене с именем contoso.com будет использоваться следящий каталог по умолчанию C:\\DAGFileShareWitnesses\\DAG1.contoso.com с общим доступом по адресу \\\\CAS3\\DAG1.contoso.com.

  - Пользователь может указать имя для группы обеспечения доступности баз данных, для используемого следящего сервера, а также для каталога, созданного и открытого для совместного доступа на следящем сервере.

  - Пользователь может указать имя для группы обеспечения доступности баз данных и используемого следящего сервера и оставить поле **Следящий каталог** пустым. В этом сценарии на указанном следящем сервере мастер создаст каталог по умолчанию.

  - Можно указать имя группы обеспечения доступности баз данных, не заполнять поле **Следящий сервер** и указать каталог, который требуется создать и открыть для совместного доступа на следящем сервере. В этом сценарии мастер выполнит поиск сервера клиентского доступа, на котором не установлена роль сервера почтовых ящиков, автоматически создаст на сервере указанную группу обеспечения доступности баз данных, включит общий доступ для каталога и будет использовать сервер клиентского доступа в качестве следящего сервера.

После формирования группы обеспечения доступности баз данных в ней первоначально используется модель кворума "Большинство узлов". После добавления второго сервера почтовых ящиков в группу обеспечения доступности баз данных кворум автоматически меняется на модель кворума "Большинство сайтов и общих файловых ресурсов". После этих изменений кластер группы обеспечения доступности баз данных будет использовать следящий сервер для сохранения кворума. Если следящего каталога не существует, сервер Exchange автоматически создаст его, включит для него общий доступ и предоставит для общего ресурса разрешения на полный доступ для учетной записи компьютера сетевого объекта кластера (CNO) в группе доступности баз данных.

<table>
<thead>
<tr class="header">
<th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Использование общей папки, которая является частью пространства имен распределенной файловой системы, не поддерживается.</td>
</tr>
</tbody>
</table>


Если брандмауэр Windows включен на следящем сервере до создания группы обеспечения доступности баз данных, он может блокировать ее создание. Сервер Exchange использует инструментарий управления Windows (WMI) для создания каталога и общего файлового ресурса на следящем сервере. Если брандмауэр Windows включен на следящем сервере и для инструментария управления Windows не настроены исключения брандмауэра, произойдет сбой командлета **New-DatabaseAvailabilityGroup**. Если указан следящий сервер, а не следящий каталог, отобразится следующее сообщение об ошибке:


<table>
<colgroup>
<col style="width: 100%" />
</colgroup>
<tbody>
<tr class="odd">
<td><p>Задаче не удалось создать следящий каталог по умолчанию на сервере &lt;<em>Имя сервера</em>&gt;. Укажите следящий каталог вручную.</p></td>
</tr>
</tbody>
</table>


Если указаны следящий сервер и следящий каталог, отобразится следующее предупреждение:


<table>
<colgroup>
<col style="width: 100%" />
</colgroup>
<tbody>
<tr class="odd">
<td><p>Не удалось получить доступ к общим файловым ресурсам на следящем сервере <em>Имя_сервера</em>. До решения этой неполадки группа обеспечения доступности баз данных может быть более уязвимой к сбоям. Можно повторно выполнить операцию с помощью командлета Set-DatabaseAvailabilityGroup. Ошибка: сетевой путь не найден.</p></td>
</tr>
</tbody>
</table>


Если брандмауэр Windows включен на следящем сервере после создания группы обеспечения доступности баз данных, но перед добавлением серверов, он может блокировать добавление или удаление членов группы обеспечения доступности баз данных. Если брандмауэр Windows включен на следящем сервере и для инструментария управления Windows не настроены исключения брандмауэра, командлет **Add-DatabaseAvailabilityGroupServer** вернет следующее предупреждение:


<table>
<colgroup>
<col style="width: 100%" />
</colgroup>
<tbody>
<tr class="odd">
<td><p>Не удалось создать следящий каталог общего файлового ресурса C:\DAGFileShareWitnesses\DAG_FQDN на следящем сервере <em>Имя_сервера</em>. До решения этой неполадки группа обеспечения доступности баз данных может быть более уязвимой к сбоям. Можно повторно выполнить операцию с помощью командлета Set-DatabaseAvailabilityGroup. Ошибка: на сервере <em>Имя_сервера</em> произошло исключение WMI: сервер RPC недоступен. (Исключение из HRESULT: 0x800706BA).</p></td>
</tr>
</tbody>
</table>


Чтобы устранить предыдущие сообщения об ошибках и предупреждения, выполните одно из следующих действий.

  - Вручную создайте следящий каталог и общий ресурс на следящем сервере и назначьте для них разрешения на полный доступ для объекта CNO в группе DAG.

  - Включите исключение WMI в брандмауэре Windows.

  - Отключите брандмауэр Windows.

В начало

## Членство в группы обеспечения доступности базы данных

После создания группы обеспечения доступности баз данных в нее можно добавлять или удалять из нее серверы с помощью мастера управления группами обеспечения доступности баз данных в центре администрирования Exchange или с помощью командлетов **Add-DatabaseAvailabilityGroupServer** или **Remove-DatabaseAvailabilityGroupServer** в командной консоли. Дополнительные сведения об управлении членством в группе DAG см. в разделе [Управление членством в группе обеспечения доступности баз данных](manage-database-availability-group-membership-exchange-2013-help.md).

<table>
<thead>
<tr class="header">
<th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Каждый сервер почтовых ящиков, являющийся членом такой группы DAG, также является узлом базового кластера, используемого группой. Таким образом, сервер почтовых ящиков одновременно может быть членом только одной группы обеспечения доступности баз данных.</td>
</tr>
</tbody>
</table>


Если на сервере почтовых ящиков, добавляемом в группу обеспечения доступности баз данных, не установлен компонент отказоустойчивой кластеризации, то с помощью метода, используемого для добавления сервера (например, командлета **Add-DatabaseAvailabilityGroupServer** или мастера управления группами обеспечения доступности баз данных), будет установлено средство отказоустойчивой кластеризации.

При добавлении первого сервера почтовых ящиков в группу DAG происходит следующее:

  - Устанавливается компонент отказоустойчивости кластера Windows, если он еще не установлен.

  - Создается отказоустойчивый кластер с помощью имени группы DAG. Отказоустойчивый кластер используется только группой DAG и должен быть выделен для этой группы. Использование кластера в других целях не поддерживается.

  - Создается объект CNO в контейнере компьютеров по умолчанию.

  - Регистрируется имя и IP-адрес группы обеспечения доступности баз данных в качестве записи узла (A) в службе DNS.

  - Добавляется сервер к объекту DAG в Active Directory.

  - Обновляется база данных кластера информацией о базах данных, установленных на добавленный сервер.

В крупных средах или средах с несколькими сайтами, особенно в которых группа DAG расширена на несколько сайтов Active Directory, необходимо дождаться завершения репликации Active Directory объекта DAG, содержащего первый член группы DAG. Если этот объект Active Directory не реплицирован во всей среде, при добавлении второго сервера может быть создан новый кластер (и новый объект CNO) для группы DAG. Это происходит потому, что объект DAG является пустым с точки зрения второго добавляемого сервера, в результате чего командлет **Add-DatabaseAvailabilityGroupServer** создает новый кластер и объект CNO для группы DAG, даже если эти объекты уже существуют. Чтобы убедиться, что объект DAG, содержащий первый сервер DAG, реплицирован, используйте командлет **Get-DatabaseAvailabilityGroup** на втором добавляемом сервере, чтобы проверить, что первый добавленный сервер включен в список членов группы обеспечения доступности баз данных.

После добавления второго и последующих серверов к группе DAG происходит следующее.

  - Сервер присоединяется к отказоустойчивому кластеру Windows для группы DAG.

  - Автоматически настраивается модель кворума:
    
      - Используется модель кворума "Большинство узлов" для групп DAG с нечетным количеством участников.
    
      - Используется модель кворума "Большинство узлов и общих файловых ресурсов" для групп DAG с четным количеством участников.

  - При необходимости Exchange автоматически создает следящий каталог и общий ресурс.

  - Добавляется сервер к объекту DAG в Active Directory.

  - Обновляется база данных кластера информацией об установленных базах данных.

<table>
<thead>
<tr class="header">
<th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Автоматически меняется модель кворума. Однако если модель кворума не меняется автоматически на правильную модель, можно запустить командлет <strong>Set-DatabaseAvailabilityGroup</strong> только с параметром <em>Identity</em>, чтобы исправить параметры кворума для группы обеспечения доступности базы данных.</td>
</tr>
</tbody>
</table>


## Регистрация объекта имени кластера для группы DAG

Объект имени кластера — это учетная запись компьютера, создаваемая в службе Active Directory и связываемая с ресурсом имени кластера. Ресурс имени кластера связан с объектом имени кластера, который является объектом с включенной поддержкой Kerberos, действующим как идентификатор кластера и обеспечивающим контекст безопасности кластера. Формирование базового кластера группы обеспечения доступности баз данных и объекта CNO для этого кластера выполняется при добавлении первого члена в группу DAG. После добавления первого сервера в группу DAG удаленная среда Powershell подключается к службе репликации Microsoft Exchange на добавляемом сервере почтовых ящиков. Служба репликации Microsoft Exchange устанавливает средство отказоустойчивой кластеризации (если оно не установлено) и запускает процесс создания кластера. Служба репликации Microsoft Exchange работает в контексте безопасности LOCAL SYSTEM, и создание кластера выполняется в этом контексте.

<table>
<thead>
<tr class="header">
<th><img src="images/JJ983803.warning(EXCHG.150).gif" title="Предупреждение" alt="Предупреждение" />Предупреждение.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Если члены группы обеспечения доступности баз данных используют Windows Server 2012, необходимо подготовить объект CNO до добавления первого сервера в группу DAG. Если члены группы обеспечения доступности баз данных используют Windows Server 2012 R2, и она создана без точки административного доступа кластера, объект CNO не создается, и создавать объект CNO для группы обеспечения доступности баз данных не требуется.</td>
</tr>
</tbody>
</table>


В средах, в которых создание учетной записи компьютера ограничено или учетные записи компьютеров создаются в контейнере, отличном от контейнера компьютеров по умолчанию, необходимо зарегистрировать и подготовить объект CNO. Пользователь создает и отключает учетную запись компьютера для объекта CNO, а затем выполняет одно из следующих действий.

  - Назначить разрешения на полный доступ к учетной записи компьютера для учетной записи компьютера, являющегося первым сервером почтовых ящиков, добавляемым в группу обеспечения доступности баз данных.

  - Назначить универсальной группе безопасности доверенной подсистемы Exchange разрешения на полный доступ к учетной записи компьютера.

Назначение разрешений на полный доступ к учетной записи компьютера для учетной записи компьютера первого сервера почтовых ящиков, добавленного в группу DAG, позволяет контексту безопасности LOCAL SYSTEM управлять зарегистрированной учетной записью компьютера. Вместо этого можно назначить разрешения на полный доступ к учетной записи компьютера универсальной группе безопасности доверенной подсистемы Exchange, так как эта группа доверенной подсистемы Exchange включает в себя учетные записи компьютеров всех серверов Exchange в домене.

Дополнительные сведения о регистрации и подготовке объекта CNO для группы обеспечения доступности баз данных см. в разделе [Регистрация объекта имени кластера для группы обеспечения доступности баз данных](pre-stage-the-cluster-name-object-for-a-database-availability-group-exchange-2013-help.md).

## Удаление серверов из DAG

Серверы почтовых ящиков можно удалять из группы обеспечения доступности баз данных с помощью мастера управления группами обеспечения доступности баз данных в центре администрирования Exchange или командлета **Remove-DatabaseAvailabilityGroupServer** в командной консоли. Необходимо удалить все реплицированные базы данных почтовых ящиков с сервера почтовых ящиков, прежде чем удалить сам сервер из группы DAG. При попытке удалить сервер почтовых ящиков с реплицированными базами данных почтовых ящиков из группы DAG произойдет сбой.

Существует несколько сценариев, в которых перед выполнением определенных операций необходимо удалить сервер почтовых ящиков из группы обеспечения доступности баз данных. Это происходит в описанных ниже случаях.

  - **Выполнение операции по восстановлению сервера**   При потере связи с сервером почтовых ящиков, который является членом группы обеспечения доступности баз данных, или при возникновении неустранимых ошибок и необходимости замены сервера можно выполнить восстановление сервера с помощью параметра **Setup /m:RecoverServer**. Однако перед выполнением восстановления необходимо удалить сервер из группы DAG с помощью командлета [Remove-DatabaseAvailabilityGroupServer](https://technet.microsoft.com/ru-ru/library/dd297956\(v=exchg.150\)) с параметром *ConfigurationOnly*.

  - **Удаление группы доступности базы данных**   Существуют сценарии, в которых необходимо удалить группу обеспечения доступности баз данных (например, при отключении режима сторонней репликации). Перед удалением группы DAG необходимо сначала удалить из нее все серверы. Попытка удаления группы DAG, содержащей члены, завершится неудачей.

В начало

## Настройка свойств DAG

После добавления серверов в группу обеспечения доступности баз данных можно использовать центра администрирования Exchange или командную консоль Exchange для настройки свойств группы DAG, в том числе следящего сервера и каталога, используемых группой DAG, а также назначенных ей IP-адресов.

Настраиваемые свойства включают в себя следующее:

  - **Следящий сервер**   Имя сервера, на котором необходимо разместить общий файловый ресурс для файлового ресурса-свидетеля. Мы рекомендуем указать сервер клиентского доступа в качестве следящего сервера. Это позволяет системе автоматически формировать, защищать и использовать общий ресурс по мере необходимости, а также позволяет администратору контролировать доступность следящего сервера.

  - **Следящий каталог**   Имя каталога на следящем сервере, в котором будут храниться данные файлового ресурса-свидетеля. Этот каталог будет автоматически создан системой на указанном следящем сервере.

  - **IP-адреса группы обеспечения доступности баз данных**   Группе DAG должен быть назначен хотя бы один IP-адрес. Это правило не соблюдается, если члены группы используют Windows Server 2012 R2, а группа создается без IP-адреса. В ином случае, IP-адреса группы можно настроить с помощью назначенных вручную статических IP-адресов или назначить группе DAG автоматически с помощью DHCP-сервера организации.

Командная консоль позволяет настраивать свойства группы DAG, которые недоступны в центре администрирования Exchange, например ее IP-адреса, параметры шифрования и сжатия в сети, обнаружение сети, используемый для репликации TCP-порт, а также изменять параметры следящего сервера и следящего каталога и включать режим координации активации центра обработки данных.

Дополнительные сведения о настройке свойств группы DAG см. в разделе [Настройка свойств группы обеспечения доступности баз данных](configure-database-availability-group-properties-exchange-2013-help.md).

## Шифрование в сети группы обеспечения доступности баз данных

Группы DAG поддерживают использование шифрования путем применения возможностей шифрования ОС Windows Server. Группы DAG используют проверку подлинности Kerberos между серверами Exchange. API DecryptMessage и EncryptMessage поставщика поддержки безопасности (SSP) Microsoft Kerberos отвечают за шифрование сетевого трафика группы DAG. Поставщик поддержки безопасности Microsoft Kerberos поддерживает несколько алгоритмов шифрования. (Полный список см. в подразделе 3.1.5.2 "Типы шифрования" раздела [Расширения протокола Kerberos](https://go.microsoft.com/fwlink/p/?linkid=179131)). При подтверждении проверки подлинности Kerberos выбирается самый надежный поддерживаемый протокол шифрования из указанных в списке: обычно стандарт AES с 256-разрядным ключом, возможно, вместе с кодом проверки подлинности сообщения на основе хэша (HMAC) по алгоритму SHA для сохранения целостности данных. Дополнительные сведения см. в разделе [HMAC](https://ru.wikipedia.org/wiki/hmac).

Шифрование в сети является свойством группы DAG, а не сети DAG. Настроить шифрование в сети DAG можно с помощью командлета **Set-DatabaseAvailabilityGroup** в командной консоли. Возможные параметры для установления связи в сети DAG показаны в следующей таблице.

### Параметры шифрования связи в сети DAG

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Отключено</p></td>
<td><p>Шифрование сети не используется.</p></td>
</tr>
<tr class="even">
<td><p>Включено</p></td>
<td><p>Шифрование в сети используется во всех сетях DAG для репликации и заполнения.</p></td>
</tr>
<tr class="odd">
<td><p>InterSubnetOnly</p></td>
<td><p>Шифрование в сети используется в сетях DAG при репликации в разных подсетях. Это настройка по умолчанию.</p></td>
</tr>
<tr class="even">
<td><p>SeedOnly</p></td>
<td><p>Шифрование в сети используется во всех сетях DAG только для заполнения.</p></td>
</tr>
</tbody>
</table>


## Сжатие в сети DAG

В группах DAG поддерживается встроенное сжатие. Если сжатие включено, при установлении связи в сети DAG используется сжатие XPRESS, которое является реализацией Microsoft для алгоритма LZ77. Дополнительные сведения см. в разделе [Алгоритм сжатия](http://www.zlib.net/feldspar.html) и в подразделе 3.1.4.11.1.2.1 "Алгоритм сжатия LZ77" раздела [Спецификация протокола формата подключения](https://go.microsoft.com/fwlink/p/?linkid=179133). Это тот же тип сжатия, который используется во многих протоколах Майкрософт, в частности, сжатие MAPI RPC между Microsoft Outlook и Exchange.

Как и шифрование в сети, сжатие в сети является свойством группы DAG, а не сети DAG. Сжатие в сети DAG можно настроить с помощью командлета [Set-DatabaseAvailabilityGroup](https://technet.microsoft.com/ru-ru/library/dd297934\(v=exchg.150\)) в командной консоли. Возможные параметры сжатия для установления связи в сети DAG показаны в следующей таблице.

### Параметры сжатия для связи в сети DAG

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Отключено</p></td>
<td><p>Сжатие в сети не используется.</p></td>
</tr>
<tr class="even">
<td><p>Включен</p></td>
<td><p>Сжатие в сети используется во всех сетях DAG для репликации и заполнения.</p></td>
</tr>
<tr class="odd">
<td><p>InterSubnetOnly</p></td>
<td><p>Сжатие в сети используется в сетях DAG при репликации в разных подсетях. Это настройка по умолчанию.</p></td>
</tr>
<tr class="even">
<td><p>SeedOnly</p></td>
<td><p>Сжатие в сети используется во всех сетях DAG только для заполнения.</p></td>
</tr>
</tbody>
</table>


В начало

## Сети групп обеспечения доступности баз данных

Сеть DAG — это коллекция из одной или нескольких подсетей, используемых либо для трафика репликации, либо для трафика MAPI. Каждая группа DAG содержит не более одной сети MAPI и 0 или более сетей репликации.

## Конфигурации с одним сетевым адаптером

В конфигурации с одним сетевым адаптером одна и та же сеть используется как для трафика MAPI, так и для трафика репликации. Для серверов Exchange Server рекомендуется использовать конфигурацию с одним сетевым адаптером, чтобы уменьшить сложность. Следовательно, трафик MAPI и трафик репликации могут проходить по одной сети.

## Конфигурации с двумя сетевыми адаптерами

Как правило, конфигурации с двумя сетевыми адаптерами требуются, только если увеличивающийся объем сетевого трафика может превысить допустимый для одного сетевого адаптера.

В конфигурации с двумя сетевыми адаптерами одна сеть обычно выделяется для трафика репликации, а другая сеть в основном используется для трафика MAPI. Кроме того, вы можете добавить сетевые адаптеры для каждого члена группы DAG и настроить дополнительные сети DAG как сети репликации.

<table>
<thead>
<tr class="header">
<th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>При использовании нескольких сетей репликации невозможно указать приоритет использования сети. Exchange случайным образом выбирает сеть репликации из группы сетей репликации для доставки журналов.</td>
</tr>
</tbody>
</table>


В Exchange 2010 во многих сценариях необходима ручная настройка сетей DAG. По умолчанию в Exchange 2013 сети DAG будут настроены автоматически системой. Перед созданием или изменением сетей DAG необходимо сначала включить ручное управление сетью DAG, выполнив следующую команду:

    Set-DatabaseAvailabilityGroup <DAGName> -ManualDagNetworkConfiguration $true

После включения ручной настройки сети DAG можно использовать командлет **New-DatabaseAvailabilityGroupNetwork** в командной консоли для создания сети группы обеспечения доступности баз данных. Дополнительные сведения о создании сети группы обеспечения доступности баз данных см. в разделе [Создание сети группы доступности базы данных](create-a-database-availability-group-network-exchange-2013-help.md).

Можно использовать командлет **Set-DatabaseAvailabilityGroupNetwork** в командной консоли Exchange для настройки свойств сети группы обеспечения доступности базы данных. Дополнительные сведения о настройке свойств сети DAG см. в разделе [Настройка свойств сети для группы обеспечения доступности баз данных](configure-database-availability-group-network-properties-exchange-2013-help.md). В каждой сети DAG есть необходимые и дополнительные параметры для настройки:

  - **Сетевое имя**   Уникальное имя для сети DAG длиной не более 128 символов.

  - **Шифрование в сети**   Дополнительное описание для сети DAG длиной до 256 символов.

  - **Подсети сети**   Одна или несколько введенных подсетей в формате *IP-адрес/Битовая\_маска* (например, 192.168.1.0/24 для подсетей IPv4; 2001:DB8:0:C000::/64 для подсетей IPv6).

  - **Включить репликацию**   В центре администрирования Exchange установите флажок, чтобы выделить сеть DAG для трафика репликации и блокировать трафик MAPI. Снимите флажок, чтобы запретить использование сети группы DAG для репликации и включить трафик MAPI. Чтобы включить или отключить репликацию, используйте параметр *ReplicationEnabled* в командлете [Set-DatabaseAvailabilityGroupNetwork](https://technet.microsoft.com/ru-ru/library/dd298008\(v=exchg.150\)) в командной консоли.

<table>
<thead>
<tr class="header">
<th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Отключение репликации для сети MAPI не гарантирует того, что система не будет использовать эту сеть для репликации. Когда все настроенные сети репликации находятся в автономном режиме, неисправны или недоступны и сохраняется только сеть MAPI, для которой отключена репликация, система будет использовать эту сеть для репликации.</td>
</tr>
</tbody>
</table>


Начальные сети DAG (например, MapiDagNetwork и ReplicationDagNetwork01), создаваемые системой, основаны на подсетях службы кластеров. Каждый член группы DAG должен иметь идентичное количество сетевых адаптеров, а каждый сетевой адаптер должен иметь адрес IPv4 (а также, возможно, и адрес IPv6) в уникальной подсети. Несколько членов группы DAG могут иметь адреса IPv4 в одной подсети, но IP-адрес каждого сетевого адаптера определенного сервера группы DAG должен принадлежать уникальной подсети. Кроме того, шлюз по умолчанию должен использоваться только адаптером сети MAPI. Сети репликации не должны настраиваться на использование шлюза по умолчанию.

Например, рассмотрим группу DAG1 с двумя членами, каждый из которых имеет по два сетевых адаптера (один выделен для сети MAPI, а другой — для сети репликации). Примерные параметры конфигурации IP-адреса представлены в следующей таблице.

### Пример настройки параметров сетевого адаптера

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Плата &quot;сервер-сеть&quot;</th>
<th>IP-адрес/маска подсети</th>
<th>Шлюз по умолчанию</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>EX1-MAPI</p></td>
<td><p>192.168.1.15/24</p></td>
<td><p>192.168.1.1</p></td>
</tr>
<tr class="even">
<td><p>EX1-Репликация</p></td>
<td><p>10.0.0.15/24</p></td>
<td><p>Неприменимо</p></td>
</tr>
<tr class="odd">
<td><p>EX2-MAPI</p></td>
<td><p>192.168.1.16</p></td>
<td><p>192.168.1.1</p></td>
</tr>
<tr class="even">
<td><p>EX2-Репликация</p></td>
<td><p>10.0.0.16</p></td>
<td><p>Неприменимо</p></td>
</tr>
</tbody>
</table>


В следующей конфигурации группа DAG содержит две настроенные подсети: 192.168.1.0 и 10.0.0.0. При добавлении серверов EX1 и EX2 в группу DAG обе подсети будут пронумерованы и будет создано две сети DAG: MapiDagNetwork (192.168.1.0) и ReplicationDagNetwork01 (10.0.0.0). Эти сети будут настроены, как показано в следующей таблице.

### Параметры нумерованных сетей DAG для группы DAG с одной подсетью

<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th>Имя</th>
<th>Подсети</th>
<th>Интерфейсы</th>
<th>Доступ MAPI включен</th>
<th>Репликация включена</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>MapiDagNetwork</p></td>
<td><p>192.168.1.0/24</p></td>
<td><p>EX1 (192.168.1.15)</p>
<p>EX2 (192.168.1.16)</p></td>
<td><p>Да</p></td>
<td><p>Да</p></td>
</tr>
<tr class="even">
<td><p>ReplicationDagNetwork01</p></td>
<td><p>10.0.0.0/24</p></td>
<td><p>EX1 (10.0.0.15)</p>
<p>EX2 (10.0.0.16)</p></td>
<td><p>Нет</p></td>
<td><p>Да</p></td>
</tr>
</tbody>
</table>


Чтобы завершить настройку Replicationdagnetwork01 в качестве выделенной сети репликации, отключите репликацию для MapiDagNetwork, выполнив следующую команду.

    Set-DatabaseAvailabilityGroupNetwork -Identity DAG1\MapiDagNetwork -ReplicationEnabled:$false

После отключения репликации для MapiDagNetwork служба репликации Microsoft Exchange использует ReplicationDagNetwork01 для непрерывной репликации. Если произойдет сбой ReplicationDagNetwork01, то служба репликации Microsoft Exchange вернется к использованию MapiDagNetwork для непрерывной репликации. Это преднамеренное действие системы для обеспечения высокого уровня доступности.

## Развертывание нескольких подсетей и сетей группы обеспечения доступности баз данных

В предыдущем примере несмотря на использование в группе DAG двух различных подсетей (192.168.1.0 и 10.0.0.0) эта группа считается группой DAG с одной подсетью, потому что все члены группы используют одну подсеть для формирования сети MAPI. Когда члены группы DAG используют различные подсети для сети MAPI, такая группа называется *группой DAG с несколькими подсетями*. В группах DAG с несколькими подсетями соответствующие подсети будут автоматически назначаться каждой сети DAG.

Например, рассмотрим группу DAG2 с двумя членами, каждый из которых имеет по два сетевых адаптера (один выделен для сети MAPI, а другой — для сети репликации) и расположен на отдельном сайте Active Directory, а их сети MAPI находятся в различных подсетях. Примерные параметры конфигурации IP-адреса представлены в следующей таблице.

### Примерные параметры сетевых адаптеров для группы DAG с несколькими подсетями

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Адаптер &quot;сервер-сеть&quot;</th>
<th>IP-адрес/маска подсети</th>
<th>Шлюз по умолчанию</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>EX1-MAPI</p></td>
<td><p>192.168.0.15/24</p></td>
<td><p>192.168.0.1</p></td>
</tr>
<tr class="even">
<td><p>EX1-Репликация</p></td>
<td><p>10.0.0.15/24</p></td>
<td><p>Неприменимо</p></td>
</tr>
<tr class="odd">
<td><p>EX2-MAPI</p></td>
<td><p>192.168.1.15</p></td>
<td><p>192.168.1.1</p></td>
</tr>
<tr class="even">
<td><p>EX2-Репликация</p></td>
<td><p>10.0.1.15</p></td>
<td><p>Неприменимо</p></td>
</tr>
</tbody>
</table>


В следующей конфигурации группа DAG содержит четыре настроенные подсети: 192.168.0.0, 192.168.1.0, 10.0.0.0 и 10.0.1.0. При добавлении EX1 и EX2 в группу перечисляются четыре подсети, но созданы будут только две сети DAG. MapiDagNetwork (192.168.0.0, 192.168.1.0) и ReplicationDagNetwork01 (10.0.0.0, 10.0.1.0). Эти сети будут настроены, как показано в следующей таблице.

### Параметры нумерованных сетей DAG для группы DAG с несколькими подсетями

<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 20%" />
</colgroup>
<thead>
<tr class="header">
<th>Имя</th>
<th>Подсети</th>
<th>Интерфейсы</th>
<th>Доступ MAPI включен</th>
<th>Репликация включена</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>MapiDagNetwork</p></td>
<td><p>192.168.0.0/24</p>
<p>192.168.1.0/24</p></td>
<td><p>EX1 (192.168.0.15)</p>
<p>EX2 (192.168.1.15)</p></td>
<td><p>Да</p></td>
<td><p>Да</p></td>
</tr>
<tr class="even">
<td><p>ReplicationDagNetwork01</p></td>
<td><p>10.0.0.0/24</p>
<p>10.0.1.0/24</p></td>
<td><p>EX1 (10.0.0.15)</p>
<p>EX2 (10.0.1.15)</p></td>
<td><p>Нет</p></td>
<td><p>Да</p></td>
</tr>
</tbody>
</table>


## Сети DAG и iSCSI

По умолчанию в группах DAG выполняется поиск всех сетей, обнаруженных и настроенных для использования с помощью базового кластера. При этом учитываются любые сети Internet SCSI (iSCSI), которые используются в результате применения хранилища iSCSI для одного или нескольких членов DAG. Рекомендуется использовать для хранилища iSCSI выделенные сети и сетевые адаптеры. Эти сети не должны управляться группами DAG и ее кластерами или использоваться в качестве сетей DAG (MAPI или репликация). Вместо этого для них необходимо вручную отключить использование группой DAG и выделить их для трафика хранилища iSCSI. Для отключения обнаружения и использования сетей iSCSI в качестве сетей DAG, настройте DAG так, чтобы игнорировать любые обнаруженные сети iSCSI, с помощью командлета [Set-DatabaseAvailabilityGroupNetwork](https://technet.microsoft.com/ru-ru/library/dd298008\(v=exchg.150\)), как показано в следующем примере:

    Set-DatabaseAvailabilityGroupNetwork -Identity DAG2\DAGNetwork02 -ReplicationEnabled:$false -IgnoreNetwork:$true

Эта команда также отключит использование сети кластером. Хотя сети iSCSI по-прежнему будут отображаться как сети DAG, они не будут использоваться для трафика репликации или MAPI после выполнения предыдущей команды.

В начало

## Настройка членов DAG

Серверы почтовых ящиков, являющиеся членами группы DAG, имеют несколько свойств, относящихся к обеспечению высокого уровня доступности, которые необходимо настроить, как описано в следующих разделах.

  - Automatic database mount dial

  - Database copy automatic activation policy

  - Maximum active databases

## Автоматическое подключение базы данных

Параметр *AutoDatabaseMountDial* определяет поведение при автоматическом подключении базы данных после отработки отказа базой данных. С помощью командлета [Set-MailboxServer](https://technet.microsoft.com/ru-ru/library/aa998651\(v=exchg.150\)) можно настроить одно из следующих значений параметра *AutoDatabaseMountDial*.

  - `BestAvailability`   Если указано это значение, база данных будет автоматически подключаться сразу после отработки отказа, если длина очереди копирования не превышает 12. Длина очереди копирования — это число журналов, определяемых пассивной копией, для которых необходимо выполнить репликацию. Если значение длины очереди копирования превышает 12, база данных не будет подключаться автоматически. Если длина очереди копирования не превышает 12, Exchange попытается реплицировать оставшиеся журналы на пассивную копию и подключит базы данных.

  - `GoodAvailability`   Если указано это значение, база данных будет автоматически подключаться сразу после отработки отказа, если длина очереди копирования не превышает 6. Длина очереди копирования — это число журналов, определяемых пассивной копией, для которых необходимо выполнить репликацию. Если значение длины очереди копирования превышает 6, база данных не будет подключаться автоматически. Если длина очереди копирования не превышает 6, Exchange попытается реплицировать оставшиеся журналы на пассивную копию и подключит базу данных.

  - `Lossless`   Если указано это значение, база данных не будет подключаться автоматически до копирования в пассивную копию всех журналов, созданных в активной копии. При этом значении алгоритмом выбора лучшей копии диспетчера Active Manager возможные кандидаты для активации будут выбираться на основе значения приоритета активации копии базы данных, а не длины очереди копии.

По умолчанию используется значение `GoodAvailability`. Если установлено значение `BestAvailability` или `GoodAvailability`, но все журналы в активной копии не могут быть скопированы в пассивную активируемую копию, может произойти потеря данных почтовых ящиков. Тем не менее, функция системы безопасности (которая включена по умолчанию) обеспечивает защиту от потери данных благодаря повторной отправке сообщений в очереди системы безопасности.

## Пример. Настройка автоматического подключения базы данных

В следующем примере для параметра *AutoDatabaseMountDial* сервера почтовых ящиков устанавливается значение `GoodAvailability`.

    Set-MailboxServer -Identity EX1 -AutoDatabaseMountDial GoodAvailability

## Политика автоматической активации копии базы данных

Параметр *DatabaseCopyAutoActivationPolicy* указывает тип автоматической активации, доступной для копий базы данных почтовых ящиков на выбранных серверах почтовых ящиков. С помощью командлета [Set-MailboxServer](https://technet.microsoft.com/ru-ru/library/aa998651\(v=exchg.150\)) можно настроить одно из следующих значений параметра *DatabaseCopyAutoActivationPolicy*.

  - `Blocked`   Если указано это значение, автоматическая активация баз данных на выбранных серверах почтовых ящиков невозможна.

  - `IntrasiteOnly`   Если указано это значение, активация копии базы данных разрешается на серверах одного сайта Active Directory. Это предотвращает отработку отказа или активацию между сайтами. Это свойство предназначено для входящих копий базы данных почтовых ящиков (например, пассивная копия становится активной). Базы данных не могут быть активированы на этом сервере почтовых ящиков для копий баз данных, которые активны на другом сайте Active Directory.

  - `Unrestricted`   Если указано это значение, для активации копий базы данных почтовых ящиков на выбранных серверах почтовых ящиков не применяются специальные ограничения.

## Пример. Настройка политики автоматической активации копии базы данных

В следующем примере для параметра *DatabaseCopyAutoActivationPolicy* сервера почтовых ящиков устанавливается значение `Blocked`.

    Set-MailboxServer -Identity EX1 -DatabaseCopyAutoActivationPolicy Blocked

## Максимальное количество активных баз данных

Параметр *MaximumActiveDatabases* (также используемый с командлетом [Set-MailboxServer](https://technet.microsoft.com/ru-ru/library/aa998651\(v=exchg.150\))) указывает количество баз данных, которые можно подключить к серверу почтовых ящиков. Для соблюдения требований развертывания серверы почтовых ящиков можно настроить таким образом, чтобы не превышалась нагрузка на отдельные серверы почтовых ящиков.

В качестве значения параметра *MaximumActiveDatabases* задается целое число. Когда будет достигнуто максимальное количество баз данных, копии баз данных на сервере не будут активироваться при отработке отказа. Если копии уже активированы на сервере, сервер не позволит выполнить подключение баз данных.

## Пример. Настройка максимального количества активных баз данных

В следующем примере показана настройка сервера почтовых ящиков для поддержки не более 20 активных баз данных.

    Set-MailboxServer -Identity EX1 -MaximumActiveDatabases 20

В начало

## Обслуживание участников DAG

Перед выполнением любого вида обслуживания программного или аппаратного обеспечения для члена группы DAG необходимо сначала перевести этого члена DAG в режим обслуживания. Это подразумевает перемещение всех активных баз данных с сервера и запрет на перемещение активных баз данных на сервер. Сценарий также обеспечивает перемещение всех важных средств поддержки группы DAG, находящихся на сервере (например, роль основного диспетчера Active Manager (PAM)), на другой сервер и блокирует их перемещение назад. В частности, не выполнять следующие задачи:

1.  Чтобы начать процесс опустошения транспортных очередей, выполните `Set-ServerComponentState <ServerName> -Component HubTransport -State Draining -Requester Maintenance`

2.  Чтобы начать процесс опустошения транспортных очередей, выполните команду `Restart-Service MSExchangeTransport`

3.  Чтобы начать процесс очистки всех вызовов единой системы обмена сообщениями, выполните `Set-ServerComponentState <ServerName> -Component UMCallRouter -State Draining -Requester Maintenance`

4.  Чтобы перенаправить сообщения, ожидающие доставки в локальных очередях, на сервер почтовых ящиков, указанный в параметре "Цель", выполните `Redirect-Message -Server <ServerName> -Target <MailboxServerFQDN>`

5.  Чтобы приостановить узел кластера, не позволяющий узлу являться или стать PAM, выполните `Suspend-ClusterNode <ServerName>`

6.  Чтобы переместить все активные базы данных, размещенные на сервере группы DAG, на другие серверы группы DAG, выполните `Set-MailboxServer <ServerName> -DatabaseCopyActivationDisabledAndMoveNow $True`

7.  Чтобы предотвратить размещение на сервере копий активной базы данных, выполните `Set-MailboxServer <ServerName> -DatabaseCopyAutoActivationPolicy Blocked`

8.  Чтобы перевести сервер в режим обслуживания, выполните `Set-ServerComponentState <ServerName> -Component ServerWideOffline -State Inactive -Requester Maintenance`

Чтобы убедиться в готовности сервера к обслуживанию, выполните следующие задачи.

1.  Чтобы убедиться, что сервер переведен в режим обслуживания, выполните `Get-ServerComponentState <ServerName> | ft Component,State -Autosize`

2.  Чтобы убедиться, что на сервере нет копий активной базы данных, выполните `Get-MailboxServer <ServerName> | ft DatabaseCopy* -Autosize`

3.  Чтобы убедиться, что узел приостановлен, выполните `Get-ClusterNode <ServerName> | fl`

4.  Чтобы убедиться, что были опустошены все транспортные очереди, выполните `Get-Queue`

По завершении обслуживания и при готовности члена DAG к возобновлению работы можно перевести член DAG из режима обслуживания в рабочий режим, выполнив следующие задачи.

  - Чтобы обозначить выход сервера из режима обслуживания, выполните `Set-ServerComponentState <ServerName> -Component ServerWideOffline -State Active -Requester Maintenance`

  - Чтобы разрешить прием сервером вызовов единой системы обмена сообщениями, выполните `Set-ServerComponentState <ServerName> -Component UMCallRouter -State Active -Requester Maintenance`

  - Чтобы возобновить работу узла в кластере и включить полную функциональность кластера для сервера, выполните `Resume-ClusterNode <ServerName>`

  - Чтобы разрешить базам данных стать активными на сервере, выполните `Set-MailboxServer <ServerName> -DatabaseCopyActivationDisabledAndMoveNow $False`

  - Для снятия блокировки автоматической активации выполните `Set-MailboxServer <ServerName> -DatabaseCopyAutoActivationPolicy Unrestricted`

  - Чтобы включить транспортные очереди и разрешить серверу принимать и обрабатывать сообщения, выполните команду `Set-ServerComponentState <ServerName> -Component HubTransport -State Active -Requester Maintenance`

  - Чтобы возобновить действие транспорта, выполните команду `Restart-Service MSExchangeTransport`

Чтобы убедиться, что сервер готов к использованию в производственной среде, выполните следующие действия.

1.  Чтобы проверить, не работает ли сервер в режиме обслуживания, выполните команду `Get-ServerComponentState <ServerName> | ft Component,State -Autosize`

Если вы устанавливаете обновление Exchange, и процесс обновления заканчивается сбоем, на сервере могут остаться некоторые компоненты в неактивном состоянии. Они будут отображаться при выводе вышеупомянутого командлета Get-ServerComponentState. Чтобы устранить эту проблему, выполните следующие команды:

  - `Set-ServerComponentState <ServerName> -Component ServerWideOffline -State Active -Requester Functional`

  - `Set-ServerComponentState <ServerName> -Component Monitoring -State Active -Requester Functional`

  - `Set-ServerComponentState <ServerName> -Component RecoveryActionsEnabled -State Active -Requester Functional`

В начало

## Завершение работы участников группы обеспечения доступности базы данных

Решение высокой надежности Exchange 2013 интегрировано с процессом завершения работы Windows. Если администратор или приложение инициирует завершение работы сервера Windows в группе DAG, к которому подключена база данных, реплицированная на один или несколько серверов группы DAG, система попытается активировать другую копию подключенной базы данных до того, как разрешить завершение работы.

Тем не менее, это новое поведение не гарантирует, что все базы данных на отключаемом сервере пройдут активацию `lossless`. Поэтому перед завершением работы сервера, который является участником группы DAG, лучше выполнить его переключение.

В начало

## Установка обновлений на членах группы DAG

Установка обновлений Microsoft Exchange Server 2013 на сервере, который входит в группу обеспечения доступности баз данных, является относительно простым процессом. При установке накопительного пакета обновления на сервере, который является членом группы DAG, выполняется остановка нескольких служб, в том числе всех служб Exchange и службы кластеров. Общий процесс применения обновлений для участника группы DAG выглядит следующим образом.

1.  С помощью шагов, указанных выше, переведите члена группы DAG в режим обслуживания.

2.  Установите обновление.

3.  С помощью шагов, указанных выше, выведите члена группы DAG из режима обслуживания и верните его в рабочий режим.

4.  Как вариант, можно с помощью сценария RedistributeActiveDatabases.ps1 выполнить балансировку активных копий баз данных в группе DAG.

Вы можете скачать последнее обновление для Exchange 2013 на веб-сайте [Центра загрузки Майкрософт](http://www.microsoft.com/downloads/).

В начало

