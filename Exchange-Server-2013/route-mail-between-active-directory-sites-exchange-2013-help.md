---
title: 'Маршрутизация почты между сайтами Active Directory: Exchange 2013 Help'
TOCTitle: Маршрутизация почты между сайтами Active Directory
ms:assetid: 86b423e3-7bec-4430-9a5a-4f84ce9d82ea
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/JJ916681(v=EXCHG.150)
ms:contentKeyID: 52061267
ms.date: 04/30/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# Маршрутизация почты между сайтами Active Directory

 

_**Применимо к:**Exchange Server 2013_

_**Последнее изменение раздела:**2016-12-09_

Сайт Active Directory — это логический компонент конфигурации, основанный на физических аспектах сети. Основная цель создания сайта Active Directory — определить, какие подсети в сети связаны так, что это позволяет оптимизировать контроль над трафиком репликации Active Directory. Microsoft Exchange Server 2013 распознает и группы обеспечения доступности баз данных (DAG), и сайты Active Directory в качестве границ маршрутизации, а серверы Exchange 2013 принимают решения о маршрутизации на основе топологии сайта Active Directory.

По умолчанию лес Active Directory содержит только один сайт Active Directory. Этот сайт Active Directory имеет следующее имя по умолчанию: `Default-First-Site-Name`. Если не создано никаких других сайтов Active Directory, все компьютеры-участники домена в лесу являются участниками `Default-First-Site-Name`. Сопоставление подсети и сайта настраивать не требуется. Если созданы дополнительные сайты Active Directory, необходимо указать подсети, сопоставленные с этим сайтом Active Directory.

**Содержание**

Определение членства на сайте

IP-связи сайтов

Управление стоимостями IP-связей сайтов

Внедрение узловых сайтов

Обнаружение топологии

## Определение членства на сайте

Каждый сайт Active Directory сопоставлен с одной или несколькими IP-подсетями. Администратор назначает членство на сайте Active Directory компьютерам, которые настроены в качестве контроллеров домена и серверов глобального каталога. Другим компьютерам, являющимся участниками домена, таким как серверы Exchange, членство на сайте Active Directory назначается автоматически при настройке на использование IP-адреса, который входит в IP-подсеть, связанную с сайтом Active Directory. Подразумевается, что между компьютерами, которые являются участниками одного и того же сайта Active Directory, существует хорошее сетевое подключение. Сервер всегда является участником одного сайта Active Directory.

Если приложение может определить, к какому сайту Active Directory принадлежит компьютер, на котором оно установлено, и другие компьютеры в лесу, а затем использовать эти сведения для управления потоком сообщений, то это означает, что приложение поддерживает сайты. Когда приложениям, поддерживающим сайты, необходимо использовать службы на другом сервере, например на контроллере домена или сервере глобального каталога, приоритет отдается серверам, находящимся на том же сайте Active Directory, что и компьютер, запрашивающий службы.

Exchange 2013 — это приложение, поддерживающее сайты, и оно использует топологию Active Directory для маршрутизации сообщений и связи со службами, запущенными на других компьютерах Exchange 2013. Сайт Active Directory является не только границей маршрутизации, но и границей обнаружения служб.

Для определения принадлежности компьютера, являющегося членом домена, к сайту, требуется последовательность запросов DNS для сравнения локальных IP-адресов с определенными подсетями и последующего определения подходящего сопоставления членства в сайте. Чтобы снизить издержки, связанные с запросами DNS, дополнения схемы Active Directory Exchange 2013 включают в себя атрибут **msExchServerSite** для объекта сервера Exchange. Значение этого атрибута — различающееся имя сайта Active Directory сервера Exchange. Этот атрибут является свойством каждого объекта сервера Exchange. Когда сходство членства на сайтах хранится в качестве атрибута объекта сервера, можно считывать текущую топологию напрямую из Active Directory и не использовать запросы DNS. Кроме того, сопоставление членства на сайтах включается для компьютеров, не принадлежащих к домену, например для подписанных пограничных транспортных серверов.

Значение атрибута **msExchServerSite** заполняется и обновляется службой топологии Microsoft Exchange Active Directory. При запуске компьютера с Windows служба сетевого входа в систему определяет членство компьютера на сайте. Служба сетевого входа в систему использует эти сведения для обнаружения контроллеров домена, которые расположены на том же сайте Active Directory, что и локальный компьютер, а затем направляет запросы на авторизацию и проверку подлинности на эти серверы. Служба топологии Microsoft Exchange Active Directory использует вызов API **DsGetSiteName** для получения значения членства на сайте от службы сетевого входа в систему и записывает различающееся имя сайта Active Directory в атрибут **msExchServerSite** для объекта сервера Exchange в службе каталогов Active Directory.

В следующей таблице показан способ определения сайтов Active Directory в организации. В этом примере определены три сайта Active Directory и каждый сайт Active Directory сопоставлен с несколькими IP-подсетями.

**Пример сопоставления сайтов и подсетей Active Directory**


<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Имя сайта Active Directory</th>
<th>Сопоставленные IP-подсети</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Сайт A</p></td>
<td><p>192.168.1.0/24</p>
<p>192.168.2.0/24</p></td>
</tr>
<tr class="even">
<td><p>Сайт B</p></td>
<td><p>192.168.3.0/24</p>
<p>192.168.4.0/24</p></td>
</tr>
<tr class="odd">
<td><p>Сайт C</p></td>
<td><p>192.168.5.0/24</p>
<p>192.168.6.0/24</p></td>
</tr>
</tbody>
</table>


Если сервер с именем Mailbox01 имеет IP-адрес 192.168.1.1, он является участником сайта A. Чтобы изменить его членство в сайте, необходимо изменить IP-адрес сервера. Если изменить IP-адрес сервера Mailbox01 на 192.168.2.1, его членство на сайте Active Directory не изменится, так как эта подсеть также сопоставлена с сайтом A. Однако при перемещении сервера и изменении его IP-адреса на 192.168.3.1 он будет считаться участником сайта B.

Изменение членства в сайте также может произойти при изменении сопоставления подсетей и сайтов Active Directory. Например, если удалить сопоставление подсети 192.168.3.0 с сайтом B и сопоставить ее с сайтом A, сервер с IP-адресом 192.168.3.1 также станет участником сайта A. При изменении членства на сайте Exchange необходимо обновить сведения о конфигурации, чтобы это изменение учитывалось при принятии Exchange решений о маршрутизации. Между изменением членства на сайте Active Directory и полным распространением изменения топологии существует задержка.

В начало

## IP-связи сайтов

Связи сайтов — это логические пути между сайтами Active Directory. Объект связи сайта представляет набор сайтов, которые могут связываться по единой стоимости. Связи сайтов не соответствуют действительному пути, который проходят сетевые пакеты в физической сети. Тем не менее стоимость, назначенная связи сайтов администратором, обычно обуславливается надежностью, скоростью и доступной пропускной способностью сети. Например, администратор Active Directory может назначить для сетевого подключения со скоростью 100 мегабит в секунду (Мбит/с) более низкую стоимость, чем для сетевого подключения со скоростью 10 Мбит/с.

По умолчанию все связи сайтов являются транзитивными. Это значит, что если сайт A имеет связь с сайтом B, а сайт B — связь с сайтом C, сайт A транзитивно связан с сайтом C. Транзитивная связь между сайтом A и C также называется *мостом связи сайтов*.

Чтобы определить топологию маршрутизации сайта Active Directory, Exchange использует только IP-связи сайтов. Стоимость, назначенная IP-связи сайтов, будет учитываться компонентом маршрутизации Exchange при расчете таблицы маршрутизации. Эти стоимости используются при расчете пути маршрутизации с наименьшей стоимостью к конечному месту назначения сообщения.

Каждый сайт Active Directory должен быть сопоставлен хотя бы с одной IP-связью сайта. Существует единственная IP-связь сайта по умолчанию с именем `DEFAULTIPSITELINK`. При создании сайта Active Directory необходимо сопоставить этот сайт с IP-связью сайта. Можно создать дополнительные IP-связи сайтов для реализации требуемой топологии или сопоставить все сайты Active Directory с `DEFAULTIPSITELINK`. Каждый сайт Active Directory, который входит в IP-связь сайтов, может взаимодействовать напрямую с любым другим сайтом в этой связи по единой стоимости.

На следующем рисунке в лесу настроены четыре сайта Active Directory. Каждый сайт сопоставлен с `DEFAULTIPSITELINK`. Поэтому каждый сайт Active Directory связывается напрямую с любым другим сайтом по той же стоимости. Указано несколько путей связи, но определена только одна IP-связь сайтов.

**Топология полной сетки с одной IP-связью сайтов**

![Топология полной сетки с одной IP-связью сайтов](images/JJ916681.af38d41d-e768-4221-ab4b-b782aa388b73(EXCHG.150).gif "Топология полной сетки с одной IP-связью сайтов")

На следующем рисунке в лесу настроены четыре сайта Active Directory. В этой топологии администратор настроил IP-связи сайтов так, чтобы создать *звездообразную топологию* для сайтов Active Directory. Каждый лучевой сайт может связываться напрямую с центральным сайтом, а также с другими лучевыми сайтами с помощью транзитивных IP-связей сайтов.

**Топология «звезда» IP-связей сайтов Active Directory**

![Топология IP-связей сайтов "звезда"](images/JJ916681.eca6cd51-8c2e-4996-81ea-070cd9766ef8(EXCHG.150).gif "Топология IP-связей сайтов \"звезда\"")

Необходимо учитывать, что Exchange использует связи сайтов при определении пути с наименьшей стоимостью, но при этом всегда пытается доставить сообщения непосредственно на сервер назначения Exchange. Например, если в топологии, показанной на предыдущем рисунке, пользователь на сайте B отправляет сообщение другому пользователю на сайт C, почтовый сервер на сайте B установит подключение напрямую к почтовому серверу на сайте C. Чтобы выполнить принудительную маршрутизацию сообщения через сайт A, необходимо включить этот сайт в качестве узлового сайта. Дополнительные сведения о сайтах концентраторов см. в подразделе «Внедрение сайтов концентраторов» далее в этом разделе.

Администратор Active Directory реализует топологию, которая лучше всего отражает требования к возможности подключения и связи в лесу. Поскольку эта же топология используется Exchange, убедитесь, что текущая топология обеспечивает эффективный обмен сообщениями.

Стоимость связи сайтов по умолчанию — 100. Допустимой стоимостью связи сайтов является любое число от 1 до 99 999. Если заданы избыточные связи, предпочтение всегда будет отдаваться связи, которой назначена более низкая стоимость. Администратор организации Exchange может назначить IP-связи сайтов стоимость, относящуюся к Exchange. Если IP-связи сайтов назначена стоимость Exchange, то Exchange будет использовать ее. В противном случае используется стоимость Active Directory. Дополнительные сведения о способах задания стоимости Exchange для IP-связи сайта см. в разделе "Управление стоимостями IP-связей сайтов" далее в этом разделе. Администратор с членством в группе администраторов предприятия может создавать дополнительные IP-связи сайтов.

Дополнительные сведения о конфигурации сайтов Active Directory см. в разделе [Разработка топологии сайтов](https://go.microsoft.com/fwlink/p/?linkid=33551).

В начало

## Управление стоимостями IP-связей сайтов

Стоимости IP-связей сайтов Active Directory основаны на относительной скорости работы сети по сравнению со всеми сетевыми подключениями в глобальной сети и заданы таким образом, чтобы обеспечивать надежную и эффективную топологию репликации. Поэтому в большинстве случаев существующие стоимости IP-связей сайтов будут эффективными для маршрутизации сообщений Exchange. Тем не менее, если после документирования существующей топологии сайтов и IP-связей сайтов Active Directory выяснится, что стоимости IP-связей сайтов Active Directory и шаблоны потока трафика не являются оптимальными для Exchange, можно внести изменения в стоимости, оцениваемые Exchange. Изменение стоимости, назначенной IP-связи сайтов с помощью средств Active Directory, повлияет на все компоненты среды. Вместо этого можно использовать командлет **Set-AdSiteLink** в командной консоли Exchange, чтобы назначить IP-связи сайтов стоимость, относящуюся к Exchange. Например, чтобы задать значение стоимости, относящейся к Exchange, равным 25 для IP-связи сайта с именем SITELINKAB, выполните следующую команду в командной консоли. `Set-AdSiteLink SITELINKAB -ExchangeCost 25`.

После назначения IP-связи сайтов стоимости, связанной с Exchange, стоимость Exchange переопределяет стоимость Active Directory для целей маршрутизации сообщений, а при маршрутизации стоимость Exchange учитывается только при вычислении пути маршрутизации с наименьшей стоимостью.

Корректировка стоимости IP-связей сайтов может быть полезна, если необходимо, чтобы топология маршрутизации сообщений отличалась от топологии репликации Active Directory. Стоимости Exchange можно использовать для принудительной маршрутизации всех сообщений через узловой сайт. Стоимости Exchange также можно использовать для управления тем, в какие очереди помещаются сообщения, когда нарушается связь с сайтом Active Directory. На следующем рисунке показана топология Active Directory с четырьмя сайтами.

**Топология со стоимостями Exchange, настроенными для IP-связей сайтов**

![Топология со стоимостью Exchange для IP-связей сайтов](images/JJ916681.56ac2bab-99de-4ddf-b968-80cd34ab8c21(EXCHG.150).gif "Топология со стоимостью Exchange для IP-связей сайтов")

На предыдущем рисунке между сайтами C и D существует подключение с низкой пропускной способностью, которое используется только для репликации Active Directory и не должно использоваться для маршрутизации сообщений. Тем не менее, из-за стоимостей IP-связей сайтов Active Directory эта связь включается в путь маршрутизации с наименьшей стоимостью от любого другого сайта Active Directory к сайту D. Поэтому сообщения, которые необходимо доставить на сайт D, помещаются в очередь на сайте C. Администратору Exchange необходимо, чтобы вместо этого путь маршрутизации с наименьшей стоимостью включал в себя сайт B и сообщения помещались в очередь на сайте B, если сайт D недоступен. Задание высокой стоимости Exchange для IP-связи сайтов между сайтами C и D предотвращает ее включение в путь маршрутизации с наименьшей стоимостью до сайта D.

Exchange поддерживает настройку максимального размера сообщения для IP-связи сайтов Active Directory. По умолчанию Exchange не накладывает ограничений на максимальный размер сообщения для сообщений, ретранслируемых между серверами Exchange, расположенными на различных сайтах Active Directory. При использовании командлета **Set-AdSiteLink** для настройки максимального размера сообщения для IP-связи сайта Active Directory в процессе маршрутизации создается отчет о недоставке (NDR) для всех сообщений, размер которых превышает максимально допустимый размер сообщения, заданный для любой связи сайта Active Directory в пути маршрутизации с наименьшей стоимостью. Подобная конфигурация полезна для ограничения размера сообщений, отправляемых на удаленные сайты Active Directory, которые должны взаимодействовать через низкоскоростные подключения. Подробнее см. в разделе [Ограничения на размер сообщений](message-size-limits-exchange-2013-help.md).

В начало

## Внедрение узловых сайтов

В организации Exchange может быть необходимо принудительно доставлять все сообщения через определенный сайт Active Directory. C помощью командной консоли можно назначить сайт Active Directory в качестве узлового сайта. В этом случае появятся дополнительные общие расходы, потому что в процессе доставки сообщений будет задействовано большее количество серверов. Допустим, что сообщение отправляется из сайта A на сайт E. Если путем маршрутизации с наименьшей стоимостью является путь «сайт A — сайт B — сайт C — сайт D — сайт E» и сайт C назначается в качестве концентратора, сообщение ретранслируется с сайта A на сайт C, а затем с сайта C на сайт E.

Чтобы назначить сайт Active Directory в качестве узлового сайта, можно использовать командлет **Set-AdSite**. Если в пути маршрутизации с наименьшей стоимостью, который используется для доставки сообщения, имеется узловой сайт, то до ретрансляции сообщений в конечное место назначения они помещаются в очередь и обрабатываются транспортной службой на серверах почтовых ящиков узлового сайта.

После выбора пути маршрутизации с наименьшей стоимостью определяется, существует ли на этом пути концентратор. Если узловой сайт настроен, то перед ретрансляцией сообщений в конечное место назначения они останавливаются на сервере почтовых ящиков узлового сайта. Если на пути маршрутизации с наименьшей стоимостью существует несколько концентраторов, сообщения будут останавливаться на каждом из них.

Такое отличие от маршрутизации с прямой ретрансляцией существует только в том случае, если концентратор расположен на пути маршрутизации с наименьшей стоимостью. На следующем рисунке показан пример правильного использования концентратора. В этой схеме сайт B настроен в качестве концентратора. Сообщения, маршрутизируемые с сайта A на сайт D, ретранслируются на сайт B до доставки на сайт D.

**Доставка сообщений через центральный сайт**

![Доставка сообщений через центральный сайт](images/JJ916681.93238bcb-6bbc-4a48-aeb0-09342a421b5b(EXCHG.150).gif "Доставка сообщений через центральный сайт")

На следующем рисунке показано, как IP-связи сайтов влияют на маршрутизацию на сайт концентратора. В этом сценарии сайт B назначен в качестве концентратора. Тем не менее, в пути маршрутизации с наименьшей стоимостью между другими сайтами нет сайта B. Поэтому сообщения, маршрутизируемые с сайта A на сайт D никогда не ретранслируются через сайт B. Сайт Active Directory никогда не используется в качестве узлового сайта, если он не входит в путь маршрутизации с наименьшей стоимостью между двумя другими сайтами.

**Неправильно настроенный центральный сайт**

![Неправильно настроенный центральный сайт](images/JJ916681.c010d4d8-5cd3-4b79-b7db-0367ba3cc287(EXCHG.150).gif "Неправильно настроенный центральный сайт")

Любой сайт Active Directory можно настроить в качестве узлового. Но для правильной работы такой конфигурации на узловом сайте должен быть хотя бы один сервер почтовых ящиков.

В начало

## Обнаружение топологии

Топологию Active Directory можно сделать доступной для Exchange с помощью следующих обязательных элементов.

  - Служба топологии Microsoft Exchange Active Directory.

  - Модуль обнаружения топологии в транспортной службе Microsoft Exchange.

Служба топологии Microsoft Exchange Active Directory работает на всех серверах клиентского доступа и почтовых ящиков Exchange 2013. Эти серверы используют службу топологии Microsoft Exchange Active Directory для обнаружения контроллеров домена и серверов глобального каталога, которые могут быть использованы серверами Exchange для чтения и записи данных Active Directory. Exchange 2013 связывается с идентифицированными серверами каталога, когда Exchange необходимо читать или записывать данные в службу каталогов Active Directory.

Модуль обнаружения топологии является частью транспортной службы Microsoft Exchange. Он предоставляет сведения о топологии Active Directory серверам Exchange. Этот API обнаруживает серверы и роли Exchange в организации и определяет их отношение к объектам конфигурации Active Directory. Выполняется получение данных конфигурации из службы каталогов Active Directory и их кэширование, что обеспечивает доступ к ним для служб Exchange, запущенных на этом компьютере.

Для создания топологии маршрутизации Exchange модуль обнаружения топологии выполняет следующие действия.

1.  Выполняется чтение данных из Active Directory. Получаются все следующие объекты:
    
      - Сайты Active Directory.
    
      - IP-связи сайтов;
    
      - Все серверы Exchange.

2.  Данные, полученные на шаге 1, используются для создания исходной топологии и начала связывания и сопоставления соответствующих объектов конфигурации.

3.  Серверы Exchange сопоставляются с сайтами Active Directory путем получения значения атрибута сайта от объекта сервера Exchange, который хранится в Active Directory.

4.  Таблицы маршрутизации обновляются на основе полученных сведений.

В результате этого процесса все серверы Exchange 2013 получают сведения о наличии других серверов Exchange в организации и о том, как далеко друг от друга находятся серверы Exchange.

В начало

