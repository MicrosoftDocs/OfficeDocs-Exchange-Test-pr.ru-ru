---
title: 'Маршрутизация почты: Exchange 2013 Help'
TOCTitle: Маршрутизация почты
ms:assetid: 6fd39079-9655-4fd9-9269-c7462c76e0a7
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Aa998825(v=EXCHG.150)
ms:contentKeyID: 50488389
ms.date: 04/30/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# Маршрутизация почты

 

_**Применимо к:**Exchange Server 2013_

_**Последнее изменение раздела:**2015-03-09_

Основная задача службы транспорта, которая существует на всех серверах почтовых ящиков в организации Microsoft Exchange Server 2013, — маршрутизация сообщений, полученных от пользователей и внешних источников, в конечные места назначения. Решения о маршрутизации принимаются во время классификации сообщений. Классификатор — это компонент службы транспорта на сервере почтовых ящиков, который обрабатывает все входящие сообщения и определяет, как поступить с сообщением, на основе сведений о месте назначения.

В настоящее время маршрутизация в Exchange 2013 полностью поддерживает группы обеспечения доступности баз данных (DAG) и использует членство в группе DAG как границу маршрутизации. Почему? В Exchange 2013 все серверы почтовых ящиков поддерживали службу транспорта. Поэтому, если почтовый сервер находится в DAG, основной механизм маршрутизации сообщений тесно связан с DAG. Если группа DAG распространяется на несколько сайтов Active Directory, использование сайта Active Directory в качестве основной границы маршрутизации неэффективно. Exchange 2013 также использует членство в сайтах Active Directory как границу маршрутизации для серверов почтовых ящиков, не принадлежащих к группам обеспечения доступности баз данных, а также для совместимости маршрутизации с предыдущими версиями Exchange. Другие существенные изменения в маршрутизации Exchange 2013:

  - Служба транспорта на сервере почтовых ящиков не взаимодействует напрямую с базой данных почтовых ящиков. Вместо этого служба транспорта взаимодействует со службой транспорта почтовых ящиков на сервере почтовых ящиков. Только служба транспорта почтовых ящиков связывается с базой данных почтовых ящиков на локальном сервере почтовых ящиков. Если сервер почтовых ящиков является участником группы DAG, только служба транспорта почтовых ящиков на сервере почтовых ящиков, на котором хранится активная копия базы данных почтовых ящиков, принимает сообщения для конечного получателя.

  - Удаленные вызовы процедур (RPC) используются службой транспорта почтовых ящиков только для отправки и получения сообщений в локальной базе данных почтовых ящиков. Если сервер почтовых ящиков является членом группы DAG, служба транспорта почтовых ящиков использует RPC только для локальной связи с активными копиями базы данных почтовых ящиков. Другими словами, RPC никогда не используется для связи между серверами. Вместо этого служба транспорта почтовых ящиков и служба транспорта на разных серверах почтовых ящиков всегда связываются по протоколу SMTP.

  - Exchange 2013 использует более точные очереди для удаленных мест назначения. Вместо одной очереди для всех мест назначения на удаленном сайте Active Directory Exchange 2013 ставит сообщения в очередь для конкретных мест в сайте, например для отдельных соединителей отправки.

  - Связанные соединители были убраны. Связанный соединитель — это соединитель получения, связанный с соединителем отправления. Все сообщения, полученные соединителем получения, автоматически переадресовывались соединителю отправки.

**Содержание**

Компоненты маршрутизации

  - Места назначения

  - Группы доставки

  - Очереди

Маршрутизация сообщений

  - Маршрутизация сообщений между сайтами Active Directory

  - Маршрутизация в транспортной службе внешнего интерфейса на серверах клиентского доступа

  - Маршрутизация в транспортной службе почтовых ящиков на серверах почтовых ящиков

  - Маршрутизация в транспортной службе на пограничных транспортных серверах

## Компоненты маршрутизации

Если сообщение получено службой транспорта на сервере почтовых ящиков Exchange 2013, его необходимо классифицировать. Первым этапом классификации сообщения является разрешение получателя. После разрешения получателя можно определить конечное назначение. На следующем этапе — этапе маршрутизации — определяется наилучший способ достижения этого назначения. Маршрутизация Exchange 2013 обобщена для повышения гибкости и упрощения путем внедрения концепций мест назначения и групп доставки.

## Места назначения

В Exchange 2013 конечное место назначения сообщения называется *назначением маршрутизации*. В Exchange 2013 существуют следующие назначения:

  - **Базы данных почтовых ящиков**   Это назначение маршрутизации для любого получателя, почтовый ящик которого расположен на сервере почтовых ящиков в организации Exchange. В Exchange 2013 общие папки являются разновидностью почтовых ящиков, поэтому маршрутизация сообщений в общие папки не отличается от маршрутизации сообщений в почтовые ящики получателей.

  - **Соединитель**   Это соединитель отправки для сообщений SMTP при использовании в качестве назначения маршрутизации. Соединитель агента доставки или внешний соединитель используется в качестве места назначения для маршрутизации сообщений, не использующих SMTP.

  - **Сервер расширения группы рассылки** Это назначение маршрутизации, в котором у группы рассылки есть специальный сервер расширения, ответственный за расширение списка членов этой группы. Сервер расширения группы рассылки всегда является транспортным сервером-концентратором или сервером почтовых ящиков Exchange 2013.

Обратите внимание, что эти же места назначения маршрутизации также существовали в предыдущих версиях Exchange.

В начало

## Группы доставки

В каждом назначении маршрутизации Exchange 2013 имеется коллекция транспортных серверов, которые отвечают за доставку сообщений в назначения маршрутизации. Такая коллекция транспортных серверов называется *группой доставки*. Транспортным сервером может быть сервер почтовых ящиков Exchange 2013 либо сервер Exchange 2010 или Exchange 2007 с установленной ролью транспортного сервера-концентратора. Если назначение маршрутизации — база данных почтовых ящиков, транспортные серверы в группе доставке имеют ту же версию Exchange, что и база данных почтовых ящиков. Если назначение маршрутизации — соединитель или сервер расширения группы рассылки, группа доставки может одновременно содержать серверы почтовых ящиков Exchange 2013 и транспортные серверы-концентраторы Exchange 2010 или Exchange 2007. То, как сообщение маршрутизируется, зависит от отношений между исходным транспортным сервером и целевой группой доставки:

  - Если исходный транспортный сервер входит в целевую группу доставки, назначение маршрутизации будет следующим переходом для сообщения. Сообщение доставляется исходным транспортным сервером в базу данных почтовых ящиков или соединитель на транспортном сервере в группе доставки. Обратите внимание, что когда назначением маршрутизации является сервер расширения группы рассылки, группа рассылки уже будет расширена к тому времени, как сообщения достигнут этапа классификации на сервере расширения группы рассылки. Следовательно, назначение маршрутизации на сервере расширения группы рассылки — это всегда соединитель или база данных почтовых ящиков.

  - Если исходный транспортный сервер находится за пределами целевой группы доставки, сообщение ретранслируется по пути маршрутизации с наименьшей стоимостью в конечную группу доставки. В зависимости от размера и сложности топологии Exchange сообщение ретранслируется на другие транспортные серверы по пути маршрутизации с наименьшей стоимостью или передается напрямую на транспортный сервер в целевой группе доставки.

В Exchange 2013 существуют следующие типы групп рассылки:

  - **Маршрутизируемая DAG**   Это коллекция серверов почтовых ящиков Exchange 2013, которые принадлежат к одной группе DAG. Базы данных почтовых ящиков в группе DAG являются назначениями маршрутизации, которые обрабатываются данной группой доставки. Когда сообщение поступает в службу транспорта на сервере почтовых ящиков, который принадлежит к группе DAG, служба транспорта отправляет сообщение в службу транспорта почтовых ящиков на сервере почтовых ящиков в группе обеспечения доступности баз данных, где в текущий момент находится активная копия базы данных почтовых ящиков. Служба транспорта почтовых ящиков на конечном сервере почтовых ящиков затем доставляет сообщение в локальную базу данных почтовых ящиков. Хотя группа DAG может содержать серверы почтовых ящиков в разных сайтах Active Directory, DAG является границей группы доставки.

  - **Группа доставки почты**   Это коллекция серверов Exchange одинаковой версии в одном сайте Active Directory. Сайт Active Directory — граница группы доставки. Назначения маршрутизации и группы доставки, обслуживающие их, разделяются основными выпусками Exchange в сайте Active Directory. Базы данных почтовых ящиков, расположенные на серверах почтовых ящиков Exchange 2010, обслуживаются транспортными серверами-концентраторами Exchange 2010 в сайте Active Directory. Базы данных почтовых ящиков, расположенные на серверах почтовых ящиков Exchange 2007, обслуживаются транспортными серверами-концентраторами Exchange 2007 в сайте Active Directory. Базы данных почтовых ящиков, расположенные на серверах почтовых ящиков Exchange 2013 в сайте Active Directory, которые не принадлежат к группе DAG, обслуживаются службой транспорта на серверах почтовых ящиков Exchange 2013 в сайте Active Directory. То, как сообщение доставляется в базу данных почтовых ящиков, зависит от версии сервера Exchange:
    
      - **Exchange 2013**   После того как сообщение поступает на конечный сервер почтовых ящиков в целевом сайте Active Directory, служба транспорта использует SMTP для передачи сообщения в службу транспорта почтовых ящиков. Она затем доставляет сообщение в локальную базу данных почтовых ящиков с использованием RPC.
    
      - **Exchange 2010 или Exchange 2007**. После того как сообщение поступает на случайный транспортный сервер-концентратор той же версии на целевом сайте Active Directory, драйвер хранилища на транспортном сервере-концентраторе использует RPC для записи сообщения в базу данных почтовых ящиков.

  - **Исходные серверы соединителя.**   Это смешанный набор транспортных серверов-концентраторов Exchange 2010 или Exchange 2007 либо серверов почтовых ящиков Exchange 2013, которые считаются исходными серверами для соединителя отправки, соединителя агента доставки или внешнего соединителя. Соединитель является назначением маршрутизации,которое обслуживается этой группой маршрутизации. Если соединитель настроен на определенный сервер, только этот сервер может выполнять маршрутизацию сообщений в место назначения, заданное соединителем. Эта группа доставки может содержать транспортные серверы-концентраторы Exchange 2010 или Exchange 2007 либо серверы почтовых ящиков Exchange 2013, расположенные в разных сайтах Active Directory.

  - **Сайт Active Directory.**   В некоторых случаях сайт Active Directory не является конечным местом назначения сообщения, но сообщение должно пройти через транспортный сервер-концентратор Exchange 2010 или Exchange 2007 либо сервер почтовых ящиков Exchange 2013 в этом сайте Active Directory. Причины таких обстоятельств:
    
      - Если сайт Active Directory настроен в качестве сайта-концентратора. Если сайт-концентратор стоит на пути маршрутизации с наименьшей стоимостью для доставки сообщения, сообщения помещаются в очередь и обрабатываются транспортными серверами-концентраторами на сайте-концентраторе до ретрансляции в конечное место назначения.
    
      - Если пограничный транспортный сервер подписан на сайт Active Directory. Такие подписанные пограничные транспортные серверы недоступны напрямую из других сайтов Active Directory. Обратите внимание, что пограничным транспортным сервером могут быть Exchange 2013, Exchange 2010 или Exchange 2007.
    
    <table>
    <thead>
    <tr class="header">
    <th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td>Задержка разветвления используется только в случае, если группа доставки — сайт Active Directory. Задержка разветвления призвана уменьшить число передач сообщений при наличии нескольких получателей с какой-либо общей частью общего пути маршрутизации с наименьшей стоимостью.</td>
    </tr>
    </tbody>
    </table>


  - **Список серверов.**   Это набор из одного или нескольких транспортных серверов-концентраторов Exchange 2010 или Exchange 2007 либо серверов почтовых ящиков Exchange 2013, настроенных в качестве серверов расширения группы рассылки. Сервер расширения групп рассылки — назначение маршрутизации такой группы доставки.

Членство в группе доставки не является взаимоисключающим. Например, сервер почтовых ящиков Exchange 2013, который входит в группу обеспечения доступности базы данных, также может быть исходным сервером для соединителя отправки с заданной областью. Этот сервер почтовых ящиков будет относиться к маршрутизируемой группе доставки DAG для баз данных почтовых ящиков в DAG, а также к группе доставки исходного сервера соединителя для соединителя отправки с заданной областью.

В следующей таблице назначения маршрутизации и группы доставки сопоставлены на основе используемых версий Exchange:


<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>Сервер почтовых ящиков Exchange 2013</th>
<th>Транспортный сервер-концентратор Exchange 2010 или Exchange 2007.</th>
<th>Пограничный транспортный сервер в сети периметра</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>База данных почтовых ящиков в группе обеспечения доступности базы данных</p></td>
<td><p>Маршрутизируемая группа обеспечения доступности баз данных</p></td>
<td><p>Группа доставки в почтовые ящики</p></td>
<td><p>не применимо</p></td>
</tr>
<tr class="even">
<td><p>База данных почтовых ящиков вне группы обеспечения доступности базы данных</p></td>
<td><p>Группа доставки в почтовые ящики</p></td>
<td><p>Группа доставки в почтовые ящики</p></td>
<td><p>не применимо</p></td>
</tr>
<tr class="odd">
<td><p>Соединитель</p></td>
<td><p>Исходные серверы соединителя</p></td>
<td><p>Исходные серверы соединителя</p></td>
<td><p>Сайт Active Directory</p></td>
</tr>
<tr class="even">
<td><p>Сервер расширения группы рассылки</p></td>
<td><p>Список серверов</p></td>
<td><p>Список серверов</p></td>
<td><p>не применимо</p></td>
</tr>
</tbody>
</table>


В начало

## Очереди

С точки зрения отправляющего сервера каждая очередь доставки представляет собой назначение для конкретного сообщения. Когда служба транспорта на сервере почтовых ящиков Exchange 2013 выбирает назначение для сообщения, оно указывается для получателя в атрибуте **NextHopSolutionKey**. Если одно сообщение отправляется нескольким получателям, каждый из них имеет атрибут **NextHopSolutionKey**. Принимающий сервер также выполняет классификацию сообщения и помещает сообщение в очередь для доставки. После помещения сообщения в очередь можно просмотреть ее тип доставки, чтобы определить, будет ли сообщение снова передаваться, когда оно достигнет следующего прыжка. Каждое уникальное значение **NextHopSolutionKey** соответствует отдельной очереди доставки.

Подробнее см. в подразделе "NextHopSolutionKey" темы [Очереди](queues-exchange-2013-help.md).

В начало

## Маршрутизация сообщений

Если сообщение должно быть доставлено в удаленную группу доставки, необходимо определить для него путь маршрутизации. Exchange 2013 использует следующую логику для выбора пути маршрутизации сообщения. Эта логика практически не изменилась по сравнению с Exchange 2010:

1.  Сначала рассчитывается маршрут с наименьшей стоимостью путем сложения стоимости связей сайтов IP, которые необходимо пройти для достижения сервера назначения. Если назначением является соединитель, стоимость, назначенная адресному пространству, добавляется к стоимости достижения указанного соединителя. Если возможно несколько путей маршрутизации, используется только путь маршрутизации с наименьшей совокупной стоимостью.

2.  Если существует несколько путей маршрутизации с одинаковой совокупной стоимостью, оценивается количество прыжков в каждом пути. Используется путь маршрутизации с наименьшим количеством прыжков.

3.  Если все же доступно несколько путей маршрутизации, используется имя, данное сайтам Active Directory перед сервером назначения. Используется путь маршрутизации, в котором ближайший к месту назначения сайт Active Directory имеет минимальное буквенно-цифровое значение. Если ближайший к месту назначения сайт для всех путей маршрутизации оказывается один и тот же, рассматриваются имена предыдущих сайтов.

В Exchange 2010 каждый получатель сообщения всегда связан только с одним сайтом Active Directory и существует только один наиболее экономичный маршрут от исходного сайта Active Directory к конечному сайту Active Directory. В Exchange 2013 группа доставки может включать несколько сайтов Active Directory и могут существовать различные маршруты наименьшей стоимости к этим сайтам Active Directory. Exchange 2013 определяет один сайт Active Directory в рамках целевой группы доставки как *основной сайт*. Основной сайт — самый близкий сайт Active Directory с точки зрения описанной выше логики маршрутизации. Чтобы успешно маршрутизировать сообщения между группами доставки, Exchange 2013 берет во внимание следующие моменты:

  - **Наличие одного или нескольких сайтов-концентраторов на пути маршрутизации с наименьшей стоимостью**   Если путь маршрутизации с наименьшей стоимостью к основному сайту включает сайты-концентраторы, сообщение должно проводиться через сайты-концентраторы. Ближайший сайт-концентратор на пути маршрутизации с наименьшей стоимостью будет выбран в качестве новой группы доставки — **AD site**, в которую входят все транспортные серверы на этом сайте. После прохода сайта-концентратора маршрутизация сообщения по пути маршрутизации с наименьшей стоимостью продолжается. Если основной сайт оказался сайтом-концентратором, то он все же считается сайтом-концентратором по следующим причинам:
    
      - Если целевая группа доставки охватывает несколько сайтов Active Directory, исходный сервер должен подключаться только к серверам-концентраторам в сайте-концентраторе.
    
      - Серверы в сайте-концентраторе, которые фактически принадлежат к целевой группе доставки, являются предпочтительными.
    
    Как и в предыдущей версии сервера Exchange, все сайты-концентраторы не на пути маршрутизации с наименьшей стоимостью к основному сайту игнорируются.

  - **Целевой сервер Exchange Server, выбираемый в конечной группе маршрутизации**   Когда целевая группа доставки охватывает несколько сайтов Active Directory, путь маршрутизации к конкретным серверам в группе доставки может быть разным по цене. Серверы, расположенные в ближайшем сайте Active Directory, выбираются как целевые для группы доставки на основе пути маршрутизации с наименьшей стоимостью, и сайт Active Directory, где находятся эти серверы, выбирается в качестве основного сайта.

  - **Резервные варианты в случае, если подключение не удается установить ни с одним сервером в целевой группе маршрутизации**   Если целевая группа доставки охватывает несколько сайтов Active Directory, первый резервный вариант — все остальные серверы в целевой группе доставки в других сайтах Active Directory, не выбранные как целевые серверы. Выбора сервера осуществляется в зависимости от стоимости маршрута до других сайтов Active Directory. Если целевая группа доставки содержит серверы в локальном сайте Active Directory, не существует других резервных вариантов, так как сообщение находится в непосредственной близости к назначению маршрутизации. Если целевая группа поставки содержит серверы на удаленных сайтах Active Directory, резервный вариант — попытка подключения ко всем другим серверам в основном сайте. Если это не удается сделать, резервный вариант — использование пути маршрутизации с наименьшим маршрутом к основному сайту. Exchange 2013 пытается доставить сообщения как можно ближе к месту назначения, выполняя отход (прыжок за прыжком) по пути маршрутизации с наименьшей стоимостью до установки подключения.

В начало

## Маршрутизация сообщений между сайтами Active Directory

Exchange 2013 маршрутизирует сообщения между сайтами Active Directory практически то же, как Exchange 2010. Дополнительные сведения см. в разделе [Маршрутизация почты между сайтами Active Directory](route-mail-between-active-directory-sites-exchange-2013-help.md).

В начало

## Маршрутизация в транспортной службе внешнего интерфейса на серверах клиентского доступа

Эта служба выступает в роли прокси-сервера без сведений о состоянии для всего входящего и (при необходимости) исходящего внешнего SMTP-трафика для организации Exchange 2013. В случае исходящих сообщений служба транспорта использует соединители отправки, чтобы взаимодействовать со службой транспорта переднего плана на сервере клиентского доступа. Строго говоря, исходящие сообщения передаются через транспортную службу внешнего интерфейса, если параметр *FrontEndProxyEnabled* у применимого соединителя отправки имеет значение `$true` или включен параметр **Прокси через сервер клиентского доступа** в свойствах соединителя отправки в Центре администрирования Exchange (EAC). Будет выбран любой сервер клиентского доступа в локальном сайте Active Directory. Обратите внимание, что у транспортной службы внешнего интерфейса нет соединителей отправки.

В случае входящих сообщений служба транспорта переднего плана должна быстро найти отдельную работающую службу транспорта на сервере почтовых ящиков, чтобы получить передаваемое сообщение независимо от числа и типа получателей. При невыполнении этого требования служба электронной почты будет восприниматься как недоступная для внешних отправителей. Как и служба транспорта, служба транспорта переднего плана загружает таблицы маршрутизации на основе сведений из Active Directory, и использует группы доставки для маршрутизации сообщений. Тем не менее таблицы маршрутизации, используемые службой транспорта переднего плана, отличаются следующими уникальными характеристиками:

  - Служба транспорта переднего плана не считается членом группы доставки, даже когда сервер почтовых ящиков и сервер клиентского доступа установлены на одном физическом сервере. Это принуждает службу транспорта переднего плана взаимодействовать только со службой транспорта.

  - Таблицы маршрутизации не содержат маршрутов соединителей отправки.

  - Таблицы маршрутизации содержат специальный список серверов почтовых ящиков в локальном сайте Active Directory для целей быстрого восстановления после сбоя.

Маршрутизация в службе транспорта переднего плана определяет по получателям сообщения нужные базы данных почтовых ящиков. Список серверов почтовых ящиков, используемых службой транспорта переднего плана, определяется по базам данных почтовых ящиков у получателей сообщения. Примечание. Ни у кого из получателей может не быть почтового ящика, например, если получателем является группа рассылки или почтовый пользователь. Для каждой базы данных почтовых ящиков служба транспорта переднего плана ведет поиск группы доставки и связанной маршрутной информации. Группы доставки, которые используются службой транспорта:

  - Маршрутизируемая группа обеспечения доступности баз данных

  - Группа доставки в почтовые ящики

  - Сайт Active Directory

В зависимости от числа и типа получателей служба транспорта переднего плана выполняет одно из следующих действий:

  - В случае отправки сообщений электронной почты с одним получателем выберите сервер почтовых ящиков в целевой группе доставки, отдавая при этом предпочтение серверу почтовых ящиков на основании близости к сайту Active Directory. Передача сообщения получателю может включать маршрутизацию через узловой сайт.

  - В случае отправки сообщений электронной почты с несколькими получателями используйте первых 20 получателей для выбора сервера почтовых ящиков в самой близкой группе доставки на основании близости к сайту Active Directory. Обратите внимание, что разделение сообщений не выполняется в службе транспорта переднего плана, поэтому в конечном счете выбирается только один сервер почтовых ящиков независимо от числа получателей сообщения.

  - Если сообщение не имеет получателей с почтовыми ящиками, выбирается случайный сервер почтовых ящиков в локальном сайте Active Directory.

В начало

## Маршрутизация в транспортной службе почтовых ящиков на серверах почтовых ящиков

В ее состав входят две отдельные службы: транспортная служба отправки почты в почтовый ящик и транспортная служба доставки почты в почтовый ящик. Для входящих сообщений служба транспорта почтовых ящиков получает сообщения SMTP из службы транспорта и подключается к локальной базе данных почтовых ящиков с помощью RPC для доставки сообщения. Для исходящих сообщений служба транспорта почтовых ящиков соединяется с локальной базой данных почтовых ящиков с использованием RPC для извлечения сообщений и передает сообщения через SMTP в службу транспорта. Служба транспорта почтовых ящиков не имеет состояний и не поддерживает локальную очередь сообщений.

Как и служба транспорта, служба транспорта почтовых ящиков загружает таблицы маршрутизации на основе сведений из Active Directory, и использует группы доставки для маршрутизации сообщений. Однако существуют аспекты маршрутизации, уникальные для службы транспорта почтовых ящиков:

  - Поскольку служба транспорта и служба транспорта почтовых ящиков размещаются на одном сервере почтовых ящиков Exchange 2013, служба транспорта почтовых ящиков всегда принадлежит к той же самой группе доставки, что и сервер почтовых ящиков. Это группа доставки называется *локальной*.

  - Служба отправки транспорта почтовых ящиков не отправляет сообщения автоматически в службу транспорта на локальном сервере почтовых ящиков или на других серверах почтовых ящиков в своей локальной группе доставки. Служба отправки транспорта почтовых ящиков имеет доступ к тем же сведениями о топологии маршрутизации, что и служба транспорта, так что служба отправки транспорта почтовых ящиков может отправлять сообщения в службу транспорта на серверах почтовых ящиков за пределами группы доставки. Серверы почтовых ящиков в локальной группе доставки используются как резервные варианты, а также для доставки получателям без почтовых ящиков.

  - Служба транспорта почтовых ящиков взаимодействует лишь со службой транспорта на серверах почтовых ящиков Exchange 2013.

  - Служба транспорта почтовых ящиков взаимодействует только с базами данных почтовых ящиков на локальном сервере почтовых ящиков Exchange 2013. Служба транспорта почтовых ящиков не взаимодействует с базами данных почтовых ящиков на других серверах почтовых ящиков.

Когда пользователь отправляет сообщения из своего почтового ящика, служба отправки транспорта почтовых ящиков определяет по получателям сообщения нужные базы данных почтовых ящиков. Список серверов почтовых ящиков, используемых службой отправки транспорта почтовых ящиков, определяется по базам данных почтовых ящиков у получателей сообщения. Примечание. Ни у кого из получателей может не быть почтового ящика, например, если получателем является группа рассылки или почтовый пользователь. Для каждой базы данных почтовых ящиков служба отправки транспорта почтовых ящиков ведет поиск группы доставки и связанной маршрутной информации. Группы доставки, которые используются службой отправки транспорта почтовых ящиков:

  - Маршрутизируемая группа обеспечения доступности баз данных

  - Группа доставки в почтовые ящики

  - Сайт Active Directory

В зависимости от числа и типа получателей служба отправки транспорта почтовых ящиков выполняет одно из следующих действий:

  - В случае отправки сообщений электронной почты с одним получателем выберите сервер почтовых ящиков в целевой группе доставки, отдавая при этом предпочтение серверу почтовых ящиков на основании близости к сайту Active Directory. Передача сообщения получателю может включать маршрутизацию через узловой сайт.

  - В случае отправки сообщений электронной почты с несколькими получателями используйте первых 20 получателей для выбора сервера почтовых ящиков в самой близкой группе доставки на основании близости к сайту Active Directory.

  - Если сообщение не имеет получателей с почтовыми ящиками, выбирается сервер почтовых ящиков в локальной группе доставки.

Если служба доставки транспорта почтовых ящиков получает сообщение от службы транспорта, она принимает либо отклоняет его для доставки в локальную базу данных почтовых ящиков. Служба доставки транспорта почтовых ящиков может доставить сообщение в том случае, если получатель находится в активной копии локальной базы данных почтовых ящиков. Если же получатель отсутствует в активной копии локальной базы данных почтовых ящиков, служба доставки транспорта почтовых ящиков не может доставить сообщение и должна сообщить о недоставке в службу транспорта. Например, если активная копия базы данных почтовых ящиков недавно перемещена на другой сервер, служба транспорта может ошибочно передать сообщение на сервер почтовых ящиков, который теперь содержит неактивную копию базы данных почтовых ящиков. Среди ответов о недоставке, которые служба доставки транспорта почтовых ящиков возвращает службе транспорта, могут быть следующие:

  - Повторная попытка доставки

  - Создается отчет о недоставке

  - Сообщение перенаправляется

В начало

## Маршрутизация в транспортной службе на пограничных транспортных серверах

Если в сети периметра установлен пограничный транспортный сервер, транспортная служба на нем обеспечивает ретрансляцию SMTP и работу служб промежуточных узлов для всего потока почты в Интернет. Сообщения, получаемые из сети Интернет и посылаемые в нее, помещаются в очередь локально на пограничном транспортном сервере. Очереди соответствуют внешним доменам или соединителям отправки. Подробнее см. в подразделе "NextHopSolutionKey" темы [Очереди](queues-exchange-2013-help.md).

Как правило, при установке пограничного транспортного сервера в вашей сети периметра вы подписываете пограничный транспортный сервер на сайт Active Directory. Сайт Active Directory содержит серверы почтовых ящиков, которые будут ретранслировать сообщения на пограничный транспортный сервер и обратно. В процессе пограничной подписки создается членство на сайте Active Directory для пограничного транспортного сервера. Это членство позволяет серверам почтовых ящиков на сайте Active Directory ретранслировать сообщения на пограничный транспортный сервер для доставки в Интернет без настройки явных соединителей отправки.

В конфигурациях с несколькими сайтами исходящая почта от внутренних получателей ко внешним сначала направляется на подписанный сайт Active Directory. Целевой сайт Active Directory является группой доставки. Конечным пунктом маршрутизации является внутриорганизационный соединитель отправки в транспортной службе на любом из серверов почтовых ящиков подписанного сайта Active Directory. *Внутриорганизационный соединитель отправки* — это специальный соединитель отправки, который существует в транспортной службе на каждом сервере почтовых ящиков. Этот соединитель отправки создается неявно, он невидимый и не требует управления. Он используется для ретрансляции сообщений между серверами Exchange.

Исходящие почтовые сообщения для внешних получателей направляются от сервера почтовых ящиков к пограничному транспортному серверу. Сервер клиентского доступа не задействован в маршрутизации почтовых сообщений на подписанный пограничный транспортный сервер. Почтовые сообщения передаются от внутриорганизационного соединителя отправки в транспортной службе сервера почтовых ящиков на соединитель получения в транспортной службе пограничного транспортного сервера. На подписанном пограничном транспортном сервере соединитель получения по умолчанию настроен на прослушивание подключений от внутренних серверов почтовых ящиков на подписанном сайте Active Directory и анонимных подключений через сеть Интернет. После классификации сообщения транспортной службой на пограничном транспортном сервере оно помещается в локальную очередь для доставки в сеть Интернет с помощью специального соединителя отправки, созданного в процессе пограничной подписки.

Входящая почта от внешних получателей поступает на пограничный транспортный сервер через соединитель получения по умолчанию. Сообщения проходят классификацию и помещаются в очередь для доставки. Сообщения ретранслируются через специальный соединитель отправки, созданный пограничной подпиской для отправки почты в организацию Exchange. Дальнейший маршрут сообщений зависит от настройки внутренних серверов Exchange.

  - **Сервер почтовых ящиков и сервер клиентского доступа установлены на одном компьютере**   В этой конфигурации сервер клиентского доступа используется для входящего потока электронной почты. Электронная почта направляется от соединителя отправки в транспортной службе пограничного транспортного сервера на соединитель получения по умолчанию в транспортной службе внешнего интерфейса сервера клиентского доступа, а затем на соединитель получения по умолчанию в транспортной службе сервера почтовых ящиков.

  - **Сервер почтовых ящиков и сервер клиентского доступа установлены на разных компьютерах**   В этой конфигурации входящий поток электронной почты направляется в обход сервера клиентского доступа. Электронная почта направляется от соединителя отправки в транспортной службе пограничного транспортного сервера на соединитель получения по умолчанию в транспортной службе сервера почтовых ящиков.

Если в вашей сети периметра установлены пограничные транспортные серверы Exchange 2007 или Exchange 2010, обработка потока входящей и исходящей почты всегда происходит непосредственно между пограничным транспортным сервером и сервером почтовых ящиков. Сервер клиентского доступа не используется.

В начало

