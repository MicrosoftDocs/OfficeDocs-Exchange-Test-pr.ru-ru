---
title: 'Правила обработки почтового потока и транспорта: Exchange 2013 Help'
TOCTitle: Правила потока обработки почты (правила транспорта)
ms:assetid: c3d2031c-fb7b-4866-8ae1-32928d0138ef
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Dd351127(v=EXCHG.150)
ms:contentKeyID: 50489042
ms.date: 04/30/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# Правила обработки почтового потока и транспорта

 

_**Применимо к:** Exchange Server 2013_

_**Последнее изменение раздела:** 2017-04-28_

С помощью правил потока обработки почты (также называемых правилами транспорта) можно определять сообщения, проходящие через организацию Exchange 2013, и выполнять с ними действия. Правила потока обработки почты подобны правилам для папки "Входящие", доступным в Outlook и Outlook Web App. Основное отличие заключается в том, что правила потока обработки почты выполняют действия с сообщениями во время их передачи, а не после доставки сообщения в почтовый ящик. Правила потока обработки почты включают более широкий спектр условий, исключений и действий, позволяющих реализовать политики обмена сообщениями многих типов.

В данной статье описываются компоненты правил потока обработки почты и принципы их работы.

Сведения о правилах для потока обработки почты в Exchange Online см. в статье [Правила потока обработки почты (правила транспорта) в Exchange Online](https://technet.microsoft.com/ru-ru/library/jj919238\(v=exchg.150\)). Сведения о правилах для потока обработки почты в Exchange Online Protection см. в статье [Правила потока обработки почты (правила транспорта) в Exchange Online Protection](https://technet.microsoft.com/ru-ru/library/dn271424\(v=exchg.150\)).

Для управления правилами потока обработки почты можно использовать Центр администрирования Exchange (EAC) или командную консоль Exchange. Инструкции по управлению правилами транспорта см. в статье [Управление правилами потока обработки почты](manage-mail-flow-rules-exchange-2013-help.md).

Каждое правило можно применить принудительно или тестировать (с уведомлением отправителя или без него). Дополнительные сведения о параметрах тестирования см. в статьях [Тестирование правила обработки почтового потока](test-a-mail-flow-rule-exchange-2013-help.md) и [Советы политик](technical-overview-of-policy-tips-in-exchange-online-and-exchange-2013.md).

Сценарии использования правил для потока обработки почты см. в следующих статьях:

  - [Использование правил транспорта для проверки вложений сообщений](use-transport-rules-to-inspect-message-attachments-exchange-2013-help.md)

  - [Распространенные сценарии блокирования вложений](common-attachment-blocking-scenarios-for-mail-flow-rules-exchange-2013-help.md)

  - [Заявления об отказе, подписи, верхние или нижние колонтитулы на уровне организации](organization-wide-disclaimers-signatures-footers-or-headers-exchange-online-help.md)

  - [Использование правил обработки почтового потока для обхода папки "Несрочные"](use-mail-flow-rules-so-messages-can-bypass-clutter-exchange-2013-help.md)

  - [Использование правил обработки почтового потока для маршрутизации электронной почты с учетом списка слов, фраз или шаблонов](use-mail-flow-rules-to-route-email-based-on-a-list-of-words-phrases-or-patterns-exchange-2013-help.md)

  - [Распространенные сценарии утверждения сообщений](common-message-approval-scenarios-exchange-2013-help.md)

## Компоненты правила обработки почтового потока

Правило для потока обработки почты состоит из условий, исключений, действий и свойств.

  - **Условия** указывают, с какими сообщениями должны выполняться действия. Некоторые условия проверяют поля заголовков сообщений (например, поля "Кому", "От" или "Копия"). Другие условия проверяют свойства сообщений (например, тему, текст, вложения, размер или классификацию сообщения). Для большинства условий требуется указать оператор сравнения (например, "равно", "не равно" или "содержит"), а также значение для сравнения. Если условий или исключений нет, правило применяется ко всем сообщениям.
    
    Дополнительные сведения об условиях правил для потока обработки почты в Exchange 2013 см. в статье [Условия правил транспорта (предикаты)](mail-flow-rule-conditions-and-exceptions-predicates-in-exchange-2013-exchange-2013-help.md).

  - **Исключения** при необходимости указывают сообщения, к которым правило не должно применяться. В исключениях доступны те же идентификаторы сообщений, что и в условиях. Исключения переопределяют условия и запрещают применение действий правила к сообщению, даже если оно соответствует всем настроенным условиям.

  - **Действия** указывают, что делать с сообщениями, которые соответствуют условиям правила и не относятся ни к одному из исключений. Доступно множество действий, таких как отклонение, удаление и перенаправление сообщений, добавление получателей, добавление префиксов к теме сообщения и вставка заявления об отказе в текст сообщения.
    
    Дополнительные сведения о действиях правил для потока обработки почты в Exchange 2013 см. в статье [Действия правил транспорта](mail-flow-rule-actions-in-exchange-2013-exchange-2013-help.md).

  - **Свойства** — это другие параметры правил, не являющиеся условиями, исключениями или действиями. Например, они могут указывать, следует ли принудительно применять правило или проверять его, а также период, в течение которого применяется правило.
    
    Дополнительные сведения см. в разделе Свойства правил для потока обработки почты этой статьи.

## Несколько условий, исключений и действий

В приведенной ниже таблице показан принцип обработки нескольких условий, значений условий, исключений и действий в правиле.


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Компонент</th>
<th>Логический оператор</th>
<th>Комментарии</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Несколько условий</p></td>
<td><p>И</p></td>
<td><p>Сообщение должно соответствовать всем условиям правила. Если требуется соответствие одному из условий, используйте отдельные правила для каждого условия. Например, если требуется добавлять одно и то же заявление об отказе к сообщениям с вложениями и сообщениям, содержащим определенный текст, создайте отдельное правило для каждого из условий. В Центре администрирования Exchange очень легко скопировать правило.</p></td>
</tr>
<tr class="even">
<td><p>Одно условие с несколькими значениями</p></td>
<td><p>ИЛИ</p></td>
<td><p>В некоторых условиях можно указать несколько значений. Сообщение должно соответствовать любому (не обязательно всем) указанным значениям. Например, если тема сообщения — <strong>Сведения о курсах акций</strong>, а в условии <strong>Тема содержит любое из этих слов</strong> указаны слова <strong>Contoso</strong> и <strong>акций</strong>, то условие выполняется, так как тема содержит одно из указанных значений.</p></td>
</tr>
<tr class="odd">
<td><p>Несколько исключений</p></td>
<td><p>ИЛИ</p></td>
<td><p>Если сообщение соответствует какому-либо из исключений, к нему не применяются действия. Сообщение может соответствовать не всем исключениям.</p></td>
</tr>
<tr class="even">
<td><p>Несколько действий</p></td>
<td><p>И</p></td>
<td><p>С сообщениями, соответствующими условиям правила, выполняются все действия, указанные в правиле. Например, если выбраны действия <strong>Добавить в начало темы сообщения</strong> и <strong>Добавить получателей в поле &quot;Скрытая копия&quot;</strong>, к сообщению применяются оба действия.</p>
<p>Необходимо помнить, что некоторые действия, например <strong>Удалить сообщение без уведомления</strong>, препятствуют последующей обработке сообщения другими правилами. Другие действия, например <strong>Переслать сообщение</strong>, запрещают дополнительные действия.</p>
<p>Кроме того, вы можете задать для правила действие, которые останавливает применение последующих правил к сообщению.</p></td>
</tr>
</tbody>
</table>


Компоненты правила обработки почтового потока

## Свойства правил обработки почтового потока

В представленной ниже таблице описываются свойства, доступные в правилах потока обработки почты.


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Имя свойства в Центре администрирования Exchange</th>
<th>Имя параметра в PowerShell</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>Приоритет</strong></p></td>
<td><p><em>Priority</em></p></td>
<td><p>Указывает порядок применения правил к сообщениям. Приоритет по умолчанию зависит от того, когда было создано правило (у старых правил приоритет выше, чем у новых). Чем выше приоритет правила, тем раньше оно обрабатывается.</p>
<p>Чтобы изменить приоритет правила в Центре администрирования Exchange, переместите его вверх или вниз в списке правил. В PowerShell можно задать значение приоритета (0 — это высший приоритет).</p>
<p>Например, если одно правило отклоняет сообщения с номером кредитной карты, а второе требует подтверждения, необходимо, чтобы правило отклонения применялось первым и останавливало обработку других правил.</p>
<p>Дополнительные сведения см. в разделе <a href="manage-mail-flow-rules-exchange-2013-help.md">Установка приоритета для правил потока обработки почты</a>.</p></td>
</tr>
<tr class="even">
<td><p><strong>Режим</strong></p></td>
<td><p><em>Mode</em></p></td>
<td><p>Вы можете сразу начать применять правило к сообщениям или проверить его, не оказывая влияния на доставку сообщений (как с подсказками политики защиты от потери данных, так и без них).</p>
<p>Подсказки политик — это краткие примечания в Outlook и Outlook в Интернете с информацией о возможных нарушениях политики. Дополнительные сведения см. в статье <a href="technical-overview-of-policy-tips-in-exchange-online-and-exchange-2013.md">Советы политик</a>.</p>
<p>Дополнительные сведения о режимах см. в статье <a href="test-a-mail-flow-rule-exchange-2013-help.md">Тестирование правила обработки почтового потока</a>.</p></td>
</tr>
<tr class="odd">
<td><p><strong>Активировать это правило начиная с</strong></p>
<p><strong>Отключить это правило начиная с</strong></p></td>
<td><p><em>ActivationDate</em></p>
<p><em>ExpiryDate</em></p></td>
<td><p>Задает диапазон дат для работы правила.</p></td>
</tr>
<tr class="even">
<td><p>Флажок <strong>Вкл</strong> установлен или снят</p></td>
<td><p>Новые правила: параметр <em>Enabled</em> командлета <strong>New-TransportRule</strong>.</p>
<p>Существующие правила: используйте командлет <strong>Enable-TransportRule</strong> или <strong>Disable-TransportRule</strong>.</p>
<p>Значение отображается в свойстве <strong>State</strong> правила.</p></td>
<td><p>Вы можете создать отключенное правило и включить его, когда будете готовы его проверить. Кроме того, чтобы сохранить параметры, правило можно отключить, не удаляя.</p></td>
</tr>
<tr class="odd">
<td><p><strong>Отложить сообщение, если не завершена обработка правил</strong></p></td>
<td><p><em>RuleErrorAction</em></p></td>
<td><p>Вы можете указать, как должно обрабатываться сообщение, если не удается завершить обработку правила. По умолчанию правило игнорируется, но при желании сообщение можно отправлять на повторную обработку.</p></td>
</tr>
<tr class="even">
<td><p><strong>Соответствие адреса отправителя в сообщении</strong></p></td>
<td><p><em>SenderAddressLocation</em></p></td>
<td><p>Если в правиле используются условия или исключения, проверяющие электронный адрес отправителя, нужное значение можно искать в заголовке, конверте сообщения или одновременно в заголовке и конверте.</p></td>
</tr>
<tr class="odd">
<td><p><strong>Остановить обработку других правил</strong></p></td>
<td><p><em>SenderAddressLocation</em></p></td>
<td><p>Это действие для правила, но в Центре администрирования Exchange оно отображается как свойство. Вы можете остановить применение других правил к сообщению после его обработки данным правилом.</p></td>
</tr>
<tr class="even">
<td><p><strong>Комментарии</strong></p></td>
<td><p><em>Comments</em></p></td>
<td><p>Вы можете описать правило.</p></td>
</tr>
</tbody>
</table>


Компоненты правила обработки почтового потока

## Как правила для потока обработки почты применяются к сообщениям

Все сообщения, которые проходят через вашу организацию, оцениваются на соответствие включенным правилам для потока обработки почты. Правила обрабатываются в порядке, указанном на странице **Поток обработки почты** \> **Правила** в Центре администрирования Exchange, или на основе соответствующего значения параметра *Priority* в PowerShell.

Если найдено соответствие правилу, дальнейшая обработка правил может быть прекращена. Этот параметр важен для сообщений, которые соответствуют условиям в нескольких правилах для потока обработки почты (какое правило вы хотите применить к сообщению? Все? Только одно?).

## Различия обработки в зависимости от типа сообщения

Существует несколько типов сообщений, которые проходят через организацию. Типы сообщений, которые могут быть обработаны правилами транспорта, описаны в таблице ниже.


<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Тип сообщения</th>
<th>Возможность применения правила</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>Обычные сообщения</strong>. Сообщения, которые содержат обычный текст либо текст в формате RTF или HTML. Кроме того, текст может содержать составной или альтернативный набор форматов.</p></td>
<td><p>Да</p></td>
</tr>
<tr class="even">
<td><p><strong>Шифрование сообщений Office 365</strong> . Сообщения, к которым применено Шифрование сообщений Office 365. Дополнительные сведения см. в статье <a href="https://go.microsoft.com/fwlink/p/?linkid=39252">Шифрование сообщений Office 365</a>.</p></td>
<td><p>Правила всегда могут получать доступ к заголовкам конвертов и обрабатывать сообщения при соблюдении условий, проверяющих эти заголовки.</p>
<p>Чтобы правило могло проверить или изменить содержимое зашифрованного сообщения, включите расшифровку транспорта (используя значение Mandatory или Optional; значение по умолчанию — Optional). Дополнительные сведения см. в статье <a href="https://go.microsoft.com/fwlink/p/?linkid=84806">Включение и отключение расшифровки транспорта</a>.</p>
<p>Вы можете также создать правило для автоматической расшифровки зашифрованных сообщений. Дополнительные сведения см. в статье <a href="https://go.microsoft.com/fwlink/p/?linkid=40284">Определение правил для шифрования и расшифровки электронных сообщений</a>.</p></td>
</tr>
<tr class="odd">
<td><p><strong>Зашифрованные S/MIME-сообщения</strong></p></td>
<td><p>Правила могут получать доступ к заголовкам конвертов и обрабатывать сообщения только при соблюдении условий, проверяющих эти заголовки.</p>
<p>Правила с условиями, требующими проверки содержимого сообщения, или действиями, которые меняют содержимое сообщения, не могут обрабатываться.</p></td>
</tr>
<tr class="even">
<td><p><strong>Сообщения с защитой RMS.</strong> Сообщения, к которым применена политика Службы Active Directory Rights Management (AD RMS) или Azure Rights Management (RMS).</p></td>
<td><p>Правила всегда могут получать доступ к заголовкам конвертов и обрабатывать сообщения при соблюдении условий, проверяющих эти заголовки.</p>
<p>Чтобы правило могло проверить или изменить содержимое сообщения с защитой RMS, включите расшифровку транспорта, задав значения Mandatory или Optional (значение по умолчанию — Optional). Дополнительные сведения см. в статье <a href="https://go.microsoft.com/fwlink/p/?linkid=84806">Включение и отключение расшифровки транспорта</a>.</p></td>
</tr>
<tr class="odd">
<td><p><strong>Сообщения с открытой подписью.</strong> Сообщения, которые были подписаны, но не зашифрованы.</p></td>
<td><p>Да</p></td>
</tr>
<tr class="even">
<td><p><strong>Сообщения единой системы обмена сообщениями</strong>. Сообщения, созданные или обработанные службой единой системы обмена сообщениями, например сообщения голосовой почты, факсы, уведомления о пропущенных звонках и сообщения, созданные или переадресованные с помощью Голосовой доступ к Microsoft Outlook.</p></td>
<td><p>Да</p></td>
</tr>
<tr class="odd">
<td><p><strong>Анонимные сообщения.</strong> Сообщения от анонимных отправителей.</p></td>
<td><p>Да</p></td>
</tr>
<tr class="even">
<td><p><strong>Отчеты о прочтении.</strong> Отчеты, созданные в ответ на запросы уведомлений о прочтении от отправителей. Отчеты о прочтении относятся к классу сообщений <code>IPM.Note*.MdnRead</code> или <code>IPM.Note*.MdnNotRead</code>.</p></td>
<td><p>Да</p></td>
</tr>
</tbody>
</table>


## Правила транспорта и членство в группах

При определении правила транспорта с использованием условия, расширяющего членство в группе рассылки, полученный список получателей кэшируется транспортной службой на сервере почтовых ящиков, где применяется правило. Это так называемый *кэш раскрытых групп*, который также используется агентом ведения журнала для проверки членства в группах для правил ведения журнала. По умолчанию членства в группах хранятся в кэше раскрытых групп в течение четырех часов. Также в нем сохраняются получатели, возвращаемые фильтром получателей динамических групп рассылки. Кэш раскрытых групп устраняет необходимость в регулярных запросах к Active Directory и сокращает объем трафика, связанного с разрешением членства в группах.

В Exchange 2013 можно настраивать интервал хранения и другие параметры кэша раскрытых групп. Можно уменьшить интервал кэширования или полностью отключить кэширование, чтобы обеспечить более частое обновление сведений о группах. При этом нужно учитывать соответственно возрастающую нагрузку на контроллеры домена Active Directory, вызываемую запросами раскрытия групп рассылки. Кэш на транспортном сервере почтовых ящиков можно очистить, перезапустив на нем транспортную службу Microsoft Exchange. Это необходимо сделать на всех серверах почтовых ящиков, где требуется очистить кэш. При создании, тестировании и диагностике правил транспорта, использующих условия на основе членства в группах рассылки, также следует учитывать наличие кэша раскрытых групп.

## Хранение и репликация правил

Правила потока обработки почты, создаваемые и настраиваемые на серверах почтовых ящиков, хранятся в Active Directory. Служба транспорта читает и применяет эти правила на всех серверах почтовых ящиков в организации. При создании, изменении или удалении правила потока обработки почты изменение реплицируется на контроллерах доменов в организации. Благодаря этому Exchange может предоставлять согласованный набор правил потока обработки почты в организации.

**Примечания.**

  - На репликацию между контроллерами доменов влияют факторы, не зависящие от Exchange (например, количество сайтов Active Directory и скорость сетевых соединений). Следовательно, при реализации правил потока обработки почты в организации следует учитывать задержки репликации. Дополнительные сведения о репликации в Active Directory см. в статье [Общие сведения о репликации каталогов и управлении топологией Active Directory с помощью Windows PowerShell](https://go.microsoft.com/fwlink/p/?linkid=27490).

  - Каждый сервер почтовых ящиков кэширует расширенные группы рассылки, чтобы избежать повторных запросов Active Directory на определение членства в группах. По умолчанию записи в кэше расширенных групп действительны в течение четырех часов. Следовательно, правила потока обработки почты не обнаруживают членство в группах, пока кэш расширенных групп не будет обновлен. Чтобы принудительно обновить кэш на сервере почтовых ящиков, перезапустите службу транспорта Microsoft Exchange. Эту службу необходимо перезапустить на каждом сервере почтовых ящиков, где требуется принудительно обновить кэш.

Правила потока обработки почты, создаваемые и настраиваемые на пограничных транспортных серверах, хранятся в локальном экземпляре служб AD LDS на сервере. На пограничных транспортных серверах не происходит автоматическая репликация правил потока обработки почты. Правила на пограничном транспортном сервере применяются только к сообщениям, проходящим через локальный сервер. Если один и тот же набор правил потока обработки почты требуется применить на нескольких пограничных транспортных серверах, вы можете клонировать конфигурацию пограничного транспортного сервера либо экспортировать, а затем импортировать правила потока обработки почты. Дополнительные сведения см. в статье [Клонированная конфигурация пограничного транспортного сервера](edge-transport-server-cloned-configuration-exchange-2013-help.md) и разделе [Импорт и экспорт коллекций правил потока обработки почты](manage-mail-flow-rules-exchange-2013-help.md).

Каждый раз, когда служба транспорта на сервере почтовых ящиков или пограничном транспортном сервере обнаруживает измененное правило потока обработки почты, соответствующее событие записывается в журнал приложений в средстве просмотра событий (код события 4002 на серверах почтовых ящиков и 16028 на пограничных транспортных серверах).

## Репликация и хранение правила в смешанных средах

В Exchange 2013 часто используются две смешанные среды:

  - **Гибридные развертывания, где часть организации находится в UNRESOLVED\_TOKEN\_VAL(Office365)**
    
    В гибридной среде не происходит репликация правил между локальной организацией Exchange и UNRESOLVED\_TOKEN\_VAL(Office365). Следовательно, при создании правила в Exchange необходимо создать соответствующее правило в UNRESOLVED\_TOKEN\_VAL(Office365). Правила, созданные в UNRESOLVED\_TOKEN\_VAL(Office365), хранятся в облаке, а правила, созданные в локальной организации, — в локальной службе Active Directory. При управлении правилами в гибридной среде необходимо обеспечить синхронизацию двух наборов правил. Для этого можно либо вносить изменения в оба набора, либо совершать их в одной среде, а затем импортировать в другую.
    
    <table>
    <thead>
    <tr class="header">
    <th><img src="images/Dd876857.important(EXCHG.150).gif" title="Важно" alt="Важно" />Важно!</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td>Несмотря на то что условия и действия, доступные в UNRESOLVED_TOKEN_VAL(Office365) и Exchange Server, во многом совпадают, существуют некоторые отличия. Если вы планируете создавать одно и то же правило в обеих средах, убедитесь, что нужные действия доступны. Списки условий и действий, доступных в UNRESOLVED_TOKEN_VAL(Office365), представлены в следующих статьях:<br />
    <a href="https://technet.microsoft.com/ru-ru/library/jj919235(v=exchg.150)">Почтовые поток правила условий и исключений (предикаты) в Exchange Online</a><br />
    <a href="https://technet.microsoft.com/ru-ru/library/jj919237(v=exchg.150)">Почтовые действия правил поток в Exchange Online</a></td>
    </tr>
    </tbody>
    </table>


  - **Сосуществование с Exchange 2010 или Exchange 2007**
    
    При сосуществовании с Exchange 2010 или Exchange 2007 все правила для потока обработки почты хранятся в Active Directory и реплицируются по всей организации, независимо от того, какая версия Exchange Server использовалась для создания правил. Однако все правила для потока обработки почты связаны с версией Exchange Server Server, которая использовалась для их создания, и хранятся в специальном контейнере в Active Directory. При первом развертывании Exchange 2013 в организации все существующие правила импортируются в Exchange 2013. Однако все последующие изменения потребуется вносить в обе версии. Например, если вы измените правило в Exchange 2013 (Командная консоль Exchange или Центр администрирования Exchange), вам потребуется также внести это изменение в Exchange 2010 (Командная консоль Exchange или UNRESOLVED\_TOKEN\_VAL(exEMC)). Или вы можете экспортировать правила из Exchange 2013 и импортировать их в Exchange 2010.
    
    Exchange 2010 не может обрабатывать правила, у которых для свойства **Версия** или **RuleVersion** задано значение 15.*n*.*n*.*n*. Чтобы обрабатывались все правила, используйте только правила со значением 14.*n*.*n*.*n*.

## Дополнительные сведения

[Управление правилами потока обработки почты](manage-mail-flow-rules-exchange-2013-help.md)

[Условия правил транспорта (предикаты)](mail-flow-rule-conditions-and-exceptions-predicates-in-exchange-2013-exchange-2013-help.md)

[Действия правил транспорта](mail-flow-rule-actions-in-exchange-2013-exchange-2013-help.md)

[Агенты транспорта](transport-agents-exchange-2013-help.md)

