---
title: 'Использование пакетной миграции для переноса общедоступных папок в Exchange 2013 из предыдущих версий: Exchange 2013 Help'
TOCTitle: Использование пакетной миграции для переноса общедоступных папок в Exchange 2013 из предыдущих версий
ms:assetid: da808e27-d2b7-4fbd-915c-a600751f526c
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Dn912663(v=EXCHG.150)
ms:contentKeyID: 64129683
ms.date: 05/22/2018
mtps_version: v=EXCHG.150
ms.translationtype: MT
---

# Использование пакетной миграции для переноса общедоступных папок в Exchange 2013 из предыдущих версий

 

_**Применимо к:** Exchange Server 2013_

_**Последнее изменение раздела:** 2018-03-26_

**Сводка**. В этой статье описано, как переместить общедоступные папки из Exchange 2007 или Exchange 2010 в Exchange 2013.

В этой статье описано, как перенести общедоступные папки из Exchange Server 2010 с пакетом обновления 3 (SP3) и накопительным пакетом обновления 8 (RU8) или Exchange 2007 с пакетом обновления 3 (SP3) и накопительным пакетом обновления 15 (RU15) в Microsoft Exchange Server 2013 с накопительным пакетом обновления 7 (CU7) или более поздних версий в одном лесе.

Серверы Exchange 2010 с пакетом обновления 3 (SP3) и накопительным пакетом обновления 8 (RU8) и Exchange 2007 с пакетом обновления 3 (SP3) и накопительным пакетом обновления 15 (RU15) называются *серверами Exchange прежних версий*.

> [!NOTE]  
> Метод пакетной миграции, описанный в этой статье, — это единственный поддерживаемый способ переноса общедоступных папок предыдущих версий в Exchange 2013. Старый метод последовательной миграции общих папок больше не поддерживается корпорацией Майкрософт.


Перенос выполняется с помощью командлетов **\* MigrationBatch** и **\* PublicFolderMigrationRequest** для устранения неполадок. Кроме того, потребуется использовать следующие сценарии PowerShell:

  - `Export-PublicFolderStatistics.ps1`. Этот сценарий создает файл сопоставления имени и размера папки.

  - ` Export-PublicFolderStatistics.psd1`. Этот файл поддержки используется сценарием Export-PublicFolderStatistics.ps1 и должен быть загружен туда же.

  - `PublicFolderToMailboxMapGenerator.ps1`. Этот сценарий создает файл сопоставления общедоступных папок и почтовых ящиков.

  - `PublicFolderToMailboxMapGenerator.strings.psd1`. Этот файл поддержки используется сценарием PublicFolderToMailboxMapGenerator.ps1 и должен быть загружен туда же.

  - `Create-PublicFolderMailboxesForMigration.ps1`. Этот сценарий создает почтовые ящики целевой общедоступной папки для переноса. Кроме того, этот сценарий подсчитывает необходимое количество почтовых ящиков для обработки прогнозируемой пользовательской нагрузки, основываясь на указаниях по количеству входов пользователей на почтовый ящик общедоступных папок с учетом рекомендаций в [Ограничения общедоступных папок](limits-for-public-folders-exchange-2013-help.md).

  - `Create-PublicFolderMailboxesForMigration.strings.psd1`. Этот файл поддержки используется сценарием Create-PublicFolderMailboxesForMigration.ps1 и должен быть скачан в то же расположение.

Шаг 1. Скачивание сценариев переноса содержит сведения о том, куда их скачивать. Убедитесь, что все сценарии скачиваются в одно и то же расположение.

Дополнительные сведения о задачах управления, связанных с общедоступными папками, см. в разделе [Процедуры с общедоступными папками](public-folder-procedures-exchange-2013-help.md).

## Какие версии Exchange поддерживают миграцию общедоступных папок в Exchange 2013?

Exchange поддерживает перемещение общедоступных папок из следующих прежних версий Exchange Server:

  - Exchange 2010 с пакетом обновления 3 (SP3) и накопительным пакетом обновления 8 (RU8) или более поздних версий;

  - Exchange 2007 с пакетом обновления 3 (SP3) и накопительным пакетом обновления 15 (RU15) или более поздних версий.

Если вам нужно переместить общедоступные папки в Exchange 2013, но на локальных серверах не выполняются минимальные поддерживаемые версии Exchange 2010 или Exchange Server 2007, см. раздел [Использование последовательной миграции для переноса общедоступных папок в Exchange 2013 из предыдущих версий](https://technet.microsoft.com/ru-ru/library/jj150486\(v=exchg.150\)). Хотя можно выполнить последовательную миграцию, настоятельно рекомендуется обновить локальные серверы и использовать пакетную миграцию. Пакетная миграция выполняется значительно быстрее и отличается большей надежностью.

Перенести общедоступные папки непосредственно из Exchange 2003 невозможно. Если в вашей организации используется Exchange 2003, переместите все базы данных и реплики общедоступных папок в Exchange 2010 с пакетом обновления 3 (SP3) и накопительным пакетом обновления 8 (RU8) или более поздних версий либо в Exchange 2007 с пакетом обновления 3 (SP3) и накопительным пакетом обновления 15 (RU15) или более поздних версий. Реплики общедоступных папок не могут оставаться в Exchange 2003. Кроме того, почта, отправленная в общедоступную папку Exchange 2013, не может передаваться через сервер Exchange 2003.

## Что нужно знать перед началом работы

  - Перед началом мы советуем полностью прочитать этот раздел, поскольку при выполнении некоторых действий требуется простой.

  - Сервер Exchange 2010 должен работать под управлением Exchange 2010 с пакетом обновления 3 (SP3) и накопительным пакетом обновления 8 (RU8) или более поздних версий.

  - Сервер Exchange 2007 должен работать под управлением Exchange 2007 с пакетом обновления 3 (SP3) и накопительным пакетом обновления 15 (RU15) или более поздних версий.

  - Максимальное количество общедоступных папок, которые можно перенести в Exchange 2013 за один раз, составляет 500 000.

  - В Exchange 2013 вам необходимо быть членом группы ролей "Управление организацией". Сведения о том, как включить группу ролей "Управление организацией", см. в разделе [Управление группами ролей](manage-role-groups-exchange-2013-help.md).

  - В Exchange 2010 вам необходимо быть членом группы ролей RBAC "Управление организацией" или "Управление сервером". Дополнительные сведения см. в статье [Добавление участников в группу роли](https://go.microsoft.com/fwlink/?linkid=299212).

  - В Exchange 2007 вам необходима роль администратора организации Exchange или администратора сервера Exchange Server. Кроме того, вам необходима роль администратора общедоступных папок, а также вы должны входить в локальную группу администраторов целевого сервера. Дополнительные сведения см. в статье [Инструкции по добавлению пользователя или группы в роль администратора](https://go.microsoft.com/fwlink/p/?linkid=81779).

  - При работе с сервером Exchange 2007 необходимо выполнить обновление до [Windows PowerShell 2.0 и WinRM 2.0 для 64-разрядного выпуска Windows Server 2008](http://go.microsoft.com/fwlink/p/?linkid=3052&kbid=968930).

  - Перед переносом следует ознакомиться с разделом [Ограничения общедоступных папок](limits-for-public-folders-exchange-2013-help.md).

  - Перед переносом переместите все почтовые ящики пользователей в Exchange 2013, так как пользователи с почтовыми ящиками Exchange 2007 или Exchange 2010 не будут иметь доступ к общедоступным папкам в Exchange 2013. Дополнительные сведения см. в разделе [Перемещение почтовых ящиков в Exchange 2013](mailbox-moves-in-exchange-2013-exchange-2013-help.md).

  - В среде несколькими доменами общие папки с включенной поддержкой почты перестанет работать после миграции в Exchange 2013, если Exchange выполняется в дочернем домене. Это так, как в Exchange 2013, общедоступные папки с включенной поддержкой почты объекты, должны быть в разделе корневого домена. Чтобы решить эту проблему, необходимо отключить ваших общедоступных папок с поддержкой электронной почты и затем включить поддержку почты их еще раз, которые позволяют переместить их в расположение правильный домен.

  - Когда миграция будет завершена, чтобы внешние отправители могли отправлять сообщения в перенесенные общедоступные папки с включенной поддержкой почты, **анонимному** пользователю необходимо предоставить разрешение по крайней мере на **создание элементов**. Если этого не сделать, внешние отправители получат уведомление об ошибке доставки, а сообщения не будут доставлены в перенесенную общедоступную папку с включенной поддержкой почты. Дополнительные сведения о настройке разрешений для анонимного пользователя см. в статье [Включение и отключение поддержки почты для общедоступной папки](mail-enable-or-mail-disable-a-public-folder-exchange-2013-help.md).

  - Сочетания клавиш для процедур, описанных в этой статье, приведены в статье [Сочетания клавиш в Центре администрирования Exchange](keyboard-shortcuts-in-the-exchange-admin-center-exchange-online-protection-help.md).

> [!TIP]  
> Возникли проблемы? Обратитесь за помощью к участникам форумов, посвященных Exchange. Посетите форумы по таким продуктам: <a href="https://go.microsoft.com/fwlink/p/?linkid=60612">Exchange Server</a>, <a href="https://go.microsoft.com/fwlink/p/?linkid=267542">Exchange Online</a> или <a href="https://go.microsoft.com/fwlink/p/?linkid=285351">Exchange Online Protection</a>.


## Как это сделать

## Шаг 1. Загрузка сценариев переноса

1.  Скачайте все сценарии и сопутствующие файлы со страницы [Public Folders Migration Scripts](https://go.microsoft.com/fwlink/?linkid=299838).

2.  Сохраните эти сценарии на локальном компьютере, с которого вы собираетесь запускать оболочку PowerShell. (Например, в папку C:\\PFScripts). Убедитесь, что все сценарии сохранены в одном и том же месте.

## Этап 2. Подготовка к миграции

Перед началом миграции выполните указанные ниже предварительные действия.

**Предварительные действия на сервере Exchange прежних версий**

1.  Для проверки при завершении переноса мы советуем вам выполнить следующие команды на сервере Exchange прежних версий, чтобы сделать моментальные снимки текущих развертываемых общедоступных папок:
    
      - Выполните следующую команду, чтобы сделать моментальный снимок начальной структуры исходных папок:
        
            Get-PublicFolder -Recurse | Export-CliXML C:\PFMigration\Legacy_PFStructure.xml
    
      - Выполните следующую команду, чтобы сделать моментальный снимок статистики общедоступных папок, такой как число элементов, размер и владелец:
        
            Get-PublicFolderStatistics | Export-CliXML C:\PFMigration\Legacy_PFStatistics.xml
    
      - Выполните следующую команду, чтобы сделать моментальный снимок разрешений:
        
            Get-PublicFolder -Recurse | Get-PublicFolderClientPermission | Select-Object Identity,User -ExpandProperty AccessRights | Export-CliXML C:\PFMigration\Legacy_PFPerms.xml
    
    Сохраните сведения из предыдущих команд для сравнения после завершения переноса.

2.  Если имя общедоступной папки содержит обратную косую черту (**\\**), то после переноса общедоступные папки будут созданы внутри родительской общедоступной папки. Перед переносом мы советуем переименовать общедоступные папки с обратной косой чертой в имени.
    
    1.  Чтобы найти общедоступные папки с обратной косой чертой в имени, на сервере Exchange 2010 выполните следующую команду:
        
            Get-PublicFolderStatistics -ResultSize Unlimited | Where {($_.Name -like "*\*") -or ($_.Name -like "*/*") } | Format-List Name, Identity
    
    2.  Чтобы найти общедоступные папки с обратной косой чертой в имени, на сервере Exchange 2007 выполните следующую команду:
        
            Get-PublicFolderDatabase | ForEach {Get-PublicFolderStatistics -Server $_.Server | Where {$_.Name -like "*\*"}}
    
    3.  Если эта команда возвращает сведения об общедоступных папках, переименуйте их с помощью следующей команды:
        
            Set-PublicFolder -Identity <public folder identity> -Name <new public folder name>

3.  Убедитесь в отсутствии записи о предыдущем успешном переносе.
    
    1.  В следующем примере проверяется состояние переноса общедоступных папок.
        
            Get-OrganizationConfig | Format-List PublicFoldersLockedforMigration, PublicFolderMigrationComplete
        
        Если ранее уже осуществлялся успешный перенос, свойства *PublicFoldersLockedforMigration* или *PublicFolderMigrationComplete* будут иметь значение `$true`. Чтобы изменить значение на `$false`, используйте команду в шаге 3б. Если значение равно `$true`, то запрос на перенос не удастся выполнить.
    
    2.  Если для свойства *PublicFoldersLockedforMigration* или *PublicFolderMigrationComplete* установлено состояние `$true`, выполните следующую команду, чтобы установить значение `$false`.
        
            Set-OrganizationConfig -PublicFoldersLockedforMigration:$false -PublicFolderMigrationComplete:$false
    
    > [!WARNING]  
    > После сброса этих свойств необходимо дождаться обнаружения новых параметров системой Exchange. На это может потребоваться до двух часов.


Подробные сведения о синтаксисе и параметрах см. в следующих разделах:

  - [Get-PublicFolder](https://technet.microsoft.com/ru-ru/library/aa997615\(v=exchg.150\))

  - [Get-PublicFolderDatabase](https://technet.microsoft.com/ru-ru/library/jj733416\(v=exchg.150\))

  - [Set-PublicFolder](https://technet.microsoft.com/ru-ru/library/aa998596\(v=exchg.150\))

  - [Get-PublicFolderStatistics](https://technet.microsoft.com/ru-ru/library/aa998663\(v=exchg.150\))

  - [Get-PublicFolderClientPermission](https://technet.microsoft.com/ru-ru/library/bb124365\(v=exchg.150\))

  - [Get-OrganizationConfig](https://go.microsoft.com/fwlink/p/?linkid=183212)

  - [Set-OrganizationConfig](https://go.microsoft.com/fwlink/p/?linkid=183213)

**Предварительные действия на сервере Exchange 2013**

1.  Убедитесь в отсутствии существующих запросов на миграцию общедоступных папок. Если они есть, очистите их. В противном случае запрос на миграцию завершится ошибкой. Это действие требуется не всегда. Его необходимо выполнить, только если вы подозреваете, что конвейер может содержать существующий запрос на миграцию.
    
    Существующий запрос на миграцию может относиться к одному из двух типов: пакетной миграции или последовательной миграции. Ниже указаны команды для обнаружения и удаления запросов обоих типов.
    
    > [!IMPORTANT]  
    > Перед удалением запроса на миграцию важно понять, почему он существовал. Выполните следующие команды, чтобы определить, когда сделан предыдущий запрос, и обнаружить любые возможные проблемы. Чтобы определить, почему сделано это изменение, может потребоваться консультация с другими администраторами в организации.
    
    В примере ниже показано обнаружение существующих запросов на последовательную миграцию.
    
        Get-PublicFolderMigrationRequest | Get-PublicFolderMigrationRequestStatistics -IncludeReport | Format-List
    
    В примере ниже показано удаление существующих запросов на последовательную миграцию общедоступных папок.
    
        Get-PublicFolderMigrationRequest | Remove-PublicFolderMigrationRequest
    
    В примере ниже показано обнаружение существующих запросов на пакетную миграцию.
    
        $batch = Get-MigrationBatch | ?{$_.MigrationType.ToString() -eq "PublicFolder"}
    
    В примере ниже показано удаление существующих запросов на пакетную миграцию общедоступных папок.
    
        $batch | Remove-MigrationBatch -Confirm:$false

2.  Убедитесь, что на серверах Exchange 2013 нет общедоступных папок или почтовых ящиков общедоступных папок.
    
    1.  Выполните следующую команду, чтобы проверить наличие почтовых ящиков общедоступных папок.
        
            Get-Mailbox -PublicFolder 
    
    2.  Если команда не вернула никаких почтовых ящиков общедоступных папок, перейдите к Step 3: Generate the CSV files. Если команда вернула какие-либо общедоступные папки, запустите следующую команду, чтобы проверить наличие каких-либо общедоступных папок:
        
            Get-PublicFolder
    
    3.  Если вы обнаружили общедоступные папки, выполните следующие команды PowerShell, чтобы удалить их. Убедитесь, что вы сохранили информацию, содержавшуюся в общедоступных папках.
        
        > [!NOTE]  
        > При удалении общедоступных папок вся информация в них удаляется безвозвратно.
        
        ```
            Get-Mailbox -PublicFolder | Where{$_.IsRootPublicFolderMailbox -eq $false} | Remove-Mailbox -PublicFolder -Force -Confirm:$false
        ```
        ```        
            Get-Mailbox -PublicFolder | Remove-Mailbox -PublicFolder -Force -Confirm:$false
        ```

Подробные сведения о синтаксисе и параметрах см. в следующих разделах:

  - [Get-MigrationBatch](https://technet.microsoft.com/ru-ru/library/jj219164\(v=exchg.150\))

  - [Get-PublicFolderMigrationRequest](https://technet.microsoft.com/ru-ru/library/jj218718\(v=exchg.150\))

  - [Remove-PublicFolderMigrationRequest](https://technet.microsoft.com/ru-ru/library/jj218625\(v=exchg.150\))

  - [Get-Mailbox](https://technet.microsoft.com/ru-ru/library/bb123685\(v=exchg.150\))

  - [Get-PublicFolder](https://technet.microsoft.com/ru-ru/library/aa997615\(v=exchg.150\))

  - [Get-MailPublicFolder](https://technet.microsoft.com/ru-ru/library/bb124772\(v=exchg.150\))

  - [Disable-MailPublicFolder](https://technet.microsoft.com/ru-ru/library/bb123781\(v=exchg.150\))

  - [Remove-PublicFolder](https://technet.microsoft.com/ru-ru/library/bb124894\(v=exchg.150\))

  - [Remove-Mailbox](https://technet.microsoft.com/ru-ru/library/aa995948\(v=exchg.150\))

## Шаг 3. Создание CSV-файлов

1.  На сервере Exchange Server прежних версий запустите сценарий `Export-PublicFolderStatistics.ps1`, чтобы создать файл сопоставления имени и размера папки. Этот сценарий должен запускать локальный администратор. Этот файл будет содержать два столбца: **FolderName** и **FolderSize**. Значения для столбца **FolderSize** будут отображены в байтах (например, **\\PublicFolder01,10000**).
    
        .\Export-PublicFolderStatistics.ps1  <Folder to size map path> <FQDN of source server>
    
      - *FQDN of source server* указывает полное доменное имя сервера почтовых ящиков, на котором размещена иерархия общедоступных папок.
    
      - *Folder to size map path* указывает имя файла и путь к этому файлу в сетевой общедоступной папке, в которой необходимо сохранить CSV-файл. Для дальнейших действий в этом разделе вам потребуется доступ к этому файлу с сервера Exchange 2013. Если указать только имя файла, он будет создан в текущем каталоге оболочки PowerShell на локальном компьютере.

2.  Запустите сценарий `PublicFolderToMailboxMapGenerator.ps1`, чтобы создать файл сопоставления общедоступных папок и почтовых ящиков. Этот файл используется для вычисления правильного количества почтовых ящиков общедоступных папок на сервере почтовых ящиков Exchange 2013.
    
    > [!NOTE]  
    > Если имя общедоступной папки содержит обратную косую черту (<strong>\</strong>), то общедоступные папки будут созданы внутри родительской общедоступной папки. Мы советуем вам просмотреть CSV-файл и изменить имена папок с обратной косой чертой.
    
        .\PublicFolderToMailboxMapGenerator.ps1 <Maximum mailbox size in bytes> <Folder to size map path> <Folder to mailbox map path>
    
      - *Maximum mailbox size in bytes* указывает максимальный размер новых почтовых ящиков общедоступных папок. Указывая значение данного параметра, обязательно оставьте свободное место на случай увеличения размера почтового ящика общедоступных папок.
    
      - *Folder to size map path* указывает путь к CSV-файлу, созданному при запуске сценария `Export-PublicFolderStatistics.ps1`.
    
      - *Folder to mailbox map path* указывает имя и путь CSV-файла сопоставления папок с почтовыми ящиками, который будет создан в результате этого действия. Если указать только имя файла, он будет создан в текущем каталоге оболочки PowerShell на локальном компьютере.

## Шаг 4. Создание почтовых ящиков общедоступных папок в Exchange 2013

1.  Выполните следующую команду, чтобы создать целевые почтовые ящики общедоступной папки. Сценарий создаст целевой почтовый ящик для каждого ящика в файле .csv, созданного на шаге 3, запустив сценарий PublicFoldertoMailboxMapGenerator.ps1.
    
        .\Create-PublicFolderMailboxesForMigration.ps1 -FolderMappingCsv Mapping.csv -EstimatedNumberOfConcurrentUsers:<estimate>
    
    *Mapping.csv* — файл, созданный сценарием PublicFoldertoMailboxMapGenerator.ps1 на шаге 3. Предполагаемое количество одновременных подключений пользователей, просматривающих иерархию общедоступной папки, обычно меньше, чем общее количество пользователей в организации.

## Шаг 5. Запуск запроса на перенос

Действия для переноса общедоступных папок из Exchange 2007 отличаются от действий для переноса из Exchange 2010.

> [!TIP]  
> При переносе как из Exchange 2007, так и из Exchange 2010, после создания запросов на пакетную миграцию с помощью соответствующего командлета можно просматривать их и управлять ими в Центре администрирования Exchange.


**Перенос общедоступных папок из Exchange 2007**

1.  Общедоступные папки в системах предыдущих версий, таких как OWAScratchPad и поддерево папок корневой схемы в Exchange 2007, не распознаются Exchange 2013 и обрабатываются как неправильные элементы. Это приведет к завершению переноса с ошибкой. В составе запроса на перенос необходимо указать значение для параметра `BadItemLimit`. Это значение будет разным для разного количества существующих баз данных общедоступных папок. Приведенные ниже команды помогут вам определить количество существующих баз данных общедоступных папок и определить значение параметра `BadItemLimit` для запроса на перенос.
    
```
        $PublicFolderDatabasesInOrg = @(Get-PublicFolderDatabase)
```
```    
        $BadItemLimitCount = 5 + ($PublicFolderDatabasesInOrg.Count -1)
```

2.  Выполните следующую команду на сервере Exchange 2013:
    
        New-MigrationBatch -Name PFMigration -SourcePublicFolderDatabase (Get-PublicFolderDatabase -Server <Source server name>) -CSVData (Get-Content <Folder to mailbox map path> -Encoding Byte) -NotificationEmails <email addresses for migration notifications> -BadItemLimit $BadItemLimitCount 

3.  Запустите миграцию, выполнив следующую команду.
    
        Start-MigrationBatch PFMigration

**Перенос общедоступных папок из Exchange 2010**

1.  Выполните следующую команду на сервере Exchange 2013.
    
        New-MigrationBatch -Name PFMigration -SourcePublicFolderDatabase (Get-PublicFolderDatabase -Server <Source server name>) -CSVData (Get-Content <Folder to mailbox map path> -Encoding Byte) -NotificationEmails <email addresses for migration notifications> 
    
    Параметр `NotificationEmails` не обязателен.

2.  Запустите перенос, выполнив следующую команду:
    
        Start-MigrationBatch PFMigration
    
    Или:
    
    Перенос можно запустить в Центре администрирования Exchange.
    
    1.  Войдите в Exchange Online и откройте Центр администрирования Exchange.
    
    2.  Последовательно выберите пункты **Получатели** \> **Перенос**.
    
    3.  Выберите только что созданный пакет миграции и нажмите кнопку "Пуск".

В столбце **Состояние** начальное состояние пакета будет показано как **Создан**. Во время переноса состояние изменяется на **Синхронизация**. После завершения запроса на перенос состояние изменится на **Синхронизация завершена**. Дважды щелкните пакет, чтобы увидеть состояние отдельных почтовых ящиков в пакете. Задания почтовых ящиков начинаются с состоянием **В очереди**. При начале выполнения задания отображается статус **Синхронизация**, а после завершения `InitialSync` состояние изменится на **Синхронизация завершена**.

Ход выполнения и завершение переноса можно просматривать и контролировать через Центр администрирования Exchange. Так как командлет **New-MigrationBatch** инициирует запрос на перенос почтовых ящиков для каждого почтового ящика общедоступных папок, вы можете просмотреть состояние этих запросов на странице переноса почтовых ящиков. Чтобы перейти на страницу переноса почтовых ящиков и создать отчеты о переносе, доставляемые по электронной почте, выполните следующие действия.

1.  Войдите в Exchange Online и откройте Центр администрирования Exchange.

2.  Последовательно выберите пункты **Почтовый ящик** \> **Перенос**.

3.  Выберите только что созданный запрос на перенос и щелкните **Просмотр сведений** в области **Сведения**.

Подробные сведения о синтаксисе и параметрах см. в следующих разделах:

  - [New-PublicFolderMigrationRequest](https://technet.microsoft.com/ru-ru/library/jj218636\(v=exchg.150\))

  - [Get-PublicFolderDatabase](https://technet.microsoft.com/ru-ru/library/jj733416\(v=exchg.150\))

  - [Get-PublicFolderMigrationRequest](https://technet.microsoft.com/ru-ru/library/jj218718\(v=exchg.150\))

  - [Get-PublicFolderMigrationRequestStatistics](https://technet.microsoft.com/ru-ru/library/jj218697\(v=exchg.150\))

## Шаг 6. Блокировка общедоступных папок на сервере Exchange прежних версий для окончательного переноса (требуется простой в работе)

До этого этапа в процессе переноса пользователи могли обращаться к общедоступным папкам. В следующих действиях выполняется выход пользователей из общедоступных папок прежних версий и блокировка этих папок до окончания итоговой синхронизации в рамках переноса. В это время пользователи не смогут обратиться к общедоступным папкам. Кроме того, все сообщения, отправленные в общедоступные папки с включенной поддержкой почты, будут занесены в очередь и не будут доставлены до окончания переноса общедоступных папок.

Перед выполнением команды `PublicFoldersLockedForMigration` , как описано ниже, убедитесь в том, что все задания находятся в состоянии **синхронизирован**. Это можно сделать с помощью команды `Get-PublicFolderMailboxMigrationRequest` . Выполните этот шаг только после проверки, что все задания находятся в состоянии **синхронизирован**.

На сервере Exchange прежних версий выполните следующую команду для блокировки старых общедоступных папок для завершения процесса.

    Set-OrganizationConfig -PublicFoldersLockedForMigration:$true

> [!NOTE]  
> Если по какой-либо причине файл пакета миграции не выполняется окончательно (параметр <strong>PublicFolderMigrationComplete</strong> имеет значение <strong>False</strong>), перезапустите банк данных на устаревшем сервере.


Дополнительные сведения о синтаксисе и параметрах см. в разделе [Set-OrganizationConfig](https://technet.microsoft.com/ru-ru/library/aa997443\(v=exchg.150\)).

Если в организации используется несколько баз данных общедоступных папок, потребуется дождаться завершения репликации общедоступных папок, чтобы убедиться, что все базы данных общедоступных папок получили флаг `PublicFoldersLockedForMigration` и все ожидающие обработки изменения, сделанные пользователем в папках, сошлись во всей организации. Это может занять несколько часов.

## Действие 7. Завершение миграции общедоступных папок (требуется простой в работе)

Сначала измените тип развертывания Exchange 2013 на **Удаленный** с помощью следующего командлета:

    Set-OrganizationConfig -PublicFoldersEnabled Remote

После этого можно выполнить миграцию общедоступных папок, используя следующую команду:

    Complete-MigrationBatch PublicFolderMigration

Перенос можно также завершить через Центр администрирования Exchange, нажав **Завершить этот пакет миграции**.

После завершения миграции Exchange будет выполнять окончательный синхронизации между прежних версий Exchange server и Exchange 2013. При успешном последней синхронизации общих папок на сервере Exchange 2013 остаются разблокированными и состояние пакета миграции изменится на **Завершение работы**, а затем **завершено**. Обычно для пакета миграции для времени за несколько часов до его изменения состояния из **синхронизировано** для **завершения работы**, в какой точке начнется последней синхронизации.

## Шаг 8. Проверка результатов переноса и разблокировка общедоступных папок

После завершения переноса общедоступных папок необходимо выполнить указанную ниже проверку и убедиться, что перенос прошел успешно. Это позволит вам проверить иерархию перенесенных общедоступных папок перед тем как перейти к их использованию на сервере Exchange 2013.

1.  Выполните следующую команду в PowerShell, чтобы настроить для тестовых почтовых ящиков использование любого почтового ящика с общедоступными папками после переноса как ящика с общедоступными папками по умолчанию.
    
        Set-Mailbox -Identity <Test User> -DefaultPublicFolderMailbox <Public Folder Mailbox Identity>

2.  Войдите в Outlook 2007 или более поздней версии с помощью тестового пользователя, определенного во время предыдущего действия, и выполните следующие тесты общедоступной папки:
    
      - Просмотр иерархии.
    
      - проверка разрешений;
    
      - Создание и удаление общедоступных папок.
    
      - помещение содержимого в общедоступную папку и его удаление.

3.  Если возникнут проблемы, см. раздел Roll back the migration далее в этой статье. Если содержимое и иерархия общедоступных папок приемлемы и работают надлежащим образом, выполните следующую команду, чтобы разблокировать общедоступные папки для остальных пользователей.
    
        Get-Mailbox -PublicFolder | Set-Mailbox -PublicFolder -IsExcludedFromServingHierarchy $false
    
    > [!IMPORTANT]  
    > После выполнения первоначальной проверки переноса не используйте параметр <em>IsExcludedFromServingHierarchy</em>, поскольку он используется службой автоматического управления хранением для Exchange Online.


4.  На сервере Exchange прежних версий выполните приведенную ниже команду, чтобы указать завершение миграции общедоступных папок:
    
        Set-OrganizationConfig -PublicFolderMigrationComplete:$true

5.  Убедившись, что миграция завершена, выполните следующую команду:
    
        Set-OrganizationConfig -PublicFoldersEnabled Local

6.  Чтобы внешние отправители могли отправлять сообщения в перенесенные общедоступные папки с включенной поддержкой почты, **анонимному** пользователю необходимо предоставить разрешение по крайней мере на **создание элементов**. Если этого не сделать, внешние отправители получат уведомление об ошибке доставки, а сообщения не будут доставлены в перенесенную общедоступную папку с включенной поддержкой почты.
    
    Настроить разрешения для анонимного пользователя можно с помощью командной консоли или приложения Outlook. Дополнительные сведения о настройке разрешений для анонимного пользователя см. в разделе [Включение и отключение поддержки почты для общедоступной папки](mail-enable-or-mail-disable-a-public-folder-exchange-2013-help.md).

## Как проверить, что это работает

В Step 2: Prepare for the migration указывалось, что перед началом переноса необходимо сделать моментальные снимки структуры, статистики и разрешений общедоступных папок. С помощью приведенных ниже действий можно проверить успешность переноса общедоступных папок, сделав такие же моментальные снимки после завершения переноса. Затем можно сравнить данные в обоих файлах, чтобы проверить успешность.

1.  Выполните следующую команду, чтобы сделать моментальный снимок новой структуры папок.
    
        Get-PublicFolder -Recurse | Export-CliXML C:\PFMigration\Cloud_PFStructure.xml

2.  Выполните следующую команду, чтобы сделать моментальный снимок статистики общедоступных папок, такой как число элементов, размер и владелец.
    
        Get-PublicFolderStatistics -ResultSize Unlimited | Export-CliXML C:\PFMigration\Cloud_PFStatistics.xml

3.  Выполните следующую команду, чтобы сделать моментальный снимок разрешений.
    
        Get-PublicFolder -Recurse | Get-PublicFolderClientPermission | Select-Object Identity,User -ExpandProperty AccessRights | Export-CliXML  C:\PFMigration\Cloud_PFPerms.xml

## Удаление баз данных общедоступных папок с серверов Exchange прежних версий

После окончания переноса и проверки надлежащей работы общедоступных папок на сервере Exchange 2013 необходимо удалить базы данных общедоступных папок с серверов Exchange прежних версий.

  - Дополнительные сведения об удалении баз данных общедоступных папок с серверов Exchange 2007 см. в разделе [Удаление баз данных общих папок](https://go.microsoft.com/fwlink/?linkid=123678).

  - Дополнительные сведения об удалении баз данных общедоступных папок с серверов Exchange 2010 см. в разделе [Удаление баз данных общих папок](https://go.microsoft.com/fwlink/?linkid=81409).

## Откат миграции

Если из-за ошибок при переносе необходимо повторно активировать общедоступные папки Exchange прежних версий, выполните следующие действия.

> [!WARNING]  
> Если выполнять откат переноса на серверы Exchange прежних версий, то будут потеряны все сообщения электронной почты, которые отправлены на общедоступные папки с включенной поддержкой почты, и содержимое, опубликованное в общедоступных папках в Exchange 2013 после переноса. Чтобы сохранить это содержимое, необходимо экспортировать содержимое общедоступных папок в PST-файл, а затем импортировать его в общедоступные папки прежних версий после отката.


1.  На сервере Exchange прежних версий выполните следующую команду, чтобы разблокировать общедоступные папки на сервере Exchange прежних версий. Этот процесс может занять несколько часов.
    
        Set-OrganizationConfig -PublicFoldersLockedForMigration:$False

2.  На сервере Exchange 2013 выполните следующие команды для удаления почтовых ящиков с общедоступными папками.
    
```
        Get-Mailbox -PublicFolder | Where{$_.IsRootPublicFolderMailbox -eq $false} | Remove-Mailbox -PublicFolder -Force -Confirm:$false
```
```        
        Get-Mailbox -PublicFolder | Remove-Mailbox -PublicFolder -Force -Confirm:$false
```

3.  На сервере Exchange прежних версий выполните следующую команду, чтобы для флага `PublicFolderMigrationComplete` установить значение `$false`.
    
        Set-OrganizationConfig -PublicFolderMigrationComplete:$False

