---
title: 'Гибридная современная проверка подлинности в Outlook для iOS и Android'
TOCTitle: Using hybrid Modern Authentication with Outlook for iOS and Android
ms:assetid: 0e701643-1f18-4cc3-8595-4fd4b15caf6c
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Mt846639(v=EXCHG.150)
ms:contentKeyID: 74520287
ms.date: 04/30/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# Using hybrid Modern Authentication with Outlook for iOS and Android

 

_**Применимо к:** Exchange Server 2013_

_**Последнее изменение раздела:** 2018-04-19_

**Сводка.** Узнайте, как администраторы могут развертывать функции гибридной современной проверки подлинности и "Enterprise Mobility + Security" для локальных почтовых ящиков Exchange, чтобы обеспечить поддержку Outlook для iOS и Android.

Приложение Outlook для iOS и Android разработано как лучший способ работы с Office 365 на мобильном устройстве. Оно позволяет использовать службы Майкрософт для поиска, планирования и расстановки приоритетов в повседневной жизни и работе. Outlook обеспечивает безопасность, конфиденциальность и поддержку, необходимые для защиты корпоративных данных с помощью таких возможностей, как политики защиты приложений с применением Intune и условный доступ с использованием Azure Active Directory. В последующих разделах рассмотрена гибридная архитектура современной проверки подлинности и необходимые условия для ее развертывания, а также представлено руководство по безопасному развертыванию Outlook для iOS и Android для локальных почтовых ящиков Exchange.

## Архитектура Microsoft Cloud для пользователей гибридной среды Exchange Server

Приложение Outlook для iOS и Android работает при поддержке облака. Это означает, что вы работаете с локально устанавливаемым приложением на платформе надежной и масштабируемой службы, работающей в Microsoft Cloud.

Что касается почтовых ящиков Exchange Server, новая архитектура Outlook для iOS и Android подобна старой. Однако служба теперь встроена непосредственно в Microsoft Cloud (с использованием Office 365 и Microsoft Azure), поэтому клиенты получают дополнительные преимущества безопасности, конфиденциальности, обеспечения соответствия требованиям по умолчанию и прозрачности операций, заявленные корпорацией Майкрософт в [центре управления безопасностью Office 365](https://products.office.com/business/office-365-trust-center-welcome) и [центре управления безопасностью Azure](https://www.microsoft.com/trustcenter/cloudservices/azure).

![Архитектурная схема гибридной современной проверки подлинности в Outlook для iOS и Android](images/Mt846639.20a7e963-916d-47e0-bffb-4d86c4777bea(EXCHG.150).png "Архитектурная схема гибридной современной проверки подлинности в Outlook для iOS и Android")

Данные, поступающие из Exchange Online в приложение Outlook, передаются по соединению, защищенному протоколом TLS. Транслятор протоколов, работающий в Azure, служит для маршрутизации данных, команд и уведомлений, но не может сам считывать данные.

Соединение Exchange ActiveSync между Exchange Online и локальной средой позволяет синхронизировать локальные данные пользователей, включая электронную почту за четыре недели, все данные календаря, все данные контактов и статус отсутствия на рабочем месте в клиенте Exchange Online. Эти данные будут автоматически удалены из Exchange Online спустя 30 дней после удаления учетной записи Azure Active Directory.

Синхронизация данных между локальной средой и Exchange Online происходит независимо от действий пользователя. Благодаря этому мы можем очень быстро отправлять новые сообщения на устройства.

Обработка информации в Microsoft Cloud обеспечивает поддержку расширенных функций и возможностей, таких как категоризация электронных сообщений для сортировки почты, персонализированный интерфейс для путешествий и календаря, а также повышенную скорость поиска. Использование облака для интенсивной обработки и минимальное использование ресурсов пользовательских устройств повышают производительность и стабильность приложения. Наконец, это позволяет Outlook создавать функции, работающие во всех учетных записях электронной почты независимо от того, каковы технологические возможности базовых серверов (например, различных версий Exchange Server или Office 365).

В частности, эта новая архитектура включает следующие улучшения:

1.  **Поддержка "Enterprise Mobility + Security".** Клиенты могут использовать "Microsoft Enterprise Mobility + Security" (EMS), в том числе Microsoft Intune и Azure Active Directory Premium, чтобы включать политики условного доступа и защиты приложений с использованием Intune, позволяющие управлять корпоративными данными сообщений на мобильном устройстве и защищать их.

2.  **Работа на платформе Microsoft Cloud.** Данные локальных почтовых ящиков синхронизируются со средой Exchange Online, которая обеспечивает безопасность, конфиденциальность, соответствие требованиям и прозрачность операций, заявленные корпорацией Майкрософт в [центре управления безопасностью Office 365](https://products.office.com/business/office-365-trust-center-welcome).

3.  **Защита паролей пользователей с помощью OAuth.** Outlook использует гибридную современную проверку подлинности (OAuth) для защиты учетных данных пользователей. Гибридная современная проверка подлинности предоставляет приложению Outlook надежный механизм доступа к данным Exchange без использования и хранения учетных данных пользователя. При входе пользователь проходит проверку подлинности непосредственно на платформе удостоверений (в Azure Active Directory или у локального поставщика удостоверений, например ADFS) и получает взамен маркер доступа, предоставляющий приложению Outlook доступ к почтовому ящику или файлам пользователя. Служба никогда не получает доступ к паролю пользователя.

4.  **Уникальные идентификаторы устройств.** Каждое подключение Outlook однозначно регистрируется в Microsoft Intune, поэтому им можно управлять как уникальным подключением.

5.  **Новые возможности на платформах iOS и Android.** Это обновление позволяет приложению Outlook пользоваться встроенными функциями Office 365, которые не поддерживаются на данный момент в локальной версии Exchange (например, полноценным поиском по Exchange Online и сортировкой почты). Эти функции будут доступны только при использовании Outlook для iOS и Android.

> [!NOTE]  
> Управлять устройствами через локальный Центр администрирования Exchange невозможно. Для управления мобильными устройствами требуется Intune.


## Средства управления безопасностью и аудитом данных, а также доступом к ним

Локальные данные синхронизируются с Exchange Online, и у пользователей возникают вопросы о том, как эти данные защищаются в Exchange Online. В техническом документе [Шифрование в Microsoft Cloud](http://aka.ms/office365ce) рассматривается использование BitLocker для шифрования на уровне тома. Как упоминается в этом техническом документе, шифрование службы с возможностью использовать ключ клиента поддерживается в архитектуре Outlook для iOS и Android, но следует обратить внимание на то, что для назначения политики шифрования пользователю потребуется лицензия на Office 365 корпоративный E5 (или соответствующие версии этих планов для государственных и образовательных учреждений).

По умолчанию у инженеров корпорации Майкрософт нет ни прав администратора, ни доступа к контенту пользователя в Office 365. В техническом документе [Средства управления административным доступом в Office 365](http://aka.ms/office365aac) рассматриваются отбор персонала, проверка биографии и защищенное хранилище.

[средствам контроля качества обслуживания, соответствующим стандарту ISO,](https://sip.protection.office.com/) указывается статус проверенных средств управления с точки зрения международных стандартов и правил защиты информации, реализованных в Office 365.

## Поток подключения

Когда в случае Outlook для iOS и Android используется гибридная современная проверка подлинности, применяется описанный ниже поток подключения.

![Поток проверки подлинности в гибридной современной проверке подлинности](images/Mt846639.d6e20ddb-cf8e-4154-8a17-95657ef696d1(EXCHG.150).png "Поток проверки подлинности в гибридной современной проверке подлинности")

1.  Когда пользователь вводит свой электронный адрес, Outlook для iOS и Android подключается к службе AutoDetect. AutoDetect определяет тип почтового ящика, отправляя Exchange Online запрос автообнаружения. Exchange Online определяет, что почтовый ящик пользователя является локальным, и возвращает отклик 302-redirect службе AutoDetect с URL-адресом локальной службы автообнаружения. AutoDetect отправляет запрос локальной службе автообнаружения, чтобы определить конечную точку ActiveSync для электронного адреса. URL-адрес, используемый локально, выглядит примерно так: https://autodiscover.contoso.com/autodiscover/autodiscover.json?Email=test%40contoso.com\&Protocol=activesync\&RedirectCount=3.

2.  AutoDetect инициирует подключение к локальному URL-адресу ActiveSync, возвращенному на этапе 1 при помощи запроса с пустым значением bearer. Запрос с пустым значением bearer сообщает локальной службе ActiveSync о том, что клиент поддерживает современную проверку подлинности. В ответ локальная служба ActiveSync отправляет отклик 401-challenge и включает заголовок *WWW-Authenticate: Bearer*. Заголовок "WWW-Authenticate: Bearer" содержит значение authorization\_uri, определяющее конечную точку Azure Active Directory (AAD), с помощью которой следует получать токен OAuth.

3.  AutoDetect возвращает клиенту конечную точку AAD. Клиент начинает поток входа, а пользователь видит веб-форму (или перенаправляется к приложению Microsoft Authenticator) и может ввести учетные данные. В зависимости от того, какова конфигурация удостоверений, может выполняться перенаправление к локальному поставщику удостоверений через федеративную конечную точку. В конечном итоге клиент получает пару маркеров (доступа и обновления) под названием AT1/RT1. Областью действия маркера доступа является клиент Outlook для iOS и Android, а аудиторией — конечная точка Exchange Online.

4.  Outlook для iOS и Android устанавливает соединение с транслятором протокола без учета состояния, где проприетарный протокол устройства клиента преобразуется в протокол, поддерживаемый средой Exchange Online.

5.  В Exchange Online передается запрос на подготовку, включающий маркер доступа пользователя (AT1) и локальную конечную точку ActiveSync.

6.  API подготовки MRS в Exchange Online принимает AT1 в качестве входных данных и получает вторую пару маркеров доступа и обновления (AT2/RT2) для доступа к локальному почтовому ящика путем вызова Azure Active Directory "от имени". Областью действия второго маркера доступа является клиент Exchange Online, а аудиторией — конечная точка локального пространства имен ActiveSync.

7.  Если почтовый ящик не подготовлен, то API подготовки создает его.

8.  API подготовки MRS устанавливает надежное соединение с локальной конечной точкой ActiveSync и синхронизирует данные о сообщениях пользователя, используя маркер доступа AT2 в качестве механизма проверки подлинности. RT2 периодически используется для создания нового маркера AT2, чтобы данные можно было синхронизировать в фоновом режиме без участия пользователя.

## Технические и лицензионные требования

Для гибридной архитектуры современной проверки подлинности действуют следующие технические требования:

1.  **Локальная установка Exchange.**
    
      - На всех серверах Exchange должен быть установлен Exchange Server 2016 с накопительным пакетом обновления 8 (CU8) либо Exchange Server 2013 с накопительным пакетом обновления 19 (CU19) или более поздней версии. Обратите внимание на то, что пользователи, имеющие гибридные развертывания Exchange или применяющие архивацию на базе Exchange Online (EOA) для локального развертывания Exchange, должны выполнить развертывание последней или предшествующей ей версии накопительного пакета обновления.
    
      - Из среды необходимо удалить все серверы Exchange 2007 и Exchange 2010. На Exchange Server 2010 с пакетом обновления 3 (SP3) не распространяется общедоступная поддержка, и он не будет работать с Outlook для iOS и Android под управлением Intune. В этой архитектуре Outlook для iOS и Android использует OAuth в качестве механизма проверки подлинности. Одно из изменений локальной конфигурации — включение конечной точки OAuth в Microsoft Cloud в качестве конечной точки авторизации по умолчанию. После внесения этого изменения клиенты могут начать договариваться об использовании OAuth. Так как это изменение распространяется на всю организацию, почтовые ящики Exchange 2010 под управлением Exchange 2013 или Exchange 2016 будут ошибочно предполагать, что они могут выполнять поток OAuth. Это приведет к их отключению, ведь Exchange 2010 не поддерживает механизм проверки подлинности OAuth.

2.  **Синхронизация Active Directory.** Синхронизация Active Directory всего локального каталога с Azure Active Directory через Azure AD Connect. Необходимо убедиться, что синхронизированы следующие атрибуты:
    
      - Office 365 профессиональный плюс;
    
      - Exchange Online;
    
      - обратная запись для гибридного развертывания Exchange;
    
      - Azure RMS;
    
      - Intune.

3.  **Гибридная установка Exchange.** Требуется полностью гибридная связь между локальной средой Exchange и Exchange Online.
    
      - Гибридный клиент Office 365 настроен в режиме полностью гибридной конфигурации в соответствии с инструкциями [помощника по развертыванию Exchange](http://technet.microsoft.com/exdeploy).
    
      - Требуется клиент Office 365 корпоративный, Office 365 бизнес или Office 365 для образования.
    
      - Данные локальных почтовых ящиков синхронизируются с центром обработки данных в том же регионе, где установлен клиент Office 365. Дополнительные сведения о расположении данных Office 365 см. в разделе [Где мои данные?](http://o365datacentermap.azurewebsites.net/) центра управления безопасностью Office 365.
    
      - Использование клиентов Office 365 US Government Community and Defense, Office 365 Germany и Office 365 в Китае под управлением 21Vianet не поддерживается.
    
      - Внешние имена узлов URL-адресов для Exchange ActiveSync и автообнаружения должны быть опубликованы как субъекты-службы в Azure Active Directory с помощью мастера гибридной конфигурации.
    
      - Пространства имен автообнаружения и Exchange ActiveSync должны быть доступны из Интернета и не могут быть представлены решением до проверки подлинности.
    
      - Убедитесь, что между подсистемой балансировки нагрузки и серверами Exchange Server не используется разгрузка SSL или TLS, так как это повлияет на использование токена OAuth. Использование мостов SSL и TLS (завершение и повторное шифрование) поддерживается.

4.  **Настройка Intune.** Поддерживаются как облачные, так и гибридные развертывания Intune (MDM для Office 365 не поддерживается).

5.  **Лицензирование Office 365\*.** У каждого пользователя должна быть одна из перечисленных ниже лицензий на Office 365.
    
      - Для коммерческих организаций: Office 365 корпоративный E3, Office 365 корпоративный E5, Office 365 профессиональный плюс или Office 365 бизнес.
    
      - Для государственных организаций: U.S. Government Community G3, U.S. Government Community G5.
    
      - Для образования: Office 365 для образования E3, Office 365 для образования E5.
    
    Кроме того, лицензии должны включать клиентские приложения Office, необходимые для коммерческого использования Outlook для iOS и Android.

6.  **Лицензирование EMS\*.** У каждого локального пользователя должна быть одна из перечисленных ниже лицензий.
    
      - Автономные службы Intune и Azure Active Directory Premium.
    
      - "Enterprise Mobility + Security E3", "Enterprise Mobility + Security E5".

**\*** Microsoft Secure Productive Enterprise (SPE) включает все необходимые лицензии на Office 365 и EMS.

## Этапы реализации

Чтобы включить в организации поддержку гибридной современной проверки подлинности, необходимо выполнить каждое из указанных ниже действий (они подробно описаны в последующих разделах).

1.  создание политики условного доступа;

2.  создание политики защиты приложений с использованием Intune;

3.  включение гибридной современной проверки подлинности;

4.  обращение в корпорацию Майкрософт.

## Создание политики условного доступа

Если в качестве почтового приложения используется только Outlook для iOS и Android, чтобы стандартизировать доступ пользователей к данным Exchange, можно настроить политику условного доступа, блокирующую другие способы доступа с мобильных устройств. Outlook для iOS и Android проходит проверку подлинности через объект удостоверения Azure Active Directory, а затем подключается к Exchange Online. Следовательно, необходимо создать политики условного доступа с использованием Azure Active Directory, чтобы ограничить подключение мобильных устройств к Exchange Online. Для этого потребуются две политики условного доступа, каждая из которых распространяется на всех потенциальных пользователей. Сведения о создании этих политик см. в статье [Условный доступ на основе приложений Azure Active Directory](https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-mam#exchange-online-policy).

1.  Первая политика разрешает использование Outlook для iOS и Android, а также запрещает клиентам Exchange ActiveSync с поддержкой OAuth подключаться к Exchange Online. См. раздел "Шаг 1. Настройка политики условного доступа с использованием Azure AD для Exchange Online".

2.  Вторая политика запрещает клиентам Exchange ActiveSync, использующим обычную проверку подлинности, подключаться к Exchange Online. См. раздел "Шаг 2. Настройка политики условного доступа с использованием Azure AD для Exchange Online c Active Sync (EAS)".

В этих политиках используется параметр [Требовать утвержденное клиентское приложение](https://docs.microsoft.com/azure/active-directory/active-directory-conditional-access-technical-reference), который гарантирует, что доступ предоставляется только тем приложениям Майкрософт, в которые интегрирован пакет SDK Intune.

> [!IMPORTANT]  
> Чтобы можно было применять политики условного доступа для приложений на устройствах с iOS, должно быть установлено приложение Microsoft Authenticator. Для устройств с Android используется приложение &quot;Корпоративный портал Intune&quot;. Дополнительные сведения см. в статье <a href="https://docs.microsoft.com/intune/app-based-conditional-access-intune">Условный доступ на основе приложений с помощью Intune</a>.


Запретить другим клиентам для мобильных устройств (например, встроенному почтовому клиенту, входящему в состав мобильной операционной системы) подключаться к локальной среде (где используется обычная проверка подлинности в локальной службе Active Directory) можно двумя способами.

1.  Вы можете применить встроенные в Exchange правила доступа с мобильных устройств и запретить всем мобильным устройствам подключаться, выполнив следующую команду в командной консоли Exchange:
    
    ```powershell
Set-ActiveSyncOrganizationSettings -DefaultAccessLevel Block
```

2.  Вы можете использовать локальную политику условного доступа в Intune после установки локального соединителя Exchange. Дополнительные сведения см. в статье [Создание политики условного доступа к локальной организации Exchange и устаревшей версии выделенной среды Exchange Online](https://docs.microsoft.com/intune/conditional-access-exchange-create#configure-exchange-on-premises-access).

> [!NOTE]  
> При реализации любого из вышеописанных локальных способов учитывайте, что это может повлиять на пользователей, подключающихся к Exchange со своих мобильных устройств.


## Создание политики защиты приложений с использованием Intune

После включения гибридной современной проверки подлинности все локальные пользователи мобильных устройств смогут работать с Outlook для iOS и Android, применяя архитектуру на основе Office 365. Следовательно, очень важно защитить корпоративные данные с помощью политики защиты приложений с использованием Intune.

Чтобы создать политики защиты приложений с использованием Intune для iOS и Android, выполните действия, описанные в статье [Как создать и назначить политики защиты приложений](https://docs.microsoft.com/intune/app-protection-policies). Каждая политика должна соответствовать следующим минимальным требованиям:

1.  Она должна включать все мобильные приложения Майкрософт, такие как Word, Excel и PowerPoint. Благодаря этому пользователи смогут безопасно получать доступ к корпоративным данным и управлять ими в любом приложении Майкрософт.

2.  В ней должны быть реализованы функции защиты, предоставляемые средой Exchange для мобильных устройств, в том числе:
    
      - запрашивание ПИН-кода для доступа (предусматривает выбор типа, длину ПИН-кода, разрешение простого ПИН-кода и разрешение отпечатков);
    
      - шифрование данных приложения;
    
      - запрет запуска управляемых приложений на взломанных и рутованных устройствах.

3.  Она назначена всем пользователям. Это гарантирует защиту всех пользователей независимо от того, работают ли они с приложением Outlook для iOS и Android.

Помимо вышеописанных минимальных требований к политикам, рекомендуем развернуть дополнительные параметры политик защиты, например **Ограничить вырезание, копирование и вставку из других приложений**, чтобы обеспечить дополнительную защиту от утечки корпоративных данных. Дополнительные сведения о доступных параметрах см. в статьях [Параметры политики защиты приложений Android в Microsoft Intune](https://docs.microsoft.com/intune/app-protection-policy-settings-android) и [Параметры политик для защиты приложений в iOS](https://docs.microsoft.com/intune/app-protection-policy-settings-ios).

> [!IMPORTANT]  
> Чтобы применять политики защиты приложений с использованием Intune к приложениям на устройствах с Android, не зарегистрированных в Intune, пользователь также должен установить приложение &quot;Корпоративный портал Intune&quot;. Дополнительные сведения см. в статье <a href="https://docs.microsoft.com/ru-ru/intune/app-protection-enabled-apps-android">Что происходит при управлении приложением Android с помощью политик защиты приложений</a>.


## Включение гибридной современной проверки подлинности

Если гибридная современная проверка подлинности еще не включена, изучите и выполните действия, описанные в статье [Общие сведения о гибридной современной проверке подлинности и предварительные требования к ее использованию с локальными серверами Skype для бизнеса и Exchange Server](https://support.office.com/article/hybrid-modern-authentication-overview-and-prerequisites-for-using-it-with-on-premises-skype-for-business-and-exchange-servers-ef753b32-7251-4c9e-b442-1a5aec14e58d?).

Если вы уже включили гибридную современную проверку подлинности для поддержки других версий Outlook (в том числе Outlook для Mac) для локальных пользователей, как описано в статье [Как настроить локальный сервер Exchange Server на использование гибридной современной проверки подлинности](https://support.office.com/article/how-to-configure-exchange-server-on-premises-to-use-hybrid-modern-authentication-cef3044d-d4cb-4586-8e82-ee97bd3b14ad?), то осталось выполнить лишь несколько действий:

1.  Создайте правило, разрешающее устройствам доступ к Exchange, чтобы среда Exchange Online могла подключаться к локальной среде по протоколу ActiveSync:
    
        If ((Get-ActiveSyncOrganizationSettings).DefaultAccessLevel -ne "Allow") {New-ActiveSyncDeviceAccessRule -Characteristic DeviceType -QueryString "OutlookService" -AccessLevel Allow}
    
    Обратите внимание на то, что управлять устройствами через локальный Центр администрирования Exchange невозможно. Для управления мобильными устройствами требуется Intune.

2.  Создайте правило доступа к Exchange с устройств, которое запрещает пользователям подключаться к локальной среде при помощи приложений Outlook для iOS и Android с обычной проверкой подлинности по протоколу Exchange ActiveSync:
    
        New-ActiveSyncDeviceAccessRule -Characteristic DeviceModel -QueryString "Outlook for iOS and Android" -AccessLevel Block
    
    > [!NOTE]  
    > После создания этого правила пользователи, применяющие Outlook для iOS и Android с обычной проверкой подлинности, будут блокироваться.


3.  Убедитесь, что параметр maxRequestLength в EAS настроен в соответствии с параметрами MaxSendSize и MaxReceiveSize конфигурации транспорта:
    
      - Путь: `%ExchangeInstallPath%FrontEnd\HttpProxy\Sync\web.config`.
    
      - Свойство: `maxRequestLength`.
    
      - Значение: размер в КБ (например, размеру 10 МБ соответствует значение 10240).

## Обращение в корпорацию Майкрософт

Чтобы включить поддержку гибридной современной проверки подлинности в Outlook для iOS и Android, необходимо обратиться в команду по управлению учетными записями Майкрософт (к контактному лицу по продажам и обслуживанию или к техническому специалисту по учетным записям). Вам потребуется указать все SMTP-домены (и домены UPN, если они не соответствуют SMTP-адресу). Когда домены будут указаны и включены, гибридная современная проверка подлинности будет поддерживаться для всех локальных почтовых ящиков с использованием Outlook для iOS и Android.

## Неподдерживаемые функции клиентов

Перечисленные ниже функции не поддерживаются для локальных почтовых ящиков с использованием гибридной современной проверки подлинности и Outlook для iOS и Android.

  - Синхронизация папки "Черновики" и черновиков сообщений

  - Общий и делегированный доступ к календарям

  - Напоминания Кортаны о необходимости выходить

  - Вложения календарей

  - Управление задачами с помощью Microsoft To-Do

## Вопросы и ответы о потоке подключения

**Вопрос.** В моей организации действует политика безопасности, разрешающая входящие подключения из Интернета только с утвержденных IP-адресов и FQDN. Возможно ли это с данной архитектурой?

**Ответ.** Корпорация Майкрософт рекомендует открыть локальные конечные точки для протоколов автообнаружения и ActiveSync, чтобы они были доступны из Интернета без каких-либо ограничений. В некоторых ситуациях это может быть невозможно. Например, если идет период сосуществования с другим решением MDM, вы можете установить ограничения протокола ActiveSync, чтобы пользователи не могли обходить стороннее решение MDM во время миграции в Intune и Outlook для iOS и Android. Если необходимо установить ограничения на локальный брандмауэр или пограничные устройства шлюзов, корпорация Майкрософт рекомендует выполнять фильтрацию по конечным точкам FQDN. Если использовать конечные точки FQDN не удается, выполняйте фильтрацию по IP-адресам. Убедитесь, что в список разрешений добавлены следующие IP-подсети и полные доменные имена:

  - Все URL-адреса Exchange Online и диапазоны IP-подсетей, определенные в статье [URL-адреса и диапазоны IP-адресов Office 365](https://support.office.com/article/office-365-urls-and-ip-address-ranges-8548a211-3fe7-47cb-abb1-355ea5aa88a2).

  - Все полные доменные имена приложения Outlook для iOS и Android, определенные в статье [Сетевые запросы в Office 365 профессиональный плюс и на мобильных устройствах](https://support.office.com/article/network-requests-in-office-365-proplus-and-mobile-eb73fcd1-ca88-4d02-a74b-2dd3a9f3364d?).

  - Все IP-подсети центров обработки данных Azure в США и Европе, определенные в документе [Диапазоны IP-адресов для центров обработки данных Microsoft Azure](https://www.microsoft.com/download/details.aspx?id=41653). Это необходимо, потому что служба AutoDetect устанавливает соединения с локальной инфраструктурой, как описано в разделе Поток подключения. В настоящее время служба AutoDetect не использует резервирование IP-адресов в Azure.

**Вопрос.** На данный момент в моей организации для управления подключениями с мобильных устройств используется стороннее решение MDM. Если сделать пространство имен Exchange ActiveSync доступным из Интернета, пользователи смогут обходить стороннее решение MDM в течение периода сосуществования. Как предотвратить это?

**Ответ.** Устранить эту проблему можно тремя способами.

1.  Реализуйте правила доступа к Exchange с мобильных устройств, которые указывают, каким устройствам разрешено подключаться.

2.  Некоторые сторонние решения MDM интегрируются с правилами доступа к Exchange с мобильных устройств, блокируя несанкционированный доступ и добавляя разрешенные устройства в свойство ActiveSyncAllowedDeviceIDs пользователя.

3.  Реализуйте ограничения IP-адресов в пространстве имен Exchange ActiveSync.

**Вопрос.** Можно ли использовать Azure ExpressRoute для управления трафиком между Microsoft Cloud и локальной средой?

**Ответ.** Для соединения с Microsoft Cloud необходимо подключение к Интернету. Однако часть сетевого трафика Office 365 можно направлять через Azure ExpressRoute. Дополнительные сведения см. в статье [Azure ExpressRoute для Office 365](https://support.office.com/article/azure-expressroute-for-office-365-6d2534a2-c19c-4a99-be5e-33a0cee5d3bd).

Для подключений ExpressRoute не используется частное пространство IP-адресов. Кроме того, "частное" разрешение DNS невозможно. Это означает, что каждая конечная точка, которую компании требуется использовать через ExpressRoute, должна разрешаться в общедоступный DNS. Если эта конечная точка разрешается в IP-адрес, указанный в объявленных префиксах, которые связаны с каналом ExpressRoute (компания должна настроить эти префиксы на портале Azure при включении пиринга Майкрософт для подключения ExpressRoute), то исходящее подключение из Exchange Online к локальной среде будет маршрутизироваться через канал ExpressRoute. Компания должна убедиться, что обратный трафик, связанный с этими подключениями, проходит через канал ExpressRoute (во избежание ассиметричной маршрутизации).

> [!NOTE]  
> Так как компания будет добавлять пространство имен Exchange ActiveSync к префиксам, объявленным в сети ExpressRoute, достичь конечной точки Exchange ActiveSync можно будет только через ExpressRoute. Другими словами, подключаться к локальной среде через пространство ActiveSync с мобильного устройства можно будет только через Outlook для iOS и Android. Все остальные клиенты ActiveSync (например, встроенные почтовые клиенты мобильных устройств) не смогут подключаться к локальной среде, так как соединение из Microsoft Cloud не будет устанавливаться. Это вызвано тем, что пространство общедоступных IP-адресов, объявленное корпорации Майкрософт для канала ExpressRoute, и пространство общедоступных IP-адресов, объявленное для ваших каналов Интернета, не могут пересекаться.


**Вопрос.** В Exchange Online синхронизируются только данные о сообщениях за последние четыре недели. Означает ли это, что поисковые запросы, выполненные в Outlook для iOS и Android, не могут возвращать какие-либо сведения, кроме данных, доступных на локальном устройстве?

**Ответ.** При выполнении поискового запроса в Outlook для iOS и Android элементы, соответствующие запросу, возвращаются только в том случае, если они находятся на устройстве. Кроме того, поисковый запрос передается в локальную среду Exchange через Exchange Online. Локальная среда Exchange выполняет поисковый запрос в локальном почтовом ящике и возвращает результаты в среду Exchange Online, которая ретранслирует результаты клиенту. Локальные результаты поиска хранятся в Exchange Online на протяжении одного дня, а затем удаляются.

**Вопрос.** Как убедиться, что учетная запись электронной почты успешно добавлена в Outlook для iOS и Android?

**Ответ.** К локальным почтовым ящикам, добавляемым через гибридную современную проверку подлинности, добавляется отметка **Exchange (гибридная)** в параметрах учетной записи Outlook для iOS и Android, как показано в следующем примере:

![Пример учетной записи Outlook для iOS и Android, настроенной для гибридной современной настройки подлинности](images/Mt846639.79887a65-e5e1-4501-a274-008393dbb6c9(EXCHG.150).png "Пример учетной записи Outlook для iOS и Android, настроенной для гибридной современной настройки подлинности")

## Вопросы и ответы о проверке подлинности

**Вопрос.** Какие конфигурации удостоверений поддерживаются в случае гибридной современной проверки подлинности и Outlook для iOS и Android?

**Ответ.** Гибридная современная проверка подлинности поддерживает следующие конфигурации удостоверений с Azure Active Directory:

  - федеративное удостоверение от локального поставщика удостоверений, поддерживаемого службой Azure Active Directory;

  - синхронизация хэша паролей через Azure Active Directory Connect;

  - сквозная проверка подлинности через Azure Active Directory Connect.

**Вопрос.** Какой механизм проверки подлинности используется в Outlook для iOS и Android? Хранятся ли учетные данные в Office 365?

**Ответ.** Для доступа к данным локальных почтовых ящиков, синхронизированных с Exchange Online, в Outlook для iOS и Android используется аутентификация на основе библиотеки проверки подлинности Active Directory (ADAL). При проверке подлинности на основе ADAL, используемой приложениями Office как на настольных компьютерах, так и на мобильных устройствах, пользователи входят непосредственно в службу Azure Active Directory, которая является поставщиком удостоверений для Office 365, а не предоставляют учетные данные в Outlook.

Применение ADAL при входе позволяет использовать OAuth для локальных учетных записей гибридной среды Exchange и обеспечивает приложению Outlook для iOS и Android безопасный механизм доступа к электронной почте, не требующий доступа к учетным данным пользователя. Во время входа пользователь проходит проверку подлинности непосредственно в Microsoft Cloud и получает маркер доступа. Маркер предоставляет приложению Outlook для iOS и Android доступ к соответствующему почтовому ящику. OAuth предоставляет приложению Outlook безопасный механизм доступа к Office 365 и облачной службе Outlook, не требующий получения учетных данных пользователя или их хранения.

Дополнительные сведения см. в записи блога Office [Новые средства управления доступом и безопасностью в Outlook для iOS и Android](https://blogs.office.com/2015/06/10/new-access-and-security-controls-for-outlook-for-ios-and-android/).

**Вопрос.** Поддерживается ли единый вход в Outlook для iOS и Android, а также других мобильных приложениях Microsoft Office?

**Ответ.** Все приложения Майкрософт, использующие для аутентификации библиотеку проверки подлинности Azure Active Directory (ADAL), поддерживают единый вход. Кроме того, единый вход также поддерживается, если эти приложения работают совместно с приложением Microsoft Authenticator или "Корпоративный портал Майкрософт".

Несколько приложений Майкрософт (например, Word Mobile) могут использовать одни и те же маркеры, в том числе повторно, в перечисленных ниже случаях.

1.  Приложения подписаны одним и тем же сертификатом и используют одну и ту же конечную точку службы или URL-адрес аудитории (например, URL-адрес Office 365). В этом случае маркер хранится в общем хранилище приложений.

2.  Приложения используют или поддерживают единый вход с вовлечением брокер-приложения. Маркеры хранятся в брокер-приложении. К брокер-приложениям относится Microsoft Authenticator. В случае с брокер-приложением после попытки входа в Outlook для iOS и Android библиотека ADAL запускает приложение Microsoft Authenticator, которое подключается к Azure Active Directory для получения маркера. Затем оно сохраняет маркер и повторно использует его для запросов на проверку подлинности от других приложений (насколько позволяет настроенное время жизни маркера).

Дополнительные сведения см. в статье [Включение единого входа в нескольких приложениях iOS с помощью ADAL](https://docs.microsoft.com/ru-ru/azure/active-directory/develop/active-directory-sso-ios).

**Вопрос.** Каков срок действия маркеров, создаваемых и используемых библиотекой проверки подлинности Active Directory (ADAL) в Outlook для iOS и Android?

**Ответ.** Когда локальный пользователь проходит проверку подлинности через приложения с поддержкой ADAL, например Outlook для iOS и Android, Authenticator или "Корпоративный портал", создается несколько маркеров. Первая пара маркеров (доступа и обновления) используется для доступа к данным, синхронизируемым с Exchange Online, а вторую использует среда Exchange Online для доступа к локальному почтовому ящику по протоколу Exchange ActiveSync. Маркер доступа используется для доступа к ресурсу (например, данным сообщений Exchange), а маркер обновления — для получения новой пары маркеров (доступа и обновления), когда истечет срок действия маркера доступа.

По умолчанию время жизни маркера доступа составляет один час, а срок действия маркера обновления — четырнадцать дней. Эти значения можно настраивать. Дополнительные сведения см. в статье [Настройка времени жизни маркеров в Azure Active Directory (общедоступная предварительная версия)](https://docs.microsoft.com/azure/active-directory/active-directory-configurable-token-lifetimes). Обратите внимание на то, что сокращение времени жизни этих маркеров может снизить производительность Outlook для iOS и Android, так как приложению придется чаще получать новый маркер доступа.

**Вопрос.** Что происходит с маркером доступа при изменении пароля пользователя?

**Ответ.** Предоставленный ранее маркер доступа остается действительным, пока не истечет срок его действия. Способ обработки просроченных паролей зависит от модели удостоверений, используемой для проверки подлинности. Возможны три сценария.

1.  При использовании федеративной модели удостоверений необходимо убедиться, что локальный поставщик удостоверений отправляет утверждения об истечении срока действия пароля в Azure Active Directory. В противном случае Azure Active Directory не сможет реагировать на просроченные пароли. Дополнительные сведения см. в статье [Настройка AD FS для отправки утверждений об истечении срока действия пароля](https://docs.microsoft.com/windows-server/identity/ad-fs/operations/configure-ad-fs-to-send-password-expiry-claims).

2.  Синхронизация хэша паролей не поддерживает истечение срока действия пароля. Это означает, что приложения, которые ранее получили пару маркеров (доступа и обновления), продолжат работать, пока не истечет срок действия пары маркеров или пользователь не сменит пароль. Дополнительные сведения см. в статье [Реализация синхронизации хэшированных паролей в службе синхронизации Azure AD Connect](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnectsync-implement-password-hash-synchronization#how-password-synchronization-works).

3.  Для сквозной проверки подлинности необходимо, чтобы в AAD Connect была включена обратная запись паролей. Дополнительные сведения см. в статье [Сквозная проверка подлинности Azure Active: ответы на часто задаваемые вопросы](https://docs.microsoft.com/azure/active-directory/connect/active-directory-aadconnect-pass-through-authentication-faq#what-happens-if-my-users-password-has-expired-and-they-try-to-sign-in-by-using-pass-through-authentication).

По истечении срока действия маркера клиент попробует получить новый маркер доступа с помощью маркера обновления, но так как пароль пользователя был изменен, маркер обновления станет недействительным (предполагается, что выполнялась синхронизация службы каталогов между локальной средой и Azure Active Directory). Так как маркер обновления недействителен, пользователю придется повторно пройти проверку подлинности, чтобы получить новые маркеры доступа и обновления.

**Вопрос.** Может ли пользователь обойти AutoDetect, добавляя свою учетную запись в Outlook для iOS и Android?

**Ответ.** Да. Пользователь может обойти AutoDetect в любой момент и вручную настроить соединение, используя обычную проверку подлинности по протоколу Exchange ActiveSync. Чтобы гарантировать, что пользователь не устанавливает соединение с локальной средой при помощи механизма, не поддерживающего политики условного доступа с использованием Azure Active Directory и политики защиты приложений с использованием Intune, локальный администратор Exchange должен настроить правило доступа к устройствам Exchange, которое блокирует подключение ActiveSync. Для этого в командной консоли Exchange введите следующую команду:

``` 
 New-ActiveSyncDeviceAccessRule -Characteristic DeviceModel -QueryString "Outlook for iOS and Android" -AccessLevel Block
```

