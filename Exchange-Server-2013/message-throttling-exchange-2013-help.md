---
title: 'Регулирование количества сообщений: Exchange 2013 Help'
TOCTitle: Регулирование количества сообщений
ms:assetid: fba87902-2a79-42ac-b394-46a9016f667e
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Bb232205(v=EXCHG.150)
ms:contentKeyID: 50489510
ms.date: 04/30/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# Регулирование количества сообщений

 

_**Применимо к:** Exchange Server 2013_

_**Последнее изменение раздела:** 2015-03-09_

*Регулирование количества сообщений* ссылается на группу ограничений, установленных на количество сообщений и подключений, которые могут быть обработаны компьютером Microsoft Exchange Server 2013. Эти ограничения предотвращают случайное или намеренное использование всех системных ресурсов на сервере Exchange Server.

**Содержание**

Область регулирования количества сообщений

Затраты для сообщений и регулирование потока почты

Регулирование количества сообщений на серверах

Регулирование количества сообщений на соединителях отправки

Регулирование количества сообщений на соединителях получения

Политики регулирования количества сообщений

## Область регулирования количества сообщений

Регулирование количества сообщений предполагает установку различных ограничений скорости обработки сообщений, скорости подключения по протоколу SMTP и времени ожидания для сеанса SMTP. Вместе эти ограничения защищают сервер Exchange Server от перегрузки из-за приема и отправки сообщений. Ограничения регулирования количества сообщений позволяют серверу Exchange Server организованно обрабатывать сообщения и подключения несмотря на наличие большого журнала ожидания обработки сообщений и подключений.

Помимо регулирования количества сообщений, можно установить ограничения для отдельных компонентов сообщений, например количество получателей, размер заголовка сообщения или размер отдельных вложений. Дополнительные сведения об ограничениях размера сообщений см. в разделе [Ограничения на размер сообщений](message-size-limits-exchange-2013-help.md).

Другая возможность, которая позволяет предотвратить чрезмерное использование системных ресурсов транспортного сервера Exchange Server, — *замедленная обратная реакция*. Замедленная обратная реакция — это функция наблюдения за ресурсами системы, доступная в службах транспорта на серверах почтовых ящиков и пограничных транспортных серверах. Когда загрузка системного ресурса, за которым ведется наблюдение, например жесткого диска или памяти, превышает определенное пороговое значение, сервер снижает допустимую частоту получения новых подключений и сообщений и направляет все ресурсы на доставку существующих сообщений. Когда степень загрузки системных ресурсов, за которыми ведется наблюдение, возвращается к нормальному уровню, сервер начинает принимать новые подключения и сообщения с обычной частотой.

В начало

## Затраты для сообщений и регулирование потока почты

Чтобы обеспечить более согласованную пропускную способность для сообщений и более предсказуемую задержку доставки сообщений, Exchange 2013 вводит понятие накопленных затрат для сообщений. Эта функция качества обслуживания (QoS) добавлена в пакет обновления Microsoft Exchange Server 2010 1 (SP1). Эти затраты рассчитываются на основе описанных ниже критериев.

  - Размер сообщения

  - Количество получателей

  - Частота передачи

Транспортные серверы Exchange 2013 отслеживают средний показатель затрат на доставку сообщений, отправляемых отдельными пользователями. Используя затраты на сообщения, Exchange 2013 предоставляет группу параметров, которая позволяет управлять воздействием пользователя или подключения на организацию Exchange. Эта группа параметров называется *политикой регулирования*. Когда пользователь неоднократно отправляет сообщения с высокими затратами, например сообщения с большими вложениями или сообщения для большого числа получателей, транспортные серверы на базе Exchange 2013 используют политику регулирования, чтобы назначить более низкий приоритет сообщениям с более высокими затратами, продолжая доставлять сообщения, имеющие низкие затраты. Такое новое поведение добавляет в функциональную возможность регулирования количества сообщений Exchange 2013 аспект «качества обслуживания».

> [!NOTE]  
> Регулирование количества сообщений не влияет на приоритет сообщений с точки зрения пользователя. Сообщения по-прежнему сохраняют первоначальный приоритет, установленный пользователем. Например, сообщения сохраняют параметр важности или срочности и т. п.


Для обеспечения поддержки этой функциональной возможности Exchange 2013 использует следующие механизмы:

  - **Внутренний агент установки приоритетов**. Этот агент активируется по событию **OnResolvedMessage** и назначает более низкий приоритет сообщениям от одного отправителя, имеющим высокие накопленные затраты. Эти затраты измеряются за период в одну минуту и затрагивают сообщения, имеющие более 500 получателей или размер более 1 МБ.

  - **Организация очередей с учетом приоритетов на базе квот для типа очереди MapiDelivery**   Этот механизм позволяет Exchange доставлять сообщения из очереди с нормальным приоритетом чаще, чем сообщения из очереди с низким приоритетом. По умолчанию соотношение для сообщений с обычным и низким приоритетом составляет 20:1. Однако новые сообщения из очереди с более низким приоритетом никогда не доставляются быстрее, чем новые элементы из очереди с более высоким приоритетом. В качестве примера рассмотрим следующий сценарий.
    
    1.  Доставляются 20 сообщений с нормальным приоритетом. По умолчанию следующим доставляемым сообщением является сообщение с низким приоритетом.
    
    2.  Транспортный сервер получает два новых сообщения: одно сообщение из очереди с более высоким и одно — из очереди с более низким приоритетом.
    
    В данном сценарии сообщение из очереди с более высоким приоритетом доставляется первым. Затем доставляется сообщение из очереди с более низким приоритетом.

  - **Регулирование одновременных подключений на основании работоспособности базы данных сообщений**   Этот механизм отслеживает работоспособность базы данных сообщений (MDB) Exchange и регулирует одновременные подключения к транспортным серверам Exchange на базе назначенного значения показателя работоспособности. База данных сообщений отслеживается API монитора работоспособности ресурсов в службе транспорта на сервере почтовых ящиков, и ей назначается значение работоспособности от -1 до 100. Это значение основано на статистике производительности RPC, включаемой в каждый ответ RPC от процесса Store.exe транспортной службы почтовых ящиков. Платформа работоспособности ресурсов использует как счетчик производительности для скорости **Запросов в секунду**, так и счетчик производительности **Средняя задержка RPC**, чтобы вычислять значение работоспособности для базы данных. Чтобы обеспечить согласованное интерактивное взаимодействие с пользователем, по мере снижения значения работоспособности Exchange сокращает число одновременных подключений. Доступны следующие диапазоны значений работоспособности:
    
      - **-1:**  это значение указывает на то, что состояние работоспособности базы данных сообщений неизвестно. Это значение назначается при запуске базы данных. В данном сценарии база данных считается работоспособной.
    
      - **0:**  это значение назначается в случае, когда база данных находится в неработоспособном состоянии. В этом состоянии устанавливать связь с базой данных не следует.
    
      - **1–99:**  эти значения представляют промежуточное состояние работоспособности. Более низкое значение представляет менее работоспособную базу данных.
    
      - **100:**  это значение представляет работоспособную базу данных.

Служба регулирования Microsoft Exchange предоставляет рамки регулирования потока почты. Служба регулирования Microsoft Exchange отслеживает параметры регулирования потока почты для отдельного пользователя и кэширует сведения регулирования в памяти. Параметры регулирования потока почты также называются *бюджетом*. При перезапуске службы регулирования Microsoft Exchange также выполняется сброс бюджетов регулирования потоков почты.

Вы можете использовать доступные в Exchange 2013 командлеты политики регулирования, чтобы настраивать параметры отдельных бюджетов для политики регулирования. Бюджет — это объем прав доступа, который пользователь или приложение могут иметь для конкретного параметра. Бюджет представляет, сколько подключений пользователь может иметь или какой объем активности разрешен для пользователя для каждого из периодов длительностью в одну минуту. Например, бюджет может быть настроен на установку времени, которое пользователь может потратить на использование отдельного компонента в Exchange, такого как ActiveSync, Outlook Web App или веб-службы Exchange. Это пороговое значение хранится в политике регулирования и определяет бюджет.

Параметры времени для бюджета устанавливаются в виде процентного отношения к одной минуте. Таким образом, пороговое значение в 100 % соответствует 60 секундам. Предположим, например, что вы хотите указать для параметров политики Outlook Web App, ограничивающих время, в течение которого пользователь может выполнять код Outlook Web App на сервере клиентского доступа, а также время, в течение которого пользователь может взаимодействовать с сервером клиентского доступа, значение 600 миллисекунд за один период длительностью в одну минуту. Чтобы сделать это, вам нужно для обоих следующих параметров установить значение 1 % от одной минуты (600 миллисекунд):

  - **OWAPercentTimeInCAS:**  1

  - **OWAPercentTimeInMailboxRPC:**  1

Пользователь, для которого применяется данная политика, имеет бюджет 600 миллисекунд для OWAPercentTimeInCAS и 600 миллисекунд для OWAPercentageTimeInMailboxRPC. В данном сценарии когда пользователь выполнил вход в систему Outlook Web App, он может выполнять код клиентского доступа в течение не более 600 миллисекунд. По истечении указанного периода подключение считается превысившим бюджет, и сервер Exchange Server не разрешает выполнение дальнейших действий Outlook Web App до истечения одной минуты после достижения предела бюджета. После периода в одну минуту пользователь может выполнить код клиентского доступа Outlook Web App в течение следующих 600 миллисекунд.

В начало

## Регулирование количества сообщений на серверах

Параметры регулирования количества сообщений можно установить в следующих местах:

  - В службе транспорта

  - на соединителе отправки;

  - на соединителе приема.

Параметры регулирования количества сообщений можно настроить в службе транспорта на серверах почтовых ящиков, в службе транспорта почтовых ящиков на серверах почтовых ящиков или в службе транспорта переднего плана на серверах клиентского доступа с помощью командной консоли Exchange. Некоторые из этих же параметров можно задать через свойства транспортного сервера в Центре администрирования Exchange (EAC).

В таблице ниже представлены параметры регулирования количества сообщений, доступные на транспортных серверах.

### Параметры регулирования количества сообщений для транспортных серверов

<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>Источник</th>
<th>Параметр</th>
<th>Значение по умолчанию</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>Set-TransportService</strong></p>
<p><strong>Set-MailboxTransportService</strong></p></td>
<td><p><em>MaxConcurrentMailboxDeliveries</em></p></td>
<td><p>20</p></td>
<td><p>Этот параметр указывает максимальное количество потоков доставки, которое транспортный сервер может одновременно открыть для доставки сообщений в почтовые ящики. Допустимый диапазон значений данного параметра — от 1 до 256. Данные параметры рекомендуется изменять только после получения соответствующих указаний от службы технической поддержки Майкрософт.</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-TransportService</strong></p>
<p><strong>Set-MailboxTransportService</strong></p></td>
<td><p><em>MaxConcurrentMailboxSubmissions</em></p></td>
<td><p>20</p></td>
<td><p>Этот параметр указывает максимальное количество потоков передачи, которое транспортный сервер может одновременно открыть для отправки сообщений из почтовых ящиков. Допустимый диапазон вводимых значений для этого параметра — от 1 до 256.</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-TransportService</strong></p></td>
<td><p><em>MaxConnectionRatePerMinute</em></p></td>
<td><p>1200</p></td>
<td><p>Этот параметр указывает максимальную частоту, с которой транспортному серверу разрешается открывать подключения. При попытке открыть несколько подключений к транспортной службе значение параметра <em>MaxConnectionRatePerMinute</em> ограничивает частоту открытия подключений, чтобы избежать чрезмерного использования ресурсов сервера.</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-TransportService</strong> или</p>
<p>свойства транспортного сервера</p></td>
<td><p><em>MaxOutboundConnections</em></p></td>
<td><p>1000</p></td>
<td><p>Этот параметр указывает максимальное количество исходящих подключений, которые могут быть открыты одновременно. Если ввести значение <code>unlimited</code>, никакие ограничения на количество исходящих подключений налагаться не будут. Значение этого параметра не может быть меньше, чем значение параметра <em>MaxPerDomainOutboundConnections</em>.</p>
<p>Это значение также можно настроить в центре администрирования Exchange в разделе <strong>Серверы</strong> &gt; <strong>Серверы</strong> &gt; <strong>Свойства</strong> &gt; <strong>Пределы транспорта</strong> &gt; <strong>Ограничения исходящих подключений</strong>.</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-TransportService</strong> или</p>
<p>свойства транспортного сервера</p></td>
<td><p><em>MaxPerDomainOutboundConnections</em></p></td>
<td><p>20</p></td>
<td><p>Этот параметр указывает максимальное количество одновременных подключений к отдельному домену. Если указать значение <code>unlimited</code>, никакие ограничения на количество исходящих подключений на домен налагаться не будут. Значение этого параметра не может быть меньше, чем значение параметра <em>MaxOutboundConnections</em>.</p>
<p>Это значение также можно настроить в центре администрирования Exchange в разделе <strong>Серверы</strong> &gt; <strong>Серверы</strong> &gt; <strong>Свойства</strong> &gt; <strong>Пределы транспорта</strong> &gt; <strong>Ограничения исходящих подключений</strong>.</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-TransportService</strong></p></td>
<td><p><em>PickupDirectoryMaxMessagesPerMinute</em></p></td>
<td><p>100</p></td>
<td><p>Этот параметр указывает максимальное количество сообщений, которые могут быть обработаны за минуту каталогом раскладки и каталогом преобразования. Каждый каталог может независимо обрабатывать файлы сообщений со скоростью, заданной этим параметром.</p></td>
</tr>
</tbody>
</table>


В начало

## Регулирование количества сообщений на соединителях отправки

В таблице ниже представлен параметр регулирования количества сообщений, доступный на соединителях отправки. Для настройки этого параметра необходимо использовать командную консоль Exchange.

### Параметр регулирования количества сообщений, доступный на соединителях отправки

<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>Источник</th>
<th>Параметр</th>
<th>Значение по умолчанию</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>Set-SendConnector</strong></p></td>
<td><p><em>ConnectionInactivityTimeOut</em></p></td>
<td><p>10 минут</p></td>
<td><p>Этот параметр задает максимальное количество времени, в течение которого подключение по протоколу SMTP к конечному серверу обмена сообщениями может оставаться открытым при его бездействии.</p></td>
</tr>
</tbody>
</table>


В начало

## Регулирование количества сообщений на соединителях получения

В таблице ниже показаны параметры регулирования количества сообщений, доступные для соединителей получения, настроенных в службе транспорта на сервере почтовых ящиков или на пограничном транспортном сервере. Для настройки этих параметров необходимо использовать командную консоль Exchange.

### Параметры регулирования количества сообщений, доступные на соединителях получения

<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>Источник</th>
<th>Параметр</th>
<th>Значение по умолчанию</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>ConnectionInactivityTimeOut</em></p></td>
<td><p>5 минут в службе транспорта на серверах почтовых ящиков</p>
<p>5 минут в службе транспорта переднего плана на серверах клиентского доступа.</p>
<p>1 минута на пограничных транспортных серверах.</p></td>
<td><p>Этот параметр задает максимальное количество времени, в течение которого подключение по протоколу SMTP к исходному серверу обмена сообщениями может оставаться открытым при его бездействии. Значение данного параметра должно быть меньше значения, заданного для параметра <em>ConnectionTimeout</em>.</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>ConnectionTimeOut</em></p></td>
<td><p>10 минут в службе транспорта на серверах почтовых ящиков</p>
<p>10 минут в службе транспорта переднего плана на серверах клиентского доступа.</p>
<p>5 минут на пограничных транспортных серверах.</p></td>
<td><p>Этот параметр задает максимальное количество времени, в течение которого подключение по протоколу SMTP к исходному серверу обмена сообщениями может оставаться открытым, даже если сервер обмена сообщениями передает данные. Значение данного параметра должно быть больше значения, заданного для параметра <em>ConnectionInactivityTimeout</em>.</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>MaxInboundConnection</em></p></td>
<td><p>5000</p></td>
<td><p>Этот параметр задает максимальное количество одновременных входящих подключений SMTP, допустимое этим соединителем приема.</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>MaxInboundConnectionPercentagePerSource</em></p></td>
<td><p>100 процентов для соединителя получения по умолчанию в службе транспорта на сервере почтовых ящиков</p>
<p>2 процента для соединителя получения в службе транспорта на серверах почтовых ящиков и в службе транспорта переднего плана на серверах клиентского доступа.</p></td>
<td><p>Этот параметр указывает максимальное количество одновременных подключений SMTP с одного исходного сервера обмена сообщениями, допустимое этим соединителем приема. Значение выражается в виде процента доступных оставшихся подключений для соединителя приема. Максимальное количество подключений, допускаемое соединителем приема, определяется параметром <em>MaxInboundConnection</em>.</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>MaxInboundConnectionPerSource</em></p></td>
<td><p>unlimited для соединителя получения по умолчанию в службе транспорта на сервере почтовых ящиков</p>
<p>20 для других соединителей получения в службе транспорта на серверах почтовых ящиков и в службе транспорта переднего плана на серверах клиентского доступа.</p></td>
<td><p>Этот параметр указывает максимальное количество одновременных подключений SMTP с одного исходного сервера обмена сообщениями, допустимое этим соединителем приема.</p></td>
</tr>
<tr class="even">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>MaxProtocolErrors</em></p></td>
<td><p>5</p></td>
<td><p>Этот параметр задает максимальное количество ошибок протокола SMTP, которое допускает соединитель приема перед закрытием подключения к исходному серверу обмена сообщениями.</p></td>
</tr>
<tr class="odd">
<td><p><strong>Set-ReceiveConnector</strong></p></td>
<td><p><em>TarpitInterval</em></p></td>
<td><p>5 с</p></td>
<td><p>Этот параметр определяет продолжительность <em>искусственной задержки ответов</em>. Искусственная задержка ответов применяется для задержки откликов SMTP для определенных моделей подключений, которые указывают на атаку с целью сбора действующих адресов, а также наличие других нежелательных сообщений. <em>Атака с целью сбора действующих адресов</em> — это попытка собрать допустимые адреса электронной почты определенной организации для рассылки нежелательной почты коммерческого содержания.</p>
<p>Задержка, устанавливаемая параметром <em>TarpitInterval</em>, применяется только к анонимным подключениям.</p></td>
</tr>
</tbody>
</table>


В начало

## Политики регулирования количества сообщений

В Exchange 2013 каждый почтовый ящик имеет параметр *ThrottlingPolicy*. По умолчанию этот параметр имеет пустое значение (`$null`). Можно использовать параметр *ThrottlingPolicy* командлета **Set-Mailbox**, чтобы настроить политику регулирования для почтового ящика.

Доступна политика регулирования по умолчанию, которая предоставляет конфигурацию бюджета по умолчанию для пользователей, подключающихся к Exchange. Чтобы задать настраиваемые параметры бюджета для одного или нескольких пользователей, создайте новую политику регулирования. После этого примените ее к соответствующему пользователю или группе пользователей.

> [!IMPORTANT]  
> Рекомендуется не изменять политику регулирования по умолчанию.


Все параметры регулирования количества сообщений, доступные на серверах почтовых ящиков, можно установить с помощью командной консоли Exchange. Для управления политиками регулирования доступны следующие командлеты:

  - **Get-ThrottlingPolicy**

  - **Remove-ThrottlingPolicy**

  - **New-ThrottlingPolicy**

  - **Set-ThrottlingPolicy**

Вы можете использовать командлеты **New-ThrottlingPolicy** и **Set-ThrottlingPolicy** для настройки объема действий, которые пользователь может выполнять в Exchange в рамках определенного подключения или периода времени. Эти параметры составляют бюджет пользователя. Можно создать политики регулирования для управления доступом к следующим компонентам Exchange:

  - Exchange ActiveSync

  - Веб-службы Exchange

  - Outlook Web App

  - Единая система обмена сообщениями

  - IMAP4

  - POP3

  - Клиентские подключения Outlook (подключения MAPI или RPC)

  - Параметры потока почты

  - Команды PowerShell

  - Использование ЦП

В начало

