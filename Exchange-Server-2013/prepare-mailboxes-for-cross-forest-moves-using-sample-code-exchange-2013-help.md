---
title: 'Exchange 2013: пример кода подготовки почтовых ящиков к перемещению в иной лес'
TOCTitle: Подготовка почтовых ящиков для перемещения между лесами с помощью примера кода
ms:assetid: f35ac7a5-bb84-4653-b6d0-65906e93627b
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Ee861124(v=EXCHG.150)
ms:contentKeyID: 50489503
ms.date: 04/30/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# Подготовка почтовых ящиков для перемещения между лесами с помощью примера кода

 

_**Применимо к:** Exchange Server 2013_

_**Последнее изменение раздела:** 2016-12-09_

Microsoft Exchange 2013 поддерживает перемещение и миграцию почтовых ящиков с помощью командлетов **New-MoveRequest** и **New-MigrationBatch**. Вы также можете переместить почтовый ящик с помощью Центра администрирования Exchange. Можно переместить почтовый ящик из исходного леса Exchange в целевой лес Exchange 2010.

Для запуска **New-MoveRequest** пользователь почты должен существовать в целевом лесу Exchange и иметь минимальный набор обязательных атрибутов Active Directory.  Необходимого почтового пользователя можно создать в целевом лесу Exchange, настроив развертывание Microsoft Identity Lifecycle Manager (ILM) 2007. Пример кода расширения правил на основе ILM, описанный в этом разделе, демонстрирует, как настроить текущее развертывание ILM для создания пользователей с включенной поддержкой почты в целевом лесу Exchange 2013.

Дополнительные сведения о подготовке перемещений между лесами, включая описания обязательных атрибутов Active Directory, см. в разделе [Подготовка почтовых ящиков для запросов на перемещение между лесами](prepare-mailboxes-for-cross-forest-move-requests-exchange-2013-help.md).

## Что нужно знать перед началом работы

  - Скачайте пример кода со страницы [Подготовка к оперативному перемещению почтовых ящиков](https://go.microsoft.com/fwlink/p/?linkid=177882) в Центре загрузки Майкрософт.

  - Для запуска этого примера кода необходим пакет дополнительных компонентов 1 (FP1) для ILM 2007 с пакетом обновления 1 (SP1). Подробнее о скачивании пакета дополнительных компонентов см. в статье 977791 базы знаний Майкрософт [Для пакета дополнительных компонентов 1 (FP1) Identity Lifecycle Manager 2007 доступен пакет обновления 1 (SP1) (сборка 3.3.1139.2)](http://go.microsoft.com/fwlink/p/?linkid=3052&kbid=977791).

  - Кроме того, необходимо следующее:
    
      - Исходный лес под управлением Exchange 2013, в котором на данный момент размещен почтовый ящик.
    
      - Целевой лес с установленной системой Exchange 2013, в который необходимо переместить почтовый ящик.

  - Чтобы подключиться к целевому лесу Exchange 2013, необходимо иметь соответствующее разрешение на вызов командлета **UpdateRecipient**. Подробнее о том, какие разрешения необходимы, см. в подразделе "Разрешения подготовки получателей" темы [Разрешения получателей](recipients-permissions-exchange-2013-help.md).

  - Сочетания клавиш для процедур, описанных в этой статье, приведены в статье [Сочетания клавиш в Центре администрирования Exchange](keyboard-shortcuts-in-the-exchange-admin-center-exchange-online-protection-help.md).

> [!TIP]  
> Возникли проблемы? Обратитесь за помощью к участникам форумов, посвященных Exchange. Посетите форумы по таким продуктам: <a href="https://go.microsoft.com/fwlink/p/?linkid=60612">Exchange Server</a>, <a href="https://go.microsoft.com/fwlink/p/?linkid=267542">Exchange Online</a> или <a href="https://go.microsoft.com/fwlink/p/?linkid=285351">Exchange Online Protection</a>.


## Как это сделать?

## Действие 1. Установка примера кода ILM

1.  В Microsoft Visual Studio 2008 для просмотра примера кода откройте Microsoft.Exchange.Sample.OneWayGALSync.sln. Пример кода включает следующее:
    
      - Microsoft.MetadirectoryServicesEx.dll — это двоичный файл, который входит в пакет обновления 1 (SP1) для ILM 2007 с пакетом дополнительных компонентов 1 (FP1). Путь к этому файлу: \\Program Files\\Microsoft Identity Integration Server\\Bin\\Assemblies. На него ссылается пример кода.
    
      - Пример кода ссылается на файл OneWaySync.xml.
    
      - В папке ILMServerConfig содержатся файлы конфигурации ILM для исходного агента управления, целевого агента управления и метавселенной ILM.
    
      - Путь к файлам Microsoft.Exchange.Sample.OneWayGALSync.MARules.dll и Microsoft.Exchange.Sample.OneWayGALSync.MVRules.dll, созданным на основе примера кода: \\obj\\Debug.

2.  На сервере ILM скопируйте следующие файлы в папку \\Program Files\\Microsoft Identity Integration Server\\Extensions:
    
      - OneWaySync.xml
    
      - Microsoft.Exchange.Sample.OneWayGALSync.MARules.dll
    
      - Microsoft.Exchange.Sample.OneWayGALSync.MVRules.dll

3.  Внесите изменения в файл OneWaySync.xml (скопированный в папку ILM Extensions в действии 1), чтобы указать различающееся имя (DN) контейнера TargetOU в целевом лесу Exchange, в котором требуется создать почтовых пользователей. Если имя контейнера TargetOU неизвестно, его можно просмотреть с помощью средства LDP.exe или ADSIEdit.exe.
    
    > [!NOTE]  
    > При использовании данного примера кода совместно с ILM GalSync 2007 исключите данный контейнер из списка контейнеров, управляемых GalSync2007.


4.  В консоли диспетчера удостоверений ILM выберите **File** (Файл) \> **Import Server Configuration** (Импорт конфигурации сервера) для импорта конфигурации сервера ILM из папки ILMServerConfig. Это действие позволяет импортировать два агента управления Active Directory вместе со схемой метавселенной и правилом подготовки.
    
    > [!NOTE]  
    > Во время импорта необходимо указать имя леса и учетные данные и сопоставить разделы импортированного агента управления Active Directory (ADMA) с именем раздела в конфигурации, как для исходного, так и для целевого агента ADMA.


5.  Чтобы агент ADMA поддерживал целевой лес Exchange 2013, в области **Configure Extensions** (Настройка расширений) на странице **Create Management Agent** (Создание агента управления) выберите пункт **Exchange 2013** в раскрывающемся списке **Provision for** (Подготовка для), а затем введите удаленный URI-код Windows PowerShell для сервера клиентского доступа Exchange 2010 в поле **Exchange 2013 RPS URI** (URI-код Exchange 2013 RPS).
    
    **Создание страницы агента управления**
    
    ![Подготовка агента управления в Exchange 2010](images/Aa998597.8f403cda-e5e4-4edf-887f-c1ed46cee3f5(EXCHG.150).gif "Подготовка агента управления в Exchange 2010")  

6.  В области **Create Management Agent** (Создание агента управления) консоли диспетчера удостоверений ILM откройте окно **Свойства** для агента управления исходного леса. Выберите мастер **Configure Directory Partitions** (Настройка разделов каталога) и щелкните **Контейнеры** для выбора контейнера, который будет содержать почтовые ящики, перемещаемые в целевой лес. Снимите флажки для всех остальных контейнеров, т.е. включите в область агента управления только этот контейнер. Аналогично для агента управления целевого леса выберите контейнер, в котором будет осуществляться подготовка пользователей, поддерживающих почту (TargetOU, указанный в шаге 2).
    
    > [!NOTE]  
    > При использовании данного примера кода совместно с ILM GalSync 2007 исключите оба этих контейнера из списка контейнеров, управляемых GalSync 2007.


7.  Выполните начальный полный импорт (только размещение) для целевых агентов управления, чтобы ILM мог обнаружить контейнер TargetOU, указанный в действии 2.

## Действие 2. Создание почтового пользователя в целевом лесу Exchange

Теперь, когда пример кода установлен, используйте следующую процедуру для создания требуемого пользователя почты в целевом лесу Exchange, чтобы можно было запустить **New-MoveRequest** для выполнения оперативного перемещения почтовых ящиков.

1.  В исходном лесу с помощью Центра администрирования Exchange создайте почтовых пользователей в контейнере, выбранном в шаге 4 "Установки примера кода ILM". Чтобы переместить существующих почтовых пользователей в контейнер, можно также использовать оснастку "Пользователи и компьютеры Active Directory".

2.  Запустите разностный импорт и разностную синхронизацию для исходного агента управления, чтобы обнаружить почтовые ящики, добавленные в исходный контейнер, и подготовить пользователей почты для целевого агента управления.

3.  Выполните экспорт для целевого агента управления, чтобы экспортировать пользователей почты, подготовленных в действии 1, в целевой Active Directory.

4.  Выполните разностный импорт для целевого агента управления, чтобы подтвердить изменения, экспортированные в действии 2.

5.  В целевом лесу откройте командную консоль Exchange и используйте командлет **New-MoveRequest** для перемещения почтовых ящиков из исходного леса.

## Как проверить, что все получилось?

Чтобы убедиться, что вы успешно завершили миграцию, выполните следующие действия.

  - Проверьте, отображаются ли в целевом лесу пользователи, перенесенные из исходного леса.

