---
title: 'Наблюдение за группами обеспечения доступности баз данных: Exchange 2013 Help'
TOCTitle: Наблюдение за группами обеспечения доступности баз данных
ms:assetid: f5bdfd6e-e93c-4d96-8bc2-548750d51930
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Dd351258(v=EXCHG.150)
ms:contentKeyID: 50489543
ms.date: 05/22/2018
mtps_version: v=EXCHG.150
ms.translationtype: MT
---

# Наблюдение за группами обеспечения доступности баз данных

 

_**Применимо к:**Exchange Server 2013_

_**Последнее изменение раздела:**2015-03-09_

Сведения из этой статьи можно использовать для мониторинга работоспособности и состояния копий баз данных почтовых ящиков в группах обеспечения доступности баз данных, сбора диагностических сведений и настройки порога мониторинга недостаточного места на диске.

## Командлет Get-MailboxDatabaseCopyStatus

Командлет [Get-MailboxDatabaseCopyStatus](https://technet.microsoft.com/ru-ru/library/dd298044\(v=exchg.150\)) можно использовать для просмотра сведений о состоянии копий баз данных почтовых ящиков. Этот командлет позволяет просматривать сведения о всех копиях конкретной базы данных, об определенной копии базы данных на определенном сервере или обо всех копиях баз данных на сервере. В следующей таблице приведены возможные значения состояния копий баз данных почтовых ящиков.

### Состояние копии базы данных

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Состояние копии базы данных</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Failed</p></td>
<td><p>Копия базы данных почтовых ящиков находится в состоянии Failed (Сбой), поскольку она не приостановлена, но не может копировать или преобразовывать файлы журналов. Пока копия базы данных не приостановлена и находится в состоянии сбоя, система будет периодически проверять, устранена ли проблема, которая привела к состоянию сбоя. После того как система обнаружит, что эта проблема устранена, и никакие другие проблемы не мешают, состояние копии автоматически изменяется на Healthy (Исправно).</p></td>
</tr>
<tr class="even">
<td><p>Seeding</p></td>
<td><p>Выполняется заполнение или копии базы данных почтовых ящиков, или индекса контента или и того, и другого. После успешного завершения заполнения состояние копии должно измениться на Initializing (Инициализация).</p></td>
</tr>
<tr class="odd">
<td><p>SeedingSource</p></td>
<td><p>Копия базы данных почтовых ящиков используется как источник для заполнения копии базы данных.</p></td>
</tr>
<tr class="even">
<td><p>Suspended</p></td>
<td><p>Копия базы данных почтовых ящиков находится в состоянии Suspended (Приостановлено) в результате того, что администратор вручную приостановил эту копию базы данных, выполнив командлет <strong>Suspend-MailboxDatabaseCopy</strong>.</p></td>
</tr>
<tr class="odd">
<td><p>Healthy</p></td>
<td><p>Копия базы данных почтовых ящиков успешно копирует и преобразует файлы журналов, или она уже успешно скопировала и преобразовала все доступные файлы журналов.</p></td>
</tr>
<tr class="even">
<td><p>ServiceDown</p></td>
<td><p>Служба репликации Microsoft Exchange недоступна или не работает на сервере, на котором находится эта копия базы данных.</p></td>
</tr>
<tr class="odd">
<td><p>Initializing</p></td>
<td><p>Копия базы данных почтовых ящиков будет находиться в состоянии инициализации, когда создана копия базы данных, когда служба репликации Microsoft Exchange запускается или только что запущена, а также во время перехода из состояния Suspended, ServiceDown, Failed, Seeding или SinglePageRestore в другое состояние. В этом состоянии система проверяет, находятся ли база данных и поток журнала в согласованном состоянии. В большинстве случаев копия находится в состоянии инициализации около 15 секунд, и во всех случаях она не должна находиться в этом состоянии долее 30 секунд.</p></td>
</tr>
<tr class="even">
<td><p>Resynchronizing</p></td>
<td><p>Копия базы данных почтовых ящиков и ее файлы журналов сравниваются с действующей копией базы данных для поиска какого-либо отклонения этой копии. Копия остается в этом состоянии до тех пор, пока отклонение не будет обнаружено и устранено.</p></td>
</tr>
<tr class="odd">
<td><p>Mounted</p></td>
<td><p>Активная копия находится в оперативном режиме и принимает клиентские подключения. Только активная копия базы данных почтовых ящиков может находиться в состоянии &quot;подключено&quot;.</p></td>
</tr>
<tr class="even">
<td><p>Dismounted</p></td>
<td><p>Активная копия находится в автономном режиме и не принимает клиентские подключения. Только активная копия базы данных почтовых ящиков может находиться в состоянии &quot;отключено&quot;.</p></td>
</tr>
<tr class="odd">
<td><p>Mounting</p></td>
<td><p>Активная копия переходит в оперативный режим и еще не принимает клиентские подключения. Только активная копия базы данных почтовых ящиков может находиться в состоянии &quot;подключение&quot;.</p></td>
</tr>
<tr class="even">
<td><p>Dismounting</p></td>
<td><p>Активная копия переходит в автономный режим и завершает клиентские подключения. Только активная копия базы данных почтовых ящиков может находиться в состоянии &quot;отключение&quot;.</p></td>
</tr>
<tr class="odd">
<td><p>DisconnectedAndHealthy</p></td>
<td><p>Копия базы данных почтовых ящиков больше не подключена к активной копии базы данных, но во время потери подключения она находилась в исправном состоянии. Это состояние представляет копию базы данных по отношению к ее исходной копии базы данных. Такое состояние может быть получено при сбоях сети группы обеспечения доступности баз денных между исходной и целевой копиями базы данных.</p></td>
</tr>
<tr class="even">
<td><p>DisconnectedAndResynchronizing</p></td>
<td><p>Копия базы данных почтовых ящиков больше не подключена к активной копии базы данных, но во время потери подключения она находилась в состоянии повторной синхронизации. Это состояние представляет копию базы данных по отношению к ее исходной копии базы данных. Такое состояние может быть получено при сбоях сети группы обеспечения доступности баз денных между исходной и целевой копиями базы данных.</p></td>
</tr>
<tr class="odd">
<td><p>FailedAndSuspended</p></td>
<td><p>Состояния сбоя и приостановки установлены системой одновременно, поскольку был обнаружен сбой, и для устранения этого сбоя явно требуется вмешательство администратора. В качестве примера можно привести ситуацию, когда система обнаружила неустранимое отклонение активной базы данных почтовых ящиков от ее копии. В отличие от состояния сбоя, в данном состоянии система не будет периодически проверять, устранена ли проблема, и выполнять автоматическое восстановление. Здесь необходимо вмешательство администратора, который должен устранить причину сбоя, прежде чем копия база данных может быть переведена в исправное состояние.</p></td>
</tr>
<tr class="even">
<td><p>SinglePageRestore</p></td>
<td><p>Это состояние указывает, что в копии базы данных почтовых ящиков происходит операция восстановления одной страницы.</p></td>
</tr>
</tbody>
</table>


Командлет **Get-MailboxDatabaseCopyStatus** также возвращает сведения об используемых сетях репликации, включая *IncomingLogCopyingNetwork*, которая возвращается для пассивных копий баз данных, и *OutgoingConnections*, которая возвращается для активных баз данных, имеющих несколько копий, а также для всех копий баз данных, используемых в качестве источника операции заполнения базы данных. Сведения об исходящих подключениях предоставляются для копий баз данных, находящихся в файловом режиме репликации. Сведения об исходящих подключениях не предоставляются для копий баз данных, находящихся в блочном режиме репликации.

## Примеры использования командлета Get-MailboxDatabaseCopyStatus

В следующих примерах показано использование командлета **Get-MailboxDatabaseCopyStatus**. В каждом примере результат выполнения этого командлета передается в командлет **Format-List** для отображения результатов в виде списка.

В этом примере возвращаются сведения о состоянии всех копий базы данных с именем DB2.

    Get-MailboxDatabaseCopyStatus -Identity DB2 | Format-List

В этом примере возвращаются сведения о состоянии всех копий базы данных на сервере почтовых ящиков с именем MBX2.

    Get-MailboxDatabaseCopyStatus -Server MBX2 | Format-List

В этом примере возвращаются сведения о состоянии всех копий базы данных на локальном сервере почтовых ящиков.

    Get-MailboxDatabaseCopyStatus -Local | Format-List

Дополнительные сведения об использовании командлета **Get-MailboxDatabaseCopyStatus** см. в разделе [Get-MailboxDatabaseCopyStatus](https://technet.microsoft.com/ru-ru/library/dd298044\(v=exchg.150\)).

## Командлет Test-ReplicationHealth

Командлет [Test-ReplicationHealth](https://technet.microsoft.com/ru-ru/library/bb691314\(v=exchg.150\)) можно использовать для просмотра сведений о состоянии непрерывной репликации копий баз данных почтовых ящиков. Этот командлет можно использовать для проверки всех аспектов репликации и состояния преобразования, чтобы составить полный обзор конкретного сервера почтовых ящиков в группе обеспечения доступности баз данных.

Командлет **Test-ReplicationHealth** создан для профилактического наблюдения за непрерывной репликацией и конвейером непрерывной репликации, за доступностью службы Active Manager, а также за работоспособностью и состоянием внутренних служб кластеров, кворума и сетевых компонентов. Его можно выполнять локально или удаленно для любого сервера почтовых ящиков в группе обеспечения доступности баз данных. Командлет **Test-ReplicationHealth** выполняет тесты, приведенные в следующей таблице.

### Тесты командлета Test-ReplicationHealth

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Имя теста</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>ClusterService</p></td>
<td><p>Проверяет, работает ли служба кластеров и достижима ли она в указанном члене группы обеспечения доступности баз данных, а если член этой группы не указан, то достижима ли она на локальном сервере.</p></td>
</tr>
<tr class="even">
<td><p>ReplayService</p></td>
<td><p>Проверяет, работает ли служба репликации Microsoft Exchange и достижима ли она в указанном члене группы обеспечения доступности баз данных, а если член этой группы не указан, то достижима ли она на локальном сервере.</p></td>
</tr>
<tr class="odd">
<td><p>ActiveManager</p></td>
<td><p>Проверяет, имеет ли экземпляр диспетчера Active Manager, работающий в указанном члене группы обеспечения доступности баз данных (или если этот член группы не указан, то на локальном сервере), допустимую роль (основной, дополнительный или отдельный).</p></td>
</tr>
<tr class="even">
<td><p>TasksRpcListener</p></td>
<td><p>Проверяет, работает ли сервер Tasks RPC Server и достижим ли он в указанном члене группы обеспечения доступности баз данных, а если член этой группы не указан, то достижим ли он на локальном сервере.</p></td>
</tr>
<tr class="odd">
<td><p>TcpListener</p></td>
<td><p>Проверяет, работает ли прослушиватель копий журналов TCP и достижим ли он в указанном члене группы обеспечения доступности баз данных, а если член этой группы не указан, то достижим ли он на локальном сервере.</p></td>
</tr>
<tr class="even">
<td><p>ServerLocatorService</p></td>
<td><p>Проверяет процессы клиента и сервера Active Manager в членах группы DAG и на сервере клиентского доступа, которые выполняют поиск в Active Directory и Active Manager для определения, активен ли почтовый ящик пользователя.</p></td>
</tr>
<tr class="odd">
<td><p>DagMembersUp</p></td>
<td><p>Проверяет, работают ли все члены группы обеспечения доступности баз данных, а также их доступность и достижимость.</p></td>
</tr>
<tr class="even">
<td><p>ClusterNetwork</p></td>
<td><p>Проверяет, доступны ли все управляемые кластером сети в указанном члене группы обеспечения доступности баз данных (или на локальном сервере, если член этой группы не указан).</p></td>
</tr>
<tr class="odd">
<td><p>QuorumGroup</p></td>
<td><p>Проверяет, находится ли кластерная группа по умолчанию (группа кворума) в исправном и оперативном состоянии.</p></td>
</tr>
<tr class="even">
<td><p>FileShareQuorum</p></td>
<td><p>Проверяет, настроен ли следящий сервер и файловый ресурс-свидетель таким образом, чтобы была достижима группа обеспечения доступности баз данных.</p></td>
</tr>
<tr class="odd">
<td><p>DatabaseRedundancy</p></td>
<td><p>Проверяет, существует ли хотя бы одна доступная работоспособная копия баз данных в указанном члене группы DAG, а если не указан ни один член группы DAG, то на локальном сервере.</p></td>
</tr>
<tr class="even">
<td><p>DatabaseAvailability</p></td>
<td><p>Проверяет, достаточно ли доступны базы данных в указанном члене группы DAG, а если ни один член группы DAG не указан, то на локальном сервере.</p></td>
</tr>
<tr class="odd">
<td><p>DBCopySuspended</p></td>
<td><p>Проверяет, находятся ли какие-либо копии баз данных почтовых ящиков в приостановленном состоянии в указанном члене группы обеспечения доступности баз данных, а если член этой группы не указан, то на локальном сервере.</p></td>
</tr>
<tr class="even">
<td><p>DBCopyFailed</p></td>
<td><p>Проверяет, находятся ли какие-либо копии баз данных почтовых ящиков в состоянии сбоя в указанном члене группы обеспечения доступности баз данных, а если член этой группы не указан, то на локальном сервере.</p></td>
</tr>
<tr class="odd">
<td><p>DBInitializing</p></td>
<td><p>Проверяет, находятся ли какие-либо копии баз данных почтовых ящиков в состоянии инициализации в указанном члене группы обеспечения доступности баз данных, а если член этой группы не указан, то на локальном сервере.</p></td>
</tr>
<tr class="even">
<td><p>DBDisconnected</p></td>
<td><p>Проверяет, находятся ли какие-либо копии баз данных почтовых ящиков в отключенном состоянии в указанном члене группы обеспечения доступности баз данных, а если член этой группы не указан, то на локальном сервере.</p></td>
</tr>
<tr class="odd">
<td><p>DBLogCopyKeepingUp</p></td>
<td><p>Проверяет, выполняется ли копирование и проверка журнала пассивными копиями баз данных в указанном члене группы обеспечения доступности баз данных (или на локальном сервере, если этот член не указан) согласованно с действиями по созданию журнала в активной копии.</p></td>
</tr>
<tr class="even">
<td><p>DBLogReplayKeepingUp</p></td>
<td><p>Проверяет, выполняются ли действия по преобразованию пассивных копий баз данных в указанном члене группы обеспечения доступности баз данных (или на локальном сервере, если этот член не указан) согласованно с действиями по копированию и проверке журнала.</p></td>
</tr>
</tbody>
</table>


## Пример использования командлета Test-ReplicationHealth

В этом примере командлет **Test-ReplicationHealth** используется для тестирования исправности репликации сервера почтовых ящиков MBX1.

    Test-ReplicationHealth -Identity MBX1

## Ведение журнала событий канала Crimson

В Windows имеется две категории журналов событий: журналы Windows и журналы приложений и служб. В категорию журналов Windows входят журналы событий, доступные в предыдущих версиях Windows: журналы событий приложений, безопасности и системы. Кроме того, в эту категорию включены два новых журнала: журнал установки (Setup) и журнал пересылаемых событий (ForwardedEvents). Журналы Windows предназначены для хранения событий из устаревших приложений и событий, относящихся ко всей системе.

Журналы приложений и служб представляют собой новую категорию журналов событий. Эти журналы хранят события из одного приложения или компонента, а не события, которые имеют значение на уровне системы. Эта новая категория журналов событий называется каналом Crimson приложения.

В категорию журналов приложений и служб входят четыре подтипа: журналы администрирования, операционные, аналитические и отладки. События из журналов администрирования представляют особый интерес при использовании записей журналов событий для устранения проблем. События в журнале администрирования должны предоставлять рекомендации по реакции на эти события. События в операционном журнале также полезны, но для них может потребоваться дополнительная интерпретация. Журналы администрирования и отладки не понятны пользователям. Аналитические журналы (которые по умолчанию скрыты и отключены) хранят события, отслеживающие проблему, и в них часто записывается большой объем событий. Журналы отладки используются разработчиками при отладке приложений.

Exchange 2013 записывает события в каналы Crimson в области журналов приложений и служб. Эти каналы можно просмотреть, выполнив приведенные далее действия.

1.  Откройте окно просмотра событий.

2.  В дереве консоли выберите **Журналы приложений и служб** \> **Microsoft** \> **Exchange**.

3.  В разделе **Exchange** выберите красный канал, например **HighAvailability** или **MailboxDatabaseFailureItems**, чтобы просмотреть события, связанные с группой обеспечения доступности баз данных и копией базы, либо **ActiveMontoring** или **ManagedAvailability**, чтобы просмотреть события, связанные с управляемой доступностью.

Канал HighAvailability содержит события, относящиеся к запуску и остановке службы репликации Microsoft Exchange и разным компонентам, работающим в службе репликации Microsoft Exchange, таким как диспетчер Active Manager, API синхронной репликации сторонних производителей, сервер Tasks RPC Server, прослушиватель TCP и модуль записи службы теневого копирования томов (VSS). Канал HighAvailability также используется диспетчером Active Manager для записи в журнал событий, относящихся к событиям отслеживания роли Active Manager и работы базы данных, таких как операция подключения базы данных и усечение журнала, а также для записи событий, относящихся к базовому кластеру группы обеспечения доступности баз данных.

Канал MailboxDatabaseFailureItems используется для ведения журнала событий, связанных с любыми сбоями, влияющими на реплицированную базу данных почтовых ящиков.

Канал ActiveMonitoring содержит определения и результирующие события зондов, мониторов и ответчиков управляемой доступности.

Канал ManagedAvailability содержит журналы и результаты действий по восстановлению и связанные события.

## Монитор недостаточного дискового пространства

Компонент управляемой доступности Exchange 2013 каждую минуту отслеживает сотни показателей и компонентов системы, в том числе объем свободного дискового пространства на томах, используемых ролью сервера почтовых ящиков. Exchange 2013 без пакета обновления 1 (SP1) отслеживает доступное пространство на всех локальных томах, в том числе на тех, которые не содержат базы данных или файлы журналов. После выпуска пакета обновления 1 (SP1) и более поздних версий отслеживаются только тома, содержащие базы данных Exchange и файлы журналов. В пакете обновления 1 (SP1) для монитора недостаточного дискового пространства по умолчанию установлен порог 200 ГБ. Порог по умолчанию в накопительном пакете обновления 6 для Exchange 2013 и более поздних версиях — 180 ГБ. В пакете обновления 1 (SP1) и более поздних версиях можно изменить порог, добавив следующее значение DWORD (в МБ) в реестр на каждом сервере почтовых ящиков, который необходимо настроить:

Путь: **HKEY\_LOCAL\_MACHINE\\Software\\Microsoft\\ExchangeServer\\v15\\Replay\\Parameters**

Значение: *SpaceMonitorLowSpaceThresholdInMB*

Например, чтобы установить для порога значение 100 ГБ, необходимо задать следующее значение реестра:

**REG\_DWORD 186a0 (100000)**

Чтобы изменения вступили в силу, после настройки или изменения упомянутого выше значения реестра необходимо перезапустить службу управления Microsoft Exchange DAG.

## Сценарий CollectOverMetrics.ps1

В Exchange 2013 имеется скрипт с именем CollectOverMetrics.ps1, который можно найти в папке скриптов. Сценарий CollectOverMetrics.ps1 читает журналы событий членов группы обеспечения доступности баз данных, чтобы получить информацию об операциях над базой данных (подключениях, перемещениях и отработках отказов) за определенный период времени. Для каждой операции сценарий фиксирует следующую информацию.

  - Идентификатор базы данных

  - Время начала и окончания операции

  - Серверы, к которым была подключена база данных в моменты начала и окончания операции

  - Причина для выполнения операции

  - Завершилась ли операция успешно, включая сведения об ошибках в случае сбоя операции

Сценарий записывает эти сведения в CSV-файлы (одна операция на каждой строке). Для каждой группы обеспечения доступности баз данных создается отдельный CSV-файл.

Данный сценарий поддерживает параметры, позволяющие настроить его поведение и выходные данные. Например, результаты можно ограничить определенным подмножеством при помощи параметров *Database* или *ReportFilter*. В сводный отчет в формате HTML будут включены только операции, которые соответствуют критериям этих фильтров. Доступные параметры перечислены в следующей таблице.

### Параметры скрипта CollectOverMetrics.ps1

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><em>DatabaseAvailabilityGroup</em></p></td>
<td><p>Задает имя группы обеспечения доступности баз данных, из которой планируется собирать показатели. Если этот параметр не указан, будет использоваться группа обеспечения доступности баз данных, членом которой является локальный сервер. Для сбора информации и создания отчетов по нескольким группам обеспечения доступности баз данных можно использовать подстановочные символы.</p></td>
</tr>
<tr class="even">
<td><p><em>Database</em></p></td>
<td><p>Предоставляет список баз данных, для которых необходимо создать отчет. Поддерживаются подстановочные знаки, например <code>-Database:&quot;DB1&quot;,&quot;DB2&quot;</code> или <code>-Database:&quot;DB*&quot;</code>.</p></td>
</tr>
<tr class="odd">
<td><p><em>StartTime</em></p></td>
<td><p>Задает продолжительность периода, за который создается отчет. Сценарий собирает только сведения о событиях, зарегистрированных в течение этого периода. В результате сценарий может фиксировать неполные записи об операциях (например, только конец операции в начале периода или наоборот). Если ни <em>StartTime</em>, ни <em>EndTime</em> не указаны, то для сценария устанавливается период по умолчанию — последние 24 часа. Если указан только один параметр, то будет задан период, равный 24 часам, который начинается или заканчивается в указанное время.</p></td>
</tr>
<tr class="even">
<td><p><em>EndTime</em></p></td>
<td><p>Задает продолжительность периода, за который создается отчет. Сценарий собирает только сведения о событиях, зарегистрированных в течение этого периода. В результате сценарий может фиксировать неполные записи об операциях (например, только конец операции в начале периода или наоборот). Если ни <em>StartTime</em>, ни <em>EndTime</em> не указаны, то для сценария устанавливается период по умолчанию — последние 24 часа. Если указан только один параметр, то будет задан период 24 часа, который начинается или заканчивается в указанное время.</p></td>
</tr>
<tr class="odd">
<td><p><em>ReportPath</em></p></td>
<td><p>Задает папку, используемую для хранения результатов обработки событий. Если этот параметр не указан, то будет использоваться папка скриптов. Если этот параметр указан, то сценарий использует список созданных им CSV-файлов в качестве исходных данных для сводного отчета в формате HTML. Этот отчет аналогичен отчету, который создается при помощи параметра -GenerateHtmlReport. Файлы могут создаваться для нескольких групп обеспечения доступности баз данных в разные моменты времени или даже в перекрывающиеся периоды; тогда сценарий объединяет все эти данные.</p></td>
</tr>
<tr class="even">
<td><p><em>GenerateHtmlReport</em></p></td>
<td><p>Указывает, что сценарий собирает все записанные сведения, группирует данные по типу операции и создает файл в формате HTML, содержащий статистику для каждой группы. Отчет включает общее число операций в каждой группе, число операций, завершившихся сбоем, и статистику по продолжительности операций для каждой группы. Отчет также содержит разбивку по типам ошибок, которые привели к сбою операций.</p></td>
</tr>
<tr class="odd">
<td><p><em>ShowHtmlReport</em></p></td>
<td><p>Указывает, что созданный HTML-отчет следует сразу же отобразить в веб-браузере.</p></td>
</tr>
<tr class="even">
<td><p><em>SummariseCsvFiles</em></p></td>
<td><p>Указывает, что сценарий считывает данные из существующих CSV-файлов, которые были ранее созданы сценарием. Затем эти данные используются для создания сводного отчета, аналогичного тому, что создается при помощи параметра <em>GenerateHtmlReport</em>.</p></td>
</tr>
<tr class="odd">
<td><p><em>ActionType</em></p></td>
<td><p>Указывает тип операций, сведения о которых должен собирать сценарий. Допустимы следующие значения этого параметра: <code>Move</code>, <code>Mount</code>, <code>Dismount</code> и <code>Remount</code>. Значение <code>Move</code> соответствует любому моменту времени, когда база данных изменяет свой активный сервер путем контролируемых перемещений или путем отработки отказа. Значения <code>Mount</code>, <code>Dismount</code> и <code>Remount</code> соответствуют моментам времени, когда изменяется состояние подключения базы данных без перемещения на другой компьютер.</p></td>
</tr>
<tr class="even">
<td><p><em>ActionTrigger</em></p></td>
<td><p>Указывает, сведения о каких административных операциях должен собирать сценарий. Этот параметр может принимать значения <code>Admin</code> или <code>Automatic</code>. Автоматические действия выполняются системой автоматически (например, отработка отказа, когда сервер переходит в автономный режим). Административные действия — это любые действия, которые выполняются администратором либо с помощью командной консоли Exchange, либо Центра администрирования Exchange.</p></td>
</tr>
<tr class="odd">
<td><p><em>RawOutput</em></p></td>
<td><p>Указывает, что сценарий передает результаты, которые были бы записаны в CSV-файлы, непосредственно в выходной поток, как в случае использования параметра Write-Output. Эти сведения впоследствии могут передаваться по конвейеру в другие команды.</p></td>
</tr>
<tr class="even">
<td><p><em>IncludedExtendedEvents</em></p></td>
<td><p>Указывает, что сценарий собирает сведения о событиях, которые предоставляют диагностическую информацию по времени подключения баз данных. Этот этап может занимать много времени, если журнал событий приложений на серверах очень большой.</p></td>
</tr>
<tr class="odd">
<td><p><em>MergeCSVFiles</em></p></td>
<td><p>Указывает, что сценарий объединяет все CSV-файлы, содержащие данные по каждой операции, в один CSV-файл.</p></td>
</tr>
<tr class="even">
<td><p><em>ReportFilter</em></p></td>
<td><p>Указывает, что к операциям необходимо применить фильтр с использованием полей в том виде, в котором они представлены в CSV-файлах. Этот параметр использует тот же формат, что и операция <code>Where</code>, где для каждого элемента задано значение <code>$_</code> и возвращается логическое значение. Например: можно указать <code>{$_DatabaseName -notlike &quot;Mailbox Database*&quot;}</code>, чтобы исключить из отчета базы данных по умолчанию.</p></td>
</tr>
</tbody>
</table>


## Примеры использования сценария CollectOverMetrics.ps1

В этом примере выполняется сбор показателей для всех баз данных с именами, соответствующих шаблону "DB\*" (с учетом подстановочного знака), в группе обеспечения доступности баз данных DAG1. После сбора показателей создается и отображается отчет в формате HTML.

    CollectOverMetrics.ps1 -DatabaseAvailabilityGroup DAG1 -Database:"DB*" -GenerateHTMLReport -ShowHTMLReport

В следующих примерах показаны способы фильтрации сводного отчета в HTML-формате. В первом примере используется параметр *Database*, который определяет список имен баз данных. Сводный отчет содержит данные только об этих базах данных. В следующих двух примерах используется параметр *ReportFilter*. В последнем примере отфильтровываются все базы данных по умолчанию.

    CollectOverMetrics.ps1 -SummariseCsvFiles (dir *.csv) -Database MailboxDatabase123,MailboxDatabase456
    CollectOverMetrics.ps1 -SummariseCsvFiles (dir *.csv) -ReportFilter { $_.DatabaseName -notlike "Mailbox Database*" }
    CollectOverMetrics.ps1 -SummariseCsvFiles (dir *.csv) -ReportFilter { ($_.ActiveOnStart -like "ServerXYZ*") -and ($_.ActiveOnEnd -notlike "ServerXYZ*") }

## Сценарий CollectReplicationMetrics.ps1

CollectReplicationMetrics.ps1 — это еще один сценарий сбора показателей работоспособности, включенный в Exchange 2013. Этот сценарий представляет собой активную форму наблюдения, поскольку он собирает показатели в режиме реального времени в ходе выполнения. Сценарий CollectReplicationMetrics.ps1 собирает данные, полученные от счетчиков производительности, которые относятся к репликации баз данных. Этот сценарий собирает данные счетчиков с нескольких серверов почтовых ящиков, записывает данные каждого сервера в CSV-файл и создает отчеты по различным статистическим показателям для всех этих данных (например, по таким показателям, как период, в течение которого каждая копия находилась в состоянии сбоя или приостановки, средняя длина очереди копирования или преобразования или период, в течение которого для копий не выполнялись критерии отработки отказа).

Можно указать либо каждый сервер по отдельности, либо всю группу обеспечения доступности баз данных. Можно либо запустить сценарий, чтобы сначала собрать данные и затем создать отчет, либо запустить его только для сбора данных или только для создания отчета по уже собранным данным. Можно указать частоту и общую продолжительность сбора данных.

Данные, собранные с каждого сервера, записываются в файл с именем **CounterData.\<имя\_сервера\>.\<отметка\_времени\>.csv**. Сводный отчет записывается в файл с именем **HaReplPerfReport.\<имя\_группы\_обеспечения\_доступности\_баз\_данных\>.\<отметка\_времени\>.csv** или **HaReplPerfReport.\<отметка\_времени\>.csv**, если сценарий не был запущен с параметром *DagName*.

Сценарий запускает задания Windows PowerShell для сбора данных с каждого сервера. Эти задачи выполняются в течение всего периода сбора данных. Если пользователь указывает много серверов, этот процесс может занять значительный объем памяти. Заключительный этап процесса — обработка данных для сводного отчета — может также занять много времени в случае большого объема данных. Можно выполнить этап сбора информации на одном компьютере, а затем скопировать данные на другой компьютер для обработки.

Сценарий CollectReplicationMetrics.ps1 поддерживает параметры, позволяющие настроить его поведение и выходные данные. Доступные параметры перечислены в следующей таблице.

### Параметры скрипта CollectReplicationMetrics.ps1

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><em>DagName</em></p></td>
<td><p>Задает имя группы обеспечения доступности баз данных, из которой планируется собирать показатели. Если этот параметр не указан, будет использоваться группа обеспечения доступности баз данных, членом которой является локальный сервер.</p></td>
</tr>
<tr class="even">
<td><p><em>DatabaseNames</em></p></td>
<td><p>Предоставляет список баз данных, для которых необходимо создать отчет. Поддерживаются подстановочные знаки, например <code>-DatabaseNames:&quot;DB1&quot;,&quot;DB2&quot;</code> или <code>-DatabaseNames:&quot;DB*&quot;</code>.</p></td>
</tr>
<tr class="odd">
<td><p><em>ReportPath</em></p></td>
<td><p>Задает папку, используемую для хранения результатов обработки событий. Если этот параметр не указан, то будет использоваться папка скриптов.</p></td>
</tr>
<tr class="even">
<td><p><em>Duration</em></p></td>
<td><p>Задает время, которое должен работать процесс сбора. Обычными значениями являются 1–3 часа. Большую продолжительность следует указывать только при длительных интервалах между выборками или в виде серии коротких операций, выполняемых в рамках запланированных задач.</p></td>
</tr>
<tr class="odd">
<td><p><em>Frequency</em></p></td>
<td><p>Указывает частоту, с которой должны собираться показатели данных. Обычными значениями являются 30 секунд, 1 минута или 5 минут. При нормальных условиях более короткие интервалы не покажут значительных отличий между выборками.</p></td>
</tr>
<tr class="even">
<td><p><em>Servers</em></p></td>
<td><p>Указывает идентификатор серверов, с которых собирается статистика. Можно указать любое значение, включая подстановочные символы или идентификаторы GUID.</p></td>
</tr>
<tr class="odd">
<td><p><em>SummariseFiles</em></p></td>
<td><p>Указывает список CSV-файлов для создания сводного отчета. Формат имени этих файлов: <strong>CounterData.&lt;CounterData&gt;*</strong>; они создаются сценарием CollectReplicationMetrics.ps1.</p></td>
</tr>
<tr class="even">
<td><p><em>Mode</em></p></td>
<td><p>Указывает этапы обработки, которые выполняет сценарий. Можно использовать следующие значения.</p>
<ul>
<li><p><code>CollectAndReport</code> Это значение по умолчанию. Это значение указывает, что сценарий должен собирать данные с серверов и затем обрабатывать их для создания сводного отчета.</p></li>
<li><p><code>CollectOnly</code>   Это значение указывает, что сценарий должен только собирать данные, не создавая отчет.</p></li>
<li><p><code>ProcessOnly</code>   Это значение указывает, что сценарий должен импортировать данные из CSV-файлов и обрабатывать их для создания сводного отчета. Параметр <em>SummariseFiles</em> передает сценарию список файлов, подлежащих обработке.</p></li>
</ul></td>
</tr>
<tr class="odd">
<td><p><em>MoveFilestoArchive</em></p></td>
<td><p>Указывает, что сценарий должен переместить файлы в сжатую папку после обработки.</p></td>
</tr>
<tr class="even">
<td><p><em>LoadExchangeSnapin</em></p></td>
<td><p>Указывает, что сценарий должен загружать команды из командной консоли. Этот параметр целесообразно использовать, когда нужно запускать сценарий вне командной консоли, например в рамках запланированной задачи.</p></td>
</tr>
</tbody>
</table>


## Пример использования сценария CollectReplicationMetrics.ps1

В следующем примере показан сбор данных в течение одного часа с минутными интервалами со всех серверов в группе обеспечения доступности баз данных DAG1, а затем создание сводного отчета. Кроме того, используется параметр *ReportPath*, поэтому сценарий помещает все файлы в текущий каталог.

    CollectReplicationMetrics.ps1 -DagName DAG1 -Duration "01:00:00" -Frequency "00:01:00" -ReportPath

В следующем примере показано чтение данных из всех файлов, отвечающих критерию "CounterData\*", и затем создание сводного отчета.

    CollectReplicationMetrics.ps1 -SummariseFiles (dir CounterData*) -Mode ProcessOnly -ReportPath

