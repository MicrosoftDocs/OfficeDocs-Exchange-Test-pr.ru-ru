---
title: 'Агенты транспорта: Exchange 2013 Help'
TOCTitle: Агенты транспорта
ms:assetid: e7389d63-3172-40d5-bf53-0d7cd7e78340
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Bb125012(v=EXCHG.150)
ms:contentKeyID: 50489390
ms.date: 04/30/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# Агенты транспорта

 

_**Применимо к:** Exchange Server 2013_

_**Последнее изменение раздела:** 2015-03-09_

Агенты транспорта позволяют установить пользовательское программное обеспечение, созданное корпорацией Майкрософт, сторонними поставщиками или специалистами вашей организации, на сервер Exchange. Это программное обеспечение может обрабатывать сообщения электронной почты, которые проходят через транспортный конвейер. В Microsoft Exchange Server 2013 транспортный конвейер состоит из следующих процессов:

  - интерфейсная транспортная служба на серверах клиентского доступа;

  - транспортная служба на серверах почтовых ящиков;

  - транспортная служба почтовых ящиков на серверах почтовых ящиков;

  - транспортная служба на пограничных транспортных серверах.

Дополнительные сведения о транспортном конвейере см. в разделе [Поток обработки почты](mail-flow-exchange-2013-help.md).

Как и в предыдущих версиях Exchange, транспорт Exchange 2013 обеспечивает расширяемость посредством агентов транспорта пакета SDK Microsoft Exchange Server 2013. Версия SDK Exchange 2013 основана на Майкрософт.NET Framework версии 4.0 и позволяет сторонним производителям реализовать следующие предопределенные классы:

  - **SmtpReceiveAgent**

  - **RoutingAgent**

  - **DeliveryAgent**

После подчинения библиотекам в SDK получившиеся сборки регистрируются в Exchange 2013, который загружает агентов и вызывает обработчиков событий во время определенных стадий SMTP сессий или обработки сообщений. Эти стадии, или события, являются частью определений агентов. Регистрационные данные агента хранятся в файле конфигурации XML.

В следующем списке описываются требования для использования агентов транспорта в Exchange 2013.

  - Транспортная служба на серверах почтовых ящиков и пограничных транспортных серверах полностью поддерживает все предопределенные классы в SDK, и, следовательно, все сторонние агенты транспорта, написанные для ролей транспортного сервера-концентратора или пограничного транспортного сервера в Microsoft Exchange Server 2010 будут работать в службе транспорта Exchange 2013.

  - Служба транспорта переднего плана поддерживает только класс **SmtpReceiveAgent** в SDK, и сторонние агенты не могут работать с SMTP событием **OnEndOfData**.

  - Служба транспорта почтовых ящиков вообще не поддерживает SDK, поэтому нельзя использовать сторонних агентов в службе транспорта почтовых ящиков.

Поддержка устаревших агентов транспорта на основе версии .NET Framework до версии 4.0 не включена по умолчанию, но ее можно включить. Дополнительные сведения см. в разделе [Включение поддержки устаревших агентов транспорта](enable-support-for-legacy-transport-agents-exchange-2013-help.md).

**Содержание**

Обновления для службы управления агентами транспорта

Агенты транспорта и события SMTP

Приоритет агентов транспорта

Встроенные агенты транспорта

Устранение неполадок агентов транспорта

## Обновления для службы управления агентами транспорта

В связи с обновлениями для транспортного конвейера Exchange 2013 командлеты агента транспорта должны различать службу транспорта и службу транспорта переднего плана, особенно если сервер клиентского доступа и сервер почтовых ящиков установлены на одном компьютере. Дополнительные сведения см. в разделе [Управление агентами транспорта](manage-transport-agents-exchange-2013-help.md).

Командные командлеты агента транспорта работают с файлом конфигурации, расположенным по адресу `%ExchangeInstallPath%TransportRoles\Shared`. Для службы транспорта на серверах почтовых ящиков и пограничных транспортных серверах — файл `agents.config`. Для интерфейсной транспортной службы на серверах клиентского доступа — файл `fetagents.config`. Оба файла используют тот же формат, что и в Exchange 2010. Дополнительные сведения об управлении агентами транспорта см. в разделе [Управление агентами транспорта](manage-transport-agents-exchange-2013-help.md).

В начало

## Агенты транспорта и события SMTP

Агенты транспорта используют события SMTP. Такие события возникают при передаче сообщений через транспортный конвейер. События SMTP предоставляют агентам транспорта доступ к сообщениям в особых точках в процессе сеансов связи SMTP и при маршрутизации сообщений через организацию.

Обратите внимание, что в Exchange 2013 появились новые события получения SMTP. Они существуют в интерфейсной транспортной службе на серверах клиентского доступа, транспортной службе на серверах почтовых ящиков и пограничных транспортных серверах, а также в транспортной службе для доставки почты в почтовый ящик на серверах почтовых ящиков. Классификатор существует только в транспортной службе на серверах почтовых ящиков и пограничных транспортных серверах. Дополнительные сведения о транспортных службах и классификаторе см. в разделе [Маршрутизация почты](mail-routing-exchange-2013-help.md).

В следующих таблицах приведены события SMTP, предоставляющие доступ к сообщениям в конвейере транспорта.

### События приема SMTP

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Последовательность</th>
<th>событие SMTP</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>1</p></td>
<td><p><strong>OnConnectEvent</strong></p></td>
<td><p>Это событие инициируется первоначальным подключением удаленного узла SMTP.</p></td>
</tr>
<tr class="even">
<td><p>2</p></td>
<td><p><strong>OnHeloCommand</strong></p></td>
<td><p>Это событие инициируется, когда удаленный узел SMTP передает команду <code>HELO</code>.</p></td>
</tr>
<tr class="odd">
<td><p>3</p></td>
<td><p><strong>OnEhloCommand</strong></p></td>
<td><p>Это событие инициируется, когда удаленный узел SMTP передает команду <code>EHLO</code>.</p></td>
</tr>
<tr class="even">
<td><p>4</p></td>
<td><p><strong>OnStartTlsCommand</strong></p></td>
<td><p>Это событие инициируется, когда удаленный узел SMTP передает команду <code>STARTTLS</code>.</p></td>
</tr>
<tr class="odd">
<td><p>5</p></td>
<td><p><strong>OnAuthCommand</strong></p></td>
<td><p>Это событие инициируется, когда удаленный узел SMTP передает команду <code>AUTH</code>.</p></td>
</tr>
<tr class="even">
<td><p>6</p></td>
<td><p><strong>OnProcessAuthentication</strong></p></td>
<td><p>Это событие инициируется, когда выполняется обработка проверки подлинности с помощью удаленного узла SMTP.</p></td>
</tr>
<tr class="odd">
<td><p>7</p></td>
<td><p><strong>OnEndOfAuthentication</strong></p></td>
<td><p>Это событие инициируется, когда удаленный узел SMTP завершил проверку подлинности.</p></td>
</tr>
<tr class="even">
<td><p>8</p></td>
<td><p><strong>OnXSessionParamsCommand</strong></p></td>
<td><p>Это событие инициируется, когда удаленный узел SMTP передает команду <code>XSESSIONPARAMS</code>.</p></td>
</tr>
<tr class="odd">
<td><p>9</p></td>
<td><p><strong>OnMailCommand</strong></p></td>
<td><p>Это событие инициируется, когда удаленный узел SMTP передает команду <code>MAIL FROM</code>.</p></td>
</tr>
<tr class="even">
<td><p>10</p></td>
<td><p><strong>OnRcptToCommand</strong></p></td>
<td><p>Это событие инициируется, когда удаленный узел SMTP передает команду <code>RCPT TO</code>.</p></td>
</tr>
<tr class="odd">
<td><p>11</p></td>
<td><p><strong>OnDataCommand</strong></p></td>
<td><p>Это событие инициируется, когда удаленный узел SMTP передает команду <code>DATA</code> (текст) или <code>BDAT</code> (двоичные данные).</p></td>
</tr>
<tr class="even">
<td><p>12</p></td>
<td><p><strong>OnEndOfHeaders</strong></p></td>
<td><p>Это событие инициируется, когда удаленный узел SMTP завершает передачу заголовков сообщений электронной почты. На это указывает пустая строка (<code>&lt;CRLF&gt;</code>), которая разделяет заголовки и текст сообщения.</p></td>
</tr>
<tr class="odd">
<td><p>13</p></td>
<td><p><strong>OnProxyInboundMessage</strong></p></td>
<td><p>Это событие инициируется, когда входящий сеанс SMTP ретранслируется или <em>передается через прокси-сервер</em> службой транспорта переднего плана на сервере клиентского доступа в службу транспорта на сервере почтовых ящиков.</p></td>
</tr>
<tr class="even">
<td><p>14</p></td>
<td><p><strong>OnEndOfData</strong></p></td>
<td><p>Это событие инициируется, когда удаленный узел SMTP передает команду окончания данных. Для текстовых сеансов, запущенных командой <code>DATA</code>, индикатором окончания данных выступает команда <code>&lt;CRLF&gt;.&lt;CRLF&gt;</code>. Для двоичных сеансов, запущенных командой <code>BDAT</code>, индикатором окончания данных выступает команда <code>BDAT LAST</code>.</p></td>
</tr>
<tr class="odd">
<td><p>**</p></td>
<td><p><strong>OnHelpCommand</strong></p></td>
<td><p>Это событие инициируется, если удаленный узел SMTP передает команду <code>HELP</code>.</p></td>
</tr>
<tr class="even">
<td><p>**</p></td>
<td><p><strong>OnNoopCommand</strong></p></td>
<td><p>Это событие инициируется, если удаленный узел SMTP передает команду <code>NOOP</code>.</p></td>
</tr>
<tr class="odd">
<td><p>**</p></td>
<td><p><strong>OnReject</strong></p></td>
<td><p>Это событие инициируется, если узел-получатель SMTP передает временный или постоянный код уведомления о доставке (DSN) узлу-отправителю SMTP.</p></td>
</tr>
<tr class="even">
<td><p>**</p></td>
<td><p><strong>OnRsetCommand</strong></p></td>
<td><p>Это событие инициируется, если узел-отправитель SMTP передает команду <code>RSET</code>.</p></td>
</tr>
<tr class="odd">
<td><p>15</p></td>
<td><p><strong>OnDisconnectEvent</strong></p></td>
<td><p>Это событие инициируется при прекращении сеанса связи SMTP узлом-отправителем или узлом-получателем SMTP. Обычно это происходит, когда удаленный узел SMTP передает команду <code>QUIT</code>.</p></td>
</tr>
</tbody>
</table>


\*\* Эти события могут возникать в любое время между событиями **OnConnectEvent** и **OnDisconnectEvent**.

### Классификатор событий

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Последовательность</th>
<th>Событие классификатора</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>1</p></td>
<td><p><strong>OnSubmittedMessage</strong></p></td>
<td><p>Это событие инициируется, когда сообщение попадает в очередь передачи в службе транспорта на принимающем сервере почтовых ящиков или пограничном транспортном сервере.</p></td>
</tr>
<tr class="even">
<td><p>2</p></td>
<td><p><strong>OnResolvedMessage</strong></p></td>
<td><p>Это событие возникает после разрешения всех получателей, но до определения следующего перехода для каждого получателя. Событие маршрутизации <strong>OnResolvedMessage</strong> позволяет последующим событиям переопределять способ маршрутизации по умолчанию с помощью метода <strong>SetRoutingOverride</strong>, выполняемого для отдельных получателей.</p></td>
</tr>
<tr class="odd">
<td><p>3</p></td>
<td><p><strong>OnRoutedMessage</strong></p></td>
<td><p>Это событие инициируется после завершения классификации сообщений, расширения списков рассылки и разрешения получателей.</p></td>
</tr>
<tr class="even">
<td><p>4</p></td>
<td><p><strong>OnCategorizedMessage</strong></p></td>
<td><p>Это событие инициируется, когда классификатор завершает обработку сообщения.</p></td>
</tr>
</tbody>
</table>


В начало

## Приоритет агентов транспорта

Порядок действия агентов транспорта на сообщения в транспортном конвейере определяют два фактора:

1.  Событие SMTP, в котором зарегистрирован агент транспорта, и момент, когда такое событие SMTP обнаруживает сообщения.

2.  Значение приоритета, назначенное агенту транспорта, если в одном событии SMTP зарегистрировано несколько агентов. Самый высокий приоритет — 1. Чем больше значение, тем ниже приоритет агента.

Например, предположим, что настроены следующие агенты транспорта:

  - В событии SMTP **OnEndOfHeaders** зарегистрированы агент транспорта А с приоритетом 1 и агент транспорта В с приоритетом 2.

  - В событии SMTP **OnMailCommand** зарегистрирован агент транспорта Б с приоритетом 4.

Сначала к сообщениям применяется агент транспорта Б, так как событие **OnMailCommand** обнаруживает сообщения раньше, чем событие **OnEndOfHeaders**. Когда сообщения достигают события **OnEndOfHeaders**, сначала применяется агент транспорта А, а затем — В, так как у первого из них приоритет выше (целое значение меньше).

## Встроенные агенты транспорта

Exchange 2013 включает множество встроенных агентов транспорта, которые обеспечивают такие функции, как защита от нежелательной почты, правила транспорта и ведение журнала. Большинство встроенных агентов транспорта на серверах почтовых ящиков и серверах клиентского доступа Exchange 2013 недоступны командлетам управления агентами транспорта и не могут контролироваться с их помощью. Практически все видимые и управляемые встроенные агенты транспорта находятся в транспортной службе на серверах почтовых ящиков и пограничных транспортных серверах.

Более интересные встроенные агенты транспорта на серверах почтовых ящиков описаны в таблице ниже. Обратите внимание, что в таблицу не включены многие невидимые агенты транспорта, которыми невозможно управлять.

### Интересные встроенные агенты транспорта на серверах почтовых ящиков

<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>Имя агента</th>
<th>Управляемость</th>
<th>Приоритет</th>
<th>События SMTP или классификатора</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Агент правил транспорта</p></td>
<td><p>Да</p></td>
<td><p>1</p></td>
<td><p><strong>OnResolvedMessage</strong></p></td>
</tr>
<tr class="even">
<td><p>Агент защиты от вредоносных программ</p></td>
<td><p>Да</p></td>
<td><p>2</p></td>
<td><p><strong>OnSubmittedMessage</strong></p></td>
</tr>
<tr class="odd">
<td><p>Агент маршрутизации обмена текстовыми сообщениями</p></td>
<td><p>Да</p></td>
<td><p>3</p></td>
<td><p><strong>OnSubmittedMessage</strong></p></td>
</tr>
<tr class="even">
<td><p>Агент доставки обмена текстовыми сообщениями</p></td>
<td><p>Да</p></td>
<td><p>4</p></td>
<td><p>Недоступно</p></td>
</tr>
<tr class="odd">
<td><p>Агент ведения журнала</p></td>
<td><p>Нет</p></td>
<td><p>Не настраивается</p></td>
<td><p><strong>OnRoutedMessage</strong></p></td>
</tr>
<tr class="even">
<td><p>Агент расшифровки отчетов журнала</p></td>
<td><p>Нет</p></td>
<td><p>Не настраивается</p></td>
<td><p><strong>OnCategorizedMessage</strong></p></td>
</tr>
<tr class="odd">
<td><p>Агент расшифровки RMS</p></td>
<td><p>Нет</p></td>
<td><p>Не настраивается</p></td>
<td><p><strong>OnSubmittedMessage</strong></p></td>
</tr>
<tr class="even">
<td><p>Агент шифрования RMS</p></td>
<td><p>Нет</p></td>
<td><p>Не настраивается</p></td>
<td><p><strong>OnSubmittedMessage</strong>, <strong>OnRoutedMessage</strong></p></td>
</tr>
<tr class="odd">
<td><p>Агент расшифровки протокола RMS</p></td>
<td><p>Нет</p></td>
<td><p>Не настраивается</p></td>
<td><p><strong>OnEndOfData</strong></p></td>
</tr>
</tbody>
</table>


На пограничных транспортных серверах большинство встроенных агентов транспорта доступны для командлетов агентов транспорта и других командлетов и могут контролироваться с их помощью.

Другие интересные встроенные агенты транспорта на пограничных транспортных серверах описаны в таблице ниже. Обратите внимание, что в таблицу не включены невидимые агенты транспорта, которыми невозможно управлять.

### Интересные встроенные агенты транспорта на пограничных транспортных серверах

<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>Имя агента</th>
<th>Управляемость</th>
<th>Приоритет</th>
<th>События SMTP или классификатора</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>Агент фильтрации подключений</p></td>
<td><p>Да</p></td>
<td><p>1</p></td>
<td><p><strong>OnConnectEvent</strong>, <strong>OnMailCommand</strong>, <strong>OnRcptComand</strong>, <strong>OnEndOfHeaders</strong></p></td>
</tr>
<tr class="even">
<td><p>Агент переопределения адресов входящих сообщений</p></td>
<td><p>Да</p></td>
<td><p>2</p></td>
<td><p><strong>OnRcptCommand</strong>, <strong>OnEndOfHeaders</strong></p></td>
</tr>
<tr class="odd">
<td><p>Агент пограничных правил</p></td>
<td><p>Да</p></td>
<td><p>3</p></td>
<td><p><strong>OnEndOfData</strong></p></td>
</tr>
<tr class="even">
<td><p>Агент фильтра содержимого*</p></td>
<td><p>Да</p></td>
<td><p>4</p></td>
<td><p><strong>OnEndOfData</strong></p></td>
</tr>
<tr class="odd">
<td><p>Агент идентификации отправителей*</p></td>
<td><p>Да</p></td>
<td><p>5</p></td>
<td><p><strong>OnEndOfHeaders</strong></p></td>
</tr>
<tr class="even">
<td><p>Агент фильтра отправителей*</p></td>
<td><p>Да</p></td>
<td><p>6</p></td>
<td><p><strong>OnMailCommand</strong>, <strong>OnEndOfHeaders</strong></p></td>
</tr>
<tr class="odd">
<td><p>Агент фильтра получателей</p></td>
<td><p>Да</p></td>
<td><p>7</p></td>
<td><p><strong>OnRcptCommand</strong></p></td>
</tr>
<tr class="even">
<td><p>Агент анализа протоколов*</p></td>
<td><p>Да</p></td>
<td><p>8</p></td>
<td><p><strong>OnConnectEvent</strong>, <strong>OnEndOfHeaders</strong>, <strong>OnEndOfData</strong>, <strong>OnReject</strong>, <strong>OnRsetCommand</strong>, <strong>OnDisconnectEvent</strong></p></td>
</tr>
<tr class="odd">
<td><p>Агент фильтрации вложений</p></td>
<td><p>Да</p></td>
<td><p>9</p></td>
<td><p><strong>OnEndOfData</strong></p></td>
</tr>
<tr class="even">
<td><p>Агент переопределения адресов исходящих сообщений</p></td>
<td><p>Да</p></td>
<td><p>10</p></td>
<td><p><strong>OnSubmittedMessage</strong>, <strong>OnRoutedMessage</strong></p></td>
</tr>
</tbody>
</table>


\* Эти агенты защиты от нежелательной почты можно также установить и настроить на серверах почтовых ящиков. Дополнительные сведения см. в разделе [Включение функции защиты от нежелательной почты на сервере почтовых ящиков](enable-anti-spam-functionality-on-mailbox-servers-exchange-2013-help.md).

В начало

## Устранение неполадок агентов транспорта

Устранить неполадки агентов транспорта можно с помощью следующих функций:

  - **Get-TransportPipeline**   Этот командлет отображает события SMTP и соответствующие агенты транспорта, которые обнаруживают сообщения на сервере Exchange. Дополнительные сведения см. в разделе [Просмотр агентов транспорта в транспортном конвейере](view-transport-agents-in-the-transport-pipeline-exchange-2013-help.md).

  - **Конвейерная трассировка** создает точный снимок всего сообщения до и после его обработки каждым агентом транспорта. Это позволяет обнаружить агент транспорта, который приводит к неожиданным результатам. Дополнительные сведения см. в разделе [Трассировка конвейера](pipeline-tracing-exchange-2013-help.md).

В начало

