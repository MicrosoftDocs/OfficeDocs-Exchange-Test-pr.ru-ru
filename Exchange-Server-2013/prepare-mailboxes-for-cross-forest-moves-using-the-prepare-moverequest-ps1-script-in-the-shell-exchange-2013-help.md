---
title: 'Подготовка почтовых ящиков к перемещению между лесами с использованием в консоли сценария Prepare-MoveRequest.ps1: Exchange 2013 Help'
TOCTitle: Подготовка почтовых ящиков к перемещению между лесами с использованием в консоли сценария Prepare-MoveRequest.ps1
ms:assetid: 2cea59fb-69b7-4a2f-833f-de4d93cf1810
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Ee861103(v=EXCHG.150)
ms:contentKeyID: 50487710
ms.date: 05/22/2018
mtps_version: v=EXCHG.150
ms.translationtype: MT
---

# Подготовка почтовых ящиков к перемещению между лесами с использованием в консоли сценария Prepare-MoveRequest.ps1

 

_**Применимо к:** Exchange Server 2013_

_**Последнее изменение раздела:** 2017-11-22_

**Сводка:**  сведения об управлении перемещение почтовых ящиков между лесами и миграций в Exchange 2013 с помощью сценария Prepare-MoveRequest.ps1 в Командная консоль Exchange.

Microsoft Exchange 2013 поддерживает перемещение почтовых ящиков и миграций с помощью командлетов **New-MoveRequest** и **New-MigrationBatch** . Вы также можете переместить почтовый ящик с помощью центра администрирования Exchange (EAC). Можно переместить Exchange 2010 или почтовых ящиков Exchange 2013 из исходного леса ExchangeExchange 2013 в целевой лес.

Чтобы выполнить командлеты **New-MoveRequest** и **New-MigrationBatch**, пользователь почты должен существовать в конечном лесу Exchange и этого пользователя должен быть минимальный набор требуемых атрибутов Active Directory.

Пример скрипта Windows PowerShell, представленный в этом разделе поддерживает эту задачу, синхронизируя пользователей почтовых ящиков из исходного леса Exchange 2013 в конечные леса Exchange 2013 как пользователей с поддержкой почты. По этому сценарию выполняется копирование атрибутов Active Directory пользователей почтовых ящиков в исходном лесу в целевой лес, а затем используется командлет **Update-Recipient** для преобразования целевых объектов в пользователей с включенной поддержкой почты.

Дополнительные сведения об использовании и записи сценариев см. в разделе [Создание сценариев в среде управления Exchange](https://technet.microsoft.com/ru-ru/library/bb123798\(v=exchg.150\)). Дополнительные сведения о подготовке к перемещению между лесами см. в разделе [Подготовка почтовых ящиков для запросов на перемещение между лесами](prepare-mailboxes-for-cross-forest-move-requests-exchange-2013-help.md).

Необходимы сведения о других задачах управления, связанных с удаленными запросами на перемещение? см. в разделе [Управление локальными перемещениями](manage-on-premises-moves-exchange-2013-help.md).

## Что нужно знать перед началом работы?

  - Найдите сценарий в следующей папке: Program Files\\Microsoft\\Exchange Server\\V15\\Scripts

  - Для выполнения этого примера сценария необходимы следующие компоненты:
    
      - Exchange исходного леса, где в настоящее время находится почтовый ящик. Это может быть почтовый ящик Exchange 2010 или Exchange 2013.
    
      - Целевой лес с установленной системой Exchange 2013, в который необходимо переместить почтовый ящик.

<table>
<thead>
<tr class="header">
<th><img src="images/Bb124558.tip(EXCHG.150).gif" title="Совет" alt="Совет" />Совет.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Возникли проблемы? Обратитесь за помощью к участникам форумов, посвященных Exchange. Посетите форумы по таким продуктам: <a href="https://go.microsoft.com/fwlink/p/?linkid=60612">Exchange Server</a>, <a href="https://go.microsoft.com/fwlink/p/?linkid=267542">Exchange Online</a> или <a href="https://go.microsoft.com/fwlink/p/?linkid=285351">Exchange Online Protection</a>.</td>
</tr>
</tbody>
</table>


## Использование сценария Prepare-MoveRequest.ps1 для подготовки почтовых ящиков к перемещениям между лесами

Запустите этот сценарий в командной консоли для роли сервера под управлением Exchange 2013 в целевом лесу Exchange 2013. Сценарий выполнит копирование атрибутов почтового ящика из исходного леса.

Чтобы назначить учетные данные для проверки подлинности для контроллера домена удаленного леса, необходимо предварительно выполнить командлет Windows PowerShell **Get-Credential** и сохранить введенные пользователем данные во временной переменной. При выполнении командлета **Get-Credential** он запрашивает имя пользователя и пароль учетной записи, используемой при проверке подлинности на контроллере домена удаленного леса. Затем можно использовать временную переменную в сценарии Prepare-MoveRequest.ps1. Дополнительные сведения о командлете **Get-Credential** см. в разделе [Get-Credential](https://go.microsoft.com/fwlink/p/?linkid=142122).

<table>
<thead>
<tr class="header">
<th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Убедитесь, что при вызове этого сценария для локального и удаленного лесов используются различные учетные данные.</td>
</tr>
</tbody>
</table>


1.  Выполните следующие команды, чтобы получить учетные данные локального и удаленного лесов.
    
        $LocalCredentials = Get-Credential
        $RemoteCredentials = Get-Credential

2.  Выполните следующие команды, чтобы передать эти учетные данные в параметры *LocalForestCredential* и *RemoteForestCredential* в скрипте Prepare-MoveRequest.ps1.
    
        Prepare-MoveRequest.ps1 -Identity JohnSmith@Fabrikan.com -RemoteForestDomainController DC001.Fabrikam.com -RemoteForestCredential $RemoteCredentials -LocalForestDomainController DC001.Contoso.com -LocalForestCredential $LocalCredentials

## Набор параметров скрипта

В следующей таблице указан набор параметров для этого сценария.

### Набор параметров для сценария Prepare-MoveRequest.ps1

<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Параметр</th>
<th>Обязательный</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><em>Identity</em></p></td>
<td><p>Обязательный</p></td>
<td><p>Параметр <em>Identity</em> уникальным образом идентифицирует почтовый ящик в исходном лесу. Идентификатором может быть:</p>
<ul>
<li><p>Общее имя (CN)</p></li>
<li><p>Alias</p></li>
<li><p>Свойство <strong>proxyAddress</strong></p></li>
<li><p>Свойство <strong>objectGuid</strong></p></li>
<li><p>Свойство <strong>DisplayName</strong></p></li>
</ul></td>
</tr>
<tr class="even">
<td><p><em>RemoteForestCredential</em></p></td>
<td><p>Обязательный</p></td>
<td><p>Параметр <em>RemoteForestCredential</em> указывает администратора, который имеет разрешения на копирование данных из службы каталогов Active Directory исходного леса.</p></td>
</tr>
<tr class="odd">
<td><p><em>RemoteForestDomainController</em></p></td>
<td><p>Обязательный</p></td>
<td><p>Параметр <em>RemoteForestDomainController</em> указывает контроллер домена в исходном лесу, в котором размещен почтовый ящик.</p></td>
</tr>
<tr class="even">
<td><p><em>DisableEmailAddressPolicy</em></p></td>
<td><p>Необязательный</p></td>
<td><p>Параметр <em>DisableEmailAddressPolicy</em> указывает, требуется ли отключать политику адресов электронной почты (EAP) при создании объекта <strong>MailUser</strong> в целевом лесу.</p>
<p>При указании этого параметра политика адресов электронной почты не будет применяться в целевом лесу.</p>
<table>
<thead>
<tr class="header">
<th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>При указании этого параметра объект <strong>MailUser</strong> не будет отмечен с помощью сопоставления адресов электронной почты в домене локального леса. Обычно он отмечается с помощью политики адресов электронной почты.</td>
</tr>
</tbody>
</table>

</td>
</tr>
<tr class="odd">
<td><p><em>LinkedMailUser</em></p></td>
<td><p>Необязательный</p></td>
<td><p>Параметр <em>LinkedMailUser</em> указывает, необходимо ли создать связанный объект MailUser в локальном лесу для пользователя почтового ящика в удаленном лесу.</p>
<p>При указании этого параметра согласно сценарию создается целевой объект <strong>MailUser</strong>, связанный с исходным почтовым ящиком. Если этот параметр не указан, то по сценарию создается обычный целевой объект <strong>MailUser</strong>.</p></td>
</tr>
<tr class="even">
<td><p><em>LocalForestCredential</em></p></td>
<td><p>Необязательный</p></td>
<td><p>Параметр <em>LocalForestCredential</em> указывает администратора, который имеет разрешения на запись данных в службу каталогов Active Directory целевого леса.</p>
<p>Рекомендуется указать этот параметр явным образом, чтобы избежать проблем с разрешениями Active Directory.</p>
<p>Если в удаленном и локальном лесах настроено отношение доверия, не используйте учетную запись пользователя из удаленного леса в качестве учетных данных локального леса, даже если учетная запись удаленного пользователя имеет разрешение на изменение службы каталогов Active Directory в локальном лесу.</p></td>
</tr>
<tr class="odd">
<td><p><em>LocalForestDomainController</em></p></td>
<td><p>Необязательный</p></td>
<td><p>Параметр <em>LocalForestDomainController</em> указывает контроллер домена в целевом лесу, в котором необходимо создать пользователя с включенной поддержкой почты.</p>
<p>Рекомендуется указать этот параметр, чтобы избежать возможных проблем с задержкой репликации контроллера домена в локальном лесу, которые могут произойти при выборе случайного контроллера домена.</p></td>
</tr>
<tr class="even">
<td><p><em>MailboxDeliveryDomain</em></p></td>
<td><p>Необязательный</p></td>
<td><p>Параметр <em>MailboxDeliveryDomain</em> указывает уполномоченный домен исходного леса, поэтому сценарий позволяет выбрать правильное свойство <strong>proxyAddress</strong> пользователя исходного почтового ящика в качестве свойства <strong>targetAddress</strong> целевого пользователя с включенной поддержкой почты.</p>
<p>По умолчанию для основного SMTP-адреса пользователя исходного почтового ящика установлено свойство <strong>targetAddress</strong> целевого пользователя с включенной поддержкой почты.</p></td>
</tr>
<tr class="odd">
<td><p><em>OverWriteLocalObject</em></p></td>
<td><p>Необязательный</p></td>
<td><p>Параметр <em>OverWriteLocalObject</em> используется при создании пользователей с помощью средства миграции в Active Directory. При этом свойства существующего почтового контакта копируются для нового почтового пользователя. После этого сценарий также копирует для нового почтового пользователя свойства пользователя исходного леса.</p></td>
</tr>
<tr class="even">
<td><p><em>TargetMailUserOU</em></p></td>
<td><p>Необязательный</p></td>
<td><p>Параметр <em>TargetMailuserOU</em> указывает подразделение, в котором будет создан целевой пользователь с включенной поддержкой почты.</p></td>
</tr>
<tr class="odd">
<td><p><em>UseLocalObject</em></p></td>
<td><p>Необязательный</p></td>
<td><p>Параметр <em>UseLocalObject</em> указывает, требуется ли преобразовывать существующий локальный объект в необходимого целевого пользователя с включенной поддержкой почты, если сценарием будет обнаружен в локальном лесу объект, конфликтующий с создаваемым пользователем с включенной поддержкой почты.</p></td>
</tr>
</tbody>
</table>


## Примеры

В этом разделе приведено несколько примеров возможного использования сценария Prepare-MoveRequest.ps1.

## Пример. Один связанный пользователь с поддержкой почты

В этом примере выполняется подготовка одного связанного пользователя с включенной поддержкой почты в локальном лесу, в котором существует доверие леса между удаленным и локальным лесами.

1.  Выполните следующие команды, чтобы получить учетные данные локального и удаленного лесов.
    
        $LocalCredentials = Get-Credential
        $RemoteCredentials = Get-Credential

2.  Выполните следующую команду, чтобы передать эти учетные данные в параметры *LocalForestCredential* и *RemoteForestCredential* в скрипте Prepare-MoveRequest.ps1.
    
        Prepare-MoveRequest.ps1 -Identity JamesAlvord@Contoso.com -RemoteForestDomainController DC001.Fabrikam.com -RemoteForestCredential $RemoteCredentials -LocalForestDomainController DC001.Contoso.com -LocalForestCredential $LocalCredentials -LinkedMailUser 

## Пример. Конвейеризация

В этом примере иллюстрируется поддержка конвейерного режима при указании списка идентификаторов почтового ящика.

1.  Выполните следующую команду.
    
        $UserCredentials = Get-Credential

2.  Выполните следующую команду, чтобы передать эти учетные данные в параметр *RemoteForestCredential* в сценарии Prepare-MoveRequest.ps1.
    
        "IanP@Contoso.com", "JoeAn@Contoso.com" | Prepare-MoveRequest.ps1 -RemoteForestDomainController DC001.Fabrikam.com -RemoteForestCredential $UserCredentials

## Пример. Использование CSV-файла для массового создания пользователей с поддержкой почты

Вы можете создать CSV-файл со списком идентификаторов почтовых ящиков из исходного леса, что позволяет направлять содержимое этого файла в скрипт для массового создания пользователей с поддержкой почты.

Например, CSV-файл может иметь следующее содержимое:

Параметр Identity (идентификатор)

Ian@contoso.com

John@contoso.com

Cindy@contoso.com

В этом примере вызывается CSV-файл для массового создания пользователей с поддержкой почты.

1.  Выполните следующую команду, чтобы получить учетные данные леса.
    
        $UserCredentials = Get-Credential

2.  Выполните следующую команду, чтобы передать эти учетные данные в параметр *RemoteForestCredential* в сценарии Prepare-MoveRequest.ps1.
    
        Import-Csv Test.csv | Prepare-MoveRequest.ps1 -RemoteForestDomainController DC001.Fabrikam.com -RemoteForestCredential $UserCredentials

## Поведение скрипта в зависимости от конечного объекта

В этом разделе описывается выполнение скрипта по отношению к нескольким сценариям для конечных объектов.

## Дублирование целевого объекта с включенной поддержкой почты

При попытке сценария создать целевого пользователя с включенной поддержкой почты на основе пользователя исходного почтового ящика и обнаружении дублированного локального объекта с включенной поддержкой почты используется следующая логика.

  - Если атрибут **masterAccountSid** пользователя исходного почтового ящика соответствует какому-либо атрибуту **objectSid** или **masterAccountSid** целевого объекта, то:
    
      - Если для целевого объекта отключена поддержка почты, то сценарием возвращается сообщение об ошибке, так как он не поддерживает преобразование объекта с отключенной поддержкой почты в пользователя с включенной поддержкой почты.
    
      - Если для целевого объекта включена поддержка почты, он является дубликатом.

  - Если адрес в свойствах **proxyAddress** (только smtp/x500) пользователя исходного почтового ящика соответствует адресу в свойствах **proxyAddress** (только smtp/x500) целевого объекта, то целевой объект является дубликатом.

Сценарий запрашивает пользователя о дубликатах объектов.

Если целевой объект с включенной поддержкой почты является пользователем или контактом с включенной поддержкой почты, созданным, по всей вероятности, при развертывании синхронизации глобального списка адресов (GAL) между лесами (на основе Identity Lifecycle Management 2007 с пакетом обновления 1 (SP1)), то пользователь может повторно запустить сценарий с параметром *UseLocalObject*, чтобы использовать целевой объект с включенной поддержкой почты для миграции почтовых ящиков.

## Пользователь с включенной поддержкой почты

Если целевой объект является пользователем с включенной поддержкой почты, сценарий копирует следующие атрибуты пользователя исходного почтового ящика для целевого пользователя с включенной поддержкой почты:

  - **msExchMailboxGUID**

  - **msExchArchiveGUID**

  - **msExchArchiveName**

Если установлен параметр *LinkedMailUser*, то согласно сценарию копируется исходный атрибут **objectSid** или **masterAccountSid**.

## Контакт с включенной поддержкой почты

Если целевой объект является контактом с включенной поддержкой почты, сценарий удаляет существующий контакт и копирует все его атрибуты для нового пользователя с включенной поддержкой почты. Сценарий также копирует следующие атрибуты пользователя исходного почтового ящика:

  - **msExchMailboxGUID**

  - **msExchArchiveGUID**

  - **msExchArchiveName**

  - **sAMAccountName**

  - **userAccountControl** (значение 514 //равнозначно 0x202, ACCOUNTDISABLE | NORMAL\_ACCOUNT)

  - **userPrincipalName**

Если установлен параметр *LinkedMailUser*, то согласно сценарию копируется исходный атрибут **objectSid** или **masterAccountSid**.

## Атрибут LegacyExchangeDN

При вызове командлета **Update-Recipient** для преобразования целевого объекта в пользователя с включенной поддержкой почты создается новый атрибут **LegacyExchangeDN** для целевого пользователя с включенной поддержкой почты. В соответствии со сценарием копируется атрибут **LegacyExchangeDN** целевого пользователя с включенной поддержкой почты в качестве адреса x500 для свойств **proxyAddress** пользователя исходного почтового ящика.

