---
title: 'Сведения о средстве устранения неполадок единой системы обмена сообщениями Exchange: Exchange 2013 Help'
TOCTitle: Сведения о средстве устранения неполадок единой системы обмена сообщениями Exchange
ms:assetid: cc11bf5e-2c87-4495-b2ad-3e9a6bc81dbc
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Gg584301(v=EXCHG.150)
ms:contentKeyID: 56271236
ms.date: 04/30/2018
mtps_version: v=EXCHG.150
ms.translationtype: HT
---

# Сведения о средстве устранения неполадок единой системы обмена сообщениями Exchange

 

_**Применимо к:**Exchange Online, Exchange Server 2013, Exchange Server 2016_

_**Последнее изменение раздела:**2016-12-09_

Средство устранения неполадок единой системы обмена сообщениями Microsoft Exchange 2010 — это командлет командной консоли Exchange под названием **Test-ExchangeUMCallFlow**. Указанное средство можно использовать для проведения серии диагностических тестов единой системы обмена сообщениями в организации. Если при выполнении какого-либо теста происходит сбой, средство сообщает причину сбоя и возможные варианты решения возникшей проблемы. Использовать средство устранения неполадок единой системы обмена сообщениями можно только на серверах Exchange 2010 или более поздней версии.

Средство устранения неполадок единой системы обмена сообщениями позволяет проверить правильность работы голосовой почты в локальных и нелокальных развертываниях. Его можно использовать в развертываниях единой системы обмена сообщениями с установленными серверами Microsoft Office Communications Server 2007 R2 или Microsoft Lync Server 2010, а также в развертываниях этой системы, содержащих шлюзы VoIP, IP-УАТС или пограничные контроллеры сеансов (SBC).

<table>
<thead>
<tr class="header">
<th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Средство устранения неполадок единой системы обмена сообщениями используется для тестирования системы и устранения неполадок. С другой стороны, командлет <strong>Test-UMConnectivity</strong> следует использовать в целях наблюдения. Командлет <strong>Test-UMConnectivity</strong> применяется вместе с пакетами управления System Center Operations Manager (SCOM), предназначенными для наблюдения за серверами единой системы обмена сообщениями Exchange 2010 или серверами почтовых ящиков и клиентского доступа Exchange 2013 и компонентами телефонии. Командлет <strong>Test-UMConnectivity</strong> выполняет локальные проверки подключений SIP и процедур входа в систему для почтовых ящиков. Кроме того, он может запускаться в качестве задачи SCOM.</td>
</tr>
</tbody>
</table>


Чтобы загрузить средство устранения неполадок единой системы обмена сообщениями, см. статью [Средство устранения неполадок единой системы обмена сообщениями](https://go.microsoft.com/fwlink/p/?linkid=182625).

**Содержание**

Обзор

Архитектура устранения неполадок единой системы обмена сообщениями

Шлюз VoIP и развертывания IP-УАТС

Развертывания Office Communications Server 2007 R2 и Microsoft Lync Server

Установка средства устранения неполадок единой системы обмена сообщениями

Параметры командлета

## Обзор

Средство устранения неполадок единой системы обмена сообщениями упрощает тестирование и решение проблем в развертываниях единой системы обмена сообщениями. При запуске средство устранения неполадок единой системы обмена сообщениями автоматически создает набор файлов трассировки, сохраняемых в папке C:\\Users\\%UserProfile%\\AppData\\Roaming\\Microsoft Exchange 2010 UM Troubleshooting. Средство создает следующие файлы трассировки.

  - **UMTool\_Collaboration**   Содержит записи трассировки стека RTC.

  - **UMTool\_DiagnosticLog**   Перечисляет все проводимые тесты и их результаты.

  - **UMTool\_S4**   Содержит записи трассировки сигнального стека S4.

  - **UMTool\_SIPMessageLogs**   Содержит записи всех трассировок SIP для выполненного тестового вызова.

Средство устранения неполадок единой системы обмена сообщениями подключается непосредственно к локальному пограничному контроллеру сеансов (SBC), если он существует, или к контроллеру SBC в центре обработки данных и эмулирует входящий вызов, аналогичный вызову, поступающему из УАТС через шлюз VoIP или IP-УАТС. Средство устранения неполадок единой системы обмена сообщениями можно использовать для диагностики:

  - неправильных параметров в локальных и нелокальных развертываниях единой системы обмена сообщениями, в состав которых входит сервер Office Communications Server 2007 R2 или Microsoft Lync Server;

  - неправильных параметров локального или нелокального телефонного оборудования, в состав которого входят шлюзы VoIP и УАТС или IP-УАТС;

  - проблем со службой доменных имен (DNS);

  - проблем с сертификатами при использовании абонентских групп единой системы обмена сообщениями в безопасном режиме или режиме с защитой SIP;

  - проблем передачи сигналов и неполадок носителей для DTMF (другое название — «тональный набор») и звука.

Если средство устранения неполадок единой системы обмена сообщениями обнаруживает сбой в конфигурации, оно сообщает причину ошибки и возможные варианты решения найденных проблем. Ошибки, которые могут быть обнаружены при использовании средства устранения неполадок единой системы обмена сообщениями в локальном развертывании, перечислены ниже.

  - Превышено максимально допустимое число вызовов.

  - Для пользователя отключена поддержка единой системы обмена сообщениями.

  - Не удалось найти сведения о шлюзе IP, абонентской или сервисной группе единой системы обмена сообщениями.

  - Тип безопасности не соответствует абонентской группе единой системы обмена сообщениями.

  - Отсутствуют доступные рабочие процессы для обработки вызова.

  - Служба единой системы обмена сообщениями или маршрутизатор вызовов единой системы обмена сообщениями остановлен.

  - Не удалось найти лес Active Directory.

  - Отсутствует свободное пространство на диске.

  - Недопустимые заголовки SIP использованы в запросе.

  - Выполнен вызов на сервер Office Communications Server 2007 R2 или Lync Server.

  - Шлюз IP единой системы обмена сообщениями отключен.

  - Недопустимый универсальный код ресурса (URI) вызываемого пользователя.

Если средство устранения неполадок единой системы обмена сообщениями используется в нелокальном развертывании, могут быть выявлены следующие ошибки.

  - Для пользователя отключена поддержка единой системы обмена сообщениями.

  - Шлюз IP единой системы обмена сообщениями отключен.

  - Недопустимый универсальный код ресурса (URI) пользователя.

  - Тип безопасности не соответствует абонентской группе единой системы обмена сообщениями.

  - Недопустимые заголовки SIP использованы в запросе.

  - Не удалось найти сведения о шлюзе IP, абонентской или сервисной группе единой системы обмена сообщениями.

Средство устранения неполадок единой системы обмена сообщениями отправляет образец файла в формате WAV длительностью 15 секунд. После отправки и воспроизведения звукового файла и аудиопотока RTP средство создает отчет об общих показателях качества звука для диагностики проблем со звуком, связанных с сетевыми подключениями, например об уровне дрожания и среднем значении потери пакетов. В эти отчеты входят значения качества потоковой передачи данных мультимедиа на сервер единой системы обмена сообщениями и с него, а также следующие показатели.

  - Ожидаемая средняя скорость передачи по сети (NMOS)

  - Кодек

  - Задержка в миллисекундах (мс)

  - Дрожание в миллисекундах (мс)

  - % потерь пакетов

  - Классификация и оценка уровней NMOS, используемых для определения качества звука, выглядит следующим образом.
    
      - NMOS меньше 2 = плохое
    
      - NMOS больше 2, но меньше 3 = среднее
    
      - NMOS больше 3, но меньше 4 = хорошее
    
      - NMOS больше 4, но меньше 5 = отличное

Средство устранения неполадок единой системы обмена сообщениями поддерживает тестирование абонентских групп единой системы обмена сообщениями, в которых используются безопасные и небезопасные вызовы, а также вызовы с защитой SIP. Если выбран безопасный режим или режим с защитой SIP, отпечаток используемого сертификата проверяется, чтобы определить, истек ли срок действия сертификата и какой тип сертификата применяется для соединений по протоколу TLS. Сертификат используется для правильного определения и обеспечения подлинности удостоверения удаленного компьютера. При выборе безопасного режима или режима с защитой SIP средство устранения неполадок единой системы обмена сообщениями проверяет выполнение следующих условий.

  - Локальный сертификат найден в хранилище на локальном компьютере.

  - Используемый сертификат является доверенным.

  - Целевое имя, указанное в сертификате, является допустимым.

  - Срок действия сертификата истек.

  - Удаленный компьютер доверяет сертификату.

  - Сертификат отозван.

  - Сертификат не обеспечивает требуемого расширенного использования ключа.

Средство устранения неполадок единой системы обмена сообщениями можно запускать в режиме Gateway или SIPClient в зависимости от того, выполняется ли развертывание сервера Office Communications Server 2007 R2 либо Lync Server или используются ли шлюзы VoIP и УАТС либо IP-УАТС вместе с серверами единой системы обмена сообщениями. Если используется режим Gateway или SIPClient, средство устранения неполадок единой системы обмена сообщениями поддерживает выполнение вызовов в следующих форматах. Используемый формат зависит от типа универсального кода ресурса (URI) для абонентской группы единой системы обмена сообщениями.

  - Добавочный телефонный номер   425-555-1010

  - Телефонные номера E.164   +1 (425) 555-1010

  - SIP-адреса   tonysmith@contoso.com

При использовании режима SIPClient средство устранения неполадок единой системы обмена сообщениями создает вызов с голосовым напоминанием. Это вызов, не предполагающий дозвон по телефону или в конечную точку системы объединенных коммуникаций. Вместо этого вызов передается непосредственно в систему голосовой почты. Когда средство устранения неполадок единой системы обмена сообщениями работает в режиме SIPClient, оно будет определять:

  - какой целевой пользователь вызывается;

  - был ли удачно выполнен вызов SIP;

  - вызов SIP принят сервером единой системы обмена сообщениями Exchange 2010 или сервером почтовых ящиков Exchange 2013;

  - была ли получена правильная последовательность DTMF;

  - был ли отправлен диагностический файл WAV и получен сервером единой системы обмена сообщениями Exchange 2010 или сервером почтовых ящиков Exchange 2013;

  - показатели, использованные при получении потока мультимедиа или качества звука.

Средство устранения неполадок единой системы обмена сообщениями эмулирует входящие вызовы и проводит серию диагностических тестов, помогающих администраторам локальных и клиентских систем проверить в потоке вызовов процедуры ответов и выявить ошибки конфигурации. Несмотря на то что средство устранения неполадок единой системы обмена сообщениями можно использовать в сценариях с применением автоответчика, оно не поддерживает тестирование следующих типов вызовов:

  - вызовы голосового доступа к Outlook, в том числе вызовы, обеспечивающие доступ к голосовой и электронной почте, календарю, каталогу, личным контактам или параметрам пользователя;

  - автосекретари единой системы обмена сообщениями;

  - воспроизведение на телефоне;

  - правила автоответчика;

  - отправка и получение факсов;

  - подготовка приглашений.

Обзор

## Архитектура устранения неполадок единой системы обмена сообщениями

Средство устранения неполадок единой системы обмена сообщениями помогает выявлять, диагностировать и исправлять ошибки конфигурации в нелокальных развертываниях. Кроме того, его можно использовать в локальных развертываниях единой системы обмена сообщениями. В нелокальных развертываниях это средство дополнительно проверяет конфигурации контроллера SBC на месте эксплуатации. Администратор может проверить все компоненты, используемые единой системой обмена сообщениями, включая контроллеры SBC.

## Шлюз VoIP и развертывания IP-УАТС

В следующем примере показано использование режима Gateway для проверки потока вызовов в среде, не содержащей сервер Office Communications Server 2007 R2 или Lync Server. В этом примере тестируется телефонное оборудование, включая шлюзы VoIP, УАТС и IP-УАТС, а также компоненты единой системы обмена сообщениями. В рассматриваемом примере для режима безопасности по протоколу VoIP задается значение «Небезопасный», в качестве следующего прыжка используется IP-адрес 10.1.1.1 и в сведения о перенаправлении включается добавочный номер.

    Test-ExchangeUMCallFlow -Mode Gateway -VoIPSecurity Unsecured -NextHop 10.1.1.1 -Diversion 12345

Обзор

## Развертывания Office Communications Server 2007 R2 и Microsoft Lync Server

Средство устранения неполадок единой системы обмена сообщениями можно использовать в локальных или нелокальных развертываниях, содержащих сервер Office Communications Server 2007 R2 или Microsoft Lync Server, при работе в режиме SIPClient. В следующем примере используется режим SIPClient и проверяется поток вызовов в защищенной абонентской группе единой системы обмена сообщениями в среде, содержащей серверы Office Communications Server 2007 R2 или Lync Server. При запуске средство устранения неполадок единой системы обмена сообщениями по умолчанию использует учетные данные пользователя, который в данный момент находится в системе компьютера. При рассмотрении следующего примера будет отображен запрос на ввод учетных данных, которые требуется использовать во время запуска средства устранения неполадок единой системы обмена сообщениями. Дополнительные сведения см. в разделе [Указание учетных данных для средства устранения неполадок единой системы обмена сообщениями Exchange](set-the-credentials-to-use-with-the-exchange-um-troubleshooting-tool-exchange-2013-help.md).

    Test-ExchangeUMCallFlow -Mode SIPClient -VoIPSecurity Secured -CallingParty tony@contoso.com -CalledParty david@contoso.com -Credential $get

## Установка средства устранения неполадок единой системы обмена сообщениями

Средство устранения неполадок единой системы обмена сообщениями можно установить на локальном сервере этой системы или другом 64-разрядном компьютере, работающем под управлением:

  - Операционные системы Windows 7 или Windows 8.

  - операционных систем Windows Server 2008 или Windows Server 2008 R2.

  - Операционные системы Windows Server 2012 или Windows Server 2012 R2.

Если средство устранения неполадок единой системы обмена сообщениями будет использоваться в 64-разрядной версии Windows 7, Windows 8 или 64-разрядном выпуске Windows Server 2008, перед его установкой необходимо установить следующие компоненты:

  - Microsoft .NET Framework 3.5 с пакетом обновления 1 (SP1).   См. статью [Microsoft .NET Framework 3.5 с пакетом обновления 1](https://go.microsoft.com/fwlink/p/?linkid=152380).
    
    <table>
    <thead>
    <tr class="header">
    <th><img src="images/JJ126620.note(EXCHG.150).gif" title="Примечание" alt="Примечание" />Примечание.</th>
    </tr>
    </thead>
    <tbody>
    <tr class="odd">
    <td>Если средство будет работать на компьютере под управлением Windows Vista или Windows Server 2008, см. статью <a href="https://go.microsoft.com/fwlink/p/?linkid=178998">Обновление семейства Microsoft .NET Framework 3.5 для Windows Vista x64 и Windows Server 2008 x64</a>.</td>
    </tr>
    </tbody>
    </table>


  - Служба удаленного управления Windows (WinRM) 2.0 и Windows PowerShell V2 (Windows6.0-KB968930.msu)   См. статью 968930 базы знаний Майкрософт [Основной пакет Windows Management Framework (Windows PowerShell 2.0 и WinRM 2.0)](http://go.microsoft.com/fwlink/p/?linkid=3052%26kbid=968930).

  - Microsoft Unified Communications Managed API 2.0 Core Runtime (UcmaRuntimeWebDownloadX64.msi).   См. статью [Unified Communications Managed API 2.0, Core Runtime (64-разрядный)](https://go.microsoft.com/fwlink/p/?linkid=198175).

Средство устранения неполадок единой системы обмена сообщениями (командлет **Test-ExchangeUMCallFlow**) не входит в состав DVD-диска, содержащего программное обеспечение Exchange 2010 с пакетом обновления 1 (SP1), или загружаемых файлов, содержащих только Exchange 2010 или установочный носитель Exchange 2013. Тем не менее, средство устранения неполадок единой системы обмена сообщениями можно загрузить в [Центре загрузки Майкрософт](https://go.microsoft.com/fwlink/p/?linkid=182625).

Дополнительные сведения см. в разделе [Установка средства устранения неполадок единой системы обмена сообщениями Exchange](install-the-exchange-um-troubleshooting-tool-exchange-2013-help.md).

Обзор

## Параметры командлета

В приведенной ниже таблице перечислены параметры, которые можно использовать с командлетом **Test-ExchangeUMCallFlow**, а также их описания. Кроме того, можно использовать команду `Get-help Test-ExchangeUMCallFlow -detailed` в командной консоли для поиска дополнительных сведений о каждом параметре, применяемом с командлетом **Test-ExchangeUMCallFlow**, и получить доступ к примерам использования.

### Параметры

<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Параметр</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p><em>CalledParty</em></p></td>
<td><p>Параметр <em>CalledParty</em> определяет универсальный код ресурса (URI) SIP пользователя сервера Office Communications Server 2007 R2 или Lync Server, для которого включена поддержка корпоративной голосовой связи. Именно этому пользователю командлет <strong>Test-ExchangeUMCallFlow</strong> будет отправлять голосовой вызов, например: <code>-CalledParty tonysmith@contoso.com</code>. Используйте этот параметр при запуске средства в режиме SIPClient.</p></td>
</tr>
<tr class="even">
<td><p><em>CallingParty</em></p></td>
<td><p>Параметр <em>CallingParty</em> определяет универсальный код ресурса (URI) SIP пользователя сервера Office Communications Server 2007 R2 или Lync Server, для которого включена поддержка корпоративной голосовой связи. Именно этот пользователь совершает входящий вызов, например: <code>-CallingParty tonysmith@contoso.com</code>. Используйте этот параметр при запуске средства в режиме SIPClient.</p></td>
</tr>
<tr class="odd">
<td><p><em>Diversion</em></p></td>
<td><p>Параметр <em>Diversion</em> указывает строку, которую необходимо отправить как сведения о перенаправлении входящего вызова. Она может иметь вид заголовка перенаправления или сведений журнала. Сведения о перенаправлении, содержащиеся во входящем вызове, могут являться добавочным номером или включать в себя дополнительные сведения о перенаправлении.</p>
<p>При предоставлении таких сведений о перенаправлении, как заголовок сведений журнала, необходимо убедиться, что:</p>
<ul>
<li><p>существует по меньшей мере две различные записи с различными данными пользователей;</p></li>
<li><p>последняя запись содержит телефонный номер доступа абонентской группы единой системы обмена сообщениями, связанной с пользователем;</p></li>
<li><p>предпоследняя запись содержит добавочный номер пользователя с включенной поддержкой единой системы обмена сообщениями. Эта запись также должна содержать соответствующий текст причины. Этот текст должен пропускаться в соответствии со стандартными правилами пропуска, заданными в параметре URL-адреса.</p></li>
</ul></td>
</tr>
<tr class="even">
<td><p><em>Mode</em></p></td>
<td><p>Параметр <em>Mode</em> указывает, какой режим необходимо использовать: шлюз VoIP, IP-УАТС или сервер Office Communications Server 2007 R2 или Lync Server. Если в развертывании единой системы обмена сообщениями используются шлюзы VoIP или IP-УАТС, можно задать режим Gateway, а при использовании в развертывании серверов Office Communications Server 2007 R2 или Lync Server — режим SIPClient.</p></td>
</tr>
<tr class="odd">
<td><p><em>NextHop</em></p></td>
<td><p>Параметр <em>NextHop</em> указывает IP-адрес или полное доменное имя (FQDN) следующего прыжка, а также может содержать TCP-порт следующего прыжка, к которому должен подключиться командлет <strong>Test-ExchangeUMCallFlow</strong> во время эмуляции шлюза VoIP или IP-УАТС. Если в параметре указывается TCP-порт, необходимо также включить порт 5060 для небезопасного режима или порт 5061 для безопасного режима или режима с защитой SIP. Например: <code>gateway.contoso.com:5061</code>.</p></td>
</tr>
<tr class="even">
<td><p><em>CertificateThumbprint</em></p></td>
<td><p>Параметр <em>CertificateThumbprint</em> указывает отпечаток сертификата, используемого для протокола TLS. Этот параметр является обязательным, если для абонентской группы единой системы обмена сообщениями настроен режим с защитой SIP или безопасный режим. Отпечаток сертификата представляет собой сертификат, экспортированный из шлюза VoIP, IP-УАТС или контроллера SBC. Кроме того, компьютер с установленным средством устранения неполадок единой системы обмена сообщениями, используемый для проверки потока вызовов, должен доверять сертификату центра для следующего прыжка.</p></td>
</tr>
<tr class="odd">
<td><p><em>Credential</em></p></td>
<td><p>Параметр <em>Credential</em> указывает учетные данные, используемые для запуска командлета.</p></td>
</tr>
<tr class="even">
<td><p><em>HuntGroup</em></p></td>
<td><p>Параметр <em>HuntGroup</em> указывает сервисную группу единой системы обмена сообщениями, связанную с эмулируемым шлюзом VoIP. Обычно это добавочный номер. Используйте этот параметр при запуске средства в режиме Gateway.</p></td>
</tr>
<tr class="odd">
<td><p><em>VoIPSecurity</em></p></td>
<td><p>Параметр <em>VoIPSecurity</em> указывает режим безопасности при использовании командлета в режиме Gateway. Можно использовать один из следующих режимов безопасности VoIP:</p>
<ul>
<li><p>безопасный (TLS/SRTP);</p></li>
<li><p>небезопасный (TCP/RTP), по умолчанию;</p></li>
<li><p>с защитой SIP (TLS/RTP).</p></li>
</ul></td>
</tr>
</tbody>
</table>


Обзор

